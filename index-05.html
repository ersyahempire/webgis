<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem GIS Pengurusan Projek</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        #map { height: 100vh; width: 100%; z-index: 0; }
        
        /* Glossy Premium Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        
        .glass-dark {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Sidebar transition */
        .sidebar-right {
            transform: translateX(90%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-right:hover, .sidebar-right.active {
            transform: translateX(0);
        }

        /* Marker & Popup styling */
        .leaflet-popup-content-wrapper { border-radius: 0.8rem; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 320px !important; }
        .custom-tooltip {
            background: rgba(0,0,0,0.8);
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden font-sans">

    <!-- 1. Top Bar (Search & Report) -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] flex gap-2 w-full max-w-xl px-4 pointer-events-none">
        <div class="glass-panel rounded-full flex items-center px-5 py-3 w-full pointer-events-auto transition-all focus-within:ring-2 ring-blue-400">
            <i class="fa-solid fa-search text-gray-500 mr-3"></i>
            <input type="text" id="search-input" placeholder="Cari Nama Site, Daerah..." class="bg-transparent border-none outline-none w-full text-gray-800 placeholder-gray-500 font-medium">
        </div>
        <button onclick="bukaReportCard()" class="glass-dark pointer-events-auto hover:bg-gray-800 px-6 py-3 rounded-full font-semibold transition flex items-center whitespace-nowrap shadow-lg">
            <i class="fa-solid fa-file-pdf mr-2"></i> Laporan
        </button>
    </div>

    <!-- 2. LEFT SIDEBAR (Main Card, Stats, Legend) -->
    <div class="absolute top-24 left-4 z-[900] w-80 flex flex-col gap-4 pointer-events-none">
        
        <!-- Main Card Info -->
        <div class="glass-panel rounded-2xl p-5 pointer-events-auto shadow-2xl animate-fade-in-up">
            <!-- Header: Selected Layer Name -->
            <div class="mb-4 border-b border-gray-300 pb-2">
                <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Layer Semasa</p>
                <h1 id="current-layer-name" class="text-2xl font-extrabold text-gray-800">MALAYSIA</h1>
            </div>

            <!-- Total Stats -->
            <div class="flex justify-between items-end mb-4">
                <div>
                    <p class="text-xs text-gray-500 font-semibold">Jumlah Keseluruhan</p>
                    <h2 class="text-4xl font-black text-blue-600" id="main-total-count">0</h2>
                </div>
                <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
            </div>

            <!-- Category Breakdown (Compact) -->
            <div id="left-category-list" class="space-y-2 mb-4">
                <!-- Injected via JS -->
            </div>

            <!-- Status Project Section -->
            <div class="mt-4 pt-4 border-t border-gray-300">
                <p class="text-xs font-bold text-gray-500 uppercase mb-2">Status Projek</p>
                
                <!-- Main Progress Bar -->
                <div onclick="toggleStatusDropdown()" class="cursor-pointer group">
                    <div class="flex justify-between text-sm mb-1 font-semibold">
                        <span class="text-gray-700">Keseluruhan Siap</span>
                        <span id="main-progress-text" class="text-blue-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                        <div id="main-progress-bar" class="bg-gradient-to-r from-blue-500 to-blue-400 h-3 rounded-full transition-all duration-1000 w-0 group-hover:from-blue-600 group-hover:to-blue-500"></div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1 text-center group-hover:text-blue-500 transition">Klik untuk perincian status</p>
                </div>

                <!-- Dropdown Status (Hidden) -->
                <div id="status-dropdown" class="hidden mt-3 bg-white/50 rounded-lg p-2 border border-gray-200 text-sm animate-fade-in">
                     <div id="status-breakdown-list" class="space-y-1 max-h-40 overflow-y-auto pr-1 scrollbar-hide">
                         <!-- Injected via JS -->
                     </div>
                </div>
            </div>
        </div>

        <!-- Legend Card -->
        <div class="glass-panel rounded-2xl p-4 pointer-events-auto shadow-xl">
            <h3 class="text-xs font-bold text-gray-500 uppercase mb-3 border-b border-gray-300 pb-2">Petunjuk Peta</h3>
            <div id="map-legend" class="space-y-2">
                <!-- Injected via JS -->
            </div>
        </div>

    </div>

    <!-- 3. RIGHT SIDEBAR (Auto-hide Menus) -->
    <div class="absolute top-24 right-0 z-[900] flex flex-col items-end gap-4 pointer-events-none h-[80vh]">
        
        <!-- Layer Selector (Slide out) -->
        <div class="sidebar-right pointer-events-auto flex items-start mr-0">
            <!-- Trigger Tab -->
            <div class="bg-white/90 backdrop-blur p-3 rounded-l-xl shadow-lg cursor-pointer flex flex-col items-center justify-center h-24 w-12 border-y border-l border-gray-200 z-10 group hover:bg-blue-50">
                <i class="fa-solid fa-map text-xl text-blue-600 mb-1"></i>
                <span class="text-[10px] font-bold text-gray-600 [writing-mode:vertical-rl] rotate-180 uppercase tracking-widest">Peta</span>
            </div>
            <!-- Content -->
            <div class="glass-panel w-64 p-4 rounded-bl-xl shadow-2xl -ml-1">
                <h3 class="text-sm font-bold text-gray-700 mb-3 uppercase">Jenis Peta</h3>
                <div class="space-y-2">
                    <button onclick="setBaseMap('osm')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition text-sm font-medium flex items-center">
                        <i class="fa-solid fa-road w-6"></i> Standard
                    </button>
                    <button onclick="setBaseMap('satellite')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition text-sm font-medium flex items-center">
                        <i class="fa-solid fa-satellite w-6"></i> Satelit
                    </button>
                </div>

                <h3 class="text-sm font-bold text-gray-700 mt-4 mb-3 uppercase">Sempadan</h3>
                <div class="space-y-2">
                    <button onclick="tukarLayer('district')" id="btn-district" class="layer-btn w-full text-left px-3 py-2 rounded-lg bg-blue-500 text-white shadow text-sm font-medium">Daerah</button>
                    <button onclick="tukarLayer('dun')" id="btn-dun" class="layer-btn w-full text-left px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100 text-sm font-medium">DUN</button>
                    <button onclick="tukarLayer('parliament')" id="btn-parliament" class="layer-btn w-full text-left px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100 text-sm font-medium">Parlimen</button>
                </div>
            </div>
        </div>

        <!-- Project Categories (Slide out) -->
        <div class="sidebar-right pointer-events-auto flex items-start mr-0">
            <!-- Trigger Tab -->
            <div class="bg-white/90 backdrop-blur p-3 rounded-l-xl shadow-lg cursor-pointer flex flex-col items-center justify-center h-32 w-12 border-y border-l border-gray-200 z-10 group hover:bg-green-50">
                <i class="fa-solid fa-filter text-xl text-green-600 mb-1"></i>
                <span class="text-[10px] font-bold text-gray-600 [writing-mode:vertical-rl] rotate-180 uppercase tracking-widest">Projek</span>
            </div>
            <!-- Content -->
            <div class="glass-panel w-64 p-4 rounded-bl-xl shadow-2xl -ml-1">
                <h3 class="text-sm font-bold text-gray-700 mb-3 uppercase">Kategori Projek</h3>
                <div class="space-y-2" id="right-category-filters">
                    <button onclick="filterProjek('all')" class="w-full flex items-center justify-between px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm font-medium transition">
                        <span>Semua Projek</span>
                        <span class="bg-gray-300 text-gray-700 text-xs px-2 py-0.5 rounded-full" id="count-all">0</span>
                    </button>
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>

    </div>

    <!-- 4. Report Card Modal -->
    <div id="report-modal" class="fixed inset-0 z-[2000] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col overflow-hidden border border-gray-200">
            <!-- Header -->
            <div class="bg-gray-900 text-white p-5 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold">Laporan Analisis Projek</h2>
                    <p class="text-xs text-gray-400 mt-1">Dijana Automatik</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="muatTurunPDF()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg text-sm font-semibold transition shadow-lg flex items-center">
                        <i class="fa-solid fa-download mr-2"></i> PDF
                    </button>
                    <button onclick="tutupReportCard()" class="bg-gray-700 hover:bg-red-600 text-white px-5 py-2 rounded-lg text-sm font-semibold transition shadow-lg">
                        Tutup
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div id="report-content" class="flex-1 overflow-y-auto p-10 bg-gray-50">
                <div class="text-center mb-10 border-b border-gray-300 pb-6">
                    <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Laporan Prestasi Projek</h1>
                    <p class="text-gray-500 mt-2 text-lg">Ringkasan status terkini dan taburan projek.</p>
                </div>
                <!-- Stats Grid -->
                <div class="grid grid-cols-4 gap-6 mb-10">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-gray-400 text-xs font-bold uppercase">Jumlah Projek</p>
                        <p class="text-3xl font-black text-gray-800 mt-2" id="rpt-total">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                        <p class="text-green-600 text-xs font-bold uppercase">Siap / Operasi</p>
                        <p class="text-3xl font-black text-gray-800 mt-2" id="rpt-completed">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500">
                        <p class="text-yellow-600 text-xs font-bold uppercase">Dalam Pelaksanaan</p>
                        <p class="text-3xl font-black text-gray-800 mt-2" id="rpt-ongoing">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                        <p class="text-red-600 text-xs font-bold uppercase">Masalah / Belum Mula</p>
                        <p class="text-3xl font-black text-gray-800 mt-2" id="rpt-issues">0</p>
                    </div>
                </div>
                <!-- Charts -->
                <div class="grid grid-cols-2 gap-8 mb-10">
                    <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold text-gray-700 mb-4">Taburan Kategori</h3><div class="h-64"><canvas id="chart-pie-cat"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold text-gray-700 mb-4">Status Keseluruhan</h3><div class="h-64"><canvas id="chart-pie-status"></canvas></div></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm mb-10"><h3 class="font-bold text-gray-700 mb-4">Analisis Status per Kategori</h3><div class="h-72"><canvas id="chart-bar-status"></canvas></div></div>
            </div>
        </div>
    </div>

    <!-- 5. Map Container -->
    <div id="map"></div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIG ---
        const SHEETS = {
            db_bwa: "1594VRWEs0PF56KXeSPudZTWkbGuS5UZmxXGrKqo4bUU",
            db_pim: "1WyZiw72LOVytssXAuymJS_TIgckLCUqY56pB0QhawZU",
            db_POP: "1JLqLtZPa4Kd6hEbRA2wgMgADX2h2-tdsXnG-YivSgU8",
            tower: "1b0Aipp0MQvP8HWc-z28dugkGn5sWdNAx6ZE5-Mu13-0"
        };
        const LAYERS = {
            district: "https://ersyahempire.github.io/webgis/district.json",
            dun: "https://ersyahempire.github.io/webgis/dun.json",
            parliament: "https://ersyahempire.github.io/webgis/parliament.json"
        };
        const CATEGORY_COLORS = {
            'db_bwa': '#3B82F6', // Blue
            'db_pim': '#10B981', // Green
            'db_POP': '#F59E0B', // Yellow
            'tower': '#EF4444'   // Red
        };
        const CATEGORY_NAMES = {
            'db_bwa': 'Projek BWA',
            'db_pim': 'Projek PIM',
            'db_POP': 'Projek POP',
            'tower': 'Menara Telco'
        };
        const LAYER_DISPLAY_NAMES = {
            district: 'Daerah',
            dun: 'Dewan Undangan Negeri (DUN)',
            parliament: 'Parlimen'
        };

        let map, tileLayers = {};
        let activeGeoJsonLayer = null;
        let allProjects = [];
        let markersGroup = L.layerGroup();
        let chartInstances = {};

        document.addEventListener('DOMContentLoaded', async () => {
            initMap();
            await loadAllData();
            updateUI();
            tukarLayer('district');
            
            // Initial Plot All Markers
            filterProjek('all');
        });

        // --- MAP INITIALIZATION ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([4.2105, 101.9758], 6);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Base Layers
            tileLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            });
            
            tileLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });

            tileLayers.osm.addTo(map);
            markersGroup.addTo(map);
        }

        function setBaseMap(type) {
            map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) map.removeLayer(layer);
            });
            tileLayers[type].addTo(map);
        }

        // --- DATA LOADING ---
        async function loadAllData() {
            const sheetPromises = Object.entries(SHEETS).map(([key, id]) => fetchGoogleSheet(id, key));
            await Promise.all(sheetPromises);
            console.log("Data loaded:", allProjects.length);
        }

        function fetchGoogleSheet(sheetId, type) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;
            return new Promise(resolve => {
                Papa.parse(url, {
                    download: true, header: true,
                    complete: (results) => {
                        const projects = results.data.map(row => ({ ...row, category: type }));
                        allProjects = [...allProjects, ...projects];
                        resolve();
                    },
                    error: () => resolve()
                });
            });
        }

        // --- LAYERS LOGIC ---
        async function tukarLayer(layerKey) {
            // Update Title
            document.getElementById('current-layer-name').innerText = LAYER_DISPLAY_NAMES[layerKey].toUpperCase();
            
            // Update Buttons State
            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'shadow');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            const activeBtn = document.getElementById(`btn-${layerKey}`);
            if(activeBtn) {
                activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                activeBtn.classList.add('bg-blue-500', 'text-white', 'shadow');
            }

            // Remove old layer
            if (activeGeoJsonLayer) map.removeLayer(activeGeoJsonLayer);

            // Load new layer
            try {
                const res = await fetch(LAYERS[layerKey]);
                const data = await res.json();
                
                activeGeoJsonLayer = L.geoJSON(data, {
                    style: styleFeature,
                    onEachFeature: onEachFeature
                }).addTo(map);

                // Auto plot all markers when layer changes (optional requirement interpretation)
                filterProjek('all'); 
                
            } catch (e) { console.error(e); }
        }

        function styleFeature() {
            return { fillColor: '#3B82F6', weight: 1, opacity: 1, color: 'white', fillOpacity: 0.1 };
        }

        function onEachFeature(feature, layer) {
            // Hover Tooltip logic
            const props = feature.properties;
            // Try standard naming conventions for region name
            const name = props.Name || props.NAME || props.DAERAH || props.PARLIMEN || props.DUN || "Kawasan";
            
            layer.bindTooltip(name, {
                permanent: false,
                direction: "center",
                className: "custom-tooltip"
            });

            layer.on({
                mouseover: (e) => {
                    e.target.setStyle({ weight: 3, color: '#fff', fillOpacity: 0.4, fillColor: getRandomColor() });
                },
                mouseout: (e) => {
                    activeGeoJsonLayer.resetStyle(e.target);
                },
                click: (e) => {
                    map.fitBounds(e.target.getBounds());
                }
            });
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for(let i=0; i<6; i++) color += letters[Math.floor(Math.random()*16)];
            return color;
        }

        // --- DASHBOARD & UI UPDATES ---
        function updateUI() {
            const counts = {};
            let total = 0;
            
            // Reset Counts
            Object.keys(SHEETS).forEach(k => counts[k] = 0);
            
            allProjects.forEach(p => {
                if(counts[p.category] !== undefined) counts[p.category]++;
                total++;
            });

            // 1. Update Left Main Card
            document.getElementById('main-total-count').innerText = total;
            document.getElementById('count-all').innerText = total;

            const leftList = document.getElementById('left-category-list');
            const legendList = document.getElementById('map-legend');
            const rightFilters = document.getElementById('right-category-filters');
            
            leftList.innerHTML = '';
            legendList.innerHTML = '';
            
            // Clear right filters except the "All" button
            const allBtn = rightFilters.firstElementChild;
            rightFilters.innerHTML = '';
            rightFilters.appendChild(allBtn);

            Object.keys(SHEETS).forEach(key => {
                const color = CATEGORY_COLORS[key];
                const name = CATEGORY_NAMES[key];
                const count = counts[key];

                // Left Main Card List
                leftList.innerHTML += `
                    <div class="flex justify-between items-center text-sm">
                        <span class="flex items-center text-gray-600"><span class="w-2 h-2 rounded-full mr-2" style="background:${color}"></span>${name}</span>
                        <span class="font-bold text-gray-800">${count}</span>
                    </div>
                `;

                // Legend
                legendList.innerHTML += `
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded border border-white shadow-sm" style="background:${color}"></div>
                        <span class="text-xs text-gray-600 font-medium">${name}</span>
                    </div>
                `;

                // Right Filter Menu
                rightFilters.innerHTML += `
                    <button onclick="filterProjek('${key}')" class="w-full flex items-center justify-between px-3 py-2 rounded-lg bg-white border border-gray-100 hover:bg-gray-50 text-sm font-medium transition text-gray-600 group">
                        <span class="flex items-center"><span class="w-2 h-2 rounded-full mr-2" style="background:${color}"></span>${name}</span>
                        <span class="bg-gray-100 text-gray-500 text-xs px-2 py-0.5 rounded-full group-hover:bg-white">${count}</span>
                    </button>
                `;
            });

            // Initial Status Update
            updateStatusBar(allProjects);
        }

        // --- MARKER LOGIC ---
        function filterProjek(category) {
            markersGroup.clearLayers();
            
            let filtered = (category === 'all') ? allProjects : allProjects.filter(p => p.category === category);
            
            filtered.forEach(plotMarker);
            
            // Update Status Bar based on filtered selection
            updateStatusBar(filtered);

            if(filtered.length > 0) {
                // simple fit bounds logic
                const group = new L.featureGroup(markersGroup.getLayers());
                if(group.getLayers().length > 0) map.fitBounds(group.getBounds());
            }
        }

        function plotMarker(p) {
            // Priority: LATITUDE/LONGITUDE -> Lat/Long
            let lat = parseFloat(p.LATITUDE || p.Latitude || p.Lat || p.lat);
            let lng = parseFloat(p.LONGITUDE || p.Longitude || p.Long || p.lon);

            if (!isNaN(lat) && !isNaN(lng)) {
                const color = CATEGORY_COLORS[p.category];
                const marker = L.circleMarker([lat, lng], {
                    radius: 6,
                    fillColor: color,
                    color: "#fff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                });

                marker.bindPopup(createPopup(p));
                markersGroup.addLayer(marker);
            }
        }

        function createPopup(data) {
            // Main Info
            const name = data['Nama Site'] || data['Name'] || data['NAMA'] || 'Tapak Projek';
            const lat = data.LATITUDE || data.Latitude || '-';
            const lon = data.LONGITUDE || data.Longitude || '-';
            const status = findVal(data, 'Status') || 'Tiada Data';
            const district = findVal(data, 'Daerah') || '-';

            let html = `
                <div class="bg-gradient-to-r from-gray-800 to-gray-700 p-3 text-white">
                    <h3 class="font-bold text-base leading-tight">${name}</h3>
                    <p class="text-[10px] opacity-75 mt-1 uppercase tracking-wide">${data.category ? CATEGORY_NAMES[data.category] : ''}</p>
                </div>
                <div class="p-4 bg-white">
                    <div class="grid grid-cols-2 gap-y-3 gap-x-2 text-xs mb-3 border-b border-gray-100 pb-3">
                        <div><p class="text-gray-400 uppercase text-[10px]">Daerah</p><p class="font-bold text-gray-700">${district}</p></div>
                        <div><p class="text-gray-400 uppercase text-[10px]">Status</p><span class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 font-bold text-[10px]">${status}</span></div>
                        <div class="col-span-2"><p class="text-gray-400 uppercase text-[10px]">Koordinat</p><p class="font-mono text-gray-600 bg-gray-50 px-2 py-1 rounded inline-block">${lat}, ${lon}</p></div>
                    </div>
                    <p class="font-bold text-gray-800 text-xs mb-2">Maklumat Tambahan</p>
                    <div class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto pr-1">
            `;
            
            // Add first 15 cols
            Object.keys(data).slice(0, 15).forEach(k => {
                if(data[k]) html += `<div><p class="text-[9px] text-gray-400 uppercase truncate">${k}</p><p class="text-xs text-gray-700 truncate" title="${data[k]}">${data[k]}</p></div>`;
            });

            html += `</div></div>`;
            return html;
        }

        function findVal(obj, keyPartial) {
            const key = Object.keys(obj).find(k => k.toLowerCase().includes(keyPartial.toLowerCase()));
            return key ? obj[key] : null;
        }

        // --- STATUS BAR LOGIC ---
        function updateStatusBar(data) {
            let total = data.length;
            let completed = 0;
            const statusBreakdown = {};

            data.forEach(d => {
                const s = (findVal(d, 'Status') || 'Unknown').trim();
                statusBreakdown[s] = (statusBreakdown[s] || 0) + 1;
                
                const sLow = s.toLowerCase();
                if(sLow.includes('siap') || sLow.includes('on air') || sLow.includes('operasi')) completed++;
            });

            const percent = total > 0 ? Math.round((completed/total)*100) : 0;
            
            // Update Bar
            const bar = document.getElementById('main-progress-bar');
            document.getElementById('main-progress-text').innerText = `${percent}%`;
            
            // Animation reset
            bar.style.width = '0%';
            setTimeout(() => { bar.style.width = `${percent}%`; }, 100);

            // Update Dropdown List
            const list = document.getElementById('status-breakdown-list');
            list.innerHTML = '';
            Object.entries(statusBreakdown).forEach(([status, count]) => {
                list.innerHTML += `
                    <div onclick="filterByStatus('${status}')" class="flex justify-between items-center p-1 hover:bg-gray-100 rounded cursor-pointer transition">
                        <span class="text-gray-600 font-medium">${status}</span>
                        <span class="font-bold text-gray-800 bg-gray-200 px-2 rounded-full text-xs">${count}</span>
                    </div>
                `;
            });
        }

        function toggleStatusDropdown() {
            const dd = document.getElementById('status-dropdown');
            dd.classList.toggle('hidden');
        }

        function filterByStatus(statusName) {
            markersGroup.clearLayers();
            const filtered = allProjects.filter(d => {
                const s = findVal(d, 'Status') || 'Unknown';
                return s.trim() === statusName;
            });
            filtered.forEach(plotMarker);
            if(filtered.length > 0) {
                 const group = new L.featureGroup(markersGroup.getLayers());
                 map.fitBounds(group.getBounds());
            }
        }

        // --- SEARCH LOGIC (Auto Plot) ---
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if(term.length < 2) return;

            markersGroup.clearLayers();
            const results = allProjects.filter(p => {
                return Object.values(p).some(val => String(val).toLowerCase().includes(term));
            });
            
            results.forEach(plotMarker);
            
            if(results.length > 0) {
                 const group = new L.featureGroup(markersGroup.getLayers());
                 map.fitBounds(group.getBounds());
            }
        });

        // --- REPORT LOGIC ---
        function bukaReportCard() {
            document.getElementById('report-modal').classList.remove('hidden');
            // Recalculate stats for current filtered projects or all? Usually all for reports.
            janaAnalisisReport(); 
        }

        function tutupReportCard() {
            document.getElementById('report-modal').classList.add('hidden');
        }

        function janaAnalisisReport() {
            // ... (Logic similar to before, kept concise here)
            // Recalculate based on 'allProjects'
            let total = allProjects.length, siap = 0, jalan = 0, masalah = 0;
            const catCounts = {};
            const statusOverall = {};
            
            allProjects.forEach(p => {
                catCounts[p.category] = (catCounts[p.category]||0)+1;
                const s = (findVal(p, 'Status')||'').toLowerCase();
                statusOverall[s] = (statusOverall[s]||0)+1;
                if(s.includes('siap') || s.includes('on air')) siap++;
                else if(s.includes('masalah')) masalah++;
                else jalan++;
            });

            document.getElementById('rpt-total').innerText = total;
            document.getElementById('rpt-completed').innerText = siap;
            document.getElementById('rpt-ongoing').innerText = jalan;
            document.getElementById('rpt-issues').innerText = masalah;

            renderChart('chart-pie-cat', 'doughnut', Object.keys(catCounts).map(k=>CATEGORY_NAMES[k]), Object.values(catCounts), Object.keys(catCounts).map(k=>CATEGORY_COLORS[k]));
            renderChart('chart-pie-status', 'pie', Object.keys(statusOverall), Object.values(statusOverall), ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#6B7280']);
            renderChart('chart-bar-status', 'bar', ['Siap', 'Jalan', 'Masalah'], [siap, jalan, masalah], ['#10B981', '#F59E0B', '#EF4444']);
        }

        function renderChart(id, type, labels, data, colors) {
            const ctx = document.getElementById(id).getContext('2d');
            if(chartInstances[id]) chartInstances[id].destroy();
            chartInstances[id] = new Chart(ctx, {
                type: type,
                data: { labels, datasets: [{ data, backgroundColor: colors }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }}}
            });
        }
        
        function muatTurunPDF() {
            html2pdf().set({ margin:0.5, filename:'Laporan_GIS.pdf', html2canvas:{scale:2} }).from(document.getElementById('report-content')).save();
        }

    </script>
</body>
</html>
