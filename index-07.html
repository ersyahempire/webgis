<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Web GIS Projek Sabah v5 + Report Kad ECharts</title>
  
  <!-- FontAwesome & Google Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Apache ECharts, html2canvas, jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ----- GLOBAL VARS & RESET ----- */
:root {
  --primary: #4F46E5;
  --primary-dark: #4338ca;
  --glass-bg: rgba(255, 255, 255, 0.45);
  --glass-border: rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
  --blur: 12px;
  --text-main: #1f2937;
  --text-sub: #6b7280;
  --radius: 16px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  font-family: 'Plus Jakarta Sans', sans-serif;
  height: 100vh; width: 100vw;
  overflow: hidden;
  background: #eef2f5;
  color: var(--text-main);
}

/* ----- MAP CONTAINER ----- */
#map {
  position: absolute; top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 0;
}

/* ----- SEARCH BAR (TOP CENTER) ----- */
.search-container {
  position: absolute;
  top: 20px; left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  width: 90%; max-width: 400px;
  display: flex;
  gap: 10px;
}

.search-box {
  flex: 1;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  padding: 12px 20px;
  border-radius: 50px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex;
  align-items: center;
  transition: var(--transition);
}

.search-box:focus-within { transform: scale(1.02); box-shadow: 0 10px 40px rgba(79, 70, 229, 0.15); border-color: var(--primary); }
.search-box i { color: var(--text-sub); margin-right: 10px; }
.search-box input {
  border: none; background: transparent; width: 100%;
  font-family: inherit; font-size: 15px; color: var(--text-main);
}
.search-box input::placeholder { color: #9ca3af; }

/* ----- FLOATING DASHBOARD (LEFT) ----- */
.panel-toggle {
  position: absolute; top: 20px; left: 20px; z-index: 20;
  background: var(--primary); color: white;
  width: 45px; height: 45px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
  border: none;
  transition: var(--transition);
}
.panel-toggle:hover { transform: translateY(-2px); background: var(--primary-dark); }

.dashboard-panel {
  position: absolute; top: 75px; left: 20px; bottom: 20px;
  width: 320px;
  z-index: 10;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  border-radius: var(--radius);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex; flex-direction: column;
  transform: translateX(0);
  transition: var(--transition);
  opacity: 1;
  overflow: hidden;
}

.dashboard-panel.closed {
  transform: translateX(-120%);
  opacity: 0; pointer-events: none;
}

.panel-header {
  padding: 20px;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0.1));
}
.panel-header h2 { margin: 0; font-size: 18px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }

.panel-content {
  padding: 20px;
  overflow-y: auto;
  scrollbar-width: thin;
}
.panel-content::-webkit-scrollbar { width: 6px; }
.panel-content::-webkit-scrollbar-track { background: transparent; }
.panel-content::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 20px; }

/* Stats Cards */
.main-stat {
  text-align: center; margin-bottom: 20px;
  padding: 15px; border-radius: 12px;
  background: rgba(255,255,255,0.5);
  border: 1px solid rgba(255,255,255,0.6);
}
.main-stat-value { font-size: 36px; font-weight: 800; color: var(--text-main); line-height: 1; }
.main-stat-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); margin-top: 5px; }

.area-badge {
  background: #e0e7ff; color: var(--primary);
  padding: 6px 12px; border-radius: 20px;
  font-size: 13px; font-weight: 600;
  display: inline-block; margin-top: 10px;
}

.grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.mini-stat {
  background: rgba(255,255,255,0.4); padding: 12px; border-radius: 12px;
  text-align: center; border: 1px solid rgba(255,255,255,0.4);
  transition: var(--transition);
  cursor: pointer;
  user-select: none;
}
.mini-stat:hover { background: rgba(255,255,255,0.7); transform: translateY(-2px); }
.mini-stat.selected { 
  background: #fff; 
  border: 2px solid var(--primary); 
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
}

.mini-stat-val { font-size: 20px; font-weight: 700; color: var(--text-main); }
.mini-stat-lbl { font-size: 11px; color: var(--text-sub); }

/* Status List Styles */
.status-section-title { font-size: 13px; font-weight: 700; text-transform: uppercase; color: var(--text-sub); margin: 20px 0 10px 0; }
.status-wrapper { margin-bottom: 12px; }
.status-item { 
  margin-bottom: 0; 
  background: rgba(255,255,255,0.3); 
  padding: 8px 10px; 
  border-radius: 8px; 
  cursor: pointer;
  transition: var(--transition);
  border: 1px solid transparent;
  position: relative;
  z-index: 2;
} 
.status-item:hover { background: rgba(255,255,255,0.6); }
.status-item.selected {
  background: #fff;
  border: 1px solid var(--primary);
  border-bottom: 1px solid rgba(0,0,0,0.05);
  border-radius: 8px 8px 0 0;
  box-shadow: 0 -2px 10px rgba(79, 70, 229, 0.05);
  transform: none;
}
.status-details {
  background: rgba(255,255,255,0.5);
  padding: 12px;
  border-radius: 0 0 8px 8px;
  border: 1px solid rgba(255,255,255,0.6);
  border-top: none;
  display: none;
  animation: slideDown 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  transform-origin: top;
}
.status-details.show { display: block; }

@keyframes slideDown {
  from { opacity: 0; transform: scaleY(0.9); max-height: 0; }
  to { opacity: 1; transform: scaleY(1); max-height: 300px; }
}

.sub-stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 11px; }
.sub-stat-label { color: var(--text-main); font-weight: 500; display: flex; align-items: center; gap: 6px;}
.sub-stat-val { font-weight: 700; color: var(--text-sub); }
.sub-stat-bar-bg { width: 100%; height: 4px; background: rgba(0,0,0,0.05); border-radius: 2px; margin-bottom: 8px; overflow: hidden; }
.sub-stat-bar-fill { height: 100%; border-radius: 2px; }

.status-header { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin-bottom: 6px; font-weight: 600; } 
.status-name { font-weight: 700; }
.status-count { color: var(--text-sub); font-weight: 500; margin-left: 5px; font-size: 12px; }
.status-percent { font-size: 14px; font-weight: 700; } 

.progress-bg { width: 100%; height: 10px; background: rgba(0,0,0,0.1); border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
.progress-fill { height: 100%; background: var(--primary); border-radius: 5px; width: 0%; transition: width 1s cubic-bezier(0.25, 0.46, 0.45, 0.94); }


/* ----- CONTROLS (RIGHT) ----- */
.controls-container {
  position: absolute; top: 80px; right: 20px;
  display: flex; flex-direction: column; gap: 10px;
  z-index: 10;
}

.control-card {
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  padding: 5px;
  border-radius: 12px;
  box-shadow: var(--glass-shadow);
  width: 50px;
  overflow: hidden;
  transition: width 0.3s ease, background 0.3s;
  border: 1px solid var(--glass-border);
  white-space: nowrap;
}

.control-card:hover, .control-card.expanded {
  width: 180px;
  background: rgba(255, 255, 255, 0.55);
}

.control-group-title {
  padding: 10px 15px; font-size: 11px; font-weight: 700; 
  text-transform: uppercase; color: var(--text-sub); letter-spacing: 0.5px;
  display: none;
}
.control-card.expanded .control-group-title { display: block; }

.toggle-btn {
  display: flex; align-items: center;
  width: 100%; padding: 10px;
  background: transparent; border: none; cursor: pointer;
  border-radius: 8px; color: var(--text-sub);
  transition: all 0.2s;
  text-align: left;
}
.toggle-btn i { width: 30px; text-align: center; font-size: 16px; flex-shrink: 0; }
.toggle-btn span { opacity: 0; transition: opacity 0.2s; font-size: 13px; font-weight: 500; }

.control-card:hover .toggle-btn span, .control-card.expanded .toggle-btn span { opacity: 1; }
.control-card:hover .toggle-btn, .control-card.expanded .toggle-btn { padding: 10px 15px; }

.toggle-btn:hover { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
.toggle-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }

/* Legend Mini */
.legend-mini { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); }
.legend-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 12px; color: var(--text-sub); }
.dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

/* ----- REPORT CARD MODAL STYLES (TAILWIND STYLE REFINED) ----- */
.report-modal-overlay {
  position: fixed; inset: 0;
  background: rgba(15, 23, 42, 0.6); /* Slate-900 with opacity */
  backdrop-filter: blur(8px);
  z-index: 2000;
  display: none;
  justify-content: center; align-items: center;
  padding: 20px;
}
.report-modal-overlay.active { display: flex; }

.report-container {
  background: #f8fafc; /* Slate-50 */
  width: 100%; max-width: 1280px;
  height: 95vh;
  border-radius: 20px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  display: flex; flex-direction: column;
  overflow: hidden;
  font-family: 'Plus Jakarta Sans', sans-serif;
  border: 1px solid rgba(255,255,255,0.8);
}

/* Header */
.report-header {
  background: white;
  color: #1e293b; /* Slate-800 */
  padding: 24px 32px;
  border-bottom: 1px solid #e2e8f0;
  display: flex; 
  flex-direction: column;
  position: relative;
}

.report-meta {
  position: absolute; top: 24px; right: 80px;
  text-align: right;
}
.report-date { font-size: 14px; font-weight: 500; color: #64748b; } /* Slate-500 */

.report-title-container {
  text-align: center; width: 100%; margin-top: 8px;
}
.report-title { 
  font-size: 26px; font-weight: 800; color: #0f172a; /* Slate-900 */
  display: inline-flex; align-items: center; gap: 12px; 
  text-transform: uppercase; letter-spacing: -0.5px;
}
.report-title i { color: var(--primary); }

.report-actions {
    position: absolute; top: 24px; right: 24px;
    display: flex; gap: 10px;
}
.btn-close { 
    background: #fee2e2; color: #ef4444; border: none; width: 40px; height: 40px; 
    border-radius: 12px; cursor: pointer; display:flex; align-items:center; justify-content:center;
    transition: 0.2s; font-size: 18px;
}
.btn-close:hover { background: #fecaca; transform: scale(1.05); }

.btn-pdf {
    background: #e0e7ff; color: var(--primary-dark); border: none; 
    padding: 10px 20px; border-radius: 10px; font-weight: 700; font-size: 13px;
    cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s;
    position: absolute; top: 24px; left: 32px; 
    box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.1);
}
.btn-pdf:hover { background: #c7d2fe; transform: translateY(-1px); }

/* Body Area */
.report-body {
  padding: 32px;
  overflow-y: auto;
  flex: 1;
  background: #f1f5f9; /* Slate-100 */
}

/* Report Cards */
.report-section { 
  background: white; 
  border-radius: 16px; 
  padding: 24px; 
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); 
  margin-bottom: 0; 
  border: 1px solid #f1f5f9;
  transition: transform 0.2s;
}
.report-section:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }

.report-section h3 { 
  margin: 0 0 24px 0; font-size: 15px; font-weight: 700; 
  color: #475569; /* Slate-600 */
  text-transform: uppercase; letter-spacing: 0.5px;
  display: flex; align-items: center; gap: 10px;
  padding-bottom: 12px; border-bottom: 1px solid #f1f5f9;
}
.report-section h3 i { color: var(--primary); font-size: 18px; }

/* Grid System */
.report-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 24px; }
.col-span-12 { grid-column: span 12; }
.col-span-8 { grid-column: span 8; }
.col-span-6 { grid-column: span 6; }
.col-span-4 { grid-column: span 4; }

/* Map Capture */
.map-capture-box { 
    width: 100%; height: 350px; background: #e2e8f0; 
    border-radius: 12px; overflow: hidden; position: relative; 
    border: 4px solid white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.map-capture-img { width: 100%; height: 100%; object-fit: cover; }

/* Summary Grid */
.summary-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px; }
.summary-card { 
    background: white; padding: 24px; border-radius: 16px; text-align: center; 
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
    transition: transform 0.2s;
}
.summary-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
.summary-val { font-size: 36px; font-weight: 800; color: #0f172a; line-height: 1; margin-bottom: 8px; }
.summary-lbl { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; letter-spacing: 1px; }

/* Detailed Status List (No Scroll) */
.status-list-container {
    display: flex; flex-direction: column; gap: 12px;
}
.report-section.no-scroll {
    overflow: visible; max-height: none;
}
.report-section .status-item {
    background: white; border: 1px solid #e2e8f0;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
    border-radius: 12px 12px 0 0;
    padding: 12px 16px;
    cursor: default;
}
.report-section .status-header { margin-bottom: 8px; }
.report-section .status-details {
    display: block; 
    background: #f8fafc; border: 1px solid #e2e8f0; border-top: none;
    border-radius: 0 0 12px 12px;
    padding: 16px;
}
.report-section .status-item.selected {
    border-color: #e2e8f0; background: white;
}
.sub-stat-row { font-size: 12px; margin-bottom: 8px; }
.sub-stat-bar-bg { height: 6px; border-radius: 3px; background: #e2e8f0; }
.sub-stat-bar-fill { border-radius: 3px; }

/* Charts */
.chart-wrapper { position: relative; height: 320px; width: 100%; display:block; }

/* Responsive */
@media (max-width: 1200px) {
  .summary-grid { grid-template-columns: repeat(3, 1fr); }
  .col-span-8, .col-span-4 { grid-column: span 12; }
}
@media (max-width: 768px) {
  .col-span-6 { grid-column: span 12; }
  .summary-grid { grid-template-columns: repeat(2, 1fr); }
  .report-meta { position: static; text-align: center; margin-top: 10px; }
  .btn-pdf { position: static; margin-bottom: 10px; justify-content: center; width: 100%; }
  .report-actions { position: absolute; top: 15px; right: 15px; }
}

/* ----- LOADING & INFO ----- */
.loading-overlay {
  position: absolute; inset: 0;
  background: rgba(255,255,255,0.8);
  backdrop-filter: blur(5px);
  z-index: 999;
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  transition: opacity 0.5s;
}
.loading-overlay.hide { opacity: 0; pointer-events: none; }
.spinner {
  width: 40px; height: 40px; border: 4px solid #e0e7ff;
  border-top-color: var(--primary); border-radius: 50%;
  animation: spin 1s linear infinite; margin-bottom: 10px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* InfoWindow Customization */
.gm-style .gm-style-iw-c {
  padding: 0 !important; border-radius: 12px !important;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
}
.gm-style-iw-d { overflow: hidden !important; max-height: 400px !important; }
.info-popup { padding: 0; min-width: 280px; max-width: 320px; }
.info-header { background: var(--primary); color: white; padding: 12px 16px; font-weight: 600; font-size: 14px; }
.info-body { padding: 12px 16px; background: white; max-height: 300px; overflow-y: auto; }
.info-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
.info-label { color: #666; font-weight: 500; min-width: 100px; }
.info-val { color: #111; font-weight: 600; text-align: right; overflow-wrap: break-word; max-width: 180px; }
.section-header { font-size: 11px; font-weight: 700; color: var(--primary); text-transform: uppercase; margin: 12px 0 8px 0; border-bottom: 2px solid #eee; padding-bottom: 4px; }

@media (max-width: 600px) {
  .dashboard-panel { width: calc(100% - 40px); bottom: auto; max-height: 60vh; }
  .controls-container { top: auto; bottom: 80px; right: 20px; }
  .control-card { width: 45px; }
  .control-card:hover, .control-card.expanded { width: 160px; }
  .search-container { width: 75%; }
}
</style>
</head>
<body>

  <!-- Map Background -->
  <div id="map"></div>

  <!-- Loading Screen -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div style="font-weight: 600; color: var(--primary);">Memuatkan Data GIS...</div>
  </div>

  <!-- Top Search Bar -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="search-input" placeholder="Cari tapak, daerah, atau parlimen...">
    </div>
  </div>

  <!-- Sidebar Toggle Button -->
  <button class="panel-toggle" id="sidebar-toggle" onclick="toggleDashboard()">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Floating Dashboard Panel -->
  <div class="dashboard-panel" id="dashboard-panel">
    <div class="panel-header">
      <h2><i class="fas fa-layer-group"></i> Statistik Projek</h2>
    </div>
    
    <div class="panel-content">
      <!-- Main Count -->
      <div class="main-stat">
        <div class="main-stat-value" id="total-projects">0</div>
        <div class="main-stat-label">Jumlah Projek</div>
        <div id="selected-area" class="area-badge">SELURUH SABAH</div>
      </div>

      <!-- Category Grid (With Click Handlers) -->
      <div class="grid-stats">
        <div class="mini-stat" id="stat-card-menara" onclick="handleCategoryClick('TOWER', 'stat-card-menara')">
          <div class="mini-stat-val" id="menara-count" style="color: #FF5722;">0</div>
          <div class="mini-stat-lbl">Menara</div>
        </div>
        <div class="mini-stat" id="stat-card-nadi" onclick="handleCategoryClick('NADI', 'stat-card-nadi')">
          <div class="mini-stat-val" id="nadi-count" style="color: #2196F3;">0</div>
          <div class="mini-stat-lbl">NADI</div>
        </div>
        <div class="mini-stat" id="stat-card-wifi" onclick="handleCategoryClick('BWA', 'stat-card-wifi')">
          <div class="mini-stat-val" id="wifi-count" style="color: #4CAF50;">0</div>
          <div class="mini-stat-lbl">WiFi</div>
        </div>
        <div class="mini-stat" id="stat-card-pop" onclick="handleCategoryClick('POP', 'stat-card-pop')">
          <div class="mini-stat-val" id="pop-count" style="color: #FF9800;">0</div>
          <div class="mini-stat-lbl">POP</div>
        </div>
      </div>

      <!-- Status Progress Bars (Real Data) -->
      <div class="status-section-title">Status Kemajuan</div>
      <div id="status-list">
        <!-- JS will inject status bars here -->
      </div>

      <!-- Mini Legend -->
      <div class="legend-mini">
        <div class="legend-row"><span class="dot" style="background: #FF5722;"></span> Menara Komunikasi</div>
        <div class="legend-row"><span class="dot" style="background: #2196F3;"></span> Pusat NADI</div>
        <div class="legend-row"><span class="dot" style="background: #4CAF50;"></span> WiFi Komuniti</div>
        <div class="legend-row"><span class="dot" style="background: #FF9800;"></span> Point of Presence (POP)</div>
      </div>
    </div>
  </div>

  <!-- Right Side Controls (Expandable Cards) -->
  <div class="controls-container">
    
    <!-- Report Card Button -->
    <div class="control-card" id="report-card-btn">
       <button class="toggle-btn" id="btn-open-report" title="Report Kad">
        <i class="fas fa-file-alt" style="color: #E91E63;"></i> <span>Report Kad</span>
       </button>
    </div>

    <!-- Layer Toggle Group -->
    <div class="control-card" id="layer-card">
      <div class="control-group-title">Sempadan</div>
      <button class="toggle-btn active" id="toggle-daerah" title="Daerah">
        <i class="fas fa-map-marked-alt"></i> <span>Daerah</span>
      </button>
      <button class="toggle-btn" id="toggle-dun" title="DUN">
        <i class="fas fa-landmark"></i> <span>DUN</span>
      </button>
      <button class="toggle-btn" id="toggle-parliament" title="Parlimen">
        <i class="fas fa-building"></i> <span>Parlimen</span>
      </button>
    </div>

    <!-- Category Filter Group -->
    <div class="control-card" id="filter-card">
      <div class="control-group-title">Penapis Data</div>
      <button class="toggle-btn" id="toggle-menara" title="Menara">
        <i class="fas fa-broadcast-tower" style="color: #FF5722;"></i> <span>Menara</span>
      </button>
      <button class="toggle-btn" id="toggle-nadi" title="NADI">
        <i class="fas fa-satellite-dish" style="color: #2196F3;"></i> <span>NADI</span>
      </button>
      <button class="toggle-btn" id="toggle-wifi" title="WiFi">
        <i class="fas fa-wifi" style="color: #4CAF50;"></i> <span>WiFi</span>
      </button>
      <button class="toggle-btn" id="toggle-pop" title="POP">
        <i class="fas fa-globe" style="color: #FF9800;"></i> <span>POP</span>
      </button>
    </div>
  </div>

  <!-- Report Card Modal (ECHARTS VERSION) -->
  <div class="report-modal-overlay" id="report-overlay">
    <div class="report-container" id="report-print-area">
        
        <!-- Header -->
        <div class="report-header">
            <button class="btn-pdf" onclick="downloadPDF()">
                <i class="fas fa-file-pdf"></i> Muat Turun PDF
            </button>
            <div class="report-meta">
                <div class="report-date" id="report-date-text">17 Dis 2025, 3:35PM</div>
            </div>
            <div class="report-actions">
                <button class="btn-close" onclick="closeReportCard()"><i class="fas fa-times"></i></button>
            </div>
            <div class="report-title-container">
                <div class="report-title"><i class="fas fa-file-contract"></i> <span id="report-title-text">Laporan Projek: SABAH</span></div>
            </div>
        </div>

        <div class="report-body">
            
            <!-- Summary Stats (Added Total Project Card Here) -->
            <div class="summary-grid">
                <div class="summary-card" style="border-color: var(--primary);">
                    <div class="summary-val" id="rpt-total" style="color:var(--primary)">0</div>
                    <div class="summary-lbl">Jumlah Projek</div>
                </div>
                <div class="summary-card">
                    <div class="summary-val" id="rpt-menara" style="color:#FF5722">0</div>
                    <div class="summary-lbl">Menara Komunikasi</div>
                </div>
                <div class="summary-card">
                    <div class="summary-val" id="rpt-nadi" style="color:#2196F3">0</div>
                    <div class="summary-lbl">Pusat NADI</div>
                </div>
                <div class="summary-card">
                    <div class="summary-val" id="rpt-bwa" style="color:#4CAF50">0</div>
                    <div class="summary-lbl">WiFi Komuniti</div>
                </div>
                <div class="summary-card">
                    <div class="summary-val" id="rpt-pop" style="color:#FF9800">0</div>
                    <div class="summary-lbl">Point of Presence</div>
                </div>
            </div>

            <div class="report-grid">
                <!-- Map Capture -->
                <div class="report-section col-span-8">
                    <h3><i class="fas fa-map"></i> Peta Lokasi</h3>
                    <div class="map-capture-box" id="map-capture-container">
                        <div style="display:flex; justify-content:center; align-items:center; height:100%; color:#999;">
                             Memproses Peta...
                        </div>
                    </div>
                </div>

                <!-- Full Status Style (Expanded, No Scroll) -->
                <div class="report-section col-span-4 no-scroll">
                    <h3><i class="fas fa-list-ul"></i> Status Kemajuan</h3>
                    <div class="status-list-container" id="report-status-full-list">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Chart 1: Komposisi Kategori (Doughnut Rounded) -->
                <div class="report-section col-span-6">
                    <h3><i class="fas fa-chart-pie"></i> Komposisi Kategori</h3>
                    <div class="chart-wrapper" id="chart-cat-doughnut"></div>
                </div>

                <!-- Chart 2: Status Keseluruhan (Half Doughnut) -->
                <div class="report-section col-span-6">
                    <h3><i class="fas fa-tachometer-alt"></i> Status Keseluruhan</h3>
                    <div class="chart-wrapper" id="chart-status-half"></div>
                </div>
                
                <!-- Chart 3: Carta Status (Nightingale) -->
                <div class="report-section col-span-6">
                    <h3><i class="fas fa-chart-pie"></i> Carta Status</h3>
                    <div class="chart-wrapper" id="chart-status-nightingale"></div>
                </div>

                <!-- Chart 4: Status vs Kategori Projek (Stacked Bar) -->
                <div class="report-section col-span-6">
                    <h3><i class="fas fa-chart-bar"></i> Status VS Kategori Projek</h3>
                    <div class="chart-wrapper" id="chart-cat-status-bar"></div>
                </div>
            </div>

        </div>
    </div>
  </div>
   
  <!-- UI Interactions Script -->
  <script>
    function toggleDashboard() {
      const panel = document.getElementById('dashboard-panel');
      const btn = document.getElementById('sidebar-toggle');
      panel.classList.toggle('closed');
      btn.innerHTML = panel.classList.contains('closed') ? '<i class="fas fa-chart-pie"></i>' : '<i class="fas fa-times"></i>';
    }

    // Auto-expand controls on mouseover
    document.querySelectorAll('.control-card').forEach(card => {
      card.addEventListener('mouseenter', () => card.classList.add('expanded'));
      card.addEventListener('mouseleave', () => card.classList.remove('expanded'));
    });
  </script>

  <!-- Main script -->
<script>
  // ---------- script.js ----------
// ---------- CONFIG ----------
const URLs = {
  district: "district.json",
  dun: "dun.json",
  parliament: "parliament.json"
};

const SHEETS = {
  db_bwa: "1594VRWEs0PF56KXeSPudZTWkbGuS5UZmxXGrKqo4bUU",
  db_pim: "1WyZiw72LOVytssXAuymJS_TIgckLCUqY56pB0QhawZU",
  db_POP: "1JLqLtZPa4Kd6hEbRA2wgMgADX2h2-tdsXnG-YivSgU8",
  tower: "1b0Aipp0MQvP8HWc-z28dugkGn5sWdNAx6ZE5-Mu13-0"
};

const SHEET_TYPE = {
  db_bwa: "BWA",
  db_pim: "NADI",
  db_POP: "POP",
  tower: "TOWER"
};

const TYPE_CFG = {
  BWA: { color: "#4CAF50", icon: "üì∂", label: "WiFi" },
  NADI: { color: "#2196F3", icon: "üì°", label: "NADI" },
  POP: { color: "#FF9800", icon: "üåê", label: "POP" },
  TOWER: { color: "#FF5722", icon: "üóº", label: "Menara" }
};

// ---------- STATE ----------
let map;
let markersBySite = new Map();
let markersList = [];
let allProjects = [];
let areaIndex = new Map();
let dataLayers = { district: null, dun: null, parliament: null };
let currentBoundaryKey = null;
let hoverInfoWindow = null;
let refreshIntervalMs = 60_000;
let batchSize = 300;
let activeFeature = null;
let activeLayer = null;
let searchTerm = "";

// INTERACTION STATE FOR DASHBOARD
let activeDashboardCategory = null; 
let activeStatusFilter = null;      
let currentFilteredData = []; // Store currently visible data for Reporting

// ECHARTS INSTANCES
let chartInstances = {};

// ---------- UTIL HELPER ----------
function showLoading(on) {
  const el = document.getElementById("loading");
  if (!el) return;
  on ? el.classList.remove("hide") : el.classList.add("hide");
}

function escapeHtml(s) {
  return String(s || "").replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
}

function debounce(fn, wait = 250) {
  let t;
  return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); };
}

function normalizeString(str) {
  return String(str || "").trim().toUpperCase();
}

function cleanFloat(val) {
  if (typeof val === 'number') return val;
  if (!val) return 0;
  const str = String(val).replace(/[^0-9.,-]/g, "").replace(',', '.').trim();
  const floatVal = parseFloat(str);
  return isNaN(floatVal) ? 0 : floatVal;
}

function generateStableId(rowObj, type) {
  const name = normalizeString(rowObj.SITE_NAME || "UNKNOWN");
  const district = normalizeString(rowObj.DISTRICT || "SABAH");
  return `${type}_${name.replace(/\s+/g, '_')}_${district.replace(/\s+/g, '_')}`;
}

function extractFeatureName(feature) {
  const props = ["NAME", "name", "DISTRICT", "DAERAH", "DUN", "PARLIAMENT", "PARLIAMEN"];
  let name = "Sabah";
  for (const k of props) {
    try {
      const v = feature.getProperty(k);
      if (v) { name = v; break; }
    } catch (_) { }
  }
  return String(name).trim();
}

function resetAllLayerStyles() {
  Object.keys(dataLayers).forEach(k => {
    const dl = dataLayers[k];
    if (dl) dl.revertStyle();
  });
  activeFeature = null;
  activeLayer = null;
}

function getRandomColor() {
  const letters = '0123456789ABCDEF';
  let color = '#';
  for (let i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

// ---------- DATA PARSING ----------
function parseGviz(text) {
  try {
    const start = text.indexOf('{');
    const end = text.lastIndexOf('}');
    if (start === -1 || end === -1) return null;
    return JSON.parse(text.substring(start, end + 1));
  } catch (e) {
    console.error("parseGviz failed", e);
    return null;
  }
}

async function fetchSheetObjects(sheetId) {
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&tq=`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Sheet fetch ${sheetId} failed (${res.status})`);
  const text = await res.text();
  const json = parseGviz(text);
  if (!json || !json.table) return { rows: [], cols: [] };

  const rawCols = json.table.cols.map(c => (c && c.label) ? c.label.toUpperCase() : "");
  const rows = json.table.rows || [];

  const processedRows = rows.map(r => {
    const obj = {};
    rawCols.forEach((c, i) => obj[c ? c : `COL${i}`] = (r.c && r.c[i] ? r.c[i].v : ""));
    return obj;
  });

  return { rows: processedRows, cols: rawCols.filter(c => c && !c.startsWith("COL")) };
}

function normalizeRows(rows, sheetKey, rawCols) {
  const normalizedKeys = new Set(["SITE_NAME", "SITE NAME", "SITE", "DISTRICT", "DAERAH", "DUN", "PARLIAMENT", "PARLIAMENT_NAME", "LATITUDE", "LAT", "LONGITUDE", "LON", "LNG", "STATUS", "STATUS_1"]);

  const normalized = rows.map((r, i) => {
    const get = k => (r[k] !== undefined ? r[k] : (r[k.toLowerCase()] !== undefined ? r[k.toLowerCase()] : ""));
    const site = get("SITE_NAME") || get("SITE NAME") || get("SITE") || "";
    const district = get("DISTRICT") || get("DAERAH") || "";
    const dun = get("DUN") || "";
    const parliament = get("PARLIAMENT") || get("PARLIAMENT_NAME") || "";

    const lat = cleanFloat(get("LATITUDE") || get("LAT") || get("LATITUDE_DEC"));
    const lng = cleanFloat(get("LONGITUDE") || get("LON") || get("LNG"));

    const rawStatus = get("STATUS") || get("STATUS_1") || "Tiada Status";

    const rawDetails = [];
    let count = 0;
    for (let colIndex = 0; colIndex < rawCols.length && count < 15; colIndex++) {
      const key = rawCols[colIndex];
      if (normalizedKeys.has(key)) continue;
      const value = r[key];
      if (value !== null && value !== "" && value !== undefined) {
        rawDetails.push({ label: key, value: String(value).trim() });
        count++;
      }
    }

    const type = SHEET_TYPE[sheetKey] || "UNKNOWN";
    const isValidCoordinate = (lat !== 0 && lng !== 0 && lat > 0 && lng > 100); 

    const rowObj = {
      SITE_NAME: String(site || "N/A").trim(),
      DISTRICT: String(district || "").trim(),
      DUN: String(dun || "").trim(),
      PARLIAMENT: String(parliament || "").trim(),
      LATITUDE: lat,
      LONGITUDE: lng,
      STATUS: String(rawStatus).trim(),
      _sheet: sheetKey,
      _type: type,
      _raw_details: rawDetails,
      _validCoord: isValidCoordinate
    };

    rowObj._id = generateStableId(rowObj, type);

    return rowObj;
  }).filter(o => o.SITE_NAME !== "N/A"); 

  return normalized;
}

function buildAreaIndex() {
  areaIndex.clear();
  allProjects.forEach(p => {
    [p.DISTRICT, p.DUN, p.PARLIAMENT].forEach(k => {
      if (!k) return;
      const key = normalizeString(k);
      if (!areaIndex.has(key)) areaIndex.set(key, new Set());
      areaIndex.get(key).add(p.SITE_NAME);
    });
  });
}

// ---------- MARKERS LOGIC ----------
function createOrUpdateMarker(project) {
  if (!project._validCoord) return null;

  const uniqueKey = project._id;
  const cfg = TYPE_CFG[project._type] || { color: "#333", icon: "üìç" };

  if (markersBySite.has(uniqueKey)) {
    const m = markersBySite.get(uniqueKey);
    m._meta = project; 
    
    const pos = m.getPosition();
    if (!pos || Math.abs(pos.lat() - project.LATITUDE) > 0.0001 || Math.abs(pos.lng() - project.LONGITUDE) > 0.0001) {
        m.setPosition({ lat: project.LATITUDE, lng: project.LONGITUDE });
    }
    return m;
  } else {
    let rawDetailsHtml = project._raw_details.map(detail =>
      `<div class="info-row"><span class="info-label">${escapeHtml(detail.label)}</span><span class="info-val">${escapeHtml(detail.value)}</span></div>`
    ).join('');

    if (rawDetailsHtml) {
      rawDetailsHtml = `<div class="section-header">Maklumat Tambahan</div>` + rawDetailsHtml;
    }

    const marker = new google.maps.Marker({
      position: { lat: project.LATITUDE, lng: project.LONGITUDE },
      map: map,
      title: project.SITE_NAME || "",
      visible: false, // Default hidden
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 6,
        fillColor: cfg.color,
        fillOpacity: 1,
        strokeColor: "#ffffff",
        strokeWeight: 2
      }
    });

    const infowin = new google.maps.InfoWindow({
      content: `
            <div class="info-popup">
              <div class="info-header">${cfg.icon} ${escapeHtml(project.SITE_NAME)}</div>
              <div class="info-body">
                <div class="section-header">Maklumat Utama</div>
                <div class="info-row"><span class="info-label">Kategori</span><span class="info-val">${cfg.label}</span></div>
                <div class="info-row"><span class="info-label">Daerah</span><span class="info-val">${escapeHtml(project.DISTRICT)}</span></div>
                <div class="info-row"><span class="info-label">DUN</span><span class="info-val">${escapeHtml(project.DUN)}</span></div>
                <div class="info-row"><span class="info-label">Parlimen</span><span class="info-val">${escapeHtml(project.PARLIAMENT)}</span></div>
                <div class="info-row"><span class="info-label">Status</span><span class="info-val" style="color:${cfg.color}">${escapeHtml(project.STATUS)}</span></div>
                <div class="info-row"><span class="info-label">Koordinat</span><span class="info-val">${project.LATITUDE.toFixed(4)}, ${project.LONGITUDE.toFixed(4)}</span></div>
                ${rawDetailsHtml} 
              </div>
            </div>
          `
    });

    marker.addListener("click", () => {
      infowin.open(map, marker);
    });

    marker._meta = project;
    markersBySite.set(uniqueKey, marker);
    return marker;
  }
}

function renderMarkersInBatches(projects, onComplete) {
  const total = projects.length;
  let i = 0;
  
  if (total === 0) {
    if (onComplete) onComplete();
    return;
  }

  const runChunk = () => {
    const end = Math.min(i + batchSize, total);
    for (; i < end; i++) {
      createOrUpdateMarker(projects[i]);
    }
    if (i < total) {
      setTimeout(runChunk, 50); 
    } else {
      if (onComplete) onComplete();
    }
  };
  runChunk();
}

// ---------- DASHBOARD INTERACTION HANDLERS ----------
function handleCategoryClick(type, elementId) {
  if (activeDashboardCategory === type) {
    activeDashboardCategory = null;
    document.querySelectorAll('.mini-stat').forEach(el => el.classList.remove('selected'));
  } else {
    activeDashboardCategory = type;
    document.querySelectorAll('.mini-stat').forEach(el => el.classList.remove('selected'));
    document.getElementById(elementId)?.classList.add('selected');
  }
  
  filterAndDisplayMarkers();
}

function handleStatusClick(statusStr) {
  if (activeStatusFilter === statusStr) {
    activeStatusFilter = null;
  } else {
    activeStatusFilter = statusStr;
  }
  filterAndDisplayMarkers();
}

// ---------- FILTERING LOGIC ----------
function filterAndDisplayMarkers() {
  const menaraToggle = document.getElementById("toggle-menara")?.classList.contains("active");
  const nadiToggle = document.getElementById("toggle-nadi")?.classList.contains("active");
  const popToggle = document.getElementById("toggle-pop")?.classList.contains("active");
  const wifiToggle = document.getElementById("toggle-wifi")?.classList.contains("active");

  let filteredList = allProjects;

  if (activeFeature && currentBoundaryKey) {
    const areaNameRaw = extractFeatureName(activeFeature);
    const areaName = normalizeString(areaNameRaw); 

    filteredList = allProjects.filter(p => {
      if (currentBoundaryKey === 'district') return normalizeString(p.DISTRICT) === areaName;
      if (currentBoundaryKey === 'dun') return normalizeString(p.DUN) === areaName;
      if (currentBoundaryKey === 'parliament') return normalizeString(p.PARLIAMENT) === areaName;
      return false;
    });
  }

  if (searchTerm && searchTerm.length > 0) {
    const term = searchTerm.toLowerCase();
    if (!searchTerm.match(/^([-+]?[\d\.]+)[,\s]+([-+]?[\d\.]+)$/)) {
        filteredList = filteredList.filter(p =>
        (p.SITE_NAME && p.SITE_NAME.toLowerCase().includes(term)) ||
        (p.DISTRICT && p.DISTRICT.toLowerCase().includes(term)) ||
        (p.PARLIAMENT && p.PARLIAMENT.toLowerCase().includes(term))
        );
    }
  }

  currentFilteredData = filteredList;

  if (activeDashboardCategory) {
      filteredList = filteredList.filter(p => p._type === activeDashboardCategory);
  }

  updateDashboard(filteredList); 

  let mapDisplayList = filteredList;
  if (activeStatusFilter) {
    mapDisplayList = filteredList.filter(p => String(p.STATUS || "").trim() === activeStatusFilter);
  }

  const visibleLocationIds = new Set(mapDisplayList.map(p => p._id));

  markersList.forEach(m => {
    if(!m) return;
    const meta = m._meta;
    const type = meta._type;

    let isCategoryAllowed = false;
    if (activeDashboardCategory) {
      isCategoryAllowed = (type === activeDashboardCategory);
    } else {
      if (type === "TOWER") isCategoryAllowed = menaraToggle;
      else if (type === "BWA") isCategoryAllowed = wifiToggle;
      else if (type === "NADI") isCategoryAllowed = nadiToggle;
      else if (type === "POP") isCategoryAllowed = popToggle;
    }

    const shouldShow = visibleLocationIds.has(meta._id) && isCategoryAllowed && meta._validCoord;
    m.setVisible(shouldShow);
  });
}

const updateDashboard = debounce(function (list) {
  const displayList = list || [];
  const totalEl = document.getElementById("total-projects");
  if(totalEl) animateValue("total-projects", parseInt(totalEl.innerText) || 0, displayList.length, 500);

  const counts = { menara: 0, nadi: 0, wifi: 0, pop: 0 };
  const statusBreakdown = {};

  displayList.forEach(p => {
    if (p._type === "TOWER") counts.menara++;
    if (p._type === "BWA") counts.wifi++;
    if (p._type === "NADI") counts.nadi++;
    if (p._type === "POP") counts.pop++;

    const s = String(p.STATUS || "Tidak Dinyatakan").trim();
    if (!statusBreakdown[s]) {
      statusBreakdown[s] = { total: 0, types: {} };
    }
    statusBreakdown[s].total++;
    if (!statusBreakdown[s].types[p._type]) {
      statusBreakdown[s].types[p._type] = 0;
    }
    statusBreakdown[s].types[p._type]++;
  });

  const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
  setTxt("menara-count", counts.menara);
  setTxt("nadi-count", counts.nadi);
  setTxt("wifi-count", counts.wifi);
  setTxt("pop-count", counts.pop);

  // Helper to generate status list HTML
  const generateStatusHTML = (containerId, isReport = false) => {
    const statusEl = document.getElementById(containerId);
    if(!statusEl) return;
    statusEl.innerHTML = "";
    
    const sortedStatuses = Object.entries(statusBreakdown).sort(([, a], [, b]) => b.total - a.total);
    const totalProjects = displayList.length;

    sortedStatuses.forEach(([statusName, data]) => {
      const count = data.total;
      const percent = totalProjects > 0 ? Math.round((count / totalProjects) * 100) : 0;
      
      let endColor = "#4F46E5"; 
      let startColor = "#818cf8";
      const statusUpper = statusName.toUpperCase();
      
      if (statusUpper.match(/SIAP|SELESAI|COMPLETE|OPERASI/)) { endColor = "#4CAF50"; startColor = "#81c784"; }
      else if (statusUpper.match(/BINA|IMPLEMENTASI|PROGRESS/)) { endColor = "#2196F3"; startColor = "#64b5f6"; }
      else if (statusUpper.match(/TANGGUH|BATAL|CANCEL/)) { endColor = "#F44336"; startColor = "#e57373"; }
      else if (statusUpper.match(/RANCANG|BARU|PLAN/)) { endColor = "#FF9800"; startColor = "#ffb74d"; }

      const isSelected = (activeStatusFilter === statusName) && !isReport;
      const selectedClass = isSelected ? "selected" : "";
      
      let detailsHtml = '';
      const sortedTypes = Object.entries(data.types).sort(([, a], [, b]) => b - a);
      
      sortedTypes.forEach(([typeKey, typeCount]) => {
        const typeCfg = TYPE_CFG[typeKey] || { label: typeKey, color: "#666" };
        const typePercent = count > 0 ? Math.round((typeCount / count) * 100) : 0;
        detailsHtml += `
          <div class="sub-stat-row">
             <span class="sub-stat-label" style="color: ${typeCfg.color}">${typeCfg.label}</span>
             <span class="sub-stat-val">${typeCount} (${typePercent}%)</span>
          </div>
          <div class="sub-stat-bar-bg">
             <div class="sub-stat-bar-fill" style="width: ${typePercent}%; background-color: ${typeCfg.color}; opacity: 0.7;"></div>
          </div>
        `;
      });

      const clickAttr = isReport ? '' : `onclick="handleStatusClick('${escapeHtml(statusName)}')"`;
      const showDetailsClass = (isSelected || isReport) ? 'show' : '';

      const itemContainer = document.createElement("div");
      itemContainer.className = "status-wrapper";
      itemContainer.innerHTML = `
            <div class="status-item ${selectedClass}" ${clickAttr}>
              <div class="status-header">
                <span class="status-name">${escapeHtml(statusName)}</span>
                <span class="status-percent" style="color: ${endColor};">${count} (${percent}%)</span>
              </div>
              <div class="progress-bg">
                <div class="progress-fill" style="width: ${percent}%; background: linear-gradient(90deg, ${startColor}, ${endColor});"></div>
              </div>
            </div>
            <div class="status-details ${showDetailsClass}">
               ${detailsHtml}
            </div>
          `;
      statusEl.appendChild(itemContainer);
    });
  };

  // Generate for Sidebar
  generateStatusHTML("status-list", false);
  
  // Also store data for report use
  window.lastDashboardStatusBreakdown = statusBreakdown;

}, 200);

function animateValue(id, start, end, duration) {
  if (start === end) return;
  const range = end - start;
  let current = start;
  const increment = end > start ? 1 : -1;
  const stepTime = Math.abs(Math.floor(duration / range));
  const obj = document.getElementById(id);
  if (!obj) return;
  
  const timer = setInterval(() => {
    current += increment;
    obj.innerHTML = current;
    if (current == end) clearInterval(timer);
  }, Math.max(stepTime, 10));
}

// ---------- REPORT CARD LOGIC (UPDATED WITH ECHARTS) ----------
function generateReport() {
    // 1. Data & Title
    const data = currentFilteredData || allProjects;
    const title = document.getElementById("selected-area").textContent;
    document.getElementById("report-title-text").textContent = "Laporan Projek: " + title;

    // 2. Date
    const now = new Date();
    const dateStr = now.toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric' });
    const timeStr = now.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });
    document.getElementById("report-date-text").textContent = `${dateStr}, ${timeStr}`;

    // 3. Stats Calculation
    let counts = { TOWER: 0, NADI: 0, BWA: 0, POP: 0 };
    let statusBreakdown = {};
    let completedCount = 0;
    
    // Structure for Bar Chart (Status vs Category)
    // Map: Status -> { TOWER: 0, NADI: 0 ... }
    let catStatusMap = {}; 

    data.forEach(p => {
        if(counts[p._type] !== undefined) counts[p._type]++;
        
        const s = String(p.STATUS || "N/A").trim();
        const sUpper = s.toUpperCase();
        
        // Breakdown for Status List
        if (!statusBreakdown[s]) { statusBreakdown[s] = { total: 0, types: {} }; }
        statusBreakdown[s].total++;
        if (!statusBreakdown[s].types[p._type]) { statusBreakdown[s].types[p._type] = 0; }
        statusBreakdown[s].types[p._type]++;

        // Completed Check
        if(sUpper.includes("SIAP") || sUpper.includes("OPERASI")) completedCount++;

        // Breakdown for Bar Chart
        if (!catStatusMap[s]) catStatusMap[s] = { TOWER: 0, NADI: 0, BWA: 0, POP: 0 };
        if (catStatusMap[s][p._type] !== undefined) catStatusMap[s][p._type]++;
    });

    const totalProjects = data.length;

    // 4. Update Header Stats
    // document.getElementById("report-total-display").textContent = "JUMLAH PROJEK: " + totalProjects; // Removed as requested
    
    // Update Grid Stats including Total
    document.getElementById("rpt-total").textContent = totalProjects;
    document.getElementById("rpt-menara").textContent = counts.TOWER;
    document.getElementById("rpt-nadi").textContent = counts.NADI;
    document.getElementById("rpt-bwa").textContent = counts.BWA;
    document.getElementById("rpt-pop").textContent = counts.POP;

    // 5. Generate Full Status List in Report (Similar to Dashboard)
    const statusReportEl = document.getElementById("report-status-full-list");
    statusReportEl.innerHTML = "";
    
    const sortedStatuses = Object.entries(statusBreakdown).sort(([,a], [,b]) => b.total - a.total);
    
    sortedStatuses.forEach(([statusName, statData]) => {
        const statTotal = statData.total;
        const statPercent = totalProjects > 0 ? Math.round((statTotal / totalProjects) * 100) : 0;
        
        let endColor = "#4F46E5"; let startColor = "#818cf8";
        const statusUpper = statusName.toUpperCase();
        if (statusUpper.match(/SIAP|SELESAI|OPERASI/)) { endColor = "#4CAF50"; startColor = "#81c784"; }
        else if (statusUpper.match(/BINA|IMPLEMENTASI/)) { endColor = "#2196F3"; startColor = "#64b5f6"; }
        else if (statusUpper.match(/TANGGUH|BATAL/)) { endColor = "#F44336"; startColor = "#e57373"; }
        else if (statusUpper.match(/RANCANG|BARU/)) { endColor = "#FF9800"; startColor = "#ffb74d"; }

        // Sub Items
        let detailsHtml = '';
        const sortedTypes = Object.entries(statData.types).sort(([,a], [,b]) => b - a);
        sortedTypes.forEach(([typeKey, typeCount]) => {
            const typeLabel = TYPE_CFG[typeKey]?.label || typeKey;
            const typeColor = TYPE_CFG[typeKey]?.color || "#666";
            const typePercent = statTotal > 0 ? Math.round((typeCount / statTotal) * 100) : 0;
            
            detailsHtml += `
            <div class="sub-stat-row">
                <span class="sub-stat-label" style="color: ${typeColor}">${typeLabel}</span>
                <span class="sub-stat-val">${typeCount} (${typePercent}%)</span>
            </div>
            <div class="sub-stat-bar-bg">
                <div class="sub-stat-bar-fill" style="width: ${typePercent}%; background-color: ${typeColor}; opacity: 0.7;"></div>
            </div>`;
        });

        const html = `
            <div class="status-item selected">
              <div class="status-header">
                <span class="status-name">${escapeHtml(statusName)}</span>
                <span class="status-percent" style="color: ${endColor};">${statTotal} (${statPercent}%)</span>
              </div>
              <div class="progress-bg">
                <div class="progress-fill" style="width: ${statPercent}%; background: linear-gradient(90deg, ${startColor}, ${endColor});"></div>
              </div>
            </div>
            <div class="status-details show">
               ${detailsHtml}
            </div>
        `;
        const div = document.createElement("div");
        div.className = "status-wrapper";
        div.innerHTML = html;
        statusReportEl.appendChild(div);
    });


    // 6. Generate ECharts
    setTimeout(() => {
        renderECharts(counts, statusBreakdown, catStatusMap, totalProjects, completedCount);
    }, 100);

    // 7. Map Capture
    captureMapForReport();

    // 8. Show Modal
    document.getElementById("report-overlay").classList.add("active");
}

function renderECharts(counts, statusBreakdown, catStatusMap, total, completed) {
    const initChart = (id) => {
        const dom = document.getElementById(id);
        if (chartInstances[id]) chartInstances[id].dispose();
        chartInstances[id] = echarts.init(dom);
        return chartInstances[id];
    };

    // --- CHART 1: Komposisi Kategori (Doughnut Rounded) ---
    const chartCat = initChart('chart-cat-doughnut');
    chartCat.setOption({
        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
        legend: { bottom: '0', left: 'center' },
        series: [{
            name: 'Kategori',
            type: 'pie',
            radius: ['45%', '75%'],
            itemStyle: {
                borderRadius: 8,
                borderColor: '#fff',
                borderWidth: 2
            },
            label: {
                show: true,
                formatter: '{b}\n{c} ({d}%)',
                fontWeight: 'bold'
            },
            data: [
                { value: counts.TOWER, name: 'Menara', itemStyle: { color: '#FF5722' } },
                { value: counts.NADI, name: 'NADI', itemStyle: { color: '#2196F3' } },
                { value: counts.BWA, name: 'WiFi', itemStyle: { color: '#4CAF50' } },
                { value: counts.POP, name: 'POP', itemStyle: { color: '#FF9800' } }
            ]
        }]
    });

    // --- CHART 2: Status Keseluruhan (Half Doughnut - Fixed Crop) ---
    const chartStatusHalf = initChart('chart-status-half');
    const notCompleted = total - completed;
    const completedPercent = total > 0 ? ((completed/total)*100).toFixed(1) : 0;
    
    chartStatusHalf.setOption({
        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
        legend: { bottom: '0', left: 'center' },
        series: [{
            type: 'pie',
            radius: ['60%', '100%'], // Slightly larger radius
            center: ['50%', '75%'],  // Moved center down to avoid cropping top
            startAngle: 180,
            endAngle: 360,
            label: {
                show: true,
                formatter: '{b}\n{c}',
                position: 'inside',
                color: '#fff',
                fontWeight: 'bold'
            },
            data: [
                { value: completed, name: 'Siap Operasi', itemStyle: { color: '#4CAF50' } },
                { value: notCompleted, name: 'Lain-lain', itemStyle: { color: '#E0E0E0', opacity: 0.5 } },
            ]
        },
        { // Text in middle
            type: 'gauge',
            radius: '100%',
            center: ['50%', '75%'],
            startAngle: 180,
            endAngle: 0,
            min: 0, max: 100,
            splitNumber: 1,
            axisLine: { show: false },
            axisTick: { show: false },
            splitLine: { show: false },
            axisLabel: { show: false },
            pointer: { show: false },
            detail: { 
                offsetCenter: [0, -30], 
                formatter: `{value}%\nSIAP`,
                fontSize: 22,
                fontWeight: '800',
                color: '#4CAF50'
            },
            data: [{ value: completedPercent }]
        }]
    });


    // --- CHART 3: Carta Status (Nightingale Chart) ---
    const chartStatusNight = initChart('chart-status-nightingale');
    const statusDataForPie = Object.keys(statusBreakdown).map(k => {
        return { value: statusBreakdown[k].total, name: k };
    }).sort((a,b) => b.value - a.value);

    chartStatusNight.setOption({
        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
        legend: { show: false },
        series: [{
            name: 'Status',
            type: 'pie',
            radius: [20, 110],
            center: ['50%', '50%'],
            roseType: 'area',
            itemStyle: { borderRadius: 6 },
            label: {
                show: true,
                formatter: '{b}\n{c}'
            },
            data: statusDataForPie
        }]
    });


    // --- CHART 4: Status VS Kategori Projek (Stacked Bar) ---
    const chartCatStatus = initChart('chart-cat-status-bar');
    
    // Axis X/Y: Status
    // Series: Categories (Stacked)
    // Structure: ['Status', 'Menara', 'NADI', 'WiFi', 'POP']
    const statusKeys = Object.keys(catStatusMap);
    const source = [['Status', 'Menara', 'NADI', 'WiFi', 'POP']];
    
    statusKeys.forEach(s => {
        const d = catStatusMap[s];
        source.push([s, d.TOWER, d.NADI, d.BWA, d.POP]);
    });

    chartCatStatus.setOption({
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        legend: { bottom: 0 },
        grid: { left: '3%', right: '4%', bottom: '15%', top: '10%', containLabel: true },
        dataset: { source: source },
        xAxis: { type: 'category', axisLabel: { interval: 0, rotate: 15, fontSize: 11, fontWeight:'bold' } },
        yAxis: { type: 'value' },
        series: [
            { type: 'bar', stack: 'total', itemStyle: { color: '#FF5722' }, label: {show: false} },
            { type: 'bar', stack: 'total', itemStyle: { color: '#2196F3' }, label: {show: false} },
            { type: 'bar', stack: 'total', itemStyle: { color: '#4CAF50' }, label: {show: false} },
            { type: 'bar', stack: 'total', itemStyle: { color: '#FF9800' }, label: {show: false} }
        ]
    });
    
    // Resize observer to handle responsiveness within modal
    new ResizeObserver(() => {
        chartCat.resize();
        chartStatusHalf.resize();
        chartStatusNight.resize();
        chartCatStatus.resize();
    }).observe(document.querySelector('.report-grid'));
}

function captureMapForReport() {
    const mapEl = document.getElementById("map");
    const container = document.getElementById("map-capture-container");
    container.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#999;">Memproses Peta...</div>';

    html2canvas(document.body, { 
        allowTaint: true,
        useCORS: true,
        x: mapEl.getBoundingClientRect().left,
        y: mapEl.getBoundingClientRect().top,
        width: mapEl.offsetWidth,
        height: mapEl.offsetHeight,
        ignoreElements: (el) => {
             return el.classList.contains('dashboard-panel') || 
                    el.classList.contains('controls-container') ||
                    el.classList.contains('search-container') ||
                    el.classList.contains('report-modal-overlay');
        }
    }).then(canvas => {
        container.innerHTML = "";
        const img = document.createElement("img");
        img.src = canvas.toDataURL("image/png");
        img.className = "map-capture-img";
        container.appendChild(img);
    }).catch(err => {
        console.error("Map capture fail", err);
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#red; font-size:12px;">Gagal menangkap peta (Isu Keselamatan Browser/CORS).<br>Sila guna screenshot manual untuk peta.</div>';
    });
}

function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const element = document.getElementById('report-print-area');
    
    // Hide buttons for capture
    const btns = element.querySelectorAll('button');
    btns.forEach(b => b.style.display = 'none');

    // Ensure ECharts are rendered as images or canvas correctly
    html2canvas(element, { scale: 1.5 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210; 
        const pageHeight = 295; 
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          doc.addPage();
          doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        doc.save('Laporan_Projek_Sabah_ECharts.pdf');

        // Restore buttons
        btns.forEach(b => b.style.display = '');
    });
}

function closeReportCard() {
    document.getElementById("report-overlay").classList.remove("active");
}

// ---------- INITIALIZATION ----------
async function loadAllSheetsAndNormalize() {
  const entries = Object.entries(SHEETS);
  const promises = entries.map(([k, id]) => fetchSheetObjectsSafe(k, id));
  const results = await Promise.all(promises);
  const combined = results.flat();
  allProjects = combined;
  buildAreaIndex();
  return combined;
}

async function fetchSheetObjectsSafe(sheetKey, id) {
  try {
    const data = await fetchSheetObjects(id);
    return normalizeRows(data.rows, sheetKey, data.cols);
  } catch (e) {
    console.warn("sheet load fail", sheetKey, e);
    return [];
  }
}

async function loadGeoJsonLayer(key, url, baseStyle = {}) {
  try {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error("geojson fetch failed " + url);
    const json = await resp.json();

    const layer = new google.maps.Data({ map: null });
    layer.addGeoJson(json);

    layer._baseStyle = {
      strokeWeight: baseStyle.strokeWeight || 1,
      strokeColor: baseStyle.strokeColor || "#666",
      fillOpacity: 0.05,
      fillColor: (baseStyle.fillColor || "#FFF")
    };
    layer.setStyle(feature => layer._baseStyle);

    layer.addListener("mouseover", e => {
      if (!layer.getMap()) return;
      if (activeFeature === e.feature) return;
      
      const randomColor = getRandomColor();
      e.feature.setProperty('_themeColor', randomColor);
      
      layer.overrideStyle(e.feature, { 
          strokeWeight: 2, 
          strokeColor: randomColor, 
          fillOpacity: 0.3, 
          fillColor: randomColor 
      });
      
      if (!hoverInfoWindow) hoverInfoWindow = new google.maps.InfoWindow();
      hoverInfoWindow.setContent(`<div style="padding:8px 12px; font-weight:600; color:${randomColor}; text-shadow: 0px 0px 1px #000;">${escapeHtml(extractFeatureName(e.feature))}</div>`);
      hoverInfoWindow.setPosition(e.latLng);
      hoverInfoWindow.open(map);
    });

    layer.addListener("mouseout", e => {
      if (activeFeature !== e.feature) layer.revertStyle(e.feature);
      if (hoverInfoWindow) hoverInfoWindow.close();
    });

    layer.addListener("click", e => {
      handleFeatureClick(key, e.feature);
    });

    dataLayers[key] = layer;
    return layer;
  } catch (e) {
    console.warn("loadGeoJsonLayer error", key, e);
    return null;
  }
}

function handleFeatureClick(key, feature) {
  const layerObj = dataLayers[key];
  if (!layerObj) return;

  const featureName = extractFeatureName(feature);
  document.getElementById("selected-area").textContent = featureName;

  toggleBoundaryLayerVisibility(key);
  resetAllLayerStyles();
  
  const themeColor = feature.getProperty('_themeColor') || "#4338ca";
  
  layerObj.overrideStyle(feature, { 
      strokeWeight: 2, 
      strokeColor: themeColor, 
      fillOpacity: 0.5,
      fillColor: themeColor 
  });

  activeFeature = feature;
  activeLayer = layerObj;
  currentBoundaryKey = key;

  filterAndDisplayMarkers();
  
  // NOTE: generateReport() removed from here so report card doesn't open automatically
}

function toggleBoundaryLayerVisibility(key) {
  Object.keys(dataLayers).forEach(k => {
    const dl = dataLayers[k];
    if (dl) dl.setMap(k === key ? map : null);
  });
  updateToggleButtonsUI(key);
}

function updateToggleButtonsUI(activeKey) {
  const mapping = { district: "toggle-daerah", dun: "toggle-dun", parliament: "toggle-parliament" };
  Object.keys(mapping).forEach(k => {
    const btn = document.getElementById(mapping[k]);
    if (btn) activeKey === k ? btn.classList.add("active") : btn.classList.remove("active");
  });
}

function setupToggles() {
  ["menara", "nadi", "pop", "wifi"].forEach(cat => {
    document.getElementById(`toggle-${cat}`)?.addEventListener("click", function () {
      this.classList.toggle("active");
      
      activeDashboardCategory = null;
      document.querySelectorAll('.mini-stat').forEach(el => el.classList.remove('selected'));
      
      filterAndDisplayMarkers();
    });
  });

  const boundaries = [
    { id: "toggle-daerah", key: "district" },
    { id: "toggle-dun", key: "dun" },
    { id: "toggle-parliament", key: "parliament" }
  ];

  boundaries.forEach(b => {
    document.getElementById(b.id)?.addEventListener("click", function () {
      if (this.classList.contains('active') && currentBoundaryKey === b.key) {
        this.classList.remove('active');
        dataLayers[b.key].setMap(null);
        currentBoundaryKey = null;
        activeFeature = null;
        document.getElementById("selected-area").textContent = "SELURUH SABAH";
      } else {
        toggleBoundaryLayerVisibility(b.key);
        document.getElementById("selected-area").textContent = "SABAH (" + b.key.toUpperCase() + ")";
        currentBoundaryKey = b.key; 
      }
      filterAndDisplayMarkers();
    });
  });

  document.getElementById("search-input")?.addEventListener("input", (e) => {
    searchTerm = e.target.value;
    
    const coordMatch = searchTerm.match(/^([-+]?[\d\.]+)[,\s]+([-+]?[\d\.]+)$/);
    if (coordMatch) {
        const lat = parseFloat(coordMatch[1]);
        const lng = parseFloat(coordMatch[2]);
        if (!isNaN(lat) && !isNaN(lng)) {
            map.panTo({lat, lng});
            map.setZoom(14);
        }
    } else {
        filterAndDisplayMarkers();
    }
  });

  document.getElementById("btn-open-report")?.addEventListener("click", generateReport);
}

async function autoRefreshLoop() {
  try {
    const newProjects = await loadAllSheetsAndNormalize();
    newProjects.forEach(np => createOrUpdateMarker(np));
    
    markersList = Array.from(markersBySite.values());
    allProjects = newProjects;
    
    filterAndDisplayMarkers();
  } catch (e) {
    console.warn("autoRefreshLoop failed", e);
  }
}

// ---------- MAIN INIT ----------
async function initMap() {
  const mapDiv = document.getElementById("map");
  if (!mapDiv) return;

  const silverStyle = [
    { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
    { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
    { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
    { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] },
    { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
    { featureType: "water", elementType: "geometry", stylers: [{ color: "#c9c9c9" }] },
    { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] }
  ];

  map = new google.maps.Map(mapDiv, {
    center: { lat: 5.9804, lng: 116.0735 },
    zoom: 8,
    mapTypeId: "satellite",
    styles: silverStyle,
    disableDefaultUI: false,
    mapTypeControl: true,
    mapTypeControlOptions: {
        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
        position: google.maps.ControlPosition.TOP_RIGHT
    },
    zoomControl: true,
    zoomControlOptions: {
        position: google.maps.ControlPosition.RIGHT_BOTTOM
    },
    streetViewControl: false,
    fullscreenControl: false
  });

  showLoading(true);

  try {
    const projects = await loadAllSheetsAndNormalize();
    
    renderMarkersInBatches(projects, () => {
      markersList = Array.from(markersBySite.values());
      filterAndDisplayMarkers();
    });

    const pDistrict = loadGeoJsonLayer("district", URLs.district).catch(e => null);
    const pDun = loadGeoJsonLayer("dun", URLs.dun).catch(e => null);
    const pPar = loadGeoJsonLayer("parliament", URLs.parliament).catch(e => null);

    google.maps.event.addListenerOnce(map, "idle", async () => {
      const ld = await pDistrict;
      await pDun; 
      await pPar;

      if (ld) {
        dataLayers['district'].setMap(map);
        currentBoundaryKey = 'district';
      }
      
      setupToggles();
      filterAndDisplayMarkers(); 
    });

    setInterval(() => autoRefreshLoop(), refreshIntervalMs);

  } catch (e) {
    console.error("Init Error", e);
    alert("Ralat sambungan data. Sila refresh.");
  } finally {
    showLoading(false);
  }
}

window.initMap = initMap;
// ---------- END OF SCRIPT ----------
</script>  
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRKvwm2qw29P6nRe6AFk0UMlSv356qMI0&callback=initMap" async defer></script>
    
</body>
</html>
