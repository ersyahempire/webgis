<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Web GIS Projek Sabah v6 + Advanced Analytics</title>
  
  <!-- FontAwesome & Google Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Apache ECharts, html2canvas, jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ----- GLOBAL VARS & RESET ----- */
:root {
  --primary: #4F46E5;
  --primary-dark: #4338ca;
  --glass-bg: rgba(255, 255, 255, 0.45);
  --glass-border: rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
  --blur: 12px;
  --text-main: #1f2937;
  --text-sub: #6b7280;
  --bg-color: #f1f5f9;
  --card-bg: #ffffff;
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  font-family: 'Plus Jakarta Sans', sans-serif;
  height: 100vh; width: 100vw;
  overflow: hidden;
  background: #eef2f5;
  color: var(--text-main);
}

/* ----- MAP CONTAINER ----- */
#map {
  position: absolute; top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 0;
}

/* ----- SEARCH BAR (TOP CENTER) ----- */
.search-container {
  position: absolute;
  top: 20px; left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  width: 90%; max-width: 400px;
  display: flex;
  gap: 10px;
}

.search-box {
  flex: 1;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  padding: 12px 20px;
  border-radius: 50px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex;
  align-items: center;
  transition: all 0.3s;
}

.search-box:focus-within { transform: scale(1.02); box-shadow: 0 10px 40px rgba(79, 70, 229, 0.15); border-color: var(--primary); }
.search-box i { color: var(--text-sub); margin-right: 10px; }
.search-box input {
  border: none; background: transparent; width: 100%;
  font-family: inherit; font-size: 15px; color: var(--text-main);
}

/* ----- FLOATING DASHBOARD (LEFT) ----- */
.panel-toggle {
  position: absolute; top: 20px; left: 20px; z-index: 20;
  background: var(--primary); color: white;
  width: 45px; height: 45px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
  border: none;
  transition: all 0.3s;
}
.panel-toggle:hover { transform: translateY(-2px); background: var(--primary-dark); }

.dashboard-panel {
  position: absolute; top: 75px; left: 20px; bottom: 20px;
  width: 320px;
  z-index: 10;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  border-radius: 16px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex; flex-direction: column;
  transform: translateX(0);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
}

.dashboard-panel.closed { transform: translateX(-120%); opacity: 0; pointer-events: none; }

.panel-header {
  padding: 20px;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0.1));
}
.panel-header h2 { margin: 0; font-size: 18px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }

.panel-content {
  padding: 20px;
  overflow-y: auto;
  scrollbar-width: thin;
}

/* Stats Cards */
.main-stat {
  text-align: center; margin-bottom: 20px;
  padding: 15px; border-radius: 12px;
  background: rgba(255,255,255,0.5);
  border: 1px solid rgba(255,255,255,0.6);
}
.main-stat-value { font-size: 36px; font-weight: 800; color: var(--text-main); line-height: 1; }
.main-stat-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); margin-top: 5px; }
.area-badge {
  background: #e0e7ff; color: var(--primary);
  padding: 6px 12px; border-radius: 20px;
  font-size: 13px; font-weight: 600;
  display: inline-block; margin-top: 10px;
}

.grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.mini-stat {
  background: rgba(255,255,255,0.4); padding: 12px; border-radius: 12px;
  text-align: center; border: 1px solid rgba(255,255,255,0.4);
  transition: all 0.2s; cursor: pointer; user-select: none;
}
.mini-stat:hover { background: rgba(255,255,255,0.7); transform: translateY(-2px); }
.mini-stat.selected { background: #fff; border: 2px solid var(--primary); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
.mini-stat-val { font-size: 20px; font-weight: 700; color: var(--text-main); }
.mini-stat-lbl { font-size: 11px; color: var(--text-sub); }

/* Status List Styles */
.status-section-title { font-size: 13px; font-weight: 700; text-transform: uppercase; color: var(--text-sub); margin: 20px 0 10px 0; }
.status-wrapper { margin-bottom: 12px; }
.status-item { 
  margin-bottom: 0; background: rgba(255,255,255,0.3); 
  padding: 8px 10px; border-radius: 8px; cursor: pointer;
  transition: all 0.3s; border: 1px solid transparent;
} 
.status-item:hover { background: rgba(255,255,255,0.6); }
.status-item.selected {
  background: #fff; border: 1px solid var(--primary); border-bottom: 1px solid rgba(0,0,0,0.05);
  border-radius: 8px 8px 0 0; box-shadow: 0 -2px 10px rgba(79, 70, 229, 0.05);
}
.status-details {
  background: rgba(255,255,255,0.5); padding: 12px;
  border-radius: 0 0 8px 8px; border: 1px solid rgba(255,255,255,0.6);
  border-top: none; display: none;
}
.status-details.show { display: block; animation: slideDown 0.3s; }
.sub-stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 11px; }
.sub-stat-bar-bg { width: 100%; height: 4px; background: rgba(0,0,0,0.05); border-radius: 2px; margin-bottom: 8px; }
.sub-stat-bar-fill { height: 100%; border-radius: 2px; }
.status-header { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin-bottom: 6px; font-weight: 600; } 
.progress-bg { width: 100%; height: 10px; background: rgba(0,0,0,0.1); border-radius: 5px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--primary); border-radius: 5px; width: 0%; transition: width 1s; }

@keyframes slideDown { from { opacity: 0; transform: scaleY(0.9); max-height: 0; } to { opacity: 1; transform: scaleY(1); max-height: 300px; } }

/* ----- CONTROLS (RIGHT) ----- */
.controls-container {
  position: absolute; top: 80px; right: 20px;
  display: flex; flex-direction: column; gap: 10px; z-index: 10;
}
.control-card {
  background: var(--glass-bg); backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur)); padding: 5px;
  border-radius: 12px; box-shadow: var(--glass-shadow);
  width: 50px; overflow: hidden; transition: width 0.3s ease, background 0.3s;
  border: 1px solid var(--glass-border); white-space: nowrap;
}
.control-card:hover, .control-card.expanded { width: 180px; background: rgba(255, 255, 255, 0.55); }
.control-group-title { padding: 10px 15px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-sub); display: none; }
.control-card.expanded .control-group-title { display: block; }
.toggle-btn {
  display: flex; align-items: center; width: 100%; padding: 10px;
  background: transparent; border: none; cursor: pointer;
  border-radius: 8px; color: var(--text-sub); transition: all 0.2s;
}
.toggle-btn i { width: 30px; text-align: center; font-size: 16px; flex-shrink: 0; }
.toggle-btn span { opacity: 0; transition: opacity 0.2s; font-size: 13px; font-weight: 500; }
.control-card:hover .toggle-btn span, .control-card.expanded .toggle-btn span { opacity: 1; }
.toggle-btn:hover { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
.toggle-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }

/* Legend Mini */
.legend-mini { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); }
.legend-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 12px; color: var(--text-sub); }
.dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

/* ----- REPORT CARD MODAL (TAILWIND STYLED) ----- */
.report-modal-overlay {
  position: fixed; inset: 0;
  background: rgba(15, 23, 42, 0.65); /* Slate-900 with opacity */
  backdrop-filter: blur(8px);
  z-index: 2000;
  display: none;
  justify-content: center; align-items: center;
  padding: 20px;
}
.report-modal-overlay.active { display: flex; }

.report-container {
  background: #f8fafc; /* Slate-50 */
  width: 100%; max-width: 1400px;
  height: 95vh;
  border-radius: 20px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  display: flex; flex-direction: column;
  overflow: hidden;
  font-family: 'Plus Jakarta Sans', sans-serif;
  border: 1px solid rgba(255,255,255,0.8);
}

/* Header */
.report-header {
  background: white;
  color: #1e293b; /* Slate-800 */
  padding: 20px 32px;
  border-bottom: 1px solid #e2e8f0;
  display: flex; flex-direction: column;
  position: relative;
}

.report-meta { position: absolute; top: 20px; right: 80px; text-align: right; }
.report-date { font-size: 13px; font-weight: 500; color: #64748b; }

.report-title-container { text-align: center; width: 100%; margin-top: 8px; }
.report-title { 
  font-size: 24px; font-weight: 800; color: #0f172a; 
  display: inline-flex; align-items: center; gap: 12px; 
  text-transform: uppercase; letter-spacing: -0.5px;
}
.report-title i { color: var(--primary); }

.report-actions { position: absolute; top: 20px; right: 24px; display: flex; gap: 10px; }
.btn-close { 
  background: #fee2e2; color: #ef4444; border: none; width: 40px; height: 40px; 
  border-radius: 10px; cursor: pointer; display:flex; align-items:center; justify-content:center;
  transition: 0.2s; font-size: 18px;
}
.btn-close:hover { background: #fecaca; transform: scale(1.05); }

.btn-pdf {
  background: #e0e7ff; color: var(--primary-dark); border: none; 
  padding: 10px 20px; border-radius: 10px; font-weight: 700; font-size: 13px;
  cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s;
  position: absolute; top: 20px; left: 32px; 
  box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.1);
}
.btn-pdf:hover { background: #c7d2fe; transform: translateY(-1px); }

/* Body */
.report-body {
  padding: 32px;
  overflow-y: auto;
  flex: 1;
  background: #f1f5f9; /* Slate-100 */
}

/* Cards (Tailwind-like) */
.report-section { 
  background: white; 
  border-radius: 16px; 
  padding: 24px; 
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); 
  border: 1px solid #e2e8f0;
  margin-bottom: 0;
  transition: transform 0.2s, box-shadow 0.2s;
}
.report-section:hover { 
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
    border-color: #cbd5e1;
}

.report-section h3 { 
  margin: 0 0 20px 0; font-size: 14px; font-weight: 700; 
  color: #475569; text-transform: uppercase; letter-spacing: 0.5px;
  display: flex; align-items: center; gap: 10px;
  padding-bottom: 12px; border-bottom: 1px solid #f1f5f9;
}
.report-section h3 i { color: var(--primary); font-size: 16px; }

/* Grid */
.report-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 24px; }
.col-span-12 { grid-column: span 12; }
.col-span-8 { grid-column: span 8; }
.col-span-6 { grid-column: span 6; }
.col-span-4 { grid-column: span 4; }

/* Map Capture */
.map-capture-box { 
  width: 100%; height: 350px; background: #e2e8f0; 
  border-radius: 12px; overflow: hidden; position: relative; 
  border: 4px solid white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.map-capture-img { width: 100%; height: 100%; object-fit: cover; }

/* Summary Grid */
.summary-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px; }
.summary-card { 
  background: white; padding: 20px; border-radius: 16px; text-align: center; 
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
  transition: transform 0.2s;
}
.summary-card:hover { transform: translateY(-3px); }
.summary-val { font-size: 32px; font-weight: 800; color: #0f172a; line-height: 1; margin-bottom: 5px; }
.summary-lbl { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; }

/* Status List in Report (No Scroll) */
.report-section.no-scroll { overflow: visible; height: auto; }
.status-list-container { display: flex; flex-direction: column; gap: 12px; }
.report-section .status-item {
  background: #fff; border: 1px solid #e2e8f0;
  box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
  border-radius: 12px 12px 0 0; padding: 12px 16px; cursor: default;
}
.report-section .status-details {
  display: block; background: #f8fafc;
  border: 1px solid #e2e8f0; border-top: none;
  border-radius: 0 0 12px 12px; padding: 16px;
}
.report-section .status-item.selected { border-color: #e2e8f0; background: white; }

/* Chart Containers */
.chart-wrapper { position: relative; height: 320px; width: 100%; }
.chart-wrapper.tall { height: 500px; }

/* Responsive */
@media (max-width: 1200px) {
  .summary-grid { grid-template-columns: repeat(3, 1fr); }
  .col-span-8, .col-span-4 { grid-column: span 12; }
}
@media (max-width: 768px) {
  .col-span-6 { grid-column: span 12; }
  .summary-grid { grid-template-columns: repeat(2, 1fr); }
  .report-meta { position: static; text-align: center; margin-top: 10px; }
  .btn-pdf { position: static; margin-bottom: 10px; justify-content: center; width: 100%; }
  .report-actions { position: absolute; top: 15px; right: 15px; }
}

/* ----- LOADING & INFO ----- */
.loading-overlay {
  position: absolute; inset: 0; background: rgba(255,255,255,0.8);
  backdrop-filter: blur(5px); z-index: 999;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  transition: opacity 0.5s;
}
.loading-overlay.hide { opacity: 0; pointer-events: none; }
.spinner {
  width: 40px; height: 40px; border: 4px solid #e0e7ff;
  border-top-color: var(--primary); border-radius: 50%;
  animation: spin 1s linear infinite; margin-bottom: 10px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* InfoWindow */
.gm-style .gm-style-iw-c { padding: 0 !important; border-radius: 12px !important; box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important; }
.info-popup { padding: 0; min-width: 280px; max-width: 320px; }
.info-header { background: var(--primary); color: white; padding: 12px 16px; font-weight: 600; font-size: 14px; }
.info-body { padding: 12px 16px; background: white; max-height: 300px; overflow-y: auto; }
.info-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
.info-label { color: #666; font-weight: 500; min-width: 100px; }
.info-val { color: #111; font-weight: 600; text-align: right; overflow-wrap: break-word; max-width: 180px; }
.section-header { font-size: 11px; font-weight: 700; color: var(--primary); text-transform: uppercase; margin: 12px 0 8px 0; border-bottom: 2px solid #eee; padding-bottom: 4px; }

@media (max-width: 600px) {
  .dashboard-panel { width: calc(100% - 40px); bottom: auto; max-height: 60vh; }
  .controls-container { top: auto; bottom: 80px; right: 20px; }
  .control-card { width: 45px; } .control-card:hover, .control-card.expanded { width: 160px; }
  .search-container { width: 75%; }
}
</style>
</head>
<body>

  <!-- Map -->
  <div id="map"></div>

  <!-- Loading -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div style="font-weight: 600; color: var(--primary);">Memuatkan Data GIS...</div>
  </div>

  <!-- Top Search -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="search-input" placeholder="Cari tapak, daerah, atau parlimen...">
    </div>
  </div>

  <!-- Sidebar Toggle -->
  <button class="panel-toggle" id="sidebar-toggle" onclick="toggleDashboard()">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Floating Dashboard -->
  <div class="dashboard-panel" id="dashboard-panel">
    <div class="panel-header">
      <h2><i class="fas fa-layer-group"></i> Statistik Projek</h2>
    </div>
    
    <div class="panel-content">
      <div class="main-stat">
        <div class="main-stat-value" id="total-projects">0</div>
        <div class="main-stat-label">Jumlah Projek</div>
        <div id="selected-area" class="area-badge">SELURUH SABAH</div>
      </div>

      <div class="grid-stats">
        <div class="mini-stat" id="stat-card-menara" onclick="handleCategoryClick('TOWER', 'stat-card-menara')">
          <div class="mini-stat-val" id="menara-count" style="color: #FF5722;">0</div>
          <div class="mini-stat-lbl">Menara</div>
        </div>
        <div class="mini-stat" id="stat-card-nadi" onclick="handleCategoryClick('NADI', 'stat-card-nadi')">
          <div class="mini-stat-val" id="nadi-count" style="color: #2196F3;">0</div>
          <div class="mini-stat-lbl">NADI</div>
        </div>
        <div class="mini-stat" id="stat-card-wifi" onclick="handleCategoryClick('BWA', 'stat-card-wifi')">
          <div class="mini-stat-val" id="wifi-count" style="color: #4CAF50;">0</div>
          <div class="mini-stat-lbl">WiFi</div>
        </div>
        <div class="mini-stat" id="stat-card-pop" onclick="handleCategoryClick('POP', 'stat-card-pop')">
          <div class="mini-stat-val" id="pop-count" style="color: #FF9800;">0</div>
          <div class="mini-stat-lbl">POP</div>
        </div>
      </div>

      <div class="status-section-title">Status Kemajuan</div>
      <div id="status-list"></div>

      <div class="legend-mini">
        <div class="legend-row"><span class="dot" style="background: #FF5722;"></span> Menara Komunikasi</div>
        <div class="legend-row"><span class="dot" style="background: #2196F3;"></span> Pusat NADI</div>
        <div class="legend-row"><span class="dot" style="background: #4CAF50;"></span> WiFi Komuniti</div>
        <div class="legend-row"><span class="dot" style="background: #FF9800;"></span> Point of Presence (POP)</div>
      </div>
    </div>
  </div>

  <!-- Right Controls -->
  <div class="controls-container">
    <div class="control-card" id="report-card-btn">
       <button class="toggle-btn" id="btn-open-report" title="Report Kad">
        <i class="fas fa-file-alt" style="color: #E91E63;"></i> <span>Report Kad</span>
       </button>
    </div>
    <div class="control-card" id="layer-card">
      <div class="control-group-title">Sempadan</div>
      <button class="toggle-btn active" id="toggle-daerah" title="Daerah">
        <i class="fas fa-map-marked-alt"></i> <span>Daerah</span>
      </button>
      <button class="toggle-btn" id="toggle-dun" title="DUN">
        <i class="fas fa-landmark"></i> <span>DUN</span>
      </button>
      <button class="toggle-btn" id="toggle-parliament" title="Parlimen">
        <i class="fas fa-building"></i> <span>Parlimen</span>
      </button>
    </div>
    <div class="control-card" id="filter-card">
      <div class="control-group-title">Penapis Data</div>
      <button class="toggle-btn" id="toggle-menara" title="Menara">
        <i class="fas fa-broadcast-tower" style="color: #FF5722;"></i> <span>Menara</span>
      </button>
      <button class="toggle-btn" id="toggle-nadi" title="NADI">
        <i class="fas fa-satellite-dish" style="color: #2196F3;"></i> <span>NADI</span>
      </button>
      <button class="toggle-btn" id="toggle-wifi" title="WiFi">
        <i class="fas fa-wifi" style="color: #4CAF50;"></i> <span>WiFi</span>
      </button>
      <button class="toggle-btn" id="toggle-pop" title="POP">
        <i class="fas fa-globe" style="color: #FF9800;"></i> <span>POP</span>
      </button>
    </div>
  </div>

  <!-- Report Card Modal (ECHARTS VERSION) -->
  <div class="report-modal-overlay" id="report-overlay">
    <div class="report-container" id="report-print-area">
        
        <div class="report-header">
            <button class="btn-pdf" onclick="downloadPDF()">
                <i class="fas fa-file-pdf"></i> Muat Turun PDF
            </button>
            <div class="report-meta">
                <div class="report-date" id="report-date-text">17 Dis 2025, 3:35PM</div>
            </div>
            <div class="report-actions">
                <button class="btn-close" onclick="closeReportCard()"><i class="fas fa-times"></i></button>
            </div>
            <div class="report-title-container">
                <div class="report-title"><i class="fas fa-file-contract"></i> <span id="report-title-text">Laporan Projek: SABAH</span></div>
            </div>
        </div>

        <div class="report-body">
            
            <!-- Summary Stats -->
            <div class="summary-grid">
                <div class="summary-card" style="border: 2px solid var(--primary);">
                    <div class="summary-val" id="rpt-total" style="color:var(--primary)">0</div>
                    <div class="summary-lbl">Jumlah Projek</div>
                </div>
                <div class="summary-card">
                    <div class="summary-val" id="rpt-menara" style="color:#FF5722">0</div>
                    <div class="summary-lbl">Menara Komunikasi</div>
                </div>
                <div class="summary-card">
                    <div class="summary-val" id="rpt-nadi" style="color:#2196F3">0</div>
                    <div class="summary-lbl">Pusat NADI</div>
                </div>
                <div class="summary-card">
                    <div class="summary-val" id="rpt-bwa" style="color:#4CAF50">0</div>
                    <div class="summary-lbl">WiFi Komuniti</div>
                </div>
                <div class="summary-card">
                    <div class="summary-val" id="rpt-pop" style="color:#FF9800">0</div>
                    <div class="summary-lbl">Point of Presence</div>
                </div>
            </div>

            <div class="report-grid">
                <!-- Map Capture -->
                <div class="report-section col-span-8">
                    <h3><i class="fas fa-map"></i> Peta Lokasi</h3>
                    <div class="map-capture-box" id="map-capture-container">
                        <div style="display:flex; justify-content:center; align-items:center; height:100%; color:#999;">
                             Memproses Peta...
                        </div>
                    </div>
                </div>

                <!-- Status Progress (No Scroll) -->
                <div class="report-section col-span-4 no-scroll">
                    <h3><i class="fas fa-list-ul"></i> Status Kemajuan</h3>
                    <div class="status-list-container" id="report-status-full-list">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Chart 1: Komposisi Kategori -->
                <div class="report-section col-span-4">
                    <h3><i class="fas fa-chart-pie"></i> Komposisi Kategori</h3>
                    <div class="chart-wrapper" id="chart-cat-doughnut"></div>
                </div>

                <!-- Chart 2: Status Keseluruhan (Pie Standard) -->
                <div class="report-section col-span-4">
                    <h3><i class="fas fa-tachometer-alt"></i> Status Keseluruhan</h3>
                    <div class="chart-wrapper" id="chart-status-pie"></div>
                </div>

                <!-- Chart 3: Carta Status (Nightingale) -->
                <div class="report-section col-span-4">
                    <h3><i class="fas fa-chart-pie"></i> Pecahan Status</h3>
                    <div class="chart-wrapper" id="chart-status-nightingale"></div>
                </div>

                <!-- Chart 4: Kategori vs Status (Cluster Bar) -->
                <div class="report-section col-span-12">
                    <h3><i class="fas fa-chart-bar"></i> Kategori Projek VS Status</h3>
                    <div class="chart-wrapper" id="chart-cat-status-bar"></div>
                </div>
                
                <!-- Chart 5: Analisis Kawasan (Bar Race Style) -->
                <div class="report-section col-span-12">
                    <h3><i class="fas fa-chart-line"></i> Analisis Mengikut Kawasan</h3>
                    <div class="chart-wrapper tall" id="chart-area-race"></div>
                </div>
            </div>
        </div>
    </div>
  </div>
   
  <!-- Script for UI Toggles -->
  <script>
    function toggleDashboard() {
      const panel = document.getElementById('dashboard-panel');
      const btn = document.getElementById('sidebar-toggle');
      panel.classList.toggle('closed');
      btn.innerHTML = panel.classList.contains('closed') ? '<i class="fas fa-chart-pie"></i>' : '<i class="fas fa-times"></i>';
    }
    document.querySelectorAll('.control-card').forEach(card => {
      card.addEventListener('mouseenter', () => card.classList.add('expanded'));
      card.addEventListener('mouseleave', () => card.classList.remove('expanded'));
    });
  </script>

  <!-- Main Logic -->
<script>
const URLs = { district: "district.json", dun: "dun.json", parliament: "parliament.json" };
const SHEETS = { db_bwa: "1594VRWEs0PF56KXeSPudZTWkbGuS5UZmxXGrKqo4bUU", db_pim: "1WyZiw72LOVytssXAuymJS_TIgckLCUqY56pB0QhawZU", db_POP: "1JLqLtZPa4Kd6hEbRA2wgMgADX2h2-tdsXnG-YivSgU8", tower: "1b0Aipp0MQvP8HWc-z28dugkGn5sWdNAx6ZE5-Mu13-0" };
const SHEET_TYPE = { db_bwa: "BWA", db_pim: "NADI", db_POP: "POP", tower: "TOWER" };
const TYPE_CFG = {
  BWA: { color: "#4CAF50", icon: "üì∂", label: "WiFi" },
  NADI: { color: "#2196F3", icon: "üì°", label: "NADI" },
  POP: { color: "#FF9800", icon: "üåê", label: "POP" },
  TOWER: { color: "#FF5722", icon: "üóº", label: "Menara" }
};

let map;
let markersBySite = new Map();
let markersList = [];
let allProjects = [];
let areaIndex = new Map();
let dataLayers = { district: null, dun: null, parliament: null };
let currentBoundaryKey = null; // 'district', 'dun', 'parliament'
let hoverInfoWindow = null;
let refreshIntervalMs = 60_000;
let batchSize = 300;
let activeFeature = null;
let activeLayer = null;
let searchTerm = "";

let activeDashboardCategory = null; 
let activeStatusFilter = null;      
let currentFilteredData = [];
let chartInstances = {};

function showLoading(on) { const el = document.getElementById("loading"); if(el) on ? el.classList.remove("hide") : el.classList.add("hide"); }
function escapeHtml(s) { return String(s || "").replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c])); }
function debounce(fn, wait = 250) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; }
function normalizeString(str) { return String(str || "").trim().toUpperCase(); }
function cleanFloat(val) { if (typeof val === 'number') return val; if (!val) return 0; const str = String(val).replace(/[^0-9.,-]/g, "").replace(',', '.').trim(); const f = parseFloat(str); return isNaN(f) ? 0 : f; }
function generateStableId(row, type) { return `${type}_${normalizeString(row.SITE_NAME).replace(/\s+/g,'_')}_${normalizeString(row.DISTRICT).replace(/\s+/g,'_')}`; }
function extractFeatureName(f) { const props = ["NAME","name","DISTRICT","DAERAH","DUN","PARLIAMENT"]; for(const k of props){ const v=f.getProperty(k); if(v) return String(v).trim(); } return "Sabah"; }
function getRandomColor() { const l='0123456789ABCDEF'; let c='#'; for(let i=0;i<6;i++) c+=l[Math.floor(Math.random()*16)]; return c; }

function resetAllLayerStyles() {
  Object.keys(dataLayers).forEach(k => { if(dataLayers[k]) dataLayers[k].revertStyle(); });
  activeFeature = null; activeLayer = null;
}

// Data Handling
function parseGviz(text) { try { const s = text.indexOf('{'), e = text.lastIndexOf('}'); if (s === -1 || e === -1) return null; return JSON.parse(text.substring(s, e + 1)); } catch (e) { return null; } }

async function fetchSheetObjects(id) {
  const res = await fetch(`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&tq=`);
  if (!res.ok) throw new Error("Fail");
  const json = parseGviz(await res.text());
  if (!json || !json.table) return { rows: [], cols: [] };
  const cols = json.table.cols.map(c => c && c.label ? c.label.toUpperCase() : "");
  const rows = json.table.rows.map(r => { const o = {}; cols.forEach((c, i) => o[c||`COL${i}`] = r.c && r.c[i] ? r.c[i].v : ""); return o; });
  return { rows, cols: cols.filter(c => c && !c.startsWith("COL")) };
}

function normalizeRows(rows, key, cols) {
  const normKeys = new Set(["SITE_NAME","SITE NAME","SITE","DISTRICT","DAERAH","DUN","PARLIAMENT","PARLIAMENT_NAME","LATITUDE","LAT","LONGITUDE","LON","LNG","STATUS","STATUS_1"]);
  return rows.map(r => {
    const get = k => r[k]!==undefined?r[k]:(r[k.toLowerCase()]!==undefined?r[k.toLowerCase()]:"");
    const lat = cleanFloat(get("LATITUDE")||get("LAT"));
    const lng = cleanFloat(get("LONGITUDE")||get("LON"));
    const details = []; let c=0;
    for(let i=0; i<cols.length && c<15; i++) { if(!normKeys.has(cols[i]) && r[cols[i]]) { details.push({label:cols[i], value:String(r[cols[i]]).trim()}); c++; } }
    
    const obj = {
      SITE_NAME: String(get("SITE_NAME")||get("SITE")||"N/A").trim(),
      DISTRICT: String(get("DISTRICT")||get("DAERAH")||"").trim(),
      DUN: String(get("DUN")||"").trim(),
      PARLIAMENT: String(get("PARLIAMENT")||"").trim(),
      LATITUDE: lat, LONGITUDE: lng,
      STATUS: String(get("STATUS")||get("STATUS_1")||"Tiada Status").trim(),
      _sheet: key, _type: SHEET_TYPE[key]||"UNKNOWN", _raw_details: details,
      _validCoord: (lat > 0 && lng > 100)
    };
    obj._id = generateStableId(obj, obj._type);
    return obj;
  }).filter(o => o.SITE_NAME !== "N/A");
}

function buildAreaIndex() {
  areaIndex.clear();
  allProjects.forEach(p => {
    [p.DISTRICT, p.DUN, p.PARLIAMENT].forEach(k => { if(!k)return; const nk=normalizeString(k); if(!areaIndex.has(nk)) areaIndex.set(nk, new Set()); areaIndex.get(nk).add(p.SITE_NAME); });
  });
}

// Markers
function createOrUpdateMarker(p) {
  if (!p._validCoord) return null;
  const cfg = TYPE_CFG[p._type] || { color: "#333", icon: "üìç" };
  if (markersBySite.has(p._id)) {
    const m = markersBySite.get(p._id); m._meta = p;
    const pos = m.getPosition();
    if (!pos || Math.abs(pos.lat()-p.LATITUDE)>0.0001 || Math.abs(pos.lng()-p.LONGITUDE)>0.0001) m.setPosition({lat:p.LATITUDE, lng:p.LONGITUDE});
    return m;
  }
  let details = p._raw_details.map(d=>`<div class="info-row"><span class="info-label">${escapeHtml(d.label)}</span><span class="info-val">${escapeHtml(d.value)}</span></div>`).join('');
  if (details) details = `<div class="section-header">Maklumat Tambahan</div>` + details;

  const marker = new google.maps.Marker({
    position: { lat: p.LATITUDE, lng: p.LONGITUDE }, map: map, title: p.SITE_NAME, visible: false,
    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: cfg.color, fillOpacity: 1, strokeColor: "#fff", strokeWeight: 2 }
  });
  const infowin = new google.maps.InfoWindow({
    content: `<div class="info-popup"><div class="info-header">${cfg.icon} ${escapeHtml(p.SITE_NAME)}</div><div class="info-body">
      <div class="section-header">Maklumat Utama</div>
      <div class="info-row"><span class="info-label">Kategori</span><span class="info-val">${cfg.label}</span></div>
      <div class="info-row"><span class="info-label">Daerah</span><span class="info-val">${escapeHtml(p.DISTRICT)}</span></div>
      <div class="info-row"><span class="info-label">DUN</span><span class="info-val">${escapeHtml(p.DUN)}</span></div>
      <div class="info-row"><span class="info-label">Parlimen</span><span class="info-val">${escapeHtml(p.PARLIAMENT)}</span></div>
      <div class="info-row"><span class="info-label">Status</span><span class="info-val" style="color:${cfg.color}">${escapeHtml(p.STATUS)}</span></div>
      ${details}</div></div>`
  });
  marker.addListener("click", () => infowin.open(map, marker));
  marker._meta = p; markersBySite.set(p._id, marker);
  return marker;
}

function renderMarkersInBatches(list, cb) {
  let i = 0, len = list.length;
  if (len === 0) { if(cb) cb(); return; }
  const run = () => {
    const end = Math.min(i + batchSize, len);
    for (; i < end; i++) createOrUpdateMarker(list[i]);
    if (i < len) setTimeout(run, 50); else if (cb) cb();
  };
  run();
}

// Filtering
function handleCategoryClick(type, id) {
  if (activeDashboardCategory === type) { activeDashboardCategory = null; document.querySelectorAll('.mini-stat').forEach(e => e.classList.remove('selected')); }
  else { activeDashboardCategory = type; document.querySelectorAll('.mini-stat').forEach(e => e.classList.remove('selected')); document.getElementById(id)?.classList.add('selected'); }
  filterAndDisplayMarkers();
}
function handleStatusClick(s) {
  activeStatusFilter = (activeStatusFilter === s) ? null : s;
  filterAndDisplayMarkers();
}

function filterAndDisplayMarkers() {
  const menara = document.getElementById("toggle-menara")?.classList.contains("active");
  const nadi = document.getElementById("toggle-nadi")?.classList.contains("active");
  const pop = document.getElementById("toggle-pop")?.classList.contains("active");
  const wifi = document.getElementById("toggle-wifi")?.classList.contains("active");

  let list = allProjects;
  if (activeFeature && currentBoundaryKey) {
    const name = normalizeString(extractFeatureName(activeFeature));
    list = list.filter(p => {
      if (currentBoundaryKey === 'district') return normalizeString(p.DISTRICT) === name;
      if (currentBoundaryKey === 'dun') return normalizeString(p.DUN) === name;
      if (currentBoundaryKey === 'parliament') return normalizeString(p.PARLIAMENT) === name;
      return false;
    });
  }

  if (searchTerm) {
    const t = searchTerm.toLowerCase();
    if (!searchTerm.match(/^([-+]?[\d\.]+)[,\s]+([-+]?[\d\.]+)$/)) {
      list = list.filter(p => (p.SITE_NAME && p.SITE_NAME.toLowerCase().includes(t)) || (p.DISTRICT && p.DISTRICT.toLowerCase().includes(t)));
    }
  }

  currentFilteredData = list;
  if (activeDashboardCategory) list = list.filter(p => p._type === activeDashboardCategory);
  updateDashboard(list);

  let mapList = list;
  if (activeStatusFilter) mapList = list.filter(p => String(p.STATUS).trim() === activeStatusFilter);
  
  const visibleIds = new Set(mapList.map(p => p._id));
  markersList.forEach(m => {
    if(!m) return;
    const t = m._meta._type;
    let allowed = false;
    if (activeDashboardCategory) allowed = (t === activeDashboardCategory);
    else {
      if (t === "TOWER") allowed = menara; else if (t === "BWA") allowed = wifi; else if (t === "NADI") allowed = nadi; else if (t === "POP") allowed = pop;
    }
    m.setVisible(visibleIds.has(m._meta._id) && allowed && m._meta._validCoord);
  });
}

const updateDashboard = debounce(function (list) {
  const total = list.length;
  const el = document.getElementById("total-projects");
  if(el) animateValue("total-projects", parseInt(el.innerText)||0, total, 500);
  
  const counts = { menara: 0, nadi: 0, wifi: 0, pop: 0 };
  const statusStats = {};
  
  list.forEach(p => {
    if (p._type === "TOWER") counts.menara++; if (p._type === "BWA") counts.wifi++; if (p._type === "NADI") counts.nadi++; if (p._type === "POP") counts.pop++;
    const s = String(p.STATUS).trim() || "Tiada Status";
    if (!statusStats[s]) statusStats[s] = { total: 0, types: {} };
    statusStats[s].total++;
    if (!statusStats[s].types[p._type]) statusStats[s].types[p._type] = 0;
    statusStats[s].types[p._type]++;
  });

  const setT = (id, v) => { const e = document.getElementById(id); if(e) e.textContent = v; };
  setT("menara-count", counts.menara); setT("nadi-count", counts.nadi); setT("wifi-count", counts.wifi); setT("pop-count", counts.pop);

  const container = document.getElementById("status-list");
  if(container) {
    container.innerHTML = "";
    Object.entries(statusStats).sort((a,b)=>b[1].total-a[1].total).forEach(([status, data]) => {
      const pct = total > 0 ? Math.round((data.total/total)*100) : 0;
      let ec="#4F46E5", sc="#818cf8";
      const u = status.toUpperCase();
      if(u.match(/SIAP|OPERASI/)) { ec="#4CAF50"; sc="#81c784"; }
      else if(u.match(/BINA|PROGRESS/)) { ec="#2196F3"; sc="#64b5f6"; }
      else if(u.match(/TANGGUH|BATAL/)) { ec="#F44336"; sc="#e57373"; }
      else if(u.match(/RANCANG/)) { ec="#FF9800"; sc="#ffb74d"; }
      
      let det = "";
      Object.entries(data.types).sort((a,b)=>b[1]-a[1]).forEach(([t, c]) => {
        const tp = Math.round((c/data.total)*100);
        const tc = TYPE_CFG[t]?.color || "#666";
        det += `<div class="sub-stat-row"><span class="sub-stat-label" style="color:${tc}">${TYPE_CFG[t]?.label||t}</span><span class="sub-stat-val">${c} (${tp}%)</span></div><div class="sub-stat-bar-bg"><div class="sub-stat-bar-fill" style="width:${tp}%; background:${tc}; opacity:0.7;"></div></div>`;
      });
      
      const sel = (activeStatusFilter === status);
      const div = document.createElement("div"); div.className = "status-wrapper";
      div.innerHTML = `<div class="status-item ${sel?'selected':''}" onclick="handleStatusClick('${escapeHtml(status)}')">
        <div class="status-header"><span class="status-name">${escapeHtml(status)}</span><span class="status-percent" style="color:${ec}">${data.total} (${pct}%)</span></div>
        <div class="progress-bg"><div class="progress-fill" style="width:${pct}%; background:linear-gradient(90deg, ${sc}, ${ec});"></div></div>
      </div><div class="status-details ${sel?'show':''}">${det}</div>`;
      container.appendChild(div);
    });
  }
}, 200);

function animateValue(id, start, end, duration) {
  if (start === end) return;
  let current = start; const range = end - start; const inc = end > start ? 1 : -1;
  const step = Math.abs(Math.floor(duration / range)); const obj = document.getElementById(id);
  const t = setInterval(() => { current += inc; obj.innerHTML = current; if (current == end) clearInterval(t); }, Math.max(step, 10));
}

// ---------- REPORT GENERATION ----------
function generateReport() {
    const data = currentFilteredData || allProjects;
    const title = document.getElementById("selected-area").textContent;
    document.getElementById("report-title-text").textContent = "Laporan Projek: " + title;
    
    const now = new Date();
    document.getElementById("report-date-text").textContent = now.toLocaleDateString('ms-MY', {day:'2-digit', month:'short', year:'numeric'}) + ", " + now.toLocaleTimeString('ms-MY', {hour:'2-digit', minute:'2-digit'});

    let counts = { TOWER:0, NADI:0, BWA:0, POP:0 };
    let statusStats = {};
    let catStatusMap = {}; // Key: Category -> { Siap: 0, Bina: 0, Rancang: 0 } - Wait, user asked for X=Cat, Series=Status

    // Simplified Status grouping helper
    const getSimpleStatus = (s) => {
        const u = s.toUpperCase();
        if(u.includes("SIAP") || u.includes("OPERASI")) return "SIAP / OPERASI";
        if(u.includes("BINA") || u.includes("PELAKSANAAN")) return "DALAM PEMBINAAN";
        return "PERANCANGAN / LAIN";
    };

    data.forEach(p => {
        if(counts[p._type]!==undefined) counts[p._type]++;
        const s = String(p.STATUS || "N/A").trim();
        const simpleS = getSimpleStatus(s);

        if(!statusStats[s]) statusStats[s] = { total:0, types:{} };
        statusStats[s].total++;
        if(!statusStats[s].types[p._type]) statusStats[s].types[p._type]=0;
        statusStats[s].types[p._type]++;
        
        // Populate Cat-Status Map
        if(!catStatusMap[p._type]) catStatusMap[p._type] = { "SIAP / OPERASI":0, "DALAM PEMBINAAN":0, "PERANCANGAN / LAIN":0 };
        catStatusMap[p._type][simpleS]++;
    });
    
    // Update Stats
    document.getElementById("rpt-total").textContent = data.length;
    document.getElementById("rpt-menara").textContent = counts.TOWER;
    document.getElementById("rpt-nadi").textContent = counts.NADI;
    document.getElementById("rpt-bwa").textContent = counts.BWA;
    document.getElementById("rpt-pop").textContent = counts.POP;

    // Report Status List (Expanded)
    const listEl = document.getElementById("report-status-full-list"); listEl.innerHTML = "";
    Object.entries(statusStats).sort((a,b)=>b[1].total-a[1].total).forEach(([status, d]) => {
        const pct = data.length > 0 ? Math.round((d.total/data.length)*100) : 0;
        let ec="#4F46E5", sc="#818cf8"; const u = status.toUpperCase();
        if(u.match(/SIAP|OPERASI/)) { ec="#4CAF50"; sc="#81c784"; }
        else if(u.match(/BINA/)) { ec="#2196F3"; sc="#64b5f6"; }
        else if(u.match(/RANCANG/)) { ec="#FF9800"; sc="#ffb74d"; }
        
        let det = "";
        Object.entries(d.types).sort((a,b)=>b[1]-a[1]).forEach(([t, c]) => {
            const tp = Math.round((c/d.total)*100); const tc = TYPE_CFG[t]?.color || "#666";
            det += `<div class="sub-stat-row"><span style="color:${tc}">${TYPE_CFG[t]?.label}</span><span>${c} (${tp}%)</span></div><div class="sub-stat-bar-bg"><div class="sub-stat-bar-fill" style="width:${tp}%; background:${tc}; opacity:0.7;"></div></div>`;
        });
        const div = document.createElement("div"); div.className = "status-wrapper";
        div.innerHTML = `<div class="status-item selected"><div class="status-header"><span class="status-name">${escapeHtml(status)}</span><span class="status-percent" style="color:${ec}">${d.total} (${pct}%)</span></div><div class="progress-bg"><div class="progress-fill" style="width:${pct}%; background:linear-gradient(90deg, ${sc}, ${ec});"></div></div></div><div class="status-details show">${det}</div>`;
        listEl.appendChild(div);
    });

    // Prepare Area Analysis Data (Bar Race)
    // Logic: Identify current level -> Group by next level
    let areaData = [];
    let groupKey = 'DISTRICT'; 
    // Usually if current boundary is 'district', user sees DUNs. If 'Sabah', user sees Districts.
    // If currentFilteredData is subset (e.g. 1 district), we list its DUNs.
    if (currentBoundaryKey === 'district') groupKey = 'DUN';
    else if (currentBoundaryKey === 'parliament') groupKey = 'DUN';
    
    let areaMap = {};
    data.forEach(p => {
        const area = normalizeString(p[groupKey] || "Lain-lain");
        if(!areaMap[area]) areaMap[area] = { total:0, cat:{TOWER:0, NADI:0, BWA:0, POP:0}, stat:{"SIAP":0, "BINA":0, "LAIN":0} };
        areaMap[area].total++;
        if(areaMap[area].cat[p._type] !== undefined) areaMap[area].cat[p._type]++;
        
        const ss = getSimpleStatus(p.STATUS || "");
        if(ss.includes("SIAP")) areaMap[area].stat["SIAP"]++;
        else if(ss.includes("BINA")) areaMap[area].stat["BINA"]++;
        else areaMap[area].stat["LAIN"]++;
    });

    areaData = Object.keys(areaMap).map(k => ({ name: k, ...areaMap[k] })).sort((a,b) => b.total - a.total);
    // Limit to top 20 to prevent clutter
    if(areaData.length > 20) areaData = areaData.slice(0, 20);

    setTimeout(() => renderECharts(counts, statusStats, catStatusMap, areaData), 100);
    captureMapForReport();
    document.getElementById("report-overlay").classList.add("active");
}

function renderECharts(counts, statusStats, catStatusMap, areaData) {
    const init = (id) => { const d=document.getElementById(id); if(chartInstances[id]) chartInstances[id].dispose(); chartInstances[id]=echarts.init(d); return chartInstances[id]; };

    // 1. Kategori (Doughnut)
    init('chart-cat-doughnut').setOption({
        tooltip: { trigger:'item', formatter:'{b}: {c} ({d}%)' },
        legend: { bottom:0 },
        series: [{
            type:'pie', radius:['45%','70%'], itemStyle:{borderRadius:8, borderColor:'#fff', borderWidth:2},
            label:{show:true, formatter:'{b}\n{c}', fontWeight:'bold'},
            data:[
                {value:counts.TOWER, name:'Menara', itemStyle:{color:'#FF5722'}},
                {value:counts.NADI, name:'NADI', itemStyle:{color:'#2196F3'}},
                {value:counts.BWA, name:'WiFi', itemStyle:{color:'#4CAF50'}},
                {value:counts.POP, name:'POP', itemStyle:{color:'#FF9800'}}
            ]
        }]
    });

    // 2. Status Keseluruhan (Pie Standard)
    const statData = Object.entries(statusStats).map(([k,v]) => ({value:v.total, name:k})).sort((a,b)=>b.value-a.value);
    init('chart-status-pie').setOption({
        tooltip: { trigger:'item', formatter:'{b}: {c} ({d}%)' },
        legend: { show:false },
        series: [{
            type:'pie', radius:'70%', center:['50%','50%'],
            itemStyle:{borderRadius:5, borderColor:'#fff', borderWidth:1},
            label:{show:true, formatter:'{b}:\n{c} ({d}%)', fontSize:10},
            data: statData
        }]
    });

    // 3. Pecahan Status (Nightingale)
    init('chart-status-nightingale').setOption({
        tooltip: { trigger:'item' },
        series: [{ type:'pie', radius:[15, 100], roseType:'area', itemStyle:{borderRadius:6}, label:{show:true}, data: statData }]
    });

    // 4. Cat vs Status (Clustered Bar)
    // X = Categories, Bars = Status Groups
    const cats = ['TOWER', 'NADI', 'BWA', 'POP'];
    const displayCats = ['Menara', 'NADI', 'WiFi', 'POP'];
    const stats = ['SIAP / OPERASI', 'DALAM PEMBINAAN', 'PERANCANGAN / LAIN'];
    const colors = ['#4CAF50', '#2196F3', '#FF9800'];
    
    const seriesList = stats.map((s, idx) => {
        return {
            name: s, type: 'bar', stack: null, 
            data: cats.map(c => catStatusMap[c] ? catStatusMap[c][s] : 0),
            itemStyle: { color: colors[idx] },
            label: { show: true, position: 'top', formatter: (p)=>p.value>0?p.value:'' }
        };
    });

    init('chart-cat-status-bar').setOption({
        tooltip: { trigger:'axis', axisPointer:{type:'shadow'} },
        legend: { bottom: 0 },
        grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
        xAxis: { type: 'category', data: displayCats, axisLabel:{fontWeight:'bold'} },
        yAxis: { type: 'value' },
        series: seriesList
    });

    // 5. Analisis Kawasan (Bar Race Style - 2 Stacked Bars per Y-category)
    // We simulate "2 bars" using multiple series on same Y-axis but distinct stack groups?
    // Actually simpler: Stacked Bar for Cat, Stacked Bar for Status. 
    // Problem: ECharts places them on top of each other if category implies same axis slot.
    // Solution: Use multiple x-axes or just simpler stacked bar of just categories?
    // The prompt asked for "Bar 1 total projects by category, Bar 2 status".
    // We can use 'barGap' to separate them.
    
    const yLabels = areaData.map(d => d.name).reverse();
    // Series A (Cats)
    const sMenara = { name:'Menara', type:'bar', stack:'cat', data:areaData.map(d=>d.cat.TOWER).reverse(), itemStyle:{color:'#FF5722'} };
    const sNadi = { name:'NADI', type:'bar', stack:'cat', data:areaData.map(d=>d.cat.NADI).reverse(), itemStyle:{color:'#2196F3'} };
    const sWifi = { name:'WiFi', type:'bar', stack:'cat', data:areaData.map(d=>d.cat.BWA).reverse(), itemStyle:{color:'#4CAF50'} };
    const sPop = { name:'POP', type:'bar', stack:'cat', data:areaData.map(d=>d.cat.POP).reverse(), itemStyle:{color:'#FF9800'} };
    
    // Series B (Status) - use separate stack, label inside
    const stSiap = { name:'Siap', type:'bar', stack:'stat', data:areaData.map(d=>d.stat.SIAP).reverse(), itemStyle:{color:'#4CAF50', opacity:0.6}, barGap: '5%' };
    const stBina = { name:'Bina', type:'bar', stack:'stat', data:areaData.map(d=>d.stat.BINA).reverse(), itemStyle:{color:'#2196F3', opacity:0.6} };
    const stLain = { name:'Lain', type:'bar', stack:'stat', data:areaData.map(d=>d.stat.LAIN).reverse(), itemStyle:{color:'#FF9800', opacity:0.6} };

    init('chart-area-race').setOption({
        tooltip: { trigger:'axis', axisPointer:{type:'shadow'} },
        legend: { top:0 },
        grid: { left:'3%', right:'4%', bottom:'3%', containLabel:true },
        xAxis: { type:'value', boundaryGap:[0, 0.01] },
        yAxis: { type:'category', data:yLabels, axisLabel:{interval:0, fontSize:10} },
        series: [sMenara, sNadi, sWifi, sPop, stSiap, stBina, stLain]
    });

    new ResizeObserver(() => { Object.values(chartInstances).forEach(c=>c.resize()); }).observe(document.querySelector('.report-grid'));
}

function captureMapForReport() {
    const m=document.getElementById("map"), c=document.getElementById("map-capture-container");
    c.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#999;">Memproses Peta...</div>';
    html2canvas(document.body, { allowTaint:true, useCORS:true, x:m.getBoundingClientRect().left, y:m.getBoundingClientRect().top, width:m.offsetWidth, height:m.offsetHeight, ignoreElements:(el)=>el.classList.contains('dashboard-panel')||el.classList.contains('controls-container')||el.classList.contains('search-container')||el.classList.contains('report-modal-overlay') })
    .then(can => { c.innerHTML=""; const i=document.createElement("img"); i.src=can.toDataURL("image/png"); i.className="map-capture-img"; c.appendChild(i); })
    .catch(() => c.innerHTML='<div style="padding:20px; text-align:center; color:red;">Gagal menangkap peta.</div>');
}
function downloadPDF() {
    const { jsPDF } = window.jspdf; const doc = new jsPDF('p','mm','a4'); const el = document.getElementById('report-print-area');
    el.querySelectorAll('button').forEach(b=>b.style.display='none');
    html2canvas(el, { scale:1.5 }).then(c => {
        const d = c.toDataURL('image/png'), w=210, h=c.height*w/c.width;
        let hl=h, p=0; doc.addImage(d,'PNG',0,p,w,h); hl-=295;
        while(hl>=0) { p=hl-h; doc.addPage(); doc.addImage(d,'PNG',0,p,w,h); hl-=295; }
        doc.save('Laporan_Projek_Sabah.pdf'); el.querySelectorAll('button').forEach(b=>b.style.display='');
    });
}
function closeReportCard() { document.getElementById("report-overlay").classList.remove("active"); }

// Init
async function initMap() {
    const d=document.getElementById("map"); if(!d) return;
    map = new google.maps.Map(d, { center: {lat:5.9804, lng:116.0735}, zoom:8, mapTypeId:"satellite", disableDefaultUI:false, mapTypeControl:true });
    showLoading(true);
    try {
        const p = await Promise.all(Object.entries(SHEETS).map(([k,i])=>fetchSheetObjects(i).then(d=>normalizeRows(d.rows,k,d.cols)).catch(()=>[])));
        allProjects = p.flat(); buildAreaIndex();
        renderMarkersInBatches(allProjects, ()=>filterAndDisplayMarkers());
        const [ld, ldun, lpar] = await Promise.all([loadGeoJsonLayer("district",URLs.district), loadGeoJsonLayer("dun",URLs.dun), loadGeoJsonLayer("parliament",URLs.parliament)]);
        google.maps.event.addListenerOnce(map,"idle",()=>{ if(ld){dataLayers['district'].setMap(map); currentBoundaryKey='district';} setupToggles(); filterAndDisplayMarkers(); });
        setInterval(()=>autoRefreshLoop(), refreshIntervalMs);
    } catch(e) { console.error(e); alert("Ralat data."); } finally { showLoading(false); }
}

async function loadGeoJsonLayer(k, u) { try{ const r=await fetch(u); if(!r.ok)throw 1; const j=await r.json(); const l=new google.maps.Data({map:null}); l.addGeoJson(j); l.setStyle({strokeWeight:1, strokeColor:"#666", fillOpacity:0.05, fillColor:"#FFF"}); 
l.addListener("mouseover",e=>{ if(activeFeature===e.feature)return; const c=getRandomColor(); e.feature.setProperty('_themeColor',c); l.overrideStyle(e.feature,{strokeWeight:2,strokeColor:c,fillOpacity:0.3,fillColor:c}); if(!hoverInfoWindow) hoverInfoWindow=new google.maps.InfoWindow(); hoverInfoWindow.setContent(`<div style="padding:8px; font-weight:600; color:${c}">${escapeHtml(extractFeatureName(e.feature))}</div>`); hoverInfoWindow.setPosition(e.latLng); hoverInfoWindow.open(map); });
l.addListener("mouseout",e=>{ if(activeFeature!==e.feature)l.revertStyle(e.feature); if(hoverInfoWindow)hoverInfoWindow.close(); });
l.addListener("click",e=>{ handleFeatureClick(k,e.feature); }); dataLayers[k]=l; return l; }catch{return null;} }

function handleFeatureClick(k, f) {
    const l=dataLayers[k]; if(!l)return; document.getElementById("selected-area").textContent=extractFeatureName(f);
    Object.keys(dataLayers).forEach(ky=>{ if(dataLayers[ky]) dataLayers[ky].setMap(ky===k?map:null); }); updateToggleButtonsUI(k); resetAllLayerStyles();
    const c=f.getProperty('_themeColor')||"#4338ca"; l.overrideStyle(f,{strokeWeight:2,strokeColor:c,fillOpacity:0.5,fillColor:c});
    activeFeature=f; activeLayer=l; currentBoundaryKey=k; filterAndDisplayMarkers();
}
function setupToggles() { 
  ["menara","nadi","pop","wifi"].forEach(c=>document.getElementById("toggle-"+c)?.addEventListener("click",function(){this.classList.toggle("active"); activeDashboardCategory=null; document.querySelectorAll('.mini-stat').forEach(e=>e.classList.remove('selected')); filterAndDisplayMarkers();})); 
  [{id:"toggle-daerah",k:"district"},{id:"toggle-dun",k:"dun"},{id:"toggle-parliament",k:"parliament"}].forEach(b=>document.getElementById(b.id)?.addEventListener("click",function(){
    if(this.classList.contains('active')&&currentBoundaryKey===b.k){ this.classList.remove('active'); dataLayers[b.k].setMap(null); currentBoundaryKey=null; activeFeature=null; document.getElementById("selected-area").textContent="SELURUH SABAH"; }
    else { Object.keys(dataLayers).forEach(ky=>{if(dataLayers[ky])dataLayers[ky].setMap(ky===b.k?map:null)}); updateToggleButtonsUI(b.k); document.getElementById("selected-area").textContent="SABAH ("+b.k.toUpperCase()+")"; currentBoundaryKey=b.k; } filterAndDisplayMarkers();
  }));
  document.getElementById("search-input")?.addEventListener("input",e=>{searchTerm=e.target.value; const m=searchTerm.match(/^([-+]?[\d\.]+)[,\s]+([-+]?[\d\.]+)$/); if(m){const lat=parseFloat(m[1]),lng=parseFloat(m[2]); if(!isNaN(lat)&&!isNaN(lng)){map.panTo({lat,lng}); map.setZoom(14);}} else filterAndDisplayMarkers();});
  document.getElementById("btn-open-report")?.addEventListener("click",generateReport);
}
function updateToggleButtonsUI(k){ const m={district:"toggle-daerah",dun:"toggle-dun",parliament:"toggle-parliament"}; Object.keys(m).forEach(ky=>{const b=document.getElementById(m[ky]); if(b) ky===k?b.classList.add("active"):b.classList.remove("active");}); }
async function autoRefreshLoop() { try{const p=(await Promise.all(Object.entries(SHEETS).map(([k,i])=>fetchSheetObjects(i).then(d=>normalizeRows(d.rows,k,d.cols))))).flat(); allProjects=p; renderMarkersInBatches(p,()=>filterAndDisplayMarkers());}catch(e){} }
window.initMap = initMap;
</script>  
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRKvwm2qw29P6nRe6AFk0UMlSv356qMI0&callback=initMap" async defer></script>
</body>
</html>
