<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Projek Infrastruktur Digital Sabah</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; }
        .dashboard-panel { position: absolute; top: 20px; left: 20px; z-index: 10; width: 350px; }
        @media (max-width: 768px) {
            .dashboard-panel { width: 90%; left: 5%; right: 5%; top: 10px; }
        }
        
        /* Dashboard Styling */
        .mini-stat { transition: all 0.2s; cursor: pointer; border: 2px solid transparent; }
        .mini-stat.selected { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border-color: #4f46e5; }
        .mini-stat:hover { transform: scale(1.03); }

        /* Status List Styling */
        .status-wrapper { margin-bottom: 12px; }
        .status-item { cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s; border-radius: 0.5rem; padding: 10px; background-color: #ffffff; border: 1px solid #e5e7eb; }
        .status-item:hover { background-color: #f3f4f6; }
        .status-item.selected { box-shadow: 0 0 0 2px #4f46e5; background-color: #eef2ff; }
        .progress-bg { height: 6px; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; margin-top: 6px; }
        .progress-fill { height: 100%; transition: width 0.5s; border-radius: 9999px; }
        .status-header { display: flex; justify-content: space-between; align-items: center; }
        .status-name { font-weight: 600; font-size: 0.9rem; color: #374151; }
        .status-percent { font-weight: 700; font-size: 0.9rem; }

        /* Status Details */
        .status-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; background-color: #f9fafb; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; padding: 0 12px; margin-top: -8px; }
        .status-details.show { max-height: 500px; padding: 12px; margin-top: 4px; border: 1px solid #e5e7eb; border-top: none; }
        .sub-stat-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 4px; }
        .sub-stat-bar-bg { height: 4px; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; margin-bottom: 8px; }
        .sub-stat-bar-fill { height: 100%; transition: width 0.5s; border-radius: 9999px; }

        /* Boundary Toggle Control */
        .controls-container { position: absolute; bottom: 20px; left: 20px; z-index: 10; display: flex; gap: 8px; }
        .toggle-btn { transition: all 0.2s; background-color: #ffffff; color: #4f46e5; border: 2px solid #4f46e5; }
        .toggle-btn.active { background-color: #4f46e5; color: #ffffff; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.4); }

        /* Loading Spinner */
        #loading-spinner { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); z-index: 50; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Report Modal Styling */
        .report-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 100; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .report-modal-overlay.active { display: flex; opacity: 1; }
        .report-card { background: white; width: 8.5in; max-width: 95%; max-height: 95vh; overflow-y: auto; border-radius: 0.75rem; padding: 1.5rem; position: relative; }
        
        .report-summary-box { padding: 1rem; border-radius: 0.5rem; text-align: center; }
        .status-group { margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        .status-header-row { display: flex; justify-content: space-between; font-weight: 700; background-color: #f3f4f6; padding: 8px 12px; font-size: 0.9rem; }
        .status-sub-item { display: flex; justify-content: space-between; padding: 4px 12px; font-size: 0.85rem; border-top: 1px solid #f9fafb; }
        
        .map-capture-img { width: 100%; height: auto; border-radius: 0.5rem; margin-top: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #map-capture-container { height: 300px; border-radius: 0.5rem; border: 1px dashed #ddd; }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }

        /* Print Styles */
        @media print {
            .report-modal-overlay { display: block !important; opacity: 1 !important; position: static !important; }
            .report-card { width: 100%; max-width: 100%; height: auto; max-height: none; overflow: visible; padding: 0; }
            .no-print { display: none !important; }
            body { overflow: visible; background: white; }
            #map { display: none; }
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Google Map Container -->
    <div id="map"></div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center">
        <div class="spinner"></div>
        <p class="mt-4 text-lg text-indigo-700 font-semibold">Memuatkan Data Projek...</p>
    </div>

    <!-- Dashboard Panel -->
    <div class="dashboard-panel bg-white p-4 rounded-xl shadow-2xl space-y-4">
        <h1 class="text-xl font-bold text-indigo-700">Peta Projek Sabah</h1>
        
        <!-- Current Area & Report Button -->
        <div class="flex justify-between items-center bg-indigo-50 p-3 rounded-lg">
            <div>
                <p class="text-xs font-medium text-indigo-600">Kawasan Dipilih:</p>
                <p id="selected-area" class="text-lg font-extrabold text-indigo-800">SELURUH SABAH</p>
            </div>
            <button id="btn-open-report" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-full text-sm shadow-md transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 inline-block -mt-0.5">
                    <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM6.945 4.099l-.771-.343a.75.75 0 0 0-.91 1.258l.77.343a.75.75 0 0 0 .91-1.258Zm10.36 1.258.77-.343a.75.75 0 0 0-.91-1.258l-.77.343a.75.75 0 0 0 .91 1.258ZM14.25 7.5a.75.75 0 0 0-.75.75v5.25a.75.75 0 0 0 1.5 0V8.25a.75.75 0 0 0-.75-.75Zm-4.5 0a.75.75 0 0 0-.75.75v5.25a.75.75 0 0 0 1.5 0V8.25a.75.75 0 0 0-.75-.75ZM20.25 10.5a.75.75 0 0 0-.75.75v3a.75.75 0 0 0 1.5 0v-3a.75.75 0 0 0-.75-.75ZM3.75 10.5a.75.75 0 0 0-.75.75v3a.75.75 0 0 0 1.5 0v-3a.75.75 0 0 0-.75-.75ZM12 18a.75.75 0 0 0-.75.75v3a.75.75 0 0 0 1.5 0v-3a.75.75 0 0 0-.75-.75Z" clip-rule="evenodd" />
                </svg>
                Laporan
            </button>
        </div>

        <!-- Search Input -->
        <div class="search-container relative">
            <input type="text" id="search-input" placeholder="Cari Projek/Daerah (atau koordinat lat,lng)" class="w-full p-2 pl-10 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11a5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.398l3.759 3.759a.75.75 0 1 1-1.06 1.06l-3.759-3.759A7 7 0 0 1 2 9Z" clip-rule="evenodd" />
            </svg>
        </div>

        <!-- Category Stats -->
        <div class="bg-gray-50 p-3 rounded-lg shadow-inner">
            <p class="text-sm font-semibold mb-2 text-gray-600">Jumlah Projek: <span id="total-projects" class="text-indigo-600">0</span></p>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div id="menara-stat" class="mini-stat bg-white p-3 rounded-lg shadow" onclick="handleCategoryClick('TOWER', 'menara-stat')">
                    <p class="font-bold text-orange-600">Menara</p>
                    <p id="menara-count" class="text-2xl font-extrabold">0</p>
                </div>
                <div id="nadi-stat" class="mini-stat bg-white p-3 rounded-lg shadow" onclick="handleCategoryClick('NADI', 'nadi-stat')">
                    <p class="font-bold text-blue-600">NADI</p>
                    <p id="nadi-count" class="text-2xl font-extrabold">0</p>
                </div>
                <div id="wifi-stat" class="mini-stat bg-white p-3 rounded-lg shadow" onclick="handleCategoryClick('BWA', 'wifi-stat')">
                    <p class="font-bold text-green-600">WiFi Komuniti</p>
                    <p id="wifi-count" class="text-2xl font-extrabold">0</p>
                </div>
                <div id="pop-stat" class="mini-stat bg-white p-3 rounded-lg shadow" onclick="handleCategoryClick('POP', 'pop-stat')">
                    <p class="font-bold text-amber-600">POP</p>
                    <p id="pop-count" class="text-2xl font-extrabold">0</p>
                </div>
            </div>
            
            <!-- Category Visibility Toggle -->
            <div class="flex justify-around mt-3 pt-3 border-t border-gray-200 text-xs">
                <button id="toggle-menara" class="active transition duration-150 rounded-full px-3 py-1 bg-orange-100 text-orange-600 hover:bg-orange-200">Menara</button>
                <button id="toggle-nadi" class="active transition duration-150 rounded-full px-3 py-1 bg-blue-100 text-blue-600 hover:bg-blue-200">NADI</button>
                <button id="toggle-wifi" class="active transition duration-150 rounded-full px-3 py-1 bg-green-100 text-green-600 hover:bg-green-200">WiFi</button>
                <button id="toggle-pop" class="active transition duration-150 rounded-full px-3 py-1 bg-amber-100 text-amber-600 hover:bg-amber-200">POP</button>
            </div>
        </div>

        <!-- Status Breakdown -->
        <div class="bg-white p-4 rounded-xl shadow-lg">
            <h3 class="text-lg font-bold text-gray-700 mb-3">Status Projek</h3>
            <div id="status-list">
                <!-- Status items will be injected here by updateDashboard -->
            </div>
        </div>
    </div>
    
    <!-- Boundary Toggles -->
    <div class="controls-container no-print">
        <button id="toggle-daerah" class="toggle-btn active py-2 px-4 rounded-full text-sm font-semibold shadow-md transition duration-150">
            Daerah
        </button>
        <button id="toggle-dun" class="toggle-btn py-2 px-4 rounded-full text-sm font-semibold shadow-md transition duration-150">
            DUN
        </button>
        <button id="toggle-parliament" class="toggle-btn py-2 px-4 rounded-full text-sm font-semibold shadow-md transition duration-150">
            Parlimen
        </button>
    </div>

    <!-- Report Modal/Overlay -->
    <div id="report-overlay" class="report-modal-overlay no-print">
        <div id="report-print-area" class="report-card shadow-2xl">
            <div class="flex justify-between items-start border-b pb-4 mb-4 border-gray-200">
                <div class="space-y-1">
                    <h2 id="report-title-text" class="text-3xl font-extrabold text-indigo-700">Laporan Projek: SELURUH SABAH</h2>
                    <p id="report-date-text" class="text-sm text-gray-500 font-medium">Tarikh & Masa: 00/00/0000, 00:00 AM</p>
                </div>
                <button onclick="closeReportCard()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Summary -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="report-summary-box bg-orange-50 text-orange-700 border border-orange-200">
                    <p class="text-xs font-semibold">Menara</p>
                    <p id="rpt-menara" class="text-3xl font-extrabold mt-1">0</p>
                </div>
                <div class="report-summary-box bg-blue-50 text-blue-700 border border-blue-200">
                    <p class="text-xs font-semibold">NADI</p>
                    <p id="rpt-nadi" class="text-3xl font-extrabold mt-1">0</p>
                </div>
                <div class="report-summary-box bg-green-50 text-green-700 border border-green-200">
                    <p class="text-xs font-semibold">WiFi Komuniti</p>
                    <p id="rpt-bwa" class="text-3xl font-extrabold mt-1">0</p>
                </div>
                <div class="report-summary-box bg-amber-50 text-amber-700 border border-amber-200">
                    <p class="text-xs font-semibold">POP</p>
                    <p id="rpt-pop" class="text-3xl font-extrabold mt-1">0</p>
                </div>
            </div>

            <!-- Charts and Map -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Status List -->
                <div class="p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-xl font-bold text-gray-700 mb-3">Status Projek Terperinci</h3>
                    <div id="report-status-text-list" class="space-y-2 text-sm">
                        <!-- Detailed status breakdown injected here -->
                    </div>
                </div>

                <!-- Map Snapshot -->
                <div class="p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-xl font-bold text-gray-700 mb-3">Lokasi Projek di Peta</h3>
                    <div id="map-capture-container">
                        <!-- Map image will be injected here -->
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="p-4 border border-gray-200 rounded-lg h-72">
                    <h3 class="text-base font-semibold text-center mb-2">Pecahan Mengikut Kategori</h3>
                    <canvas id="chart-pie-cat"></canvas>
                </div>
                <div class="p-4 border border-gray-200 rounded-lg h-72">
                    <h3 class="text-base font-semibold text-center mb-2">Status Siap Vs Lain-lain</h3>
                    <canvas id="chart-pie-status"></canvas>
                </div>
                <div class="p-4 border border-gray-200 rounded-lg h-72 col-span-1 md:col-span-1">
                    <h3 class="text-base font-semibold text-center mb-2">Status Projek Mengikut Bilangan</h3>
                    <canvas id="chart-bar-status"></canvas>
                </div>
            </div>


            <!-- Download Button -->
            <div class="text-center mt-6 no-print">
                <button onclick="downloadPDF()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-full text-lg shadow-xl transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline-block -mt-0.5 mr-1">
                        <path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L7.29 9.355a.75.75 0 0 0-1.08 1.08l3.25 3.25a.75.75 0 0 0 1.08 0l3.25-3.25a.75.75 0 1 0-1.08-1.08l-1.96 1.959V2.75Z" />
                        <path d="M5.25 14.25a.75.75 0 0 0-.75.75v1.5c0 .414.336.75.75.75h9.5a.75.75 0 0 0 .75-.75v-1.5a.75.75 0 0 0-.75-.75h-9.5Z" />
                    </svg>
                    Muat Turun Laporan (PDF)
                </button>
            </div>
        </div>
    </div>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // Register ChartJS Datalabels plugin globally
    Chart.register(ChartDataLabels);

    // =====================================================================
    // GLOBAL STATE & CONFIGURATION
    // =====================================================================

    // --- Global State ---
    let map = null;
    let allProjects = []; 
    let currentFilteredData = [];
    let dataLayers = {};
    let currentBoundaryKey = 'district';
    let activeFeature = null;
    let activeLayer = null;
    let activeDashboardCategory = null;
    let activeStatusFilter = null;
    let searchTerm = "";
    let hoverInfoWindow = null;
    let markersBySite = new Map();
    let markersList = [];
    const charts = {}; // For Chart.js instances
    const refreshIntervalMs = 60000; // 60 seconds

    // --- Configuration Constants ---
    const TYPE_CFG = {
        "TOWER": { label: "Menara", color: "#FF5722" },
        "NADI": { label: "NADI", color: "#2196F3" },
        "BWA": { label: "WiFi Komuniti", color: "#4CAF50" },
        "POP": { label: "POP", color: "#FF9800" },
    };

    const SHEETS = {
        tower: 'mock-id-1',
        nadi: 'mock-id-2',
        bwa: 'mock-id-3',
        pop: 'mock-id-4'
    };

    const URLs = {
        // Mocking real-world GeoJSON for map boundaries
        district: 'https://storage.googleapis.com/sabah-geojson/Sabah-Daerah.geojson', 
        dun: 'https://storage.googleapis.com/sabah-geojson/Sabah-DUN.geojson',
        parliament: 'https://storage.googleapis.com/sabah-geojson/Sabah-Parlimen.geojson',
    };

    const typeMap = { 'tower': 'TOWER', 'nadi': 'NADI', 'bwa': 'BWA', 'pop': 'POP' };

    // =====================================================================
    // HELPER FUNCTIONS (MOCKS & UTILITIES)
    // =====================================================================

    // --- Utility Functions ---
    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function normalizeString(str) {
        if (!str) return "";
        return String(str).toUpperCase().trim().replace(/[^A-Z0-9]/g, '');
    }

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    function extractFeatureName(feature) {
        if (feature.getProperty('DISTRICT_N')) return feature.getProperty('DISTRICT_N');
        if (feature.getProperty('DUN_NAME')) return feature.getProperty('DUN_NAME');
        if (feature.getProperty('PARLIAMENT')) return feature.getProperty('PARLIAMENT');
        return 'Kawasan Dipilih'; 
    }

    function buildAreaIndex() {
        // Mocking area indexing for filtering
    }

    function showLoading(show) {
        const el = document.getElementById("loading-spinner");
        if(el) el.style.display = show ? 'flex' : 'none';
    }

    function resetAllLayerStyles() {
        Object.values(dataLayers).forEach(layer => {
            if (layer) layer.revertStyle();
        });
    }
    
    // --- Marker & Data Functions (MOCK) ---
    function createOrUpdateMarker(project) {
        if (!project._validCoord || !map) return;
        
        let marker = markersBySite.get(project._id);
        const latLng = new google.maps.LatLng(project.LAT, project.LNG);
        const typeCfg = TYPE_CFG[project._type] || { label: '?', color: '#666' };

        const iconUrl = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='${encodeURIComponent(typeCfg.color)}'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/%3E%3C/svg%3E`;

        const icon = { 
            url: iconUrl, 
            scaledSize: new google.maps.Size(30, 30),
            anchor: new google.maps.Point(15, 30)
        };

        if (!marker) {
            marker = new google.maps.Marker({
                position: latLng,
                icon: icon,
                map: map,
                title: project.SITE_NAME || project._type,
                _meta: project 
            });
            markersBySite.set(project._id, marker);
            
            marker.addListener('click', () => {
                 showProjectDetail(marker._meta);
            });
        } else {
            marker.setPosition(latLng);
            marker.setIcon(icon);
            marker.setTitle(project.SITE_NAME || project._type);
            marker._meta = project;
        }
    }

    function showProjectDetail(project) {
        const details = Object.entries(project)
            .filter(([key, value]) => !key.startsWith('_') && key !== 'LAT' && key !== 'LNG')
            .map(([key, value]) => {
                const displayKey = key.replace(/_/g, ' ').toUpperCase();
                return `<div class="flex justify-between py-1 border-b border-gray-100"><span class="font-semibold text-gray-600">${displayKey}:</span><span class="text-right text-gray-800">${escapeHtml(String(value))}</span></div>`;
            }).join('');

        const content = `
            <div class="p-2 w-80 max-w-xs font-inter">
                <h3 class="text-lg font-bold text-indigo-700 mb-2">${escapeHtml(project.SITE_NAME || 'Projek Tanpa Nama')}</h3>
                <div class="text-sm">
                    ${details}
                    <div class="mt-2 text-xs text-gray-500">Lat: ${project.LAT.toFixed(4)}, Lng: ${project.LNG.toFixed(4)}</div>
                </div>
            </div>
        `;

        if (hoverInfoWindow) hoverInfoWindow.close();
        const infoWindow = new google.maps.InfoWindow({ content: content });
        infoWindow.setPosition(new google.maps.LatLng(project.LAT, project.LNG));
        infoWindow.open(map);
    }

    function renderMarkersInBatches(projects, callback) {
        projects.forEach(p => createOrUpdateMarker(p));
        callback();
    }

    // --- Google Sheet Mocking ---
    async function fetchSheetObjects(id) {
        // This function mocks fetching data from a Google Sheet
        const mockData = generateMockData(); 
        const rows = mockData.filter(p => p._sheetId === id);
        return new Promise(resolve => {
            setTimeout(() => {
                resolve({
                    rows: rows,
                    cols: ['SITE_NAME', 'DISTRICT', 'PARLIAMENT', 'DUN', 'LAT', 'LNG', 'STATUS']
                });
            }, 500); // Simulate network delay
        });
    }

    function normalizeRows(rows, sheetKey, cols) {
        const projectType = typeMap[sheetKey] || 'TOWER';
        return rows.map((row, index) => {
            const lat = parseFloat(row.LAT);
            const lng = parseFloat(row.LNG);
            return {
                _id: `${projectType}-${index}`, 
                _type: projectType,
                // Simple validation for coordinates within Sabah bounds (approx)
                _validCoord: !isNaN(lat) && !isNaN(lng) && lat >= 3.0 && lat <= 8.0 && lng >= 115.0 && lng <= 119.5,
                LAT: lat,
                LNG: lng,
                SITE_NAME: row.SITE_NAME || 'Projek ' + index,
                DISTRICT: row.DISTRICT || 'Tidak Dinyatakan',
                PARLIAMENT: row.PARLIAMENT || 'Tidak Dinyatakan',
                DUN: row.DUN || 'Tidak Dinyatakan',
                STATUS: row.STATUS || 'Dalam Rancangan',
            };
        });
    }

    function generateMockData() {
        const districts = ["Kota Kinabalu", "Tawau", "Sandakan", "Kudat", "Lahad Datu", "Pitas", "Semporna"];
        const parliaments = ["Kota Belud", "Sepanggar", "Kinabatangan", "Keningau", "Penampang"];
        const duns = ["Inanam", "Karambunai", "Likas", "Api-Api", "Bandar", "Moyog"];
        const statuses = ["Siap Operasi", "Dalam Pembinaan", "Cadangan", "Tertangguh", "Selesai", "Rancangan"];
        const types = ['TOWER', 'NADI', 'BWA', 'POP'];

        const mockProjects = [];
        let idCounter = 1;

        // Generate data for all mock sheets
        Object.entries(SHEETS).forEach(([sheetKey, sheetId]) => {
            const typeKey = typeMap[sheetKey];
            for (let i = 0; i < 150; i++) {
                const lat = 5.9 + (Math.random() * 2.5 - 1.25); 
                const lng = 116.5 + (Math.random() * 3.5 - 1.75);  
                mockProjects.push({
                    _id: `PROJ-${idCounter++}`,
                    _type: typeKey,
                    _sheetId: sheetId,
                    _validCoord: true,
                    LAT: lat,
                    LNG: lng,
                    SITE_NAME: `${typeKey} ${districts[i % districts.length]} #${i+1}`,
                    DISTRICT: districts[i % districts.length],
                    PARLIAMENT: parliaments[i % parliaments.length],
                    DUN: duns[i % duns.length],
                    STATUS: statuses[Math.floor(Math.random() * statuses.length)],
                });
            }
        });

        return mockProjects;
    }

    // =====================================================================
    // CORE APPLICATION LOGIC (BAHAGIAN 3)
    // =====================================================================

    // ---------- DASHBOARD INTERACTION HANDLERS ----------
    function handleCategoryClick(type, elementId) {
        if (activeDashboardCategory === type) {
            activeDashboardCategory = null;
            document.querySelectorAll('.mini-stat').forEach(el => el.classList.remove('selected'));
        } else {
            activeDashboardCategory = type;
            document.querySelectorAll('.mini-stat').forEach(el => el.classList.remove('selected'));
            document.getElementById(elementId)?.classList.add('selected');
        }
        
        filterAndDisplayMarkers();
    }

    function handleStatusClick(statusStr) {
        // Toggle status filter selection
        if (activeStatusFilter === statusStr) {
            activeStatusFilter = null;
        } else {
            activeStatusFilter = statusStr;
        }
        filterAndDisplayMarkers();
    }

    // ---------- FILTERING LOGIC ----------
    function filterAndDisplayMarkers() {
        // Check category visibility toggles (used only if activeDashboardCategory is null)
        const menaraToggle = document.getElementById("toggle-menara")?.classList.contains("active");
        const nadiToggle = document.getElementById("toggle-nadi")?.classList.contains("active");
        const popToggle = document.getElementById("toggle-pop")?.classList.contains("active");
        const wifiToggle = document.getElementById("toggle-wifi")?.classList.contains("active");

        let filteredList = allProjects;

        // 1. Filter by Map Feature (District/DUN/Parliament)
        if (activeFeature && currentBoundaryKey) {
            const areaNameRaw = extractFeatureName(activeFeature);
            const areaName = normalizeString(areaNameRaw); 

            filteredList = allProjects.filter(p => {
                if (currentBoundaryKey === 'district') return normalizeString(p.DISTRICT) === areaName;
                if (currentBoundaryKey === 'dun') return normalizeString(p.DUN) === areaName;
                if (currentBoundaryKey === 'parliament') return normalizeString(p.PARLIAMENT) === areaName;
                return false;
            });
        }

        // 2. Filter by Search Term (Text Search)
        if (searchTerm && searchTerm.length > 0) {
            const term = searchTerm.toLowerCase();
            // Check if search term is a coordinate (handled by search input event)
            if (!searchTerm.match(/^([-+]?[\d\.]+)[,\s]+([-+]?[\d\.]+)$/)) {
                filteredList = filteredList.filter(p =>
                (p.SITE_NAME && p.SITE_NAME.toLowerCase().includes(term)) ||
                (p.DISTRICT && p.DISTRICT.toLowerCase().includes(term)) ||
                (p.PARLIAMENT && p.PARLIAMENT.toLowerCase().includes(term))
                );
            }
        }

        currentFilteredData = filteredList;

        // 3. Filter by Dashboard Category Click (Menara/NADI/POP/WiFi)
        if (activeDashboardCategory) {
            filteredList = filteredList.filter(p => p._type === activeDashboardCategory);
        }

        // Update Dashboard Stats with the result after Area and Category filtering
        updateDashboard(filteredList); 

        // 4. Filter for Map Markers (Applies Status Filter)
        let mapDisplayList = filteredList;
        if (activeStatusFilter) {
            // Apply status filter for map display
            mapDisplayList = filteredList.filter(p => String(p.STATUS || "").trim() === activeStatusFilter);
        }

        const visibleLocationIds = new Set(mapDisplayList.map(p => p._id));

        // 5. Update Marker Visibility on Map
        markersList.forEach(m => {
            if(!m) return;
            const meta = m._meta;
            const type = meta._type;

            let isCategoryAllowed = false;
            // Check if category is allowed based on toggles (if no specific category is selected)
            if (activeDashboardCategory) {
                isCategoryAllowed = (type === activeDashboardCategory);
            } else {
                if (type === "TOWER") isCategoryAllowed = menaraToggle;
                else if (type === "BWA") isCategoryAllowed = wifiToggle;
                else if (type === "NADI") isCategoryAllowed = nadiToggle;
                else if (type === "POP") isCategoryAllowed = popToggle;
            }

            // A marker is shown if: it's in the filtered map list AND its category is visible AND it has valid coordinates
            const shouldShow = visibleLocationIds.has(meta._id) && isCategoryAllowed && meta._validCoord;
            m.setVisible(shouldShow);
        });
        
        // Ensure the status details section reflects the selection
        document.querySelectorAll('.status-item').forEach(el => el.classList.remove('selected'));
        document.querySelectorAll('.status-details').forEach(el => el.classList.remove('show'));

        if(activeStatusFilter) {
            const selectedItem = Array.from(document.querySelectorAll('.status-name'))
                .find(el => el.textContent.trim() === activeStatusFilter)?.closest('.status-item');
            
            if (selectedItem) {
                selectedItem.classList.add('selected');
                selectedItem.nextElementSibling?.classList.add('show');
            }
        }
    }

    const updateDashboard = debounce(function (list) {
        const displayList = list || [];
        const totalEl = document.getElementById("total-projects");
        // Animate total project count
        if(totalEl) animateValue("total-projects", parseInt(totalEl.innerText) || 0, displayList.length, 500);

        const counts = { TOWER: 0, BWA: 0, NADI: 0, POP: 0 };
        const statusBreakdown = {};

        // Calculate counts and status breakdown
        displayList.forEach(p => {
            if (p._type === "TOWER") counts.TOWER++;
            if (p._type === "BWA") counts.BWA++;
            if (p._type === "NADI") counts.NADI++;
            if (p._type === "POP") counts.POP++;

            const s = String(p.STATUS || "Tidak Dinyatakan").trim();
            if (!statusBreakdown[s]) {
                statusBreakdown[s] = { total: 0, types: {} };
            }
            statusBreakdown[s].total++;
            if (!statusBreakdown[s].types[p._type]) {
                statusBreakdown[s].types[p._type] = 0;
            }
            statusBreakdown[s].types[p._type]++;
        });

        // Update category count boxes
        const setTxt = (id, val) => { const el = document.getElementById(id); if(el) animateValue(id, parseInt(el.textContent) || 0, val, 500); };
        setTxt("menara-count", counts.TOWER);
        setTxt("nadi-count", counts.NADI);
        setTxt("wifi-count", counts.BWA);
        setTxt("pop-count", counts.POP);

        // Update status list
        const statusEl = document.getElementById("status-list");
        if(!statusEl) return;
        statusEl.innerHTML = "";
        
        const sortedStatuses = Object.entries(statusBreakdown).sort(([, a], [, b]) => b.total - a.total);
        const totalProjects = displayList.length;

        sortedStatuses.forEach(([statusName, data]) => {
            const count = data.total;
            const percent = totalProjects > 0 ? Math.round((count / totalProjects) * 100) : 0;
            
            // Determine progress bar colors based on status name keywords
            let endColor = "#4F46E5"; 
            let startColor = "#818cf8";
            const statusUpper = statusName.toUpperCase();
            
            if (statusUpper.match(/SIAP|SELESAI|COMPLETE|OPERASI/)) { endColor = "#4CAF50"; startColor = "#81c784"; }
            else if (statusUpper.match(/BINA|IMPLEMENTASI|PROGRESS/)) { endColor = "#2196F3"; startColor = "#64b5f6"; }
            else if (statusUpper.match(/TANGGUH|BATAL|CANCEL/)) { endColor = "#F44336"; startColor = "#e57373"; }
            else if (statusUpper.match(/RANCANG|BARU|PLAN/)) { endColor = "#FF9800"; startColor = "#ffb74d"; }

            const isSelected = (activeStatusFilter === statusName);
            const selectedClass = isSelected ? "selected" : "";
            
            let detailsHtml = '';
            const sortedTypes = Object.entries(data.types).sort(([, a], [, b]) => b - a);
            
            sortedTypes.forEach(([typeKey, typeCount]) => {
                const typeCfg = TYPE_CFG[typeKey] || { label: typeKey, color: "#666" };
                const typePercent = count > 0 ? Math.round((typeCount / count) * 100) : 0;
                detailsHtml += `
                    <div class="sub-stat-row">
                        <span class="sub-stat-label" style="color: ${typeCfg.color}">${typeCfg.label}</span>
                        <span class="sub-stat-val">${typeCount} (${typePercent}%)</span>
                    </div>
                    <div class="sub-stat-bar-bg">
                        <div class="sub-stat-bar-fill" style="width: ${typePercent}%; background-color: ${typeCfg.color}; opacity: 0.7;"></div>
                    </div>
                `;
            });

            const itemContainer = document.createElement("div");
            itemContainer.className = "status-wrapper";
            // Use an anonymous function wrapper to pass statusName correctly to handleStatusClick
            itemContainer.innerHTML = `
                <div class="status-item ${selectedClass}" onclick="handleStatusClick('${escapeHtml(statusName)}')">
                    <div class="status-header">
                        <span class="status-name">${escapeHtml(statusName)}</span>
                        <span class="status-percent" style="color: ${endColor};">${count} (${percent}%)</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill" style="width: ${percent}%; background: linear-gradient(90deg, ${startColor}, ${endColor});"></div>
                    </div>
                </div>
                <div class="status-details ${isSelected ? 'show' : ''}">
                    ${detailsHtml}
                </div>
            `;
            statusEl.appendChild(itemContainer);
        });
    }, 200);

    function animateValue(id, start, end, duration) {
        if (start === end) return;
        const range = end - start;
        let current = start;
        const increment = end > start ? 1 : -1;
        const stepTime = Math.abs(Math.floor(duration / range));
        const obj = document.getElementById(id);
        if (!obj) return;
        
        const timer = setInterval(() => {
            current += increment;
            obj.innerHTML = current;
            if (current == end) clearInterval(timer);
        }, Math.max(stepTime, 10));
    }

    // ---------- REPORT CARD LOGIC ----------
    function generateReport() {
        // 1. Data & Title
        const data = currentFilteredData || allProjects;
        const title = document.getElementById("selected-area").textContent;
        document.getElementById("report-title-text").textContent = "Laporan Projek: " + title;

        // 2. Date
        const now = new Date();
        const dateStr = now.toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric' });
        const timeStr = now.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });
        document.getElementById("report-date-text").textContent = `${dateStr}, ${timeStr}`;

        // 3. Stats Calculation
        let counts = { TOWER: 0, NADI: 0, BWA: 0, POP: 0 };
        let statusBreakdown = {};
        let completedCount = 0;

        data.forEach(p => {
            if(counts[p._type] !== undefined) counts[p._type]++;
            
            const s = String(p.STATUS || "N/A").trim();
            const sUpper = s.toUpperCase();
            
            if (!statusBreakdown[s]) { statusBreakdown[s] = { total: 0, types: {} }; }
            statusBreakdown[s].total++;
            if (!statusBreakdown[s].types[p._type]) { statusBreakdown[s].types[p._type] = 0; }
            statusBreakdown[s].types[p._type]++;

            if(sUpper.includes("SIAP") || sUpper.includes("OPERASI") || sUpper.includes("SELESAI")) completedCount++;
        });

        // Populate Summary Boxes (Shows all categories even if 0)
        document.getElementById("rpt-menara").textContent = counts.TOWER;
        document.getElementById("rpt-nadi").textContent = counts.NADI;
        document.getElementById("rpt-bwa").textContent = counts.BWA;
        document.getElementById("rpt-pop").textContent = counts.POP;

        // 4. Detailed Status List (Expanded)
        const listEl = document.getElementById("report-status-text-list");
        listEl.innerHTML = "";
        
        // Sort statuses by count descending
        const sortedStatuses = Object.entries(statusBreakdown).sort(([,a], [,b]) => b.total - a.total);
        const totalProjects = data.length;

        sortedStatuses.forEach(([statusName, statData]) => {
            const statTotal = statData.total;
            const statPercent = totalProjects > 0 ? Math.round((statTotal / totalProjects) * 100) : 0;

            const groupDiv = document.createElement("div");
            groupDiv.className = "status-group";

            // Main Status Header
            let html = `<div class="status-header-row">
                        <span>${escapeHtml(statusName)}</span>
                        <span>${statTotal} (${statPercent}%)</span>
                        </div>`;

            // Sub Items
            const sortedTypes = Object.entries(statData.types).sort(([,a], [,b]) => b - a);
            sortedTypes.forEach(([typeKey, typeCount]) => {
                const typeLabel = TYPE_CFG[typeKey]?.label || typeKey;
                const typePercent = statTotal > 0 ? Math.round((typeCount / statTotal) * 100) : 0;
                html += `<div class="status-sub-item">
                            <span>${typeLabel}</span>
                            <span>${typeCount} (${typePercent}%)</span>
                        </div>`;
            });

            groupDiv.innerHTML = html;
            listEl.appendChild(groupDiv);
        });

        // 5. Generate Charts with Datalabels
        renderReportCharts(counts, statusBreakdown, totalProjects, completedCount);

        // 6. Map Capture
        captureMapForReport();

        // 7. Show Modal
        document.getElementById("report-overlay").classList.add("active");
    }

    function renderReportCharts(typeCounts, statusBreakdown, total, completed) {
        // Destroy existing charts to prevent memory leaks/overlap
        const destroyChart = (key) => { if(charts[key]) { charts[key].destroy(); charts[key] = null; } };
        destroyChart('pieCat'); destroyChart('pieStatus'); destroyChart('barStatus');

        const commonOptions = {
            responsive: true, 
            maintainAspectRatio: false,
            plugins: {
                datalabels: {
                    color: '#fff',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value, ctx) => {
                        let sum = 0;
                        let dataArr = ctx.chart.data.datasets[0].data;
                        dataArr.map(data => { sum += data; });
                        let percentage = (value * 100 / sum).toFixed(0) + "%";
                        return value > 0 ? `${value}\n(${percentage})` : '';
                    }
                },
                legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
            }
        };

        // Pie: Categories
        const ctxPieCat = document.getElementById('chart-pie-cat').getContext('2d');
        charts.pieCat = new Chart(ctxPieCat, {
            type: 'pie',
            data: {
                labels: ['Menara', 'NADI', 'WiFi', 'POP'],
                datasets: [{
                    data: [typeCounts.TOWER, typeCounts.NADI, typeCounts.BWA, typeCounts.POP],
                    backgroundColor: ['#FF5722', '#2196F3', '#4CAF50', '#FF9800']
                }]
            },
            options: commonOptions
        });

        // Pie: Overall Status (Doughnut)
        const notCompleted = total - completed;
        const ctxPieStat = document.getElementById('chart-pie-status').getContext('2d');
        charts.pieStatus = new Chart(ctxPieStat, {
            type: 'doughnut',
            data: {
                labels: ['Siap Operasi/Selesai', 'Lain-lain'],
                datasets: [{
                    data: [completed, notCompleted],
                    backgroundColor: ['#4CAF50', '#E0E0E0']
                }]
            },
            options: commonOptions
        });

        // Bar: Status Detailed
        const statusLabels = Object.keys(statusBreakdown);
        const statusData = Object.values(statusBreakdown).map(d => d.total);
        const ctxBar = document.getElementById('chart-bar-status').getContext('2d');
        charts.barStatus = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: statusLabels,
                datasets: [{
                    label: 'Jumlah',
                    data: statusData,
                    backgroundColor: '#3F51B5'
                }]
            },
            options: {
                ...commonOptions,
                indexAxis: 'y', // Horizontal bars
                plugins: {
                    ...commonOptions.plugins,
                    legend: { display: false },
                    datalabels: {
                        color: '#333',
                        anchor: 'end',
                        align: 'end',
                        formatter: (value) => value
                    }
                },
                scales: { x: { display: false } } // Hide x-axis ticks/labels
            }
        });
    }

    function captureMapForReport() {
        const mapEl = document.getElementById("map");
        const container = document.getElementById("map-capture-container");
        container.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#999;">Memproses Peta...</div>';

        // Use a slight delay to ensure the map elements are ready for capture
        setTimeout(() => {
            html2canvas(document.body, { 
                allowTaint: true,
                useCORS: true,
                // Define the capture area to be exactly the map div
                x: mapEl.getBoundingClientRect().left,
                y: mapEl.getBoundingClientRect().top,
                width: mapEl.offsetWidth,
                height: mapEl.offsetHeight,
                ignoreElements: (el) => {
                    // Ignore all UI overlays when capturing the map area
                    return el.classList.contains('dashboard-panel') || 
                            el.classList.contains('controls-container') ||
                            el.classList.contains('search-container') ||
                            el.classList.contains('report-modal-overlay') ||
                            el.closest('.gmnoprint'); // Ignore Google Maps controls/overlays if possible
                }
            }).then(canvas => {
                container.innerHTML = "";
                const img = document.createElement("img");
                img.src = canvas.toDataURL("image/png");
                img.className = "map-capture-img";
                container.appendChild(img);
            }).catch(err => {
                console.error("Map capture fail", err);
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#F44336; font-size:12px;">Gagal menangkap peta (Isu Keselamatan Browser/CORS).<br>Sila guna screenshot manual untuk peta.</div>';
            });
        }, 100); 
    }

    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const element = document.getElementById('report-print-area');
        
        // Hide buttons for capture and set print styles temporarily
        const btns = element.querySelectorAll('.no-print, button');
        const originalDisplays = Array.from(btns).map(b => {
            const original = b.style.display;
            b.style.display = 'none';
            return original;
        });

        // Use scale: 2 for better resolution
        html2canvas(element, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/jpeg', 1.0); // Use JPEG for smaller file size
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();
            const imgHeight = canvas.height * pdfWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            // Add first page
            doc.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdfHeight;

            // Add remaining pages
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                doc.addPage();
                doc.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;
            }
            
            doc.save('Laporan_Projek_Sabah.pdf');

            // Restore buttons
            btns.forEach((b, i) => b.style.display = originalDisplays[i]);
        });
    }

    function closeReportCard() {
        document.getElementById("report-overlay").classList.remove("active");
    }

    // ---------- INITIALIZATION AND MAP LOGIC ----------
    async function loadAllSheetsAndNormalize() {
        const entries = Object.entries(SHEETS);
        const promises = entries.map(([k, id]) => fetchSheetObjectsSafe(k, id));
        const results = await Promise.all(promises);
        const combined = results.flat();
        allProjects = combined;
        buildAreaIndex();
        return combined;
    }

    async function fetchSheetObjectsSafe(sheetKey, id) {
        try {
            const data = await fetchSheetObjects(id);
            // Assuming data.rows is an array of objects
            return normalizeRows(data.rows, sheetKey, data.cols);
        } catch (e) {
            console.warn("sheet load fail", sheetKey, e);
            return [];
        }
    }

    async function loadGeoJsonLayer(key, url, baseStyle = {}) {
        try {
            const resp = await fetch(url);
            if (!resp.ok) throw new Error("geojson fetch failed " + url);
            const json = await resp.json();

            const layer = new google.maps.Data({ map: null });
            layer.addGeoJson(json);

            // Set base style
            layer._baseStyle = {
                strokeWeight: baseStyle.strokeWeight || 1,
                strokeColor: baseStyle.strokeColor || "#666",
                fillOpacity: 0.05,
                fillColor: (baseStyle.fillColor || "#FFF")
            };
            layer.setStyle(feature => layer._baseStyle);

            // Mouseover (Hover) effect
            layer.addListener("mouseover", e => {
                if (!layer.getMap()) return;
                if (activeFeature === e.feature) return;
                
                const randomColor = getRandomColor();
                e.feature.setProperty('_themeColor', randomColor);
                
                layer.overrideStyle(e.feature, { 
                    strokeWeight: 3, 
                    strokeColor: randomColor, 
                    fillOpacity: 0.35, 
                    fillColor: randomColor 
                });
                
                if (!hoverInfoWindow) hoverInfoWindow = new google.maps.InfoWindow();
                hoverInfoWindow.setContent(`<div style="padding:8px 12px; font-weight:600; color:${randomColor}; text-shadow: 0px 0px 1px #000;">${escapeHtml(extractFeatureName(e.feature))}</div>`);
                hoverInfoWindow.setPosition(e.latLng);
                hoverInfoWindow.open(map);
            });

            // Mouseout effect
            layer.addListener("mouseout", e => {
                if (activeFeature !== e.feature) layer.revertStyle(e.feature);
                if (hoverInfoWindow) hoverInfoWindow.close();
            });

            // Click interaction
            layer.addListener("click", e => {
                handleFeatureClick(key, e.feature);
            });

            dataLayers[key] = layer;
            return layer;
        } catch (e) {
            console.warn("loadGeoJsonLayer error", key, e);
            return null;
        }
    }

    function handleFeatureClick(key, feature) {
        const layerObj = dataLayers[key];
        if (!layerObj) return;

        const featureName = extractFeatureName(feature);
        document.getElementById("selected-area").textContent = featureName;

        toggleBoundaryLayerVisibility(key);
        resetAllLayerStyles(); // Revert styles of all other features in all layers
        
        const themeColor = feature.getProperty('_themeColor') || "#4338ca";
        
        // Highlight the selected feature
        layerObj.overrideStyle(feature, { 
            strokeWeight: 4, 
            strokeColor: themeColor, 
            fillOpacity: 0.65,
            fillColor: themeColor 
        });

        activeFeature = feature;
        activeLayer = layerObj;
        currentBoundaryKey = key;

        filterAndDisplayMarkers();
        
        // TRIGGER AUTOMATIK REPORT KAD
        generateReport();
        
        // Add pulse animation to report button
        const btn = document.getElementById("btn-open-report");
        if(btn) {
            btn.style.animation = "none"; 
            void btn.offsetWidth; // Trigger reflow
            btn.style.animation = "pulse 1s";
            setTimeout(() => btn.style.animation = "", 1000);
        }
    }

    function toggleBoundaryLayerVisibility(key) {
        Object.keys(dataLayers).forEach(k => {
            const dl = dataLayers[k];
            if (dl) dl.setMap(k === key ? map : null);
        });
        updateToggleButtonsUI(key);
    }

    function updateToggleButtonsUI(activeKey) {
        const mapping = { district: "toggle-daerah", dun: "toggle-dun", parliament: "toggle-parliament" };
        Object.keys(mapping).forEach(k => {
            const btn = document.getElementById(mapping[k]);
            if (btn) activeKey === k ? btn.classList.add("active") : btn.classList.remove("active");
        });
    }

    function setupToggles() {
        // Category Visibility Toggles
        ["menara", "nadi", "pop", "wifi"].forEach(cat => {
            document.getElementById(`toggle-${cat}`)?.addEventListener("click", function () {
                this.classList.toggle("active");
                
                // Clear dashboard category selection if any toggle is used
                activeDashboardCategory = null;
                document.querySelectorAll('.mini-stat').forEach(el => el.classList.remove('selected'));
                
                filterAndDisplayMarkers();
            });
        });

        // Boundary Toggles
        const boundaries = [
            { id: "toggle-daerah", key: "district" },
            { id: "toggle-dun", key: "dun" },
            { id: "toggle-parliament", key: "parliament" }
        ];

        boundaries.forEach(b => {
            document.getElementById(b.id)?.addEventListener("click", function () {
                if (this.classList.contains('active') && currentBoundaryKey === b.key) {
                    // Turn off current layer
                    this.classList.remove('active');
                    dataLayers[b.key].setMap(null);
                    currentBoundaryKey = null;
                    activeFeature = null;
                    document.getElementById("selected-area").textContent = "SELURUH SABAH";
                } else {
                    // Turn on selected layer
                    toggleBoundaryLayerVisibility(b.key);
                    document.getElementById("selected-area").textContent = "SABAH (" + b.key.toUpperCase() + ")";
                    currentBoundaryKey = b.key; 
                }
                filterAndDisplayMarkers();
            });
        });

        // Search Input Handler
        document.getElementById("search-input")?.addEventListener("input", (e) => {
            searchTerm = e.target.value;
            
            const coordMatch = searchTerm.match(/^([-+]?[\d\.]+)[,\s]+([-+]?[\d\.]+)$/);
            if (coordMatch) {
                const lat = parseFloat(coordMatch[1]);
                const lng = parseFloat(coordMatch[2]);
                if (!isNaN(lat) && !isNaN(lng)) {
                    map.panTo({lat, lng});
                    map.setZoom(14);
                    // No need to filter markers here, just pan the map
                }
            } else {
                filterAndDisplayMarkers();
            }
        });

        // Report Button
        document.getElementById("btn-open-report")?.addEventListener("click", generateReport);
    }

    async function autoRefreshLoop() {
        try {
            // Re-fetch all data
            const newProjects = await loadAllSheetsAndNormalize();
            
            // Update markers based on new data
            newProjects.forEach(np => createOrUpdateMarker(np));
            
            // Re-list markers (important if some sites were removed/added)
            markersList = Array.from(markersBySite.values());
            allProjects = newProjects;
            
            // Re-run filtering to update dashboard and map visibility
            filterAndDisplayMarkers();
            console.log(`Data refreshed. Total projects: ${allProjects.length}`);
        } catch (e) {
            console.warn("autoRefreshLoop failed", e);
        }
    }

    // ---------- MAIN INIT ----------
    async function initMap() {
        const mapDiv = document.getElementById("map");
        if (!mapDiv) return;

        const silverStyle = [
            { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
            { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] },
            { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#c9c9c9" }] },
            { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] }
        ];

        map = new google.maps.Map(mapDiv, {
            center: { lat: 5.9804, lng: 116.0735 }, // Kota Kinabalu, Sabah
            zoom: 8,
            mapTypeId: "satellite", // Default to satellite for better visual context
            styles: silverStyle,
            disableDefaultUI: false,
            mapTypeControl: true,
            mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                position: google.maps.ControlPosition.TOP_RIGHT
            },
            zoomControl: true,
            zoomControlOptions: {
                position: google.maps.ControlPosition.RIGHT_BOTTOM
            },
            streetViewControl: false,
            fullscreenControl: false
        });

        showLoading(true);

        try {
            // 1. Load All Project Data
            const projects = await loadAllSheetsAndNormalize();
            
            // 2. Render Markers
            renderMarkersInBatches(projects, () => {
                markersList = Array.from(markersBySite.values());
                filterAndDisplayMarkers();
            });

            // 3. Load GeoJSON Boundary Layers
            const pDistrict = loadGeoJsonLayer("district", URLs.district, { fillColor: '#4f46e5' }).catch(e => null);
            const pDun = loadGeoJsonLayer("dun", URLs.dun, { fillColor: '#10b981' }).catch(e => null);
            const pPar = loadGeoJsonLayer("parliament", URLs.parliament, { fillColor: '#f97316' }).catch(e => null);

            // 4. Final Setup after Map is Ready
            google.maps.event.addListenerOnce(map, "idle", async () => {
                const ld = await pDistrict;
                await pDun; 
                await pPar;

                // Set default boundary layer (District)
                if (ld) {
                    dataLayers['district'].setMap(map);
                    currentBoundaryKey = 'district';
                }
                
                setupToggles();
                filterAndDisplayMarkers(); // Final dashboard/marker update
            });

            // 5. Start Auto-Refresh Loop
            setInterval(() => autoRefreshLoop(), refreshIntervalMs);

        } catch (e) {
            console.error("Init Error", e);
            // Display error message in the console and via a custom modal/message box (not alert)
            const errorEl = document.getElementById("loading-spinner");
            if(errorEl) {
                errorEl.innerHTML = '<div class="p-8 bg-red-100 border border-red-400 rounded-lg text-red-700">Ralat: Gagal memulakan peta. Sila pastikan sambungan internet dan API key sah.</div>';
            }
        } finally {
            showLoading(false);
        }
    }

    window.initMap = initMap;
    // ---------- END OF SCRIPT ----------
</script> 
<!-- Google Maps API (Replace with your own key if needed) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRKvwm2qw29P6nRe6AFk0UMlSv356qMI0&callback=initMap" async defer></script>
    
</body>
</html>
