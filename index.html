<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Web GIS Projek Sabah - Moden</title>
  <!-- Favicon disable buat masa ini -->
  <link rel="icon" href="data:," />
  
  <!-- FontAwesome & Google Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #4F46E5;
  --primary-dark: #4338ca;
  --glass-bg: rgba(255, 255, 255, 0.45);
  --glass-border: rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
  --blur: 12px;
  --text-main: #1f2937;
  --text-sub: #6b7280;
  --radius: 16px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  font-family: 'Plus Jakarta Sans', sans-serif;
  height: 100vh; width: 100vw;
  overflow: hidden;
  background: #eef2f5;
  color: var(--text-main);
}
.search-box {
  flex: 1;
  background: var(--glass-bg);
  /* fallback bg untuk browser lama */
  background-color: #fff;
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  padding: 12px 20px;
  border-radius: 50px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex;
  align-items: center;
  transition: var(--transition);
}
@media (max-width: 600px) {
  .dashboard-panel { width: calc(100% - 40px); bottom: auto; max-height: 70vh; overflow-y: auto; }
  .controls-container { top: auto; bottom: 80px; right: 20px; }
  .control-card { width: 45px; }
  .control-card:hover, .control-card.expanded { width: 160px; }
  .search-container { width: 75%; }
}
</style>
</head>
<body>
  <!-- Map Background -->
  <div id="map"></div>
  <!-- Loading Screen -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div style="font-weight: 600; color: var(--primary);">Memuatkan Data GIS...</div>
  </div>
  <!-- Top Search Bar -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="search-input" placeholder="Cari tapak, daerah, atau parlimen...">
    </div>
  </div>
  <!-- Sidebar Toggle Button -->
  <button class="panel-toggle" id="sidebar-toggle" onclick="toggleDashboard()">
    <i class="fas fa-bars"></i>
  </button>
  <!-- Floating Dashboard Panel -->
  <div class="dashboard-panel" id="dashboard-panel">...</div>
  <!-- Right Side Controls (Expandable Cards) -->
  <div class="controls-container">...</div>
  <script>
    // UI Interactions Script (sama seperti asal)
    function toggleDashboard() {
      const panel = document.getElementById('dashboard-panel');
      const btn = document.getElementById('sidebar-toggle');
      panel.classList.toggle('closed');
      btn.innerHTML = panel.classList.contains('closed') ? '<i class="fas fa-chart-pie"></i>' : '<i class="fas fa-times"></i>';
    }
    document.querySelectorAll('.control-card').forEach(card => {
      card.addEventListener('mouseenter', () => card.classList.add('expanded'));
      card.addEventListener('mouseleave', () => card.classList.remove('expanded'));
    });
  </script>
<script>
// Seluruh script masih sama, dengan migrasi utama
// pada penggunaan Marker digantikan kepada AdvancedMarkerElement
// Pada createOrUpdateMarker:
function createOrUpdateMarker(project) {
  if (!project._validCoord) return null;
  const uniqueKey = project._id;
  const cfg = TYPE_CFG[project._type] || { color: "#333", icon: "ðŸ“" };
  if (markersBySite.has(uniqueKey)) {
    const m = markersBySite.get(uniqueKey);
    m._meta = project;
    const pos = m.position;
    if (!pos || Math.abs(pos.lat - project.LATITUDE) > 0.0001 || Math.abs(pos.lng - project.LONGITUDE) > 0.0001) {
       m.position = { lat: project.LATITUDE, lng: project.LONGITUDE };
    }
    return m;
  } else {
    let rawDetailsHtml = project._raw_details.map(detail =>
      `<div class="info-row"><span class="info-label">${escapeHtml(detail.label)}</span><span class="info-val">${escapeHtml(detail.value)}</span></div>`
    ).join('');
    if (rawDetailsHtml) {
      rawDetailsHtml = `<div class="section-header">Maklumat Tambahan</div>` + rawDetailsHtml;
    }
    const advMarker = new google.maps.marker.AdvancedMarkerElement({
      map,
      position: { lat: project.LATITUDE, lng: project.LONGITUDE },
      title: project.SITE_NAME || ""
    });
    // Custom icon/content boleh ditambah jika perlu
    const infowin = new google.maps.InfoWindow({
      content: `<div class="info-popup">
        <div class="info-header">${cfg.icon} ${escapeHtml(project.SITE_NAME)}</div>
        <div class="info-body">
          <div class="section-header">Maklumat Utama</div>
          <div class="info-row"><span class="info-label">Kategori</span><span class="info-val">${cfg.label}</span></div>
          <div class="info-row"><span class="info-label">Daerah</span><span class="info-val">${escapeHtml(project.DISTRICT)}</span></div>
          <div class="info-row"><span class="info-label">DUN</span><span class="info-val">${escapeHtml(project.DUN)}</span></div>
          <div class="info-row"><span class="info-label">Parlimen</span><span class="info-val">${escapeHtml(project.PARLIAMENT)}</span></div>
          <div class="info-row"><span class="info-label">Status</span><span class="info-val" style="color:${cfg.color}">${escapeHtml(project.STATUS)}</span></div>
          <div class="info-row"><span class="info-label">Koordinat</span><span class="info-val">${project.LATITUDE.toFixed(4)}, ${project.LONGITUDE.toFixed(4)}</span></div>
          ${rawDetailsHtml} 
        </div>
      </div>`
    });
    advMarker.addListener("click", () => {
      infowin.open(map, advMarker);
    });
    advMarker._meta = project;
    markersBySite.set(uniqueKey, advMarker);
    return advMarker;
  }
}
// Selepas berjaya muat data dan marker
// Aktifkan semua filter kategori secara default di permulaan
["menara", "nadi", "pop", "wifi"].forEach(cat => {
  document.getElementById(`toggle-${cat}`)?.classList.add('active');
});
filterAndDisplayMarkers();
// Pada fetch fail (sheet/boundary/json) tambah alert pengguna
document.addEventListener("DOMContentLoaded", function(){
 fetchSheetObjects = async function(sheetId){ try{ ... } catch(err){ alert(`Ralat data Google Sheet: ${err.message}`); return { rows: [], cols: [] }; } };
});
// Untuk auto refresh, tambah logic berhenti selepas beberapa kali gagal
let refreshErrorCount = 0;
const autoRefreshLoopInterval = setInterval(() => { autoRefreshLoop(); }, refreshIntervalMs);
async function autoRefreshLoop() {
  try { ... refreshErrorCount = 0; } catch(e) {
    refreshErrorCount++;
    if (refreshErrorCount > 3) {
      clearInterval(autoRefreshLoopInterval);
      alert("Gagal muat data berkali-kali. Cuba reload.");
    }
  }
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRKvwm2qw29P6nRe6AFk0UMlSv356qMI0&callback=initMap" async defer></script>
</body>
</html>
