<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Web GIS Projek Sabah - Moden</title>
  
  <!-- FontAwesome & Google Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ----- GLOBAL VARS & RESET ----- */
:root {
  --primary: #4F46E5;
  --primary-dark: #4338ca;
  --glass-bg: rgba(255, 255, 255, 0.85);
  --glass-border: rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
  --blur: 12px;
  --text-main: #1f2937;
  --text-sub: #6b7280;
  --radius: 16px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  font-family: 'Plus Jakarta Sans', sans-serif;
  height: 100vh; width: 100vw;
  overflow: hidden;
  background: #eef2f5;
  color: var(--text-main);
}

/* ----- MAP CONTAINER ----- */
#map {
  position: absolute; top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 0;
}

/* ----- SEARCH BAR (TOP CENTER) ----- */
.search-container {
  position: absolute;
  top: 20px; left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  width: 90%; max-width: 400px;
  display: flex;
  gap: 10px;
}

.search-box {
  flex: 1;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  padding: 12px 20px;
  border-radius: 50px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex;
  align-items: center;
  transition: var(--transition);
}

.search-box:focus-within { transform: scale(1.02); box-shadow: 0 10px 40px rgba(79, 70, 229, 0.15); border-color: var(--primary); }
.search-box i { color: var(--text-sub); margin-right: 10px; }
.search-box input {
  border: none; background: transparent; width: 100%;
  font-family: inherit; font-size: 15px; color: var(--text-main);
}
.search-box input::placeholder { color: #9ca3af; }

/* ----- FLOATING DASHBOARD (LEFT) ----- */
.panel-toggle {
  position: absolute; top: 20px; left: 20px; z-index: 20;
  background: var(--primary); color: white;
  width: 45px; height: 45px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
  border: none;
  transition: var(--transition);
}
.panel-toggle:hover { transform: translateY(-2px); background: var(--primary-dark); }

.dashboard-panel {
  position: absolute; top: 75px; left: 20px; bottom: 20px;
  width: 320px;
  z-index: 10;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  border-radius: var(--radius);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex; flex-direction: column;
  transform: translateX(0);
  transition: var(--transition);
  opacity: 1;
  overflow: hidden;
}

.dashboard-panel.closed {
  transform: translateX(-120%);
  opacity: 0; pointer-events: none;
}

.panel-header {
  padding: 20px;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0.1));
}
.panel-header h2 { margin: 0; font-size: 18px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }

.panel-content {
  padding: 20px;
  overflow-y: auto;
  scrollbar-width: thin;
}
/* Custom Scrollbar */
.panel-content::-webkit-scrollbar { width: 6px; }
.panel-content::-webkit-scrollbar-track { background: transparent; }
.panel-content::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 20px; }

/* Stats Cards */
.main-stat {
  text-align: center; margin-bottom: 20px;
  padding: 15px; border-radius: 12px;
  background: rgba(255,255,255,0.5);
  border: 1px solid rgba(255,255,255,0.6);
}
.main-stat-value { font-size: 36px; font-weight: 800; color: var(--text-main); line-height: 1; }
.main-stat-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); margin-top: 5px; }

.area-badge {
  background: #e0e7ff; color: var(--primary);
  padding: 6px 12px; border-radius: 20px;
  font-size: 13px; font-weight: 600;
  display: inline-block; margin-top: 10px;
}

.grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.mini-stat {
  background: rgba(255,255,255,0.4); padding: 12px; border-radius: 12px;
  text-align: center; border: 1px solid rgba(255,255,255,0.4);
  transition: var(--transition);
}
.mini-stat:hover { background: rgba(255,255,255,0.7); transform: translateY(-2px); }
.mini-stat-val { font-size: 20px; font-weight: 700; color: var(--text-main); }
.mini-stat-lbl { font-size: 11px; color: var(--text-sub); }

/* Status List Styles - UPDATED FOR PROGRESS BAR & PERCENTAGE */
.status-section-title { font-size: 13px; font-weight: 700; text-transform: uppercase; color: var(--text-sub); margin: 20px 0 10px 0; }
.status-item { 
  margin-bottom: 16px; 
  background: rgba(0,0,0,0.02); 
  padding: 8px; 
  border-radius: 8px; 
} 
.status-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  font-size: 14px; 
  margin-bottom: 6px; 
  font-weight: 600; 
} 
.status-name { font-weight: 700; }
.status-count { color: var(--text-sub); font-weight: 500; margin-left: 5px; font-size: 12px; }
.status-percent { font-size: 14px; font-weight: 700; } 

.progress-bg { 
  width: 100%; 
  height: 10px; /* Thicker bar */
  background: rgba(0,0,0,0.1); /* Darker background */
  border-radius: 5px; 
  overflow: hidden; 
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); /* Inner shadow for depth */
}
.progress-fill { 
  height: 100%; 
  background: var(--primary); /* Will be overridden by JS gradient */
  border-radius: 5px; 
  width: 0%; 
  transition: width 1s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smoother transition */
}


/* ----- CONTROLS (RIGHT) ----- */
.controls-container {
  position: absolute; top: 80px; right: 20px;
  display: flex; flex-direction: column; gap: 10px;
  z-index: 10;
}

.control-card {
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  padding: 5px;
  border-radius: 12px;
  box-shadow: var(--glass-shadow);
  width: 50px; /* Collapsed width */
  overflow: hidden;
  transition: width 0.3s ease, background 0.3s;
  border: 1px solid var(--glass-border);
  white-space: nowrap;
}

.control-card:hover, .control-card.expanded {
  width: 180px; /* Expanded width */
  background: rgba(255, 255, 255, 0.95);
}

.control-group-title {
  padding: 10px 15px; font-size: 11px; font-weight: 700; 
  text-transform: uppercase; color: var(--text-sub); letter-spacing: 0.5px;
  display: none; /* Hide when collapsed */
}
.control-card.expanded .control-group-title { display: block; }

.toggle-btn {
  display: flex; align-items: center;
  width: 100%; padding: 10px;
  background: transparent; border: none; cursor: pointer;
  border-radius: 8px; color: var(--text-sub);
  transition: all 0.2s;
  text-align: left;
}
.toggle-btn i { width: 30px; text-align: center; font-size: 16px; flex-shrink: 0; }
.toggle-btn span { opacity: 0; transition: opacity 0.2s; font-size: 13px; font-weight: 500; }

/* Show text on hover/expand */
.control-card:hover .toggle-btn span, .control-card.expanded .toggle-btn span { opacity: 1; }
.control-card:hover .toggle-btn, .control-card.expanded .toggle-btn { padding: 10px 15px; }

.toggle-btn:hover { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
.toggle-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }

/* Legend Mini */
.legend-mini {
  margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05);
}
.legend-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 12px; color: var(--text-sub); }
.dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

/* ----- LOADING & INFO ----- */
.loading-overlay {
  position: absolute; inset: 0;
  background: rgba(255,255,255,0.8);
  backdrop-filter: blur(5px);
  z-index: 999;
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  transition: opacity 0.5s;
}
.loading-overlay.hide { opacity: 0; pointer-events: none; }
.spinner {
  width: 40px; height: 40px; border: 4px solid #e0e7ff;
  border-top-color: var(--primary); border-radius: 50%;
  animation: spin 1s linear infinite; margin-bottom: 10px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* InfoWindow Customization */
.gm-style .gm-style-iw-c {
  padding: 0 !important; border-radius: 12px !important;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
}
.gm-style-iw-d { overflow: hidden !important; max-height: 400px !important; }
.info-popup { padding: 0; min-width: 280px; max-width: 320px; }
.info-header { background: var(--primary); color: white; padding: 12px 16px; font-weight: 600; font-size: 14px; }
.info-body { padding: 12px 16px; background: white; max-height: 300px; overflow-y: auto; }
.info-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
.info-label { color: #666; font-weight: 500; min-width: 100px; }
.info-val { color: #111; font-weight: 600; text-align: right; overflow-wrap: break-word; max-width: 180px; }
.section-header { font-size: 11px; font-weight: 700; color: var(--primary); text-transform: uppercase; margin: 12px 0 8px 0; border-bottom: 2px solid #eee; padding-bottom: 4px; }

@media (max-width: 600px) {
  .dashboard-panel { width: calc(100% - 40px); bottom: auto; max-height: 60vh; }
  .controls-container { top: auto; bottom: 80px; right: 20px; }
  .control-card { width: 45px; }
  .control-card:hover, .control-card.expanded { width: 160px; }
  .search-container { width: 75%; }
}
</style>
</head>
<body>

  <!-- Map Background -->
  <div id="map"></div>

  <!-- Loading Screen -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div style="font-weight: 600; color: var(--primary);">Memuatkan Data GIS...</div>
  </div>

  <!-- Top Search Bar -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="search-input" placeholder="Cari tapak, daerah, atau parlimen...">
    </div>
  </div>

  <!-- Sidebar Toggle Button -->
  <button class="panel-toggle" id="sidebar-toggle" onclick="toggleDashboard()">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Floating Dashboard Panel -->
  <div class="dashboard-panel" id="dashboard-panel">
    <div class="panel-header">
      <h2><i class="fas fa-layer-group"></i> Statistik Projek</h2>
    </div>
    
    <div class="panel-content">
      <!-- Main Count -->
      <div class="main-stat">
        <div class="main-stat-value" id="total-projects">0</div>
        <div class="main-stat-label">Jumlah Projek</div>
        <div id="selected-area" class="area-badge">SELURUH SABAH</div>
      </div>

      <!-- Category Grid -->
      <div class="grid-stats">
        <div class="mini-stat">
          <div class="mini-stat-val" id="menara-count" style="color: #FF5722;">0</div>
          <div class="mini-stat-lbl">Menara</div>
        </div>
        <div class="mini-stat">
          <div class="mini-stat-val" id="nadi-count" style="color: #2196F3;">0</div>
          <div class="mini-stat-lbl">NADI</div>
        </div>
        <div class="mini-stat">
          <div class="mini-stat-val" id="wifi-count" style="color: #4CAF50;">0</div>
          <div class="mini-stat-lbl">WiFi</div>
        </div>
        <div class="mini-stat">
          <div class="mini-stat-val" id="pop-count" style="color: #FF9800;">0</div>
          <div class="mini-stat-lbl">POP</div>
        </div>
      </div>

      <!-- Status Progress Bars (Real Data) -->
      <div class="status-section-title">Status Kemajuan</div>
      <div id="status-list">
        <!-- JS will inject status bars here -->
      </div>

      <!-- Mini Legend -->
      <div class="legend-mini">
        <div class="legend-row"><span class="dot" style="background: #FF5722;"></span> Menara Komunikasi</div>
        <div class="legend-row"><span class="dot" style="background: #2196F3;"></span> Pusat NADI</div>
        <div class="legend-row"><span class="dot" style="background: #4CAF50;"></span> WiFi Komuniti</div>
        <div class="legend-row"><span class="dot" style="background: #FF9800;"></span> Point of Presence (POP)</div>
      </div>
    </div>
  </div>

  <!-- Right Side Controls (Expandable Cards) -->
  <div class="controls-container">
    
    <!-- Layer Toggle Group -->
    <div class="control-card" id="layer-card">
      <div class="control-group-title">Sempadan</div>
      <!-- Default: Daerah Active, others inactive -->
      <button class="toggle-btn active" id="toggle-daerah" title="Daerah">
        <i class="fas fa-map-marked-alt"></i> <span>Daerah</span>
      </button>
      <button class="toggle-btn" id="toggle-dun" title="DUN">
        <i class="fas fa-landmark"></i> <span>DUN</span>
      </button>
      <button class="toggle-btn" id="toggle-parliament" title="Parlimen">
        <i class="fas fa-building"></i> <span>Parlimen</span>
      </button>
    </div>

    <!-- Category Filter Group -->
    <div class="control-card" id="filter-card">
      <div class="control-group-title">Penapis Data</div>
      <!-- Default: All inactive as requested (removed 'active' class) -->
      <button class="toggle-btn" id="toggle-menara" title="Menara">
        <i class="fas fa-broadcast-tower" style="color: #FF5722;"></i> <span>Menara</span>
      </button>
      <button class="toggle-btn" id="toggle-nadi" title="NADI">
        <i class="fas fa-satellite-dish" style="color: #2196F3;"></i> <span>NADI</span>
      </button>
      <button class="toggle-btn" id="toggle-wifi" title="WiFi">
        <i class="fas fa-wifi" style="color: #4CAF50;"></i> <span>WiFi</span>
      </button>
      <button class="toggle-btn" id="toggle-pop" title="POP">
        <i class="fas fa-globe" style="color: #FF9800;"></i> <span>POP</span>
      </button>
    </div>
  </div>
  
  <!-- UI Interactions Script -->
  <script>
    function toggleDashboard() {
      const panel = document.getElementById('dashboard-panel');
      const btn = document.getElementById('sidebar-toggle');
      panel.classList.toggle('closed');
      btn.innerHTML = panel.classList.contains('closed') ? '<i class="fas fa-chart-pie"></i>' : '<i class="fas fa-times"></i>';
    }

    // Auto-expand controls on mouseover
    document.querySelectorAll('.control-card').forEach(card => {
      card.addEventListener('mouseenter', () => card.classList.add('expanded'));
      card.addEventListener('mouseleave', () => card.classList.remove('expanded'));
    });
  </script>

  <script>
    // Projek Web GIS - Updated UI/UX Logic
    // ---------- CONFIG ----------
    const URLs = {
      district: "district.json",
      dun: "dun.json",
      parliament: "parliament.json"
    };

    const SHEETS = {
      db_bwa: "1594VRWEs0PF56KXeSPudZTWkbGuS5UZmxXGrKqo4bUU",
      db_pim: "1WyZiw72LOVytssXAuymJS_TIgckLCUqY56pB0QhawZU",
      db_POP: "1JLqLtZPa4Kd6hEbRA2wgMgADX2h2-tdsXnG-YivSgU8",
      tower: "1b0Aipp0MQvP8HWc-z28dugkGn5sWdNAx6ZE5-Mu13-0"
      };

    const SHEET_TYPE = {
      db_bwa: "BWA", 
      db_pim: "NADI",
      db_POP: "POP",
      tower: "TOWER" 
    };

    const TYPE_CFG = {
      BWA: { color: "#4CAF50", icon: "üì∂", label: "WiFi" },
      NADI: { color: "#2196F3", icon: "üì°", label: "NADI" },
      POP: { color: "#FF9800", icon: "üåê", label: "POP" },
      TOWER: { color: "#FF5722", icon: "üóº", label: "Menara" }
    };

    // ---------- STATE ----------
    let map;
    let markersBySite = new Map();
    let markersList = [];
    let allProjects = [];
    let areaIndex = new Map();
    let dataLayers = { district: null, dun: null, parliament: null }; 
    let currentBoundaryKey = null; 
    let hoverInfoWindow = null;
    let refreshIntervalMs = 60_000;
    let batchSize = 300;
    let activeFeature = null;
    let activeLayer = null;
    let searchTerm = ""; // Untuk fungsi carian

    // ---------- UTIL ----------
    function showLoading(on) {
      const el = document.getElementById("loading");
      if (!el) return;
      if(on) el.classList.remove("hide");
      else el.classList.add("hide");
    }

    function escapeHtml(s){ return String(s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; };
    function randomHexColor(){ return "#" + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'); }

    function cleanFloat(val) {
        if (typeof val === 'number') return val;
        if (!val) return 0;
        const str = String(val).replace(',', '.').trim();
        return parseFloat(str) || 0;
    }

    function extractFeatureName(feature) {
      const props = ["NAME","name","DISTRICT","DAERAH","DUN","PARLIAMENT","PARLIAMEN"];
      let name = "Sabah";
      for (const k of props) {
        try {
          const v = feature.getProperty(k);
          if (v) { name = v; break; }
        } catch(_) {}
      }
      return String(name).trim();
    }

    function resetAllLayerStyles() {
        Object.keys(dataLayers).forEach(k => {
            const dl = dataLayers[k];
            if (dl) dl.revertStyle(); 
        });
        activeFeature = null;
        activeLayer = null;
    }

    // ---------- GVIZ parse ----------
    function parseGviz(text) {
      try {
        const start = text.indexOf('{');
        const end = text.lastIndexOf('}');
        if (start === -1 || end === -1) return null;
        return JSON.parse(text.substring(start, end+1));
      } catch(e) {
        console.error("parseGviz failed", e);
        return null;
      }
    }

    // ---------- Google Sheets fetch & normalize ----------
    async function fetchSheetObjects(sheetId) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Sheet fetch ${sheetId} failed (${res.status})`);
      const text = await res.text();
      const json = parseGviz(text);
      if (!json || !json.table) return { rows: [], cols: [] };

      const rawCols = json.table.cols.map(c => (c && c.label) ? c.label.toUpperCase() : "");
      const rows = json.table.rows || [];
      
      const processedRows = rows.map(r => {
        const obj = {};
        rawCols.forEach((c, i) => obj[c ? c : `COL${i}`] = (r.c && r.c[i] ? r.c[i].v : ""));
        return obj;
      });
      
      return { rows: processedRows, cols: rawCols.filter(c => c && !c.startsWith("COL")) }; 
    }

    function normalizeRows(rows, sheetKey, rawCols) {
      const normalizedKeys = new Set(["SITE_NAME", "SITE NAME", "SITE", "DISTRICT", "DAERAH", "DUN", "PARLIAMENT", "PARLIAMENT_NAME", "LATITUDE", "LAT", "LONGITUDE", "LON", "LNG", "STATUS", "STATUS_1"]);
      
      const normalized = rows.map((r, i) => {
        const get = k => (r[k] !== undefined ? r[k] : (r[k.toLowerCase()] !== undefined ? r[k.toLowerCase()] : ""));
        const site = get("SITE_NAME") || get("SITE NAME") || get("SITE") || "";
        const district = get("DISTRICT") || get("DAERAH") || "";
        const dun = get("DUN") || "";
        const parliament = get("PARLIAMENT") || get("PARLIAMENT_NAME") || "";
        
        const lat = cleanFloat(get("LATITUDE") || get("LAT") || get("LATITUDE_DEC"));
        const lng = cleanFloat(get("LONGITUDE") || get("LON") || get("LNG"));
        
        // Normalize status untuk memastikan data konsisten untuk filtering
        const rawStatus = get("STATUS") || get("STATUS_1") || "Tiada Status";
        
        // Extract raw details - Limit to first 15 distinct columns that are NOT main keys
        const rawDetails = [];
        let count = 0;
        
        // Iterate all cols to find first 15 valid additional properties
        for(let colIndex=0; colIndex < rawCols.length && count < 15; colIndex++) {
            const key = rawCols[colIndex]; 
            if (normalizedKeys.has(key)) continue; // Skip main keys
            
            const value = r[key];
            if (value !== null && value !== "" && value !== undefined) {
                rawDetails.push({ label: key, value: String(value).trim() });
                count++;
            }
        }
        
        return {
          _id: `${sheetKey}_row_${i}`, 
          SITE_NAME: String(site || "").trim(),
          DISTRICT: String(district || "").trim(),
          DUN: String(dun || "").trim(),
          PARLIAMENT: String(parliament || "").trim(),
          LATITUDE: lat,
          LONGITUDE: lng,
          STATUS: String(rawStatus).trim(),
          _sheet: sheetKey,
          _type: SHEET_TYPE[sheetKey] || "UNKNOWN",
          _raw_details: rawDetails 
        };
      }).filter(o => o.SITE_NAME); 
      return normalized;
    }

    function buildAreaIndex() {
      areaIndex.clear();
      allProjects.forEach(p => {
        [p.DISTRICT, p.DUN, p.PARLIAMENT].forEach(k => {
          if (!k) return;
          const key = String(k).trim();
          if (!areaIndex.has(key)) areaIndex.set(key, new Set());
          areaIndex.get(key).add(p.SITE_NAME);
        });
      });
    }

    // ---------- MARKERS ----------
    function createOrUpdateMarker(project) {
      const uniqueKey = project._id;
      const cfg = TYPE_CFG[project._type] || { color: "#333", icon: "üìç" };
      
      if (markersBySite.has(uniqueKey)) {
        const m = markersBySite.get(uniqueKey);
        const pos = m.getPosition();
        if (!pos || pos.lat().toFixed(6) !== Number(project.LATITUDE).toFixed(6) || pos.lng().toFixed(6) !== Number(project.LONGITUDE).toFixed(6)) {
          m.setPosition({ lat: Number(project.LATITUDE), lng: Number(project.LONGITUDE) });
        }
        m._meta = project;
        return m;
      } else {
        
        // Jana HTML untuk 15 column tambahan
        let rawDetailsHtml = project._raw_details.map(detail => 
            `<div class="info-row"><span class="info-label">${escapeHtml(detail.label)}</span><span class="info-val">${escapeHtml(detail.value)}</span></div>`
        ).join('');

        if(rawDetailsHtml) {
            rawDetailsHtml = `<div class="section-header">Maklumat Tambahan</div>` + rawDetailsHtml;
        }

        const marker = new google.maps.Marker({
          position: { lat: Number(project.LATITUDE), lng: Number(project.LONGITUDE) },
          map: map,
          title: project.SITE_NAME || "",
          visible: false, // Default: Hidden (OFF)
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 6,
            fillColor: cfg.color,
            fillOpacity: 1,
            strokeColor: "#ffffff",
            strokeWeight: 2
          }
        });

        // Kemaskini InfoWindow mengikut permintaan (Main info explicitly listed)
        const infowin = new google.maps.InfoWindow({
          content: `
            <div class="info-popup">
              <div class="info-header">${cfg.icon} ${escapeHtml(project.SITE_NAME)}</div>
              <div class="info-body">
                <div class="section-header">Maklumat Utama</div>
                <div class="info-row"><span class="info-label">Kategori</span><span class="info-val">${cfg.label}</span></div>
                <div class="info-row"><span class="info-label">Daerah</span><span class="info-val">${escapeHtml(project.DISTRICT)}</span></div>
                <div class="info-row"><span class="info-label">DUN</span><span class="info-val">${escapeHtml(project.DUN)}</span></div>
                <div class="info-row"><span class="info-label">Parlimen</span><span class="info-val">${escapeHtml(project.PARLIAMENT)}</span></div>
                <div class="info-row"><span class="info-label">Status</span><span class="info-val" style="color:${cfg.color}">${escapeHtml(project.STATUS)}</span></div>
                <div class="info-row"><span class="info-label">Latitude</span><span class="info-val">${project.LATITUDE.toFixed(5)}</span></div>
                <div class="info-row"><span class="info-label">Longitude</span><span class="info-val">${project.LONGITUDE.toFixed(5)}</span></div>
                
                ${rawDetailsHtml} 
              </div>
            </div>
          `
        });

        marker.addListener("click", () => {
          infowin.open(map, marker);
        });

        marker._meta = project;
        markersBySite.set(uniqueKey, marker);
        markersList.push(marker);
        return marker;
      }
    }

    function renderMarkersInBatches(projects, onComplete) {
      const total = projects.length;
      let i = 0;
      if (total === 0) {
          if (typeof onComplete === "function") onComplete();
          return;
      }

      const runChunk = () => {
        const end = Math.min(i + batchSize, total);
        for (; i < end; i++) {
          const p = projects[i];
          createOrUpdateMarker(p);
        }
        if (i < total) {
          if (window.requestIdleCallback) window.requestIdleCallback(runChunk, { timeout: 200 });
          else setTimeout(runChunk, 50);
        } else {
          if (typeof onComplete === "function") onComplete();
        }
      };
      runChunk();
    }

    function filterAndDisplayMarkers() {
        // Check toggle status from DOM class 'active'
        const menaraActive = document.getElementById("toggle-menara")?.classList.contains("active");
        const nadiActive = document.getElementById("toggle-nadi")?.classList.contains("active");
        const popActive = document.getElementById("toggle-pop")?.classList.contains("active");
        const wifiActive = document.getElementById("toggle-wifi")?.classList.contains("active");

        let filteredList = allProjects;
        
        // Tapis mengikut kawasan (Sempadan)
        if (activeFeature && currentBoundaryKey) {
            let areaName = extractFeatureName(activeFeature);
            filteredList = allProjects.filter(p => {
                if (currentBoundaryKey === 'district') return p.DISTRICT === areaName;
                if (currentBoundaryKey === 'dun') return p.DUN === areaName;
                if (currentBoundaryKey === 'parliament') return p.PARLIAMENT === areaName;
                return false;
            });
        }

        // Tapis mengikut Carian (Search)
        if (searchTerm && searchTerm.length > 0) {
          const term = searchTerm.toLowerCase();
          filteredList = filteredList.filter(p => 
            (p.SITE_NAME && p.SITE_NAME.toLowerCase().includes(term)) ||
            (p.DISTRICT && p.DISTRICT.toLowerCase().includes(term)) ||
            (p.PARLIAMENT && p.PARLIAMENT.toLowerCase().includes(term))
          );
        }

        updateDashboard(filteredList);
        
        const visibleProjectKeys = new Set(
            filteredList
                .filter(p => p.LATITUDE !== 0 && p.LONGITUDE !== 0) 
                .map(p => p._id) 
        );

        markersList.forEach(m => {
            const type = m._meta._type;
            let isCategoryActive = false;

            if (type === "TOWER") isCategoryActive = menaraActive;
            else if (type === "BWA") isCategoryActive = wifiActive;
            else if (type === "NADI") isCategoryActive = nadiActive;
            else if (type === "POP") isCategoryActive = popActive;

            // Logic: Marker visible ONLY if category button is ACTIVE AND project is in filtered list
            const isVisible = visibleProjectKeys.has(m._meta._id) && isCategoryActive;
            m.setVisible(isVisible);
        });
    }

    const updateDashboard = debounce(function(list) {
      const displayList = list || allProjects || [];
      
      // Animate numbers
      animateValue("total-projects", parseInt(document.getElementById("total-projects").textContent), displayList.length, 500);
      
      const counts = { menara:0, nadi:0, wifi:0, pop:0 };
      
      // 1. Dynamic Status Counting based on actual data header "STATUS"
      const dynamicStatusCounts = {};

      displayList.forEach(p => {
        // Category Counts
        if (p._type === "TOWER") counts.menara++;
        if (p._type === "BWA") counts.wifi++;
        if (p._type === "NADI") counts.nadi++;
        if (p._type === "POP") counts.pop++;

        // Populate dynamic status counts
        const s = String(p.STATUS || "Tidak Dinyatakan").trim(); 
        if (s) {
          dynamicStatusCounts[s] = (dynamicStatusCounts[s] || 0) + 1;
        }
      });
      
      document.getElementById("menara-count").textContent = counts.menara;
      document.getElementById("nadi-count").textContent = counts.nadi;
      document.getElementById("wifi-count").textContent = counts.wifi;
      document.getElementById("pop-count").textContent = counts.pop;

      // Render Status Bars - Dynamic Status (UPDATED)
      const statusEl = document.getElementById("status-list");
      statusEl.innerHTML = "";
      
      // Sort the statuses for consistent display (e.g., by count descending)
      const sortedStatuses = Object.entries(dynamicStatusCounts)
          .sort(([, countA], [, countB]) => countB - countA); // Sort by count descending

      const totalProjects = displayList.length;

      sortedStatuses.forEach(([statusName, count]) => {
        const percent = totalProjects > 0 ? Math.round((count / totalProjects) * 100) : 0;
        const barWidth = percent; 
        
        // Simple color logic for dynamic statuses, using a fallback and making key statuses distinct.
        let endColor = "#4F46E5"; // Default primary color
        let startColor = "#818cf8";

        const statusUpper = statusName.toUpperCase();
        if(statusUpper.includes("SIAP") || statusUpper.includes("SELESAI") || statusUpper.includes("COMPLETE")) { 
            endColor = "#4CAF50"; startColor = "#81c784"; // Green (Siap)
        } else if(statusUpper.includes("BINA") || statusUpper.includes("IMPLEMENTASI") || statusUpper.includes("PEMBINAAN") || statusUpper.includes("IN PROGRESS")) { 
            endColor = "#2196F3"; startColor = "#64b5f6"; // Blue (Pembinaan/Implementasi) 
        } else if(statusUpper.includes("TANGGUH") || statusUpper.includes("DIBATALKAN") || statusUpper.includes("CANCEL")) {
            endColor = "#F44336"; startColor = "#e57373"; // Red (Tertangguh/Dibatalkan)
        } else if(statusUpper.includes("RANCANG") || statusUpper.includes("PLANNING") || statusUpper.includes("BARU")) {
            endColor = "#FF9800"; startColor = "#ffb74d"; // Orange (Perancangan/Baru)
        } 

        const div = document.createElement("div");
        div.className = "status-item";
        div.innerHTML = `
          <div class="status-header">
            <span class="status-name">${escapeHtml(statusName)}</span>
            <div>
                <!-- Format yang diminta: N (P%) -->
                <span class="status-percent" style="color: ${endColor};">${count} (${percent}%)</span>
            </div>
          </div>
          <div class="progress-bg">
            <div class="progress-fill" style="width: ${barWidth}%; background: linear-gradient(90deg, ${startColor}, ${endColor});"></div>
          </div>
        `;
        statusEl.appendChild(div);
      });
    }, 200);

    // Helper util for smooth number transition
    function animateValue(id, start, end, duration) {
        if (start === end) return;
        const range = end - start;
        let current = start;
        const increment = end > start ? 1 : -1;
        const stepTime = Math.abs(Math.floor(duration / range));
        const obj = document.getElementById(id);
        if (!obj) return;
        
        const timer = setInterval(function() {
            current += increment;
            obj.innerHTML = current;
            if (current == end) {
                clearInterval(timer);
            }
        }, Math.max(stepTime, 10)); // Min 10ms
    }


    async function loadAllSheetsAndNormalize() {
      const entries = Object.entries(SHEETS);
      const promises = entries.map(([k,id]) => fetchSheetObjectsSafe(k, id));
      const results = await Promise.all(promises);
      const combined = results.flat();
      allProjects = combined;
      buildAreaIndex();
      return combined;
    }

    async function fetchSheetObjectsSafe(sheetKey, id) {
      try {
        const data = await fetchSheetObjects(id); 
        return normalizeRows(data.rows, sheetKey, data.cols);
      } catch (e) {
        console.warn("sheet load fail", sheetKey, e);
        return [];
      }
    }

    async function loadGeoJsonLayer(key, url, baseStyle = {}) {
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("geojson fetch failed " + url);
        const json = await resp.json();

        const layer = new google.maps.Data({ map: null });
        layer.addGeoJson(json);
        
        layer._baseStyle = { 
            strokeWeight: baseStyle.strokeWeight || 1,
            strokeColor: baseStyle.strokeColor || "#666",
            fillOpacity: 0.05,
            fillColor: (baseStyle.fillColor || "#FFF")
        };
        layer.setStyle(feature => layer._baseStyle);

        layer.addListener("mouseover", e => {
          if (!layer.getMap()) return;
          if (activeFeature === e.feature) return;

          const hoverStyle = {
            strokeWeight: 2,
            strokeColor: "#4F46E5",
            fillOpacity: 0.3,
            fillColor: "#818cf8"
          };
          layer.overrideStyle(e.feature, hoverStyle);

          if (!hoverInfoWindow) hoverInfoWindow = new google.maps.InfoWindow();
          const title = extractFeatureName(e.feature);
          hoverInfoWindow.setContent(`<div style="padding:8px 12px; font-weight:600; color:#4F46E5;">${escapeHtml(title)}</div>`);
          if (e.latLng) hoverInfoWindow.setPosition(e.latLng);
          hoverInfoWindow.open(map);
        });

        layer.addListener("mouseout", e => {
          if (!layer.getMap()) return;
          if (activeFeature !== e.feature) {
              try { layer.revertStyle(e.feature); } catch(_) {}
          }
          if (hoverInfoWindow) hoverInfoWindow.close();
        });

        layer.addListener("click", e => {
          const featureName = extractFeatureName(e.feature);
          document.getElementById("selected-area").textContent = featureName;
          
          handleFeatureClick(key, e.feature);
          
          try {
            const bounds = new google.maps.LatLngBounds();
            e.feature.getGeometry().forEachLatLng && e.feature.getGeometry().forEachLatLng(ll => bounds.extend(ll));
            map.fitBounds(bounds);
          } catch(_) {}
        });

        dataLayers[key] = layer;
        return layer;
      } catch (e) {
        console.warn("loadGeoJsonLayer error", key, e);
        return null;
      }
    }

    function handleFeatureClick(key, feature) {
        const layerObj = dataLayers[key];
        if (!layerObj) return;

        toggleBoundaryLayerVisibility(key); 
        resetAllLayerStyles(); 

        const activeStyle = {
            strokeWeight: 2,
            strokeColor: "#4338ca",
            fillOpacity: 0.5,
            fillColor: "#4338ca"
        };
        layerObj.overrideStyle(feature, activeStyle);

        activeFeature = feature;
        activeLayer = layerObj;
        currentBoundaryKey = key;
        
        filterAndDisplayMarkers();
    }

    function toggleBoundaryLayerVisibility(key) {
        Object.keys(dataLayers).forEach(k => {
            const dl = dataLayers[k];
            if (dl) dl.setMap(k === key ? map : null);
        });
        
        if (currentBoundaryKey !== key) {
            resetAllLayerStyles();
        }
        
        updateToggleButtonsUI(key);
        currentBoundaryKey = key;
    }

    function updateToggleButtonsUI(activeKey) {
      const mapping = { district: "toggle-daerah", dun: "toggle-dun", parliament: "toggle-parliament" };
      Object.keys(mapping).forEach(k => {
        const btn = document.getElementById(mapping[k]);
        if (!btn) return;
        if (k === activeKey) btn.classList.add("active");
        else btn.classList.remove("active");
      });
    }

    function setupToggles() {
      const categories = ["menara", "nadi", "pop", "wifi"];
      categories.forEach(cat => {
          document.getElementById(`toggle-${cat}`).addEventListener("click", function(){
            this.classList.toggle("active");
            filterAndDisplayMarkers();
          });
      });
      
      const boundaries = [
          {id: "toggle-daerah", key: "district"},
          {id: "toggle-dun", key: "dun"},
          {id: "toggle-parliament", key: "parliament"}
      ];

      boundaries.forEach(b => {
          document.getElementById(b.id).addEventListener("click", function(){
            // Jika sudah aktif, matikan (toggle off)
            if(this.classList.contains('active') && currentBoundaryKey === b.key) {
                this.classList.remove('active');
                dataLayers[b.key].setMap(null);
                currentBoundaryKey = null;
                activeFeature = null;
                document.getElementById("selected-area").textContent = "SELURUH SABAH";
            } else {
                toggleBoundaryLayerVisibility(b.key);
                document.getElementById("selected-area").textContent = "SABAH (" + b.key.toUpperCase() + ")";
            }
            filterAndDisplayMarkers(); 
          });
      });

      // Setup Search Listener
      const searchInput = document.getElementById("search-input");
      if(searchInput) {
          searchInput.addEventListener("input", (e) => {
              searchTerm = e.target.value;
              filterAndDisplayMarkers();
          });
      }
    }

    async function autoRefreshLoop() {
      try {
        const newProjects = await loadAllSheetsAndNormalize();
        newProjects.forEach(np => createOrUpdateMarker(np));
        
        const newKeys = new Set(newProjects.map(p => p._id));
        for (const [key,m] of markersBySite.entries()) {
          if (!newKeys.has(key)) {
            m.setMap(null);
            markersBySite.delete(key);
          }
        }
        markersList = Array.from(markersBySite.values());
        allProjects = newProjects;
        buildAreaIndex();
        
        filterAndDisplayMarkers();

      } catch (e) {
        console.warn("autoRefreshLoop failed", e);
      }
    }

    async function initMap() {
      const mapDiv = document.getElementById("map");
      if(!mapDiv) {
          console.error("Map DIV not found");
          return;
      }

      // Google Maps Style: Clean & Modern (Silver/Grayscale)
      const silverStyle = [
        { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
        { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
        { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
        { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] },
        { featureType: "administrative.land_parcel", elementType: "labels.text.fill", stylers: [{ color: "#bdbdbd" }] },
        { featureType: "poi", elementType: "geometry", stylers: [{ color: "#eeeeee" }] },
        { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
        { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
        { featureType: "road.arterial", elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
        { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#dadada" }] },
        { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
        { featureType: "water", elementType: "geometry", stylers: [{ color: "#c9c9c9" }] },
        { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] }
      ];

      map = new google.maps.Map(mapDiv, {
        center: { lat: 5.9804, lng: 116.0735 }, // Sabah
        zoom: 8,
        mapTypeId: "roadmap", 
        styles: silverStyle,
        disableDefaultUI: false, 
        streetViewControl: false,
        mapTypeControl: true,
        mapTypeControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT, style: google.maps.MapTypeControlStyle.DROPDOWN_MENU },
        zoomControl: true,
        zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_BOTTOM }
      });
      
      showLoading(true);

      try {
        const projects = await loadAllSheetsAndNormalize();

        renderMarkersInBatches(projects, () => {
          markersList = Array.from(markersBySite.values());
          // Default: Hidden
          markersList.forEach(m => m.setVisible(false));
          updateDashboard(allProjects);
        });

        // Load layers but catch errors safely if JSON files are missing
        const pDistrict = loadGeoJsonLayer("district", URLs.district).catch(e => null);
        const pDun = loadGeoJsonLayer("dun", URLs.dun).catch(e => null);
        const pPar = loadGeoJsonLayer("parliament", URLs.parliament).catch(e => null);

        google.maps.event.addListenerOnce(map, "idle", async () => {
          const ld = await pDistrict;
          await pDun;
          await pPar;
          
          // Default View Logic:
          // Hanya aktifkan layer daerah (district)
          if (ld) {
            dataLayers['district'].setMap(map);
            currentBoundaryKey = 'district';
          }
          
          // Pastikan fungsi toggle menghormati kelas 'active' di HTML
          setupToggles();
          
          // Filter awal - semak butang 'active' (sekarang semua OFF default untuk markers)
          filterAndDisplayMarkers();
        });

        setInterval(() => { autoRefreshLoop(); }, refreshIntervalMs);

      } catch (e) {
        console.error("initMap main error", e);
        console.error("Gagal memuatkan data. Sila semak sambungan internet.");
      } finally {
        showLoading(false);
      }
    }

    window.initMap = initMap;
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRKvwm2qw29P6nRe6AFk0UMlSv356qMI0&callback=initMap">
  </script>
</body>
</html>
