<!doctype html>
<html lang="ms">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
Â  <title>Web GIS Projek Sabah - Moden</title>
Â Â 
Â  <!-- FontAwesome & Google Fonts -->
Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
Â  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ----- GLOBAL VARS & RESET ----- */
:root {
Â  --primary: #4F46E5;
Â  --primary-dark: #4338ca;
Â  --glass-bg: rgba(255, 255, 255, 0.45);Â  /* SMS dulu 0.85 */
Â  --glass-border: rgba(255, 255, 255, 0.5);
Â  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
Â  --blur: 12px;
Â  --text-main: #1f2937;
Â  --text-sub: #6b7280;
Â  --radius: 16px;
Â  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body {
Â  margin: 0; padding: 0;
Â  font-family: 'Plus Jakarta Sans', sans-serif;
Â  height: 100vh; width: 100vw;
Â  overflow: hidden;
Â  background: #eef2f5;
Â  color: var(--text-main);
}

/* ----- MAP CONTAINER ----- */
#map {
Â  position: absolute; top: 0; left: 0;
Â  width: 100%; height: 100%;
Â  z-index: 0;
}

/* ----- SEARCH BAR (TOP CENTER) ----- */
.search-container {
Â  position: absolute;
Â  top: 20px; left: 50%;
Â  transform: translateX(-50%);
Â  z-index: 10;
Â  width: 90%; max-width: 400px;
Â  display: flex;
Â  gap: 10px;
}

.search-box {
Â  flex: 1;
Â  background: var(--glass-bg);
Â  backdrop-filter: blur(var(--blur));
Â  -webkit-backdrop-filter: blur(var(--blur));
Â  padding: 12px 20px;
Â  border-radius: 50px;
Â  border: 1px solid var(--glass-border);
Â  box-shadow: var(--glass-shadow);
Â  display: flex;
Â  align-items: center;
Â  transition: var(--transition);
}

.search-box:focus-within { transform: scale(1.02); box-shadow: 0 10px 40px rgba(79, 70, 229, 0.15); border-color: var(--primary); }
.search-box i { color: var(--text-sub); margin-right: 10px; }
.search-box input {
Â  border: none; background: transparent; width: 100%;
Â  font-family: inherit; font-size: 15px; color: var(--text-main);
}
.search-box input::placeholder { color: #9ca3af; }

/* ----- FLOATING DASHBOARD (LEFT) ----- */
.panel-toggle {
Â  position: absolute; top: 20px; left: 20px; z-index: 20;
Â  background: var(--primary); color: white;
Â  width: 45px; height: 45px;
Â  border-radius: 12px;
Â  display: flex; align-items: center; justify-content: center;
Â  cursor: pointer;
Â  box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
Â  border: none;
Â  transition: var(--transition);
}
.panel-toggle:hover { transform: translateY(-2px); background: var(--primary-dark); }

.dashboard-panel {
Â  position: absolute; top: 75px; left: 20px; bottom: 20px;
Â  width: 320px;
Â  z-index: 10;
Â  background: var(--glass-bg);
Â  backdrop-filter: blur(var(--blur));
Â  -webkit-backdrop-filter: blur(var(--blur));
Â  border-radius: var(--radius);
Â  border: 1px solid var(--glass-border);
Â  box-shadow: var(--glass-shadow);
Â  display: flex; flex-direction: column;
Â  transform: translateX(0);
Â  transition: var(--transition);
Â  opacity: 1;
Â  overflow: hidden;
}

.dashboard-panel.closed {
Â  transform: translateX(-120%);
Â  opacity: 0; pointer-events: none;
}

.panel-header {
Â  padding: 20px;
Â  border-bottom: 1px solid rgba(0,0,0,0.05);
Â  background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0.1));
}
.panel-header h2 { margin: 0; font-size: 18px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }

.panel-content {
Â  padding: 20px;
Â  overflow-y: auto;
Â  scrollbar-width: thin;
}
/* Custom Scrollbar */
.panel-content::-webkit-scrollbar { width: 6px; }
.panel-content::-webkit-scrollbar-track { background: transparent; }
.panel-content::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 20px; }

/* Stats Cards */
.main-stat {
Â  text-align: center; margin-bottom: 20px;
Â  padding: 15px; border-radius: 12px;
Â  background: rgba(255,255,255,0.5);
Â  border: 1px solid rgba(255,255,255,0.6);
}
.main-stat-value { font-size: 36px; font-weight: 800; color: var(--text-main); line-height: 1; }
.main-stat-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); margin-top: 5px; }

.area-badge {
Â  background: #e0e7ff; color: var(--primary);
Â  padding: 6px 12px; border-radius: 20px;
Â  font-size: 13px; font-weight: 600;
Â  display: inline-block; margin-top: 10px;
}

.grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.mini-stat {
Â  background: rgba(255,255,255,0.4); padding: 12px; border-radius: 12px;
Â  text-align: center; border: 1px solid rgba(255,255,255,0.4);
Â  transition: var(--transition);
}
.mini-stat:hover { background: rgba(255,255,255,0.7); transform: translateY(-2px); }
.mini-stat-val { font-size: 20px; font-weight: 700; color: var(--text-main); }
.mini-stat-lbl { font-size: 11px; color: var(--text-sub); }

/* Status List Styles - UPDATED FOR PROGRESS BAR & PERCENTAGE */
.status-section-title { font-size: 13px; font-weight: 700; text-transform: uppercase; color: var(--text-sub); margin: 20px 0 10px 0; }
.status-item {Â 
Â  margin-bottom: 16px;Â 
Â  background: rgba(0,0,0,0.02);Â 
Â  padding: 8px;Â 
Â  border-radius: 8px;Â 
Â  cursor: pointer; /* NEW: Indicate clickable */
Â  transition: background 0.2s, box-shadow 0.2s;
}Â 
.status-item:hover {
Â  background: rgba(79, 70, 229, 0.05);
}
.status-item.status-active { /* NEW: Active state for status item */
Â  background: rgba(79, 70, 229, 0.1);
Â  box-shadow: 0 0 10px rgba(79, 70, 229, 0.1);
}

.status-header {Â 
Â  display: flex;Â 
Â  justify-content: space-between;Â 
Â  align-items: center;Â 
Â  font-size: 14px;Â 
Â  margin-bottom: 6px;Â 
Â  font-weight: 600;Â 
}Â 
.status-name { font-weight: 700; }
.status-count { color: var(--text-sub); font-weight: 500; margin-left: 5px; font-size: 12px; }
.status-percent { font-size: 14px; font-weight: 700; }Â 

.progress-bg {Â 
Â  width: 100%;Â 
Â  height: 10px; /* Thicker bar */
Â  background: rgba(0,0,0,0.1); /* Darker background */
Â  border-radius: 5px;Â 
Â  overflow: hidden;Â 
Â  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); /* Inner shadow for depth */
}
.progress-fill {Â 
Â  height: 100%;Â 
Â  background: var(--primary); /* Will be overridden by JS gradient */
Â  border-radius: 5px;Â 
Â  width: 0%;Â 
Â  transition: width 1s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smoother transition */
}


/* ----- NEW: Nested Breakdown Card Styles ----- */
.status-breakdown-card {
Â  overflow: hidden;
Â  max-height: 0;
Â  opacity: 0;
Â  transition: max-height 0.5s ease-in-out, opacity 0.5s;
}

.status-active .status-breakdown-card {
Â  max-height: 500px; /* Cukup besar untuk menampung kandungan */
Â  opacity: 1;
}

.breakdown-content {
Â  padding: 10px 5px 5px 5px;
Â  margin-top: 10px;
Â  border-top: 1px solid rgba(0,0,0,0.05);
}

.category-breakdown-item {
Â  margin-bottom: 10px;
}
.category-header {
Â  display: flex;
Â  justify-content: space-between;
Â  align-items: center;
Â  font-size: 12px;
Â  font-weight: 600;
Â  margin-bottom: 4px;
}
.category-name {
Â  display: flex;
Â  align-items: center;
Â  gap: 5px;
Â  font-weight: 700;
}
.category-percent {
Â  font-weight: 500;
Â  color: var(--text-sub);
}

.category-progress-bg {
Â  width: 100%;
Â  height: 6px;
Â  background: rgba(0,0,0,0.05);
Â  border-radius: 3px;
Â  overflow: hidden;
}
.category-progress-fill {
Â  height: 100%;
Â  width: 0%;
Â  border-radius: 3px;
Â  transition: width 0.8s ease-out;
}


/* ----- CONTROLS (RIGHT) ----- */
.controls-container {
Â  position: absolute; top: 80px; right: 20px;
Â  display: flex; flex-direction: column; gap: 10px;
Â  z-index: 10;
}

.control-card {
Â  background: var(--glass-bg);
Â  backdrop-filter: blur(var(--blur));
Â  -webkit-backdrop-filter: blur(var(--blur));
Â  padding: 5px;
Â  border-radius: 12px;
Â  box-shadow: var(--glass-shadow);
Â  width: 50px; /* Collapsed width */
Â  overflow: hidden;
Â  transition: width 0.3s ease, background 0.3s;
Â  border: 1px solid var(--glass-border);
Â  white-space: nowrap;
}

.control-card:hover, .control-card.expanded {
Â  width: 180px; /* Expanded width */
Â  background: rgba(255, 255, 255, 0.55); /* SMS dulu 0.95 */
}

.control-group-title {
Â  padding: 10px 15px; font-size: 11px; font-weight: 700;Â 
Â  text-transform: uppercase; color: var(--text-sub); letter-spacing: 0.5px;
Â  display: none; /* Hide when collapsed */
}
.control-card.expanded .control-group-title { display: block; }

.toggle-btn {
Â  display: flex; align-items: center;
Â  width: 100%; padding: 10px;
Â  background: transparent; border: none; cursor: pointer;
Â  border-radius: 8px; color: var(--text-sub);
Â  transition: all 0.2s;
Â  text-align: left;
}
.toggle-btn i { width: 30px; text-align: center; font-size: 16px; flex-shrink: 0; }
.toggle-btn span { opacity: 0; transition: opacity 0.2s; font-size: 13px; font-weight: 500; }

/* Show text on hover/expand */
.control-card:hover .toggle-btn span, .control-card.expanded .toggle-btn span { opacity: 1; }
.control-card:hover .toggle-btn, .control-card.expanded .toggle-btn { padding: 10px 15px; }

.toggle-btn:hover { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
.toggle-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }

/* Legend Mini */
.legend-mini {
Â  margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05);
}
.legend-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 12px; color: var(--text-sub); }
.dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

/* ----- LOADING & INFO ----- */
.loading-overlay {
Â  position: absolute; inset: 0;
Â  background: rgba(255,255,255,0.8);
Â  backdrop-filter: blur(5px);
Â  z-index: 999;
Â  display: flex; flex-direction: column;
Â  justify-content: center; align-items: center;
Â  transition: opacity 0.5s;
}
.loading-overlay.hide { opacity: 0; pointer-events: none; }
.spinner {
Â  width: 40px; height: 40px; border: 4px solid #e0e7ff;
Â  border-top-color: var(--primary); border-radius: 50%;
Â  animation: spin 1s linear infinite; margin-bottom: 10px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* InfoWindow Customization */
.gm-style .gm-style-iw-c {
Â  padding: 0 !important; border-radius: 12px !important;
Â  box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
}
.gm-style-iw-d { overflow: hidden !important; max-height: 400px !important; }
.info-popup { padding: 0; min-width: 280px; max-width: 320px; }
.info-header { background: var(--primary); color: white; padding: 12px 16px; font-weight: 600; font-size: 14px; }
.info-body { padding: 12px 16px; background: white; max-height: 300px; overflow-y: auto; }
.info-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
.info-label { color: #666; font-weight: 500; min-width: 100px; }
.info-val { color: #111; font-weight: 600; text-align: right; overflow-wrap: break-word; max-width: 180px; }
.section-header { font-size: 11px; font-weight: 700; color: var(--primary); text-transform: uppercase; margin: 12px 0 8px 0; border-bottom: 2px solid #eee; padding-bottom: 4px; }

@media (max-width: 600px) {
Â  .dashboard-panel { width: calc(100% - 40px); bottom: auto; max-height: 60vh; }
Â  .controls-container { top: auto; bottom: 80px; right: 20px; }
Â  .control-card { width: 45px; }
Â  .control-card:hover, .control-card.expanded { width: 160px; }
Â  .search-container { width: 75%; }
}
</style>
</head>
<body>

Â  <!-- Map Background -->
Â  <div id="map"></div>

Â  <!-- Loading Screen -->
Â  <div class="loading-overlay" id="loading">
Â  Â  <div class="spinner"></div>
Â  Â  <div style="font-weight: 600; color: var(--primary);">Memuatkan Data GIS...</div>
Â  </div>

Â  <!-- Top Search Bar -->
Â  <div class="search-container">
Â  Â  <div class="search-box">
Â  Â  Â  <i class="fas fa-search"></i>
Â  Â  Â  <input type="text" id="search-input" placeholder="Cari tapak, daerah, atau parlimen...">
Â  Â  </div>
Â  </div>

Â  <!-- Sidebar Toggle Button -->
Â  <button class="panel-toggle" id="sidebar-toggle" onclick="toggleDashboard()">
Â  Â  <i class="fas fa-bars"></i>
Â  </button>

Â  <!-- Floating Dashboard Panel -->
Â  <div class="dashboard-panel" id="dashboard-panel">
Â  Â  <div class="panel-header">
Â  Â  Â  <h2><i class="fas fa-layer-group"></i> Statistik Projek</h2>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="panel-content">
Â  Â  Â  <!-- Main Count -->
Â  Â  Â  <div class="main-stat">
Â  Â  Â  Â  <div class="main-stat-value" id="total-projects">0</div>
Â  Â  Â  Â  <div class="main-stat-label">Jumlah Projek</div>
Â  Â  Â  Â  <div id="selected-area" class="area-badge">SELURUH SABAH</div>
Â  Â  Â  </div>

Â  Â  Â  <!-- Category Grid -->
Â  Â  Â  <div class="grid-stats">
Â  Â  Â  Â  <div class="mini-stat">
Â  Â  Â  Â  Â  <div class="mini-stat-val" id="menara-count" style="color: #FF5722;">0</div>
Â  Â  Â  Â  Â  <div class="mini-stat-lbl">Menara</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mini-stat">
Â  Â  Â  Â  Â  <div class="mini-stat-val" id="nadi-count" style="color: #2196F3;">0</div>
Â  Â  Â  Â  Â  <div class="mini-stat-lbl">NADI</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mini-stat">
Â  Â  Â  Â  Â  <div class="mini-stat-val" id="wifi-count" style="color: #4CAF50;">0</div>
Â  Â  Â  Â  Â  <div class="mini-stat-lbl">WiFi</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mini-stat">
Â  Â  Â  Â  Â  <div class="mini-stat-val" id="pop-count" style="color: #FF9800;">0</div>
Â  Â  Â  Â  Â  <div class="mini-stat-lbl">POP</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <!-- Status Progress Bars (Real Data) -->
Â  Â  Â  <div class="status-section-title">Status Kemajuan (Klik untuk tapis)</div>
Â  Â  Â  <div id="status-list">
Â  Â  Â  Â  <!-- JS will inject status bars here -->
Â  Â  Â  </div>

Â  Â  Â  <!-- Mini Legend -->
Â  Â  Â  <div class="legend-mini">
Â  Â  Â  Â  <div class="legend-row"><span class="dot" style="background: #FF5722;"></span> Menara Komunikasi</div>
Â  Â  Â  Â  <div class="legend-row"><span class="dot" style="background: #2196F3;"></span> Pusat NADI</div>
Â  Â  Â  Â  <div class="legend-row"><span class="dot" style="background: #4CAF50;"></span> WiFi Komuniti</div>
Â  Â  Â  Â  <div class="legend-row"><span class="dot" style="background: #FF9800;"></span> Point of Presence (POP)</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <!-- Right Side Controls (Expandable Cards) -->
Â  <div class="controls-container">
Â  Â Â 
Â  Â  <!-- Layer Toggle Group -->
Â  Â  <div class="control-card" id="layer-card">
Â  Â  Â  <div class="control-group-title">Sempadan</div>
Â  Â  Â  <!-- Default: Daerah Active, others inactive -->
Â  Â  Â  <button class="toggle-btn active" id="toggle-daerah" title="Daerah">
Â  Â  Â  Â  <i class="fas fa-map-marked-alt"></i> <span>Daerah</span>
Â  Â  Â  </button>
Â  Â  Â  <button class="toggle-btn" id="toggle-dun" title="DUN">
Â  Â  Â  Â  <i class="fas fa-landmark"></i> <span>DUN</span>
Â  Â  Â  </button>
Â  Â  Â  <button class="toggle-btn" id="toggle-parliament" title="Parlimen">
Â  Â  Â  Â  <i class="fas fa-building"></i> <span>Parlimen</span>
Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <!-- Category Filter Group -->
Â  Â  <div class="control-card" id="filter-card">
Â  Â  Â  <div class="control-group-title">Penapis Data</div>
Â  Â  Â  <!-- Default: All inactive as requested (removed 'active' class) -->
Â  Â  Â  <button class="toggle-btn" id="toggle-menara" title="Menara">
Â  Â  Â  Â  <i class="fas fa-broadcast-tower" style="color: #FF5722;"></i> <span>Menara</span>
Â  Â  Â  </button>
Â  Â  Â  <button class="toggle-btn" id="toggle-nadi" title="NADI">
Â  Â  Â  Â  <i class="fas fa-satellite-dish" style="color: #2196F3;"></i> <span>NADI</span>
Â  Â  Â  </button>
Â  Â  Â  <button class="toggle-btn" id="toggle-wifi" title="WiFi">
Â  Â  Â  Â  <i class="fas fa-wifi" style="color: #4CAF50;"></i> <span>WiFi</span>
Â  Â  Â  </button>
Â  Â  Â  <button class="toggle-btn" id="toggle-pop" title="POP">
Â  Â  Â  Â  <i class="fas fa-globe" style="color: #FF9800;"></i> <span>POP</span>
Â  Â  Â  </button>
Â  Â  </div>
Â  </div>
Â Â 
Â  <!-- UI Interactions Script -->
Â  <script>
Â  Â  function toggleDashboard() {
Â  Â  Â  const panel = document.getElementById('dashboard-panel');
Â  Â  Â  const btn = document.getElementById('sidebar-toggle');
Â  Â  Â  panel.classList.toggle('closed');
Â  Â  Â  btn.innerHTML = panel.classList.contains('closed') ? '<i class="fas fa-chart-pie"></i>' : '<i class="fas fa-times"></i>';
Â  Â  }

Â  Â  // Auto-expand controls on mouseover
Â  Â  document.querySelectorAll('.control-card').forEach(card => {
Â  Â  Â  card.addEventListener('mouseenter', () => card.classList.add('expanded'));
Â  Â  Â  card.addEventListener('mouseleave', () => card.classList.remove('expanded'));
Â  Â  });
Â  </script>

Â <!-- Main script -->
Â  <script>
    // ---------- CONFIG ----------
const URLs = {
Â  district: "district.json",
Â  dun: "dun.json",
Â  parliament: "parliament.json"
};

const SHEETS = {
Â  db_bwa: "1594VRWEs0PF56KXeSPudZTWkbGuS5UZmxXGrKqo4bUU",
Â  db_pim: "1WyZiw72LOVytssXAuymJS_TIgckLCUqY56pB0QhawZU",
Â  db_POP: "1JLqLtZPa4Kd6hEbRA2wgMgADX2h2-tdsXnG-YivSgU8",
Â  tower: "1b0Aipp0MQvP8HWc-z28dugkGn5sWdNAx6ZE5-Mu13-0"
};

const SHEET_TYPE = {
Â  db_bwa: "BWA",
Â  db_pim: "NADI",
Â  db_POP: "POP",
Â  tower: "TOWER"
};

const TYPE_CFG = {
Â  BWA: { color: "#4CAF50", icon: "ğŸ“¶", label: "WiFi", fa_icon: "fa-wifi" },
Â  NADI: { color: "#2196F3", icon: "ğŸ“¡", label: "NADI", fa_icon: "fa-satellite-dish" },
Â  POP: { color: "#FF9800", icon: "ğŸŒ", label: "POP", fa_icon: "fa-globe" },
Â  TOWER: { color: "#FF5722", icon: "ğŸ—¼", label: "Menara", fa_icon: "fa-broadcast-tower" }
};

// ---------- STATE ----------
let map;
let markersBySite = new Map();
let markersList = [];
let allProjects = [];
let areaIndex = new Map();
let dataLayers = { district: null, dun: null, parliament: null };
let currentBoundaryKey = null;
let hoverInfoWindow = null;
let refreshIntervalMs = 60_000;
let batchSize = 300;
let activeFeature = null;
let activeLayer = null;
let searchTerm = "";
// NEW: State untuk Status Progress Breakdown
let statusBreakdownData = {}; // Stores detailed breakdown by status and project type
let activeStatusFilter = null; // Stores the currently selected status name (string)

// ---------- UTIL HELPER ----------
function showLoading(on) {
Â  const el = document.getElementById("loading");
Â  if (!el) return;
Â  on ? el.classList.remove("hide") : el.classList.add("hide");
}

function escapeHtml(s) {
Â  return String(s || "").replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
}

function debounce(fn, wait = 250) {
Â  let t;
Â  return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); };
}

// FIX: Helper untuk membersihkan string bagi tujuan perbandingan (Trim + Uppercase)
function normalizeString(str) {
Â  return String(str || "").trim().toUpperCase();
}

function cleanFloat(val) {
Â  if (typeof val === 'number') return val;
Â  if (!val) return 0;
Â  // Buang semua character pelik, tukar koma jadi titik
Â  const str = String(val).replace(/[^0-9.,-]/g, "").replace(',', '.').trim();
Â  const floatVal = parseFloat(str);
Â  return isNaN(floatVal) ? 0 : floatVal;
}

// FIX: Generate ID berdasarkan kandungan, bukan nombor baris
function generateStableId(rowObj, type) {
Â  const name = normalizeString(rowObj.SITE_NAME || "UNKNOWN");
Â  const district = normalizeString(rowObj.DISTRICT || "SABAH");
Â  return `${type}_${name.replace(/\s+/g, '_')}_${district.replace(/\s+/g, '_')}`;
}

function extractFeatureName(feature) {
Â  const props = ["NAME", "name", "DISTRICT", "DAERAH", "DUN", "PARLIAMENT", "PARLIAMEN"];
Â  let name = "Sabah";
Â  for (const k of props) {
Â  Â  try {
Â  Â  Â  const v = feature.getProperty(k);
Â  Â  Â  if (v) { name = v; break; }
Â  Â  } catch (_) { }
Â  }
Â  return String(name).trim();
}

function resetAllLayerStyles() {
Â  Object.keys(dataLayers).forEach(k => {
Â  Â  const dl = dataLayers[k];
Â  Â  if (dl) dl.revertStyle();
Â  });
Â  activeFeature = null;
Â  activeLayer = null;
}

// ---------- DATA PARSING ----------
function parseGviz(text) {
Â  try {
Â  Â  const start = text.indexOf('{');
Â  Â  const end = text.lastIndexOf('}');
Â  Â  if (start === -1 || end === -1) return null;
Â  Â  return JSON.parse(text.substring(start, end + 1));
Â  } catch (e) {
Â  Â  console.error("parseGviz failed", e);
Â  Â  return null;
Â  }
}

async function fetchSheetObjects(sheetId) {
Â  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&tq=`;
Â  const res = await fetch(url);
Â  if (!res.ok) throw new Error(`Sheet fetch ${sheetId} failed (${res.status})`);
Â  const text = await res.text();
Â  const json = parseGviz(text);
Â  if (!json || !json.table) return { rows: [], cols: [] };

Â  const rawCols = json.table.cols.map(c => (c && c.label) ? c.label.toUpperCase() : "");
Â  const rows = json.table.rows || [];

Â  const processedRows = rows.map(r => {
Â  Â  const obj = {};
Â  Â  rawCols.forEach((c, i) => obj[c ? c : `COL${i}`] = (r.c && r.c[i] ? r.c[i].v : ""));
Â  Â  return obj;
Â  });

Â  return { rows: processedRows, cols: rawCols.filter(c => c && !c.startsWith("COL")) };
}

function normalizeRows(rows, sheetKey, rawCols) {
Â  const normalizedKeys = new Set(["SITE_NAME", "SITE NAME", "SITE", "DISTRICT", "DAERAH", "DUN", "PARLIAMENT", "PARLIAMENT_NAME", "LATITUDE", "LAT", "LONGITUDE", "LON", "LNG", "STATUS", "STATUS_1"]);

Â  const normalized = rows.map((r, i) => {
Â  Â  const get = k => (r[k] !== undefined ? r[k] : (r[k.toLowerCase()] !== undefined ? r[k.toLowerCase()] : ""));
Â  Â  const site = get("SITE_NAME") || get("SITE NAME") || get("SITE") || "";
Â  Â  const district = get("DISTRICT") || get("DAERAH") || "";
Â  Â  const dun = get("DUN") || "";
Â  Â  const parliament = get("PARLIAMENT") || get("PARLIAMENT_NAME") || "";

Â  Â  const lat = cleanFloat(get("LATITUDE") || get("LAT") || get("LATITUDE_DEC"));
Â  Â  const lng = cleanFloat(get("LONGITUDE") || get("LON") || get("LNG"));

Â  Â  const rawStatus = get("STATUS") || get("STATUS_1") || "Tiada Status";

Â  Â  const rawDetails = [];
Â  Â  let count = 0;
Â  Â  for (let colIndex = 0; colIndex < rawCols.length && count < 15; colIndex++) {
Â  Â  Â  const key = rawCols[colIndex];
Â  Â  Â  if (normalizedKeys.has(key)) continue;
Â  Â  Â  const value = r[key];
Â  Â  Â  if (value !== null && value !== "" && value !== undefined) {
Â  Â  Â  Â  rawDetails.push({ label: key, value: String(value).trim() });
Â  Â  Â  Â  count++;
Â  Â  Â  }
Â  Â  }

Â  Â  const type = SHEET_TYPE[sheetKey] || "UNKNOWN";
Â  Â Â 
Â  Â  const isValidCoordinate = (lat !== 0 && lng !== 0 && lat > 0 && lng > 100);Â 

Â  Â  const rowObj = {
Â  Â  Â  SITE_NAME: String(site || "N/A").trim(),
Â  Â  Â  DISTRICT: String(district || "").trim(),
Â  Â  Â  DUN: String(dun || "").trim(),
Â  Â  Â  PARLIAMENT: String(parliament || "").trim(),
Â  Â  Â  LATITUDE: lat,
Â  Â  Â  LONGITUDE: lng,
Â  Â  Â  STATUS: String(rawStatus).trim(),
Â  Â  Â  _sheet: sheetKey,
Â  Â  Â  _type: type,
Â  Â  Â  _raw_details: rawDetails,
Â  Â  Â  _validCoord: isValidCoordinate
Â  Â  };

Â  Â  rowObj._id = generateStableId(rowObj, type);

Â  Â  return rowObj;
Â  }).filter(o => o.SITE_NAME !== "N/A");Â 

Â  return normalized;
}

function buildAreaIndex() {
Â  areaIndex.clear();
Â  allProjects.forEach(p => {
Â  Â  [p.DISTRICT, p.DUN, p.PARLIAMENT].forEach(k => {
Â  Â  Â  if (!k) return;
Â  Â  Â  const key = normalizeString(k);
Â  Â  Â  if (!areaIndex.has(key)) areaIndex.set(key, new Set());
Â  Â  Â  areaIndex.get(key).add(p.SITE_NAME);
Â  Â  });
Â  });
}

// ---------- MARKERS LOGIC ----------
function createOrUpdateMarker(project) {
Â  if (!project._validCoord) return null;

Â  const uniqueKey = project._id;
Â  const cfg = TYPE_CFG[project._type] || { color: "#333", icon: "ğŸ“" };

Â  if (markersBySite.has(uniqueKey)) {
Â  Â  const m = markersBySite.get(uniqueKey);
Â  Â  m._meta = project;Â 
Â  Â Â 
Â  Â  const pos = m.getPosition();
Â  Â  if (!pos || Math.abs(pos.lat() - project.LATITUDE) > 0.0001 || Math.abs(pos.lng() - project.LONGITUDE) > 0.0001) {
Â  Â  Â  Â m.setPosition({ lat: project.LATITUDE, lng: project.LONGITUDE });
Â  Â  }
Â  Â  return m;
Â  } else {
Â  Â  // Bina HTML InfoWindow
Â  Â  let rawDetailsHtml = project._raw_details.map(detail =>
Â  Â  Â  `<div class="info-row"><span class="info-label">${escapeHtml(detail.label)}</span><span class="info-val">${escapeHtml(detail.value)}</span></div>`
Â  Â  ).join('');

Â  Â  if (rawDetailsHtml) {
Â  Â  Â  rawDetailsHtml = `<div class="section-header">Maklumat Tambahan</div>` + rawDetailsHtml;
Â  Â  }

Â  Â  const marker = new google.maps.Marker({
Â  Â  Â  position: { lat: project.LATITUDE, lng: project.LONGITUDE },
Â  Â  Â  map: map,
Â  Â  Â  title: project.SITE_NAME || "",
Â  Â  Â  visible: false, // Default hidden
Â  Â  Â  icon: {
Â  Â  Â  Â  path: google.maps.SymbolPath.CIRCLE,
Â  Â  Â  Â  scale: 6,
Â  Â  Â  Â  fillColor: cfg.color,
Â  Â  Â  Â  fillOpacity: 1,
Â  Â  Â  Â  strokeColor: "#ffffff",
Â  Â  Â  Â  strokeWeight: 2
Â  Â  Â  }
Â  Â  });

Â  Â  // UPDATE: Menambah DUN dan Parlimen dalam Maklumat Utama
Â  Â  const infowin = new google.maps.InfoWindow({
Â  Â  Â  content: `
Â  Â  Â  Â  Â  Â  <div class="info-popup">
Â  Â  Â  Â  Â  Â  Â  <div class="info-header">${cfg.icon} ${escapeHtml(project.SITE_NAME)}</div>
Â  Â  Â  Â  Â  Â  Â  <div class="info-body">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="section-header">Maklumat Utama</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-row"><span class="info-label">Kategori</span><span class="info-val">${cfg.label}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-row"><span class="info-label">Daerah</span><span class="info-val">${escapeHtml(project.DISTRICT)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-row"><span class="info-label">DUN</span><span class="info-val">${escapeHtml(project.DUN)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-row"><span class="info-label">Parlimen</span><span class="info-val">${escapeHtml(project.PARLIAMENT)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-row"><span class="info-label">Status</span><span class="info-val" style="color:${cfg.color}">${escapeHtml(project.STATUS)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-row"><span class="info-label">Koordinat</span><span class="info-val">${project.LATITUDE.toFixed(4)}, ${project.LONGITUDE.toFixed(4)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  ${rawDetailsHtml}Â 
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  `
Â  Â  });

Â  Â  marker.addListener("click", () => {
Â  Â  Â  infowin.open(map, marker);
Â  Â  });

Â  Â  marker._meta = project;
Â  Â  markersBySite.set(uniqueKey, marker);
Â  Â  return marker;
Â  }
}

function renderMarkersInBatches(projects, onComplete) {
Â  const total = projects.length;
Â  let i = 0;
Â Â 
Â  if (total === 0) {
Â  Â  if (onComplete) onComplete();
Â  Â  return;
Â  }

Â  const runChunk = () => {
Â  Â  const end = Math.min(i + batchSize, total);
Â  Â  for (; i < end; i++) {
Â  Â  Â  createOrUpdateMarker(projects[i]);
Â  Â  }
Â  Â  if (i < total) {
Â  Â  Â  setTimeout(runChunk, 50);Â 
Â  Â  } else {
Â  Â  Â  if (onComplete) onComplete();
Â  Â  }
Â  };
Â  runChunk();
}

// ---------- FILTERING LOGIC ----------
function filterAndDisplayMarkers() {
Â  const menaraActive = document.getElementById("toggle-menara")?.classList.contains("active");
Â  const nadiActive = document.getElementById("toggle-nadi")?.classList.contains("active");
Â  const popActive = document.getElementById("toggle-pop")?.classList.contains("active");
Â  const wifiActive = document.getElementById("toggle-wifi")?.classList.contains("active");

Â  let filteredList = allProjects;

Â  // 1. Tapis mengikut Sempadan (District/Dun/Parliament)
Â  if (activeFeature && currentBoundaryKey) {
Â  Â  const areaNameRaw = extractFeatureName(activeFeature);
Â  Â  const areaName = normalizeString(areaNameRaw);Â 

Â  Â  filteredList = allProjects.filter(p => {
Â  Â  Â  if (currentBoundaryKey === 'district') return normalizeString(p.DISTRICT) === areaName;
Â  Â  Â  if (currentBoundaryKey === 'dun') return normalizeString(p.DUN) === areaName;
Â  Â  Â  if (currentBoundaryKey === 'parliament') return normalizeString(p.PARLIAMENT) === areaName;
Â  Â  Â  return false;
Â  Â  });
Â  }

Â  // NEW: 2. Tapis mengikut Status (jika aktif)
Â  if (activeStatusFilter) {
Â  Â  const activeStatusNormalized = normalizeString(activeStatusFilter);
Â  Â  filteredList = filteredList.filter(p => normalizeString(p.STATUS) === activeStatusNormalized);
Â  }

Â  // 3. Tapis mengikut Carian (Text Only - Coordinate handling is separate in listener)
Â  if (searchTerm && searchTerm.length > 0) {
Â  Â  const term = searchTerm.toLowerCase();
Â  Â  // Jika ia bukan format koordinat, kita filter senarai projek
Â  Â  if (!searchTerm.match(/^([-+]?[\d\.]+)[,\s]+([-+]?[\d\.]+)$/)) {
Â  Â  Â  Â  filteredList = filteredList.filter(p =>
Â  Â  Â  Â  (p.SITE_NAME && p.SITE_NAME.toLowerCase().includes(term)) ||
Â  Â  Â  Â  (p.DISTRICT && p.DISTRICT.toLowerCase().includes(term)) ||
Â  Â  Â  Â  (p.PARLIAMENT && p.PARLIAMENT.toLowerCase().includes(term))
Â  Â  Â  Â  );
Â  Â  }
Â  }

Â  updateDashboard(filteredList);

Â  const visibleLocationIds = new Set(filteredList.map(p => p._id));

Â  markersList.forEach(m => {
Â  Â  if(!m) return;
Â  Â  const meta = m._meta;
Â  Â  const type = meta._type;

Â  Â  let isCategoryActive = false;
Â  Â  // Jika tiada penapis kategori diaktifkan, semua kategori adalah aktif secara default (tiada kelas 'active' pada permulaan)
Â  Â  if (!menaraActive && !nadiActive && !popActive && !wifiActive) {
Â  Â  Â  Â  isCategoryActive = true;
Â  Â  } else {
Â  Â  Â  Â  if (type === "TOWER") isCategoryActive = menaraActive;
Â  Â  Â  Â  else if (type === "BWA") isCategoryActive = wifiActive;
Â  Â  Â  Â  else if (type === "NADI") isCategoryActive = nadiActive;
Â  Â  Â  Â  else if (type === "POP") isCategoryActive = popActive;
Â  Â  }

Â  Â  const shouldShow = visibleLocationIds.has(meta._id) && isCategoryActive && meta._validCoord;
Â  Â Â 
Â  Â  m.setVisible(shouldShow);
Â  });
}


const updateDashboard = debounce(function (list) {
Â  const displayList = list || [];

Â  const totalEl = document.getElementById("total-projects");
Â  if(totalEl) animateValue("total-projects", parseInt(totalEl.innerText) || 0, displayList.length, 500);

Â  // Perkiraan untuk Main Stats (Mini Cards)
Â  const counts = { menara: 0, nadi: 0, wifi: 0, pop: 0 };
Â  
Â  // Perkiraan untuk Status Progress Bars
Â  const dynamicStatusCounts = {};
Â  statusBreakdownData = {}; // RESET Global Breakdown Data

Â  displayList.forEach(p => {
Â  Â  if (p._type === "TOWER") counts.menara++;
Â  Â  if (p._type === "BWA") counts.wifi++;
Â  Â  if (p._type === "NADI") counts.nadi++;
Â  Â  if (p._type === "POP") counts.pop++;

Â  Â  const s = String(p.STATUS || "Tidak Dinyatakan").trim();
Â  Â  dynamicStatusCounts[s] = (dynamicStatusCounts[s] || 0) + 1;

Â  Â  // NEW: Kumpul data pecahan untuk setiap status
Â  Â  if (!statusBreakdownData[s]) {
Â  Â  Â  statusBreakdownData[s] = { total: 0, breakdown: { TOWER: { count: 0 }, NADI: { count: 0 }, POP: { count: 0 }, BWA: { count: 0 } } };
Â  Â  }
Â  Â  statusBreakdownData[s].total++;
Â  Â  if (statusBreakdownData[s].breakdown[p._type]) {
Â  Â  Â  statusBreakdownData[s].breakdown[p._type].count++;
Â  Â  }
Â  });

Â  const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
Â  setTxt("menara-count", counts.menara);
Â  setTxt("nadi-count", counts.nadi);
Â  setTxt("wifi-count", counts.wifi);
Â  setTxt("pop-count", counts.pop);

Â  const statusEl = document.getElementById("status-list");
Â  if(!statusEl) return;
Â Â 
Â  statusEl.innerHTML = "";
Â  const sortedStatuses = Object.entries(dynamicStatusCounts).sort(([, a], [, b]) => b - a);
Â  const totalProjects = displayList.length;

Â  // NEW: Kemaskini activeStatusFilter jika status yang aktif tiada lagi dalam senarai
Â  if (activeStatusFilter && !dynamicStatusCounts[activeStatusFilter]) {
Â  Â  activeStatusFilter = null;
Â  }


Â  sortedStatuses.forEach(([statusName, count]) => {
Â  Â  const percent = totalProjects > 0 ? Math.round((count / totalProjects) * 100) : 0;
Â  Â Â 
Â  Â  let endColor = "#4F46E5";Â 
Â  Â  let startColor = "#818cf8";
Â  Â  const statusUpper = statusName.toUpperCase();
Â  Â Â 
Â  Â  if (statusUpper.match(/SIAP|SELESAI|COMPLETE|OPERASI/)) { endColor = "#4CAF50"; startColor = "#81c784"; }
Â  Â  else if (statusUpper.match(/BINA|IMPLEMENTASI|PROGRESS/)) { endColor = "#2196F3"; startColor = "#64b5f6"; }
Â  Â  else if (statusUpper.match(/TANGGUH|BATAL|CANCEL/)) { endColor = "#F44336"; startColor = "#e57373"; }
Â  Â  else if (statusUpper.match(/RANCANG|BARU|PLAN/)) { endColor = "#FF9800"; startColor = "#ffb74d"; }

Â  Â  const div = document.createElement("div");
Â  Â  div.className = "status-item";
Â  Â  div.setAttribute('data-status', statusName);
Â  Â  // NEW: Tanda sebagai aktif jika ia adalah penapis semasa
Â  Â  if (statusName === activeStatusFilter) {
Â  Â  Â  div.classList.add('status-active');
Â  Â  }

Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  <div class="status-header">
Â  Â  Â  Â  Â  Â  <span class="status-name">${escapeHtml(statusName)}</span>
Â  Â  Â  Â  Â  Â  <span class="status-percent" style="color: ${endColor};">${count} (${percent}%)</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="progress-bg">
Â  Â  Â  Â  Â  Â  <div class="progress-fill" style="width: ${percent}%; background: linear-gradient(90deg, ${startColor}, ${endColor});"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <!-- NEW: Container for nested breakdown card -->
Â  Â  Â  Â  Â  <div class="status-breakdown-card" data-status-content="${statusName}"></div>
Â  Â  Â  Â  `;
Â  Â Â 
Â  Â  // NEW: Tambah click handler
Â  Â  div.addEventListener('click', () => handleStatusClick(statusName));

Â  Â  statusEl.appendChild(div);
Â  });

Â  // NEW: Selepas render, pastikan kad aktif dipaparkan (jika ada)
Â  if (activeStatusFilter) {
Â  Â  renderCategoryProgressCard(activeStatusFilter);
Â  }
}, 200);

function animateValue(id, start, end, duration) {
Â  if (start === end) return;
Â  const range = end - start;
Â  let current = start;
Â  const increment = end > start ? 1 : -1;
Â  const stepTime = Math.abs(Math.floor(duration / range));
Â  const obj = document.getElementById(id);
Â  if (!obj) return;
Â Â 
Â  const timer = setInterval(() => {
Â  Â  current += increment;
Â  Â  obj.innerHTML = current;
Â  Â  if (current == end) clearInterval(timer);
Â  }, Math.max(stepTime, 10));
}

// NEW: Function untuk menguruskan klik status (UI + State + Filter Peta)
function handleStatusClick(statusName) {
Â  // 1. Tentukan status baharu
Â  const isCurrentlyActive = activeStatusFilter === statusName;
Â  activeStatusFilter = isCurrentlyActive ? null : statusName;

Â  // 2. Kemas kini penapis penanda dan papan pemuka
Â  filterAndDisplayMarkers();

Â  // 3. Uruskan kelas aktif untuk maklum balas UI segera
Â  document.querySelectorAll('.status-item').forEach(item => {
Â  Â  item.classList.remove('status-active');
Â  Â  // Kosongkan kandungan pecahan untuk semua kad
Â  Â  item.querySelector('.status-breakdown-card').innerHTML = '';
Â  });

Â  if (activeStatusFilter) {
Â  Â  const activeItem = document.querySelector(`.status-item[data-status="${activeStatusFilter}"]`);
Â  Â  if (activeItem) {
Â  Â  Â  activeItem.classList.add('status-active');
Â  Â  Â  // Render kad pecahan hanya untuk item yang baru diaktifkan
Â  Â  Â  renderCategoryProgressCard(activeStatusFilter);
Â  Â  }
Â  }
}


// NEW: Function untuk memaparkan kad pecahan kategori (Sub-Card)
function renderCategoryProgressCard(statusName) {
Â  const data = statusBreakdownData[statusName];
Â  if (!data || data.total === 0) return;

Â  const cardContainer = document.querySelector(`.status-breakdown-card[data-status-content="${statusName}"]`);
Â  if (!cardContainer) return;

Â  const categories = Object.keys(TYPE_CFG);
Â  let htmlContent = `<div class="breakdown-content">`;

Â  categories.forEach(typeKey => {
Â  Â  const typeData = data.breakdown[typeKey];
Â  Â  const count = typeData.count;
Â  Â  if (count === 0) return;

Â  Â  const percent = data.total > 0 ? Math.round((count / data.total) * 100) : 0;
Â  Â  const cfg = TYPE_CFG[typeKey];

Â  Â  htmlContent += `
Â  Â  Â  Â  <div class="category-breakdown-item">
Â  Â  Â  Â  Â  <div class="category-header">
Â  Â  Â  Â  Â  Â  <span class="category-name" style="color: ${cfg.color};"><i class="fas ${cfg.fa_icon}"></i> ${cfg.label}</span>
Â  Â  Â  Â  Â  Â  <span class="category-percent">${count} (${percent}%)</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="category-progress-bg">
Â  Â  Â  Â  Â  Â  <div class="category-progress-fill" style="width: ${percent}%; background-color: ${cfg.color};"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  `;
Â  });

Â  htmlContent += `</div>`;
Â  cardContainer.innerHTML = htmlContent;
}

// ---------- INITIALIZATION ----------
async function loadAllSheetsAndNormalize() {
Â  const entries = Object.entries(SHEETS);
Â  const promises = entries.map(([k, id]) => fetchSheetObjectsSafe(k, id));
Â  const results = await Promise.all(promises);
Â  const combined = results.flat();
Â  allProjects = combined;
Â  buildAreaIndex();
Â  return combined;
}

async function fetchSheetObjectsSafe(sheetKey, id) {
Â  try {
Â  Â  const data = await fetchSheetObjects(id);
Â  Â  return normalizeRows(data.rows, sheetKey, data.cols);
Â  } catch (e) {
Â  Â  console.warn("sheet load fail", sheetKey, e);
Â  Â  return [];
Â  }
}

async function loadGeoJsonLayer(key, url, baseStyle = {}) {
Â  try {
Â  Â  const resp = await fetch(url);
Â  Â  if (!resp.ok) throw new Error("geojson fetch failed " + url);
Â  Â  const json = await resp.json();

Â  Â  const layer = new google.maps.Data({ map: null });
Â  Â  layer.addGeoJson(json);

Â  Â  layer._baseStyle = {
Â  Â  Â  strokeWeight: baseStyle.strokeWeight || 1,
Â  Â  Â  strokeColor: baseStyle.strokeColor || "#666",
Â  Â  Â  fillOpacity: 0.05,
Â  Â  Â  fillColor: (baseStyle.fillColor || "#FFF")
Â  Â  };
Â  Â  layer.setStyle(feature => layer._baseStyle);

Â  Â  layer.addListener("mouseover", e => {
Â  Â  Â  if (!layer.getMap()) return;
Â  Â  Â  if (activeFeature === e.feature) return;
Â  Â  Â  layer.overrideStyle(e.feature, { strokeWeight: 2, strokeColor: "#4F46E5", fillOpacity: 0.3, fillColor: "#818cf8" });
Â  Â  Â Â 
Â  Â  Â  if (!hoverInfoWindow) hoverInfoWindow = new google.maps.InfoWindow();
Â  Â  Â  hoverInfoWindow.setContent(`<div style="padding:8px 12px; font-weight:600; color:#4F46E5;">${escapeHtml(extractFeatureName(e.feature))}</div>`);
Â  Â  Â  hoverInfoWindow.setPosition(e.latLng);
Â  Â  Â  hoverInfoWindow.open(map);
Â  Â  });

Â  Â  layer.addListener("mouseout", e => {
Â  Â  Â  if (activeFeature !== e.feature) layer.revertStyle(e.feature);
Â  Â  Â  if (hoverInfoWindow) hoverInfoWindow.close();
Â  Â  });

Â  Â  layer.addListener("click", e => {
Â  Â  Â  handleFeatureClick(key, e.feature);
Â  Â  });

Â  Â  dataLayers[key] = layer;
Â  Â  return layer;
Â  } catch (e) {
Â  Â  console.warn("loadGeoJsonLayer error", key, e);
Â  Â  return null;
Â  }
}

function handleFeatureClick(key, feature) {
Â  const layerObj = dataLayers[key];
Â  if (!layerObj) return;

Â  const featureName = extractFeatureName(feature);
Â  document.getElementById("selected-area").textContent = featureName;

Â  toggleBoundaryLayerVisibility(key);
Â  resetAllLayerStyles();
Â  layerObj.overrideStyle(feature, { strokeWeight: 2, strokeColor: "#4338ca", fillOpacity: 0.5, fillColor: "#4338ca" });

Â  activeFeature = feature;
Â  activeLayer = layerObj;
Â  currentBoundaryKey = key;

Â  filterAndDisplayMarkers();
}

function toggleBoundaryLayerVisibility(key) {
Â  Object.keys(dataLayers).forEach(k => {
Â  Â  const dl = dataLayers[k];
Â  Â  if (dl) dl.setMap(k === key ? map : null);
Â  });
Â  updateToggleButtonsUI(key);
}

function updateToggleButtonsUI(activeKey) {
Â  const mapping = { district: "toggle-daerah", dun: "toggle-dun", parliament: "toggle-parliament" };
Â  Object.keys(mapping).forEach(k => {
Â  Â  const btn = document.getElementById(mapping[k]);
Â  Â  if (btn) activeKey === k ? btn.classList.add("active") : btn.classList.remove("active");
Â  });
}

function setupToggles() {
Â  ["menara", "nadi", "pop", "wifi"].forEach(cat => {
Â  Â  document.getElementById(`toggle-${cat}`)?.addEventListener("click", function () {
Â  Â  Â  this.classList.toggle("active");
Â  Â  Â  filterAndDisplayMarkers();
Â  Â  });
Â  });

Â  const boundaries = [
Â  Â  { id: "toggle-daerah", key: "district" },
Â  Â  { id: "toggle-dun", key: "dun" },
Â  Â  { id: "toggle-parliament", key: "parliament" }
Â  ];

Â  boundaries.forEach(b => {
Â  Â  document.getElementById(b.id)?.addEventListener("click", function () {
Â  Â  Â  if (this.classList.contains('active') && currentBoundaryKey === b.key) {
Â  Â  Â  Â  this.classList.remove('active');
Â  Â  Â  Â  dataLayers[b.key].setMap(null);
Â  Â  Â  Â  currentBoundaryKey = null;
Â  Â  Â  Â  activeFeature = null;
Â  Â  Â  Â  document.getElementById("selected-area").textContent = "SELURUH SABAH";
Â  Â  Â  } else {
Â  Â  Â  Â  toggleBoundaryLayerVisibility(b.key);
Â  Â  Â  Â  document.getElementById("selected-area").textContent = "SABAH (" + b.key.toUpperCase() + ")";
Â  Â  Â  Â  currentBoundaryKey = b.key;Â 
Â  Â  Â  }
Â  Â  Â  filterAndDisplayMarkers();
Â  Â  });
Â  });

Â  // UPDATE: Carian Responsif + Koordinat
Â  document.getElementById("search-input")?.addEventListener("input", (e) => {
Â  Â  searchTerm = e.target.value;
Â  Â Â 
Â  Â  // Check regex untuk format "Lat, Long"
Â  Â  const coordMatch = searchTerm.match(/^([-+]?[\d\.]+)[,\s]+([-+]?[\d\.]+)$/);
Â  Â  if (coordMatch) {
Â  Â  Â  Â  const lat = parseFloat(coordMatch[1]);
Â  Â  Â  Â  const lng = parseFloat(coordMatch[2]);
Â  Â  Â  Â  if (!isNaN(lat) && !isNaN(lng)) {
Â  Â  Â  Â  Â  Â  // Pan terus ke lokasi tanpa filter markers
Â  Â  Â  Â  Â  Â  map.panTo({lat, lng});
Â  Â  Â  Â  Â  Â  map.setZoom(14);
Â  Â  Â  Â  Â  Â  // Optional: Letak marker sementara atau biarkan user melihat kawasan
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  // Jika teks biasa, jalankan filter standard
Â  Â  Â  Â  filterAndDisplayMarkers();
Â  Â  }
Â  });
}

async function autoRefreshLoop() {
Â  try {
Â  Â  const newProjects = await loadAllSheetsAndNormalize();
Â  Â  newProjects.forEach(np => createOrUpdateMarker(np));
Â  Â Â 
Â  Â  markersList = Array.from(markersBySite.values());
Â  Â  allProjects = newProjects;
Â  Â Â 
Â  Â  filterAndDisplayMarkers();
Â  } catch (e) {
Â  Â  console.warn("autoRefreshLoop failed", e);
Â  }
}

// ---------- MAIN INIT ----------
async function initMap() {
Â  const mapDiv = document.getElementById("map");
Â  if (!mapDiv) return;

Â  const silverStyle = [
Â  Â  { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
Â  Â  { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
Â  Â  { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
Â  Â  { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] },
Â  Â  { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
Â  Â  { featureType: "water", elementType: "geometry", stylers: [{ color: "#c9c9c9" }] },
Â  Â  { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] }
Â  ];

Â  map = new google.maps.Map(mapDiv, {
Â  Â  center: { lat: 5.9804, lng: 116.0735 },
Â  Â  zoom: 8,
Â  Â  mapTypeId: "satellite", /* SMS - sebelumnya roadmap */
Â  Â  styles: silverStyle,
Â  Â  disableDefaultUI: false,
Â  Â Â 
Â  Â  // UPDATE: Pilihan View (Satellite/Map)
Â  Â  mapTypeControl: true,
Â  Â  mapTypeControlOptions: {
Â  Â  Â  Â  style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
Â  Â  Â  Â  position: google.maps.ControlPosition.TOP_RIGHT
Â  Â  },
Â  Â Â 
Â  Â  // UPDATE: Butang Zoom (+ -)
Â  Â  zoomControl: true,
Â  Â  zoomControlOptions: {
Â  Â  Â  Â  position: google.maps.ControlPosition.RIGHT_BOTTOM
Â  Â  },
Â  Â Â 
Â  Â  streetViewControl: false,
Â  Â  fullscreenControl: false
Â  });

Â  showLoading(true);

Â  try {
Â  Â  const projects = await loadAllSheetsAndNormalize();
Â  Â Â 
Â  Â  renderMarkersInBatches(projects, () => {
Â  Â  Â  markersList = Array.from(markersBySite.values());
Â  Â  Â  filterAndDisplayMarkers();
Â  Â  });

Â  Â  const pDistrict = loadGeoJsonLayer("district", URLs.district).catch(e => null);
Â  Â  const pDun = loadGeoJsonLayer("dun", URLs.dun).catch(e => null);
Â  Â  const pPar = loadGeoJsonLayer("parliament", URLs.parliament).catch(e => null);

Â  Â  google.maps.event.addListenerOnce(map, "idle", async () => {
Â  Â  Â  const ld = await pDistrict;
Â  Â  Â  await pDun;Â 
Â  Â  Â  await pPar;

Â  Â  Â  if (ld) {
Â  Â  Â  Â  dataLayers['district'].setMap(map);
Â  Â  Â  Â  currentBoundaryKey = 'district';
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  setupToggles();
Â  Â  Â  filterAndDisplayMarkers();Â 
Â  Â  });

Â  Â  setInterval(() => autoRefreshLoop(), refreshIntervalMs);

Â  } catch (e) {
Â  Â  console.error("Init Error", e);
Â  Â  alert("Ralat sambungan data. Sila refresh.");
Â  } finally {
Â  Â  showLoading(false);
Â  }
}

window.initMap = initMap;
// ---------- end of script ----------
  </script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRKvwm2qw29P6nRe6AFk0UMlSv356qMI0&callback=initMap" async defer></script>
Â  Â Â 
</body>
</html>
