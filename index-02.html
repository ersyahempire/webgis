<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Web GIS Projek Sabah - Optimized 0.4</title>
  
  <!-- FontAwesome & Google Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="css03_baru.css">

  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <!-- PDF/Image Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

  <!-- Map Background -->
  <div id="map"></div>

  <!-- Loading Screen -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div style="font-weight: 700; font-size: 14px; color: var(--primary); letter-spacing: 0.5px;">MEMUATKAN DATA...</div>
    <div id="loading-msg" style="font-size: 11px; margin-top: 5px; color: #666;"></div>
  </div>

  <!-- Top Search Bar -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="search-input" placeholder="Cari tapak, daerah, atau parlimen...">
    </div>
  </div>

  <!-- Sidebar Toggle -->
  <button class="panel-toggle" id="sidebar-toggle" onclick="toggleDashboard()">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Floating Dashboard -->
  <div class="dashboard-panel" id="dashboard-panel">
    <div class="panel-header">
      <h2><i class="fas fa-layer-group"></i> Statistik Projek</h2>
    </div>
    
    <div class="panel-content">
      <div class="main-stat">
        <div class="main-stat-value" id="total-projects">0</div>
        <div class="main-stat-label">Jumlah Projek</div>
        <div id="selected-area" class="area-badge">SELURUH SABAH</div>
      </div>

      <div class="grid-stats" id="dynamic-grid-stats"></div>
      <div class="status-section-title">Status Kemajuan</div>
      <div id="status-list"></div>
      <div class="legend-mini" id="dynamic-legend"></div>
    </div>
  </div>

  <!-- Right Controls -->
  <div class="controls-container">
    <div class="control-card">
        <button class="toggle-btn" title="Muat Turun CSV" onclick="downloadCSV()">
            <span class="icon-slot"><i class="fas fa-file-csv" style="color: #10B981;"></i></span> 
            <span class="text-slot">Muat Turun CSV</span>
        </button>
    </div>
    <div class="control-card">
        <button class="toggle-btn" title="Laporan Penuh" onclick="openReport()">
            <span class="icon-slot"><i class="fas fa-file-invoice-dollar" style="color: #F59E0B;"></i></span> 
            <span class="text-slot">Laporan Penuh</span>
        </button>
    </div>
    <div class="control-card" id="layer-card">
      <div class="control-group-title">Sempadan</div>
      <button class="toggle-btn active" id="toggle-daerah" title="Daerah">
        <span class="icon-slot"><i class="fas fa-map-marked-alt"></i></span> <span class="text-slot">Daerah</span>
      </button>
      <button class="toggle-btn" id="toggle-dun" title="DUN">
        <span class="icon-slot"><i class="fas fa-landmark"></i></span> <span class="text-slot">DUN</span>
      </button>
      <button class="toggle-btn" id="toggle-parliament" title="Parlimen">
        <span class="icon-slot"><i class="fas fa-building"></i></span> <span class="text-slot">Parlimen</span>
      </button>
    </div>
    <div class="control-card" id="filter-card">
      <div class="control-group-title">Penapis</div>
      <div id="dynamic-filter-btns"></div>
    </div>
  </div>

  <!-- REPORT MODAL -->
  <div class="report-overlay" id="report-overlay">
      <div class="report-modal">
          <button class="modal-close-btn" onclick="closeReport()"><i class="fas fa-times"></i></button>
          
          <!-- ID ini penting untuk capture -->
          <div class="report-container" id="report-content">
              <!-- HEADER -->
              <header class="report-header-content">
                  <div class="header-title">
                      <h1>Laporan Dashboard Projek</h1>
                      <h2 id="report-layer-name">SELURUH SABAH</h2>
                  </div>
                  <div class="header-info">
                      <div class="action-buttons" data-html2canvas-ignore="true">
                        <button class="btn-share" onclick="shareReport()">
                            <i class="fas fa-share-alt"></i> Kongsi Imej
                        </button>
                        <button class="btn-download-main" onclick="generateExport()">
                            <i class="fas fa-file-pdf"></i> Muat Turun PDF
                        </button>
                      </div>
                      <div class="current-time" id="clock">Loading...</div>
                  </div>
              </header>

              <!-- TOP STATS -->
              <div class="top-row">
                  <div class="card report-main-stat">
                      <h1 id="report-total-count">0</h1>
                      <p>JUMLAH PROJEK</p>
                      <div class="badge" id="report-badge-area">SELURUH SABAH</div>
                  </div>
                  <div class="mini-stats-grid" id="report-mini-stats"></div>
              </div>

              <!-- CHARTS ROW -->
              <div class="charts-row">
                  <div class="card chart-card">
                      <div class="chart-title">Carta 01: Mengikut Projek</div>
                      <div id="chart-01"></div>
                  </div>
                  <div class="card chart-card">
                      <div class="chart-title">Carta 02: Status Keseluruhan</div>
                      <div id="chart-02"></div>
                  </div>
                  <div class="card chart-card">
                      <div class="chart-title">Carta 03: Projek vs Status</div>
                      <div id="chart-03"></div>
                  </div>
              </div>

              <!-- MAIN CONTENT (MAP & STATUS) -->
              <div class="main-content">
                  <div class="card map-container">
                      <div id="report-map"></div>
                  </div>
                  <div class="card status-container">
                      <div class="status-header-fixed">STATUS TERPERINCI</div>
                      <div class="status-scroll-area" id="dynamic-status-container"></div>
                  </div>
              </div>

              <!-- LAYER INFO (GAS DATA) -->
              <div id="layer-info-section" style="display:none;">
                  <div class="layer-info-card">
                      <div class="layer-info-title">
                          <i class="fas fa-info-circle"></i> Info Kawasan: <span id="layer-info-name"></span>
                      </div>
                      <div class="layer-info-grid" id="layer-info-content"></div>
                  </div>
              </div>

              <!-- BOTTOM GRID -->
              <div class="bottom-grid" id="dynamic-bottom-grid"></div>

              <!-- FOOTER -->
              <footer>
                  <div>Sistem Maklumat Geografi (GIS) Projek Sabah | Â© MCMC Tawau</div>
                  <div style="font-size: 0.8rem; color: #666;">Dijana pada <span id="footer-date"></span></div>
              </footer>
          </div>
      </div>
  </div>
    
<!-- MAIN SCRIPT -->
<script>
/**
 * 1. CONFIGURATION
 */
const APP_CONFIG = {
    PROJECT_TYPES: [
        { id: "db_bwa", sheetId: "1594VRWEs0PF56KXeSPudZTWkbGuS5UZmxXGrKqo4bUU", type: "BWA", label: "WiFi", color: "#51cf66", icon: "ðŸ“¶" },
        { id: "db_pim", sheetId: "1WyZiw72LOVytssXAuymJS_TIgckLCUqY56pB0QhawZU", type: "NADI", label: "NADI", color: "#4dabf7", icon: "ðŸ“¡" },
        { id: "db_pop", sheetId: "1JLqLtZPa4Kd6hEbRA2wgMgADX2h2-tdsXnG-YivSgU8", type: "POP", label: "POP", color: "#fcc419", icon: "ðŸŒ" },
        { id: "tower", sheetId: "1b0Aipp0MQvP8HWc-z28dugkGn5sWdNAx6ZE5-Mu13-0", type: "TOWER", label: "Menara", color: "#ff6b6b", icon: "ðŸ—¼", filter: { col: "PROJECT_TYPE", val: "USP" } },
        { id: "cebol", sheetId: "1KhD9LopT0thjVPhZuCI7IulNsItW9ipQ_M6Ob0V8j0o", type: "CEBOL", label: "CEBOL", color: "#7950f2", icon: "ðŸ’¡" },
        { id: "usj", sheetId: "1OMOyrS34mAYtg-UxlE4xs0iyMoSdqc3WFbhgMlHsgqo", type: "USJ", label: "USJ", color: "#f06595", icon: "ðŸš€" },
        { id: "samb", sheetId: "1Lg_rGS0I2-lyhttQBBOvdkRR-ruPKAi1KdKcXNUmUo0", type: "SAMB", label: "SAMB", color: "#20c997", icon: "ðŸ”Œ" }
    ],
    STATUS_MAPPING: [
        { keywords: ["SIAP"], color: "#86efac" }, 
        { keywords: ["PEMBINAAN"], color: "#fde047" }, 
        { keywords: ["PERANCANGAN"], color: "#fca5a5" }, 
        { keywords: ["TIADA STATUS", "UNKNOWN"], color: "#cbd5e1" } 
    ],
    DEFAULT_STATUS_COLOR: "#cbd5e1",
    GAS_API_URL: "https://script.google.com/macros/s/AKfycbzDL6FOdwJhzA7Tt3ijuWWN2jMWJfbUEa2iE1DCJRWAX4Lxbut9FT1mphYeSUqDCu40iA/exec",
    SETTINGS: {
        MAX_EXTRA_INFO_COLUMNS: 15,
        REFRESH_INTERVAL_MS: 900000,
        DEFAULT_MAP_CENTER: [5.9804, 116.0735],
        DEFAULT_ZOOM: 8
    },
    GEOJSON_URLS: {
        district: "dosm_district.json",
        dun: "dosm_dun.json",
        parliament: "dosm_parlimen.json"
    }
};

/**
 * 2. UTILITIES
 */
const Utils = {
    escapeHtml: (str) => String(str || "").replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c])),
    normalize: (str) => String(str || "").trim().toUpperCase(),
    cleanFloat: (val) => {
        if (typeof val === 'number') return val;
        if (!val) return 0;
        const floatVal = parseFloat(String(val).replace(/[^0-9.,-]/g, "").replace(',', '.').trim());
        return isNaN(floatVal) ? 0 : floatVal;
    },
    generateId: (rowObj, type) => {
        const name = Utils.normalize(rowObj.SITE_NAME || "UNKNOWN");
        const dist = Utils.normalize(rowObj.DISTRICT || "SABAH");
        return `${type}_${name.replace(/\s+/g, '_')}_${dist.replace(/\s+/g, '_')}`;
    },
    debounce: (fn, wait = 250) => {
        let t;
        return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); };
    },
    getRandomColor: () => {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) { color += letters[Math.floor(Math.random() * 16)]; }
        return color;
    },
    getStatusCategory: (rawStatus) => Utils.normalize(rawStatus) || "TIADA STATUS",
    getTypeConfig: (typeKey) => APP_CONFIG.PROJECT_TYPES.find(t => t.type === typeKey) || { color: "#666", icon: "â“", label: typeKey },
    getStatusColor: (statusKey) => {
        const s = Utils.normalize(statusKey);
        const found = APP_CONFIG.STATUS_MAPPING.find(config => config.keywords.some(k => s.includes(k) || s === k));
        return found ? found.color : APP_CONFIG.DEFAULT_STATUS_COLOR;
    },
    getStatusSortIndex: (statusKey) => {
        const s = Utils.normalize(statusKey);
        const idx = APP_CONFIG.STATUS_MAPPING.findIndex(config => config.keywords.some(k => s.includes(k) || s === k));
        return idx !== -1 ? idx : 999;
    }
};

/**
 * 3. STATE MANAGEMENT
 */
const AppState = {
    map: null,
    reportMap: null,
    markersLayerGroup: null,
    allProjects: [],
    currentFilteredList: [],
    markersBySite: new Map(),
    dataLayers: { district: null, dun: null, parliament: null },
    activeBoundaryKey: null,
    activeFeatureName: null,
    searchTerm: "",
    activeStatusFilter: null,
    activeCategory: null,
    activeTypeToggles: new Set(),
    charts: { c1: null, c2: null, c3: null, bottom: [] }
};

/**
 * 4. DATA FETCHING (OPTIMIZED)
 */
const DataManager = {
    layerInfoCache: new Map(),

    async loadAllData() {
        UI.showLoading(true, "MENGHUBUNGI GOOGLE SHEETS...");
        try {
            const promises = APP_CONFIG.PROJECT_TYPES.map(config => this.fetchSingleSheet(config));
            const results = await Promise.all(promises);
            AppState.allProjects = results.flat();
            
            MapManager.renderMarkersInBatches(AppState.allProjects, () => {
                FilterManager.applyFilters();
                UI.showLoading(false);
                this.checkUrlParams();
            });
        } catch (error) {
            console.error("Data Load Error:", error);
            UI.showLoading(false);
        }
    },

    checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const bKey = params.get('layer');
        const bName = params.get('name');
        if (bKey && bName && AppState.dataLayers[bKey]) {
            let foundLayer = null;
            AppState.dataLayers[bKey].eachLayer(l => {
                if (MapManager.extractGeoName(l.feature) === Utils.normalize(bName)) foundLayer = l;
            });
            if (foundLayer) {
                MapManager.switchBoundary(bKey, (bKey === 'district' ? 'toggle-daerah' : (bKey === 'dun' ? 'toggle-dun' : 'toggle-parliament')));
                MapManager.highlightBoundary(bKey, foundLayer, Utils.normalize(bName), false);
                UI.openReport();
            }
        }
    },

    async fetchSingleSheet(config) {
        const url = `https://docs.google.com/spreadsheets/d/${config.sheetId}/gviz/tq?tqx=out:json&tq=`;
        try {
            const res = await fetch(url);
            if (!res.ok) return [];
            const text = await res.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            return (json.table && json.table.rows) ? this.processSheetData(json.table, config) : [];
        } catch (e) { return []; }
    },

    processSheetData(table, config) {
        const cols = table.cols.map(c => Utils.normalize(c ? c.label : ""));
        const STD_HEADERS = { SITE_NAME: ["SITE_NAME", "SITE NAME", "NAMA_TAPAK"], DISTRICT: ["DISTRICT", "DAERAH"], DUN: ["DUN"], PARLIAMENT: ["PARLIAMENT", "PARLIMEN"], LAT: ["LATITUDE", "LAT"], LNG: ["LONGITUDE", "LON", "LNG"], STATUS: ["STATUS", "KEMAJUAN"] };
        
        return table.rows.map(r => {
            const getVal = (keys) => {
                for (let k of keys) {
                    const idx = cols.indexOf(k);
                    if (idx > -1 && r.c[idx] && r.c[idx].v !== null) return r.c[idx].v;
                }
                return "";
            };

            if (config.filter) {
                const idx = cols.indexOf(Utils.normalize(config.filter.col));
                if (idx > -1 && Utils.normalize(r.c[idx]?.v) !== Utils.normalize(config.filter.val)) return null;
            }

            const rowData = {
                SITE_NAME: String(getVal(STD_HEADERS.SITE_NAME) || "N/A").trim(),
                DISTRICT: String(getVal(STD_HEADERS.DISTRICT)).trim(),
                DUN: String(getVal(STD_HEADERS.DUN)).trim(),
                PARLIAMENT: String(getVal(STD_HEADERS.PARLIAMENT)).trim(),
                STATUS: String(getVal(STD_HEADERS.STATUS) || "TIADA STATUS").trim(),
                LATITUDE: Utils.cleanFloat(getVal(STD_HEADERS.LAT)),
                LONGITUDE: Utils.cleanFloat(getVal(STD_HEADERS.LNG)),
                _type: config.type,
                _extra_details: []
            };

            rowData._validCoord = (rowData.LATITUDE !== 0 && rowData.LONGITUDE !== 0);
            if (rowData.SITE_NAME === "N/A") return null;

            let count = 0;
            const usedKeys = Object.values(STD_HEADERS).flat();
            cols.forEach((colKey, idx) => {
                if (count < APP_CONFIG.SETTINGS.MAX_EXTRA_INFO_COLUMNS && !usedKeys.includes(colKey) && r.c[idx]) {
                    const val = (r.c[idx].f !== undefined && r.c[idx].f !== null) ? r.c[idx].f : r.c[idx].v;
                    if (val) {
                        rowData._extra_details.push({ label: table.cols[idx].label, value: String(val).trim() });
                        count++;
                    }
                }
            });

            rowData._id = Utils.generateId(rowData, config.type);
            return rowData;
        }).filter(item => item !== null);
    },

    async fetchLayerInfoGAS(layerType, featureName) {
        if (!layerType || !featureName) return null;
        const cacheKey = `${layerType}_${Utils.normalize(featureName)}`;
        if (this.layerInfoCache.has(cacheKey)) return this.layerInfoCache.get(cacheKey);

        const sheetMap = { 'district': 'district', 'dun': 'dun', 'parliament': 'parliament' };
        const url = `${APP_CONFIG.GAS_API_URL}?sheet=${sheetMap[layerType] || layerType}`;

        try {
            // Add timeout race
            const fetchPromise = fetch(url);
            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 8000));
            
            const response = await Promise.race([fetchPromise, timeoutPromise]);
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            const targetName = Utils.normalize(featureName);
            const matchedRow = data.find(row => 
                (row['LAYER'] && Utils.normalize(row['LAYER']) === targetName) || 
                Object.values(row).some(val => typeof val === 'string' && Utils.normalize(val) === targetName)
            );

            const result = matchedRow ? [matchedRow] : [];
            this.layerInfoCache.set(cacheKey, result); // Cache empty results too to prevent retry
            return result;
        } catch (error) {
            console.warn("GAS Fetch failed:", error);
            return null;
        }
    }
};

/**
 * 5. MAP RENDERING
 */
const MapManager = {
    init() {
        AppState.map = L.map('map', { zoomControl: false, preferCanvas: true }).setView(APP_CONFIG.SETTINGS.DEFAULT_MAP_CENTER, APP_CONFIG.SETTINGS.DEFAULT_ZOOM);
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'OSM' });
        satellite.addTo(AppState.map);
        L.control.layers({ "Satelit": satellite, "Peta": osm }, null, { position: 'topright' }).addTo(AppState.map);
        L.control.zoom({ position: 'bottomright' }).addTo(AppState.map);
        AppState.markersLayerGroup = L.layerGroup().addTo(AppState.map);
        this.loadBoundaries();
    },

    async loadBoundaries() {
        const load = async (key, url) => {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Missing");
                const data = await res.json();
                AppState.dataLayers[key] = L.geoJSON(data, {
                    style: { color: '#666', weight: 1, fillOpacity: 0.05, fillColor: '#ffffff' },
                    onEachFeature: (feature, layer) => {
                        const name = this.extractGeoName(feature);
                        layer.bindTooltip(name, { sticky: true, interactive: false, direction: 'top', className: 'leaflet-tooltip boundary-tooltip' });
                        layer.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            this.highlightBoundary(key, layer, name, true, e.latlng);
                        });
                        layer.on('mouseover', (e) => { if (AppState.activeFeatureName !== name) e.target.setStyle({ fillColor: Utils.getRandomColor(), fillOpacity: 0.5, weight: 2, color: '#333' }); });
                        layer.on('mouseout', (e) => { if (AppState.activeFeatureName !== name) AppState.dataLayers[key].resetStyle(e.target); });
                    }
                });
            } catch (e) { AppState.dataLayers[key] = L.layerGroup(); }
        };
        await Promise.all([
            load('district', APP_CONFIG.GEOJSON_URLS.district),
            load('dun', APP_CONFIG.GEOJSON_URLS.dun),
            load('parliament', APP_CONFIG.GEOJSON_URLS.parliament)
        ]);
        
        document.getElementById('toggle-daerah').onclick = () => this.switchBoundary('district', 'toggle-daerah');
        document.getElementById('toggle-dun').onclick = () => this.switchBoundary('dun', 'toggle-dun');
        document.getElementById('toggle-parliament').onclick = () => this.switchBoundary('parliament', 'toggle-parliament');
        setTimeout(() => this.switchBoundary('district', 'toggle-daerah'), 500);
    },

    extractGeoName(feature) {
        const p = feature.properties || {};
        return Utils.normalize(p.district || p.DISTRICT || p.dun || p.DUN || p.parlimen || p.parliament || p.PARLIMEN || p.NAME || p.name || "SABAH");
    },

    switchBoundary(key, btnId) {
        Object.values(AppState.dataLayers).forEach(l => { if(l && AppState.map.hasLayer(l)) AppState.map.removeLayer(l); });
        if (AppState.dataLayers[key] && AppState.dataLayers[key].getLayers().length > 0) {
            AppState.map.addLayer(AppState.dataLayers[key]);
            AppState.activeBoundaryKey = key;
        } else AppState.activeBoundaryKey = null;
        
        AppState.activeFeatureName = null;
        document.getElementById('selected-area').textContent = "SELURUH SABAH";
        document.querySelectorAll('#layer-card .toggle-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(btnId).classList.add('active');
        AppState.map.setView(APP_CONFIG.SETTINGS.DEFAULT_MAP_CENTER, APP_CONFIG.SETTINGS.DEFAULT_ZOOM);
        FilterManager.applyFilters();
    },

    highlightBoundary(key, layer, name, showPopup = true, latlng = null) {
        AppState.dataLayers[key].eachLayer(l => AppState.dataLayers[key].resetStyle(l));
        layer.setStyle({ weight: 3, color: 'var(--primary)', fillOpacity: 0.4, fillColor: Utils.getRandomColor() });
        AppState.activeFeatureName = name;
        document.getElementById('selected-area').textContent = name;
        AppState.map.fitBounds(layer.getBounds());
        FilterManager.applyFilters();
        if (showPopup && latlng) this.openBoundaryPopup(latlng, name, key);
    },

    openBoundaryPopup(latlng, name, layerType) {
        const popup = L.popup().setLatLng(latlng).setContent(`
            <div class="boundary-popup-content">
                <div class="boundary-popup-header"><i class="fas fa-spinner fa-spin"></i> Memuatkan data...</div>
            </div>`).openOn(AppState.map);

        DataManager.fetchLayerInfoGAS(layerType, name).then(rows => {
            let htmlRows = '';
            if (rows && rows.length > 0) {
                const row = rows[0];
                const comments = row['_comments'] || {};
                const activeName = Utils.normalize(name);

                for (const [key, value] of Object.entries(row)) {
                    const normVal = Utils.normalize(String(value));
                    if (key === 'LAYER' || key === '_comments' || value === "" || normVal === activeName) continue;
                    
                    const commentHtml = comments[key] ? `<div class="boundary-comment-box">${comments[key]}</div>` : '';
                    htmlRows += `<div class="boundary-data-row"><span class="boundary-data-label">${key}</span><div style="text-align:right;"><span class="boundary-data-val">${value}</span>${commentHtml}</div></div>`;
                }
            }
            if (!htmlRows) htmlRows = '<div class="boundary-popup-loading">Tiada maklumat tambahan.</div>';
            
            popup.setContent(`
                <div class="boundary-popup-content">
                    <div class="boundary-popup-header"><i class="fas fa-info-circle"></i> ${name}</div>
                    <div class="boundary-popup-body">${htmlRows}</div>
                </div>`);
        });
    },

    createMarker(project) {
        const config = Utils.getTypeConfig(project._type);
        const extraHtml = project._extra_details.map(d => `<div class="popup-row"><span class="popup-label">${Utils.escapeHtml(d.label)}</span><span class="popup-value">${Utils.escapeHtml(d.value)}</span></div>`).join('');
        
        const content = `
            <div class="custom-popup-wrapper">
                <div class="popup-header">
                    <div class="popup-icon" style="background:${config.color}20; color:${config.color}">${config.icon}</div>
                    <div class="popup-title">${Utils.escapeHtml(project.SITE_NAME)}</div>
                </div>
                <div class="popup-status-badge" style="background:${Utils.getStatusColor(project.STATUS)}20; color:${Utils.getStatusColor(project.STATUS)}; border:1px solid ${Utils.getStatusColor(project.STATUS)}">${Utils.escapeHtml(project.STATUS)}</div>
                <div class="popup-grid">
                    <div class="popup-item"><span class="popup-label-mini">Kategori</span><span class="popup-value-main" style="color:${config.color}">${config.label}</span></div>
                    <div class="popup-item"><span class="popup-label-mini">Daerah</span><span class="popup-value-main">${Utils.escapeHtml(project.DISTRICT)}</span></div>
                    <div class="popup-item full-width"><span class="popup-label-mini">Koordinat</span><span class="popup-value-mono">${project.LATITUDE.toFixed(5)}, ${project.LONGITUDE.toFixed(5)}</span></div>
                </div>
                ${extraHtml ? `<div class="popup-divider">Info Lanjut</div><div class="popup-extra-container">${extraHtml}</div>` : ''}
            </div>`;

        return L.circleMarker([project.LATITUDE, project.LONGITUDE], {
            radius: 6, fillColor: config.color, color: "#fff", weight: 2, opacity: 1, fillOpacity: 1
        }).bindPopup(content, { minWidth: 360, maxWidth: 400 });
    },

    renderMarkersInBatches(projects, onComplete) {
        let i = 0;
        const run = () => {
            const end = Math.min(i + 500, projects.length);
            for (; i < end; i++) {
                if (!AppState.markersBySite.has(projects[i]._id) && projects[i]._validCoord) {
                    AppState.markersBySite.set(projects[i]._id, this.createMarker(projects[i]));
                }
            }
            if (i < projects.length) setTimeout(run, 20);
            else if (onComplete) onComplete();
        };
        run();
    }
};

/**
 * 6. CHARTS & FILTERING
 */
const ChartManager = {
    renderCharts(data) {
        this.destroyCharts();
        const types = APP_CONFIG.PROJECT_TYPES;
        
        // Data Prep
        const countsByType = types.map(t => data.filter(p => p._type === t.type).length);
        const statusMap = {};
        data.forEach(p => { const s = Utils.getStatusCategory(p.STATUS); statusMap[s] = (statusMap[s] || 0) + 1; });
        const sortedStatus = Object.keys(statusMap).sort((a,b) => Utils.getStatusSortIndex(a) - Utils.getStatusSortIndex(b));
        
        // Common Options (Disable animation for clean exports)
        const commonOpts = { fontFamily: 'Plus Jakarta Sans', toolbar: { show: false }, animations: { enabled: false } };

        // Chart 1: Bar Type
        const opts1 = {
            ...commonOpts, series: [{ name: 'Jumlah', data: countsByType }], chart: { type: 'bar', height: 350, ...commonOpts },
            colors: types.map(t => t.color), plotOptions: { bar: { distributed: true, borderRadius: 4 } },
            xaxis: { categories: types.map(t => t.label) }, legend: { show: false }
        };
        AppState.charts.c1 = new ApexCharts(document.querySelector("#chart-01"), opts1);
        AppState.charts.c1.render();

        // Chart 2: Donut Status
        const opts2 = {
            ...commonOpts, series: sortedStatus.map(s => statusMap[s]), labels: sortedStatus,
            chart: { type: 'donut', height: 350, ...commonOpts },
            colors: sortedStatus.map(s => Utils.getStatusColor(s)), legend: { position: 'bottom' }
        };
        AppState.charts.c2 = new ApexCharts(document.querySelector("#chart-02"), opts2);
        AppState.charts.c2.render();

        // Chart 3: Stacked
        const series3 = sortedStatus.map(s => ({
            name: s, color: Utils.getStatusColor(s),
            data: types.map(t => data.filter(p => p._type === t.type && Utils.getStatusCategory(p.STATUS) === s).length)
        }));
        const opts3 = {
            ...commonOpts, series: series3, chart: { type: 'bar', stacked: true, height: 350, ...commonOpts },
            xaxis: { categories: types.map(t => t.label) }, legend: { position: 'bottom' }
        };
        AppState.charts.c3 = new ApexCharts(document.querySelector("#chart-03"), opts3);
        AppState.charts.c3.render();
    },
    
    destroyCharts() {
        ['c1', 'c2', 'c3'].forEach(k => { if(AppState.charts[k]) AppState.charts[k].destroy(); });
    }
};

const FilterManager = {
    applyFilters() {
        let list = AppState.allProjects;
        if (AppState.activeBoundaryKey && AppState.activeFeatureName) {
            const bName = AppState.activeFeatureName;
            list = list.filter(p => Utils.normalize(p[AppState.activeBoundaryKey.toUpperCase()]) === bName);
        }
        if (AppState.searchTerm) {
            const term = AppState.searchTerm.toLowerCase();
            list = list.filter(p => p.SITE_NAME.toLowerCase().includes(term) || p.DISTRICT.toLowerCase().includes(term));
        }

        AppState.currentFilteredList = list;
        UI.updateDashboard(list);

        // Map Filter
        const activeTypes = AppState.activeCategory ? new Set([AppState.activeCategory]) : (AppState.activeTypeToggles.size ? AppState.activeTypeToggles : null);
        let mapList = activeTypes ? list.filter(p => activeTypes.has(p._type)) : []; // Default empty on load unless selected
        if (AppState.activeStatusFilter) mapList = mapList.filter(p => Utils.getStatusCategory(p.STATUS) === AppState.activeStatusFilter);
        
        AppState.markersLayerGroup.clearLayers();
        AppState.visibleProjects = mapList;
        const visibleIds = new Set(mapList.map(p => p._id));
        AppState.markersBySite.forEach((m, id) => { if (visibleIds.has(id)) AppState.markersLayerGroup.addLayer(m); });
    }
};

/**
 * 7. UI LOGIC
 */
const UI = {
    init() {
        this.genControls();
        document.getElementById('search-input').addEventListener('input', Utils.debounce((e) => {
            AppState.searchTerm = e.target.value;
            FilterManager.applyFilters();
        }));
    },
    showLoading(show, msg) {
        const el = document.getElementById('loading');
        el.classList.toggle('hide', !show);
        if(msg) document.getElementById('loading-msg').textContent = msg;
    },
    genControls() {
        const grid = document.getElementById('dynamic-grid-stats');
        const legend = document.getElementById('dynamic-legend');
        const filters = document.getElementById('dynamic-filter-btns');
        
        APP_CONFIG.PROJECT_TYPES.forEach(t => {
            grid.innerHTML += `<div class="mini-stat" id="stat-card-${t.type}" onclick="UI.catClick('${t.type}')" style="--stat-color:${t.color}"><div class="mini-stat-val" id="count-${t.type}" style="color:${t.color}">0</div><div class="mini-stat-lbl">${t.label}</div></div>`;
            legend.innerHTML += `<div class="legend-row"><span class="dot" style="background:${t.color}"></span> ${t.label}</div>`;
            filters.innerHTML += `<button class="toggle-btn" id="toggle-${t.type}" onclick="UI.typeToggle('${t.type}')"><span class="icon-slot">${t.icon}</span><span class="text-slot">${t.label}</span></button>`;
        });
    },
    catClick(type) {
        AppState.activeCategory = (AppState.activeCategory === type) ? null : type;
        document.querySelectorAll('.mini-stat').forEach(el => el.classList.remove('selected'));
        if (AppState.activeCategory) document.getElementById(`stat-card-${type}`).classList.add('selected');
        FilterManager.applyFilters();
    },
    typeToggle(type) {
        AppState.activeCategory = null;
        document.querySelectorAll('.mini-stat').forEach(el => el.classList.remove('selected'));
        if (AppState.activeTypeToggles.has(type)) {
            AppState.activeTypeToggles.delete(type);
            document.getElementById(`toggle-${type}`).classList.remove('active');
        } else {
            AppState.activeTypeToggles.add(type);
            document.getElementById(`toggle-${type}`).classList.add('active');
        }
        FilterManager.applyFilters();
    },
    updateDashboard(data) {
        const total = data.length;
        this.animateValue("total-projects", parseInt(document.getElementById('total-projects').textContent)||0, total, 1000);
        APP_CONFIG.PROJECT_TYPES.forEach(t => document.getElementById(`count-${t.type}`).textContent = data.filter(p => p._type === t.type).length);
        
        const statusData = AppState.activeCategory ? data.filter(p => p._type === AppState.activeCategory) : data;
        const container = document.getElementById('status-list');
        container.innerHTML = "";
        
        const stats = {};
        statusData.forEach(p => { const s = Utils.getStatusCategory(p.STATUS); stats[s] = (stats[s] || 0) + 1; });
        const sorted = Object.keys(stats).sort((a,b) => Utils.getStatusSortIndex(a) - Utils.getStatusSortIndex(b) || stats[b]-stats[a]);
        
        sorted.forEach(cat => {
            const count = stats[cat];
            const pct = total ? Math.round((count/total)*100) : 0;
            const col = Utils.getStatusColor(cat);
            const sel = (AppState.activeStatusFilter === cat) ? "selected" : "";
            container.innerHTML += `
                <div class="status-wrapper">
                    <div class="status-item ${sel}" onclick="UI.statusClick('${cat}')">
                        <div class="status-header"><span class="status-name">${cat}</span><span style="color:${col};font-weight:800">${count} (${pct}%)</span></div>
                        <div class="progress-bg"><div class="progress-fill" style="width:${pct}%;background:${col}"></div></div>
                    </div>
                </div>`;
        });
    },
    statusClick(status) {
        AppState.activeStatusFilter = (AppState.activeStatusFilter === status) ? null : status;
        FilterManager.applyFilters();
    },
    animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.textContent = Math.floor(progress * (end - start) + start);
            if (progress < 1) window.requestAnimationFrame(step);
            else obj.textContent = end;
        };
        window.requestAnimationFrame(step);
    },
    openReport() {
        const data = AppState.currentFilteredList.length ? AppState.currentFilteredList : AppState.allProjects;
        document.getElementById('report-overlay').classList.add('open');
        document.getElementById('report-layer-name').textContent = AppState.activeFeatureName || "SELURUH SABAH";
        document.getElementById('report-badge-area').textContent = AppState.activeFeatureName || "SELURUH SABAH";
        document.getElementById('report-total-count').textContent = data.length;
        
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleDateString('ms-MY', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
        document.getElementById('footer-date').textContent = now.toLocaleString();

        const mini = document.getElementById('report-mini-stats');
        mini.innerHTML = "";
        APP_CONFIG.PROJECT_TYPES.forEach(t => {
            mini.innerHTML += `<div class="mini-card" style="border-top-color:${t.color}"><h3 style="color:${t.color}">${data.filter(p=>p._type===t.type).length}</h3><span>${t.label}</span></div>`;
        });

        setTimeout(() => {
            ChartManager.renderCharts(data);
            this.initReportMap(data);
            this.loadGASReportData();
        }, 300);
    },
    loadGASReportData() {
        const content = document.getElementById('layer-info-content');
        const section = document.getElementById('layer-info-section');
        section.style.display = 'none';
        
        if (AppState.activeBoundaryKey && AppState.activeFeatureName) {
            section.style.display = 'block';
            content.innerHTML = '<div style="grid-column:1/-1;text-align:center"><i class="fas fa-spinner fa-spin"></i> Memuatkan data...</div>';
            document.getElementById('layer-info-name').textContent = AppState.activeFeatureName;

            DataManager.fetchLayerInfoGAS(AppState.activeBoundaryKey, AppState.activeFeatureName).then(rows => {
                content.innerHTML = '';
                if (rows && rows.length) {
                    const row = rows[0];
                    const skip = ['LAYER','_comments','OBJECTID','SHAPE_LENGTH','SHAPE_AREA','ID','F_CODE','FID'];
                    const activeName = Utils.normalize(AppState.activeFeatureName);
                    
                    for (const [k, v] of Object.entries(row)) {
                        if (skip.includes(k) || v === "" || Utils.normalize(String(v)) === activeName) continue;
                        content.innerHTML += `
                            <div class="data-row">
                                <span class="label">${k}</span><span class="value">${v}</span>
                                ${row['_comments']?.[k] ? `<div class="comment-box">ðŸ’¬ ${row['_comments'][k]}</div>` : ''}
                            </div>`;
                    }
                }
                if (!content.innerHTML) content.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999">Tiada maklumat tambahan unik.</div>';
            });
        }
    },
    initReportMap(data) {
        if (AppState.reportMap) { AppState.reportMap.remove(); AppState.reportMap = null; }
        document.getElementById('report-map').innerHTML = "";
        AppState.reportMap = L.map('report-map', { zoomControl: false, preferCanvas: true });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(AppState.reportMap);
        
        const group = L.featureGroup().addTo(AppState.reportMap);
        
        if (AppState.activeBoundaryKey && AppState.dataLayers[AppState.activeBoundaryKey]) {
            const geoJson = AppState.dataLayers[AppState.activeBoundaryKey].toGeoJSON();
            L.geoJSON(geoJson, {
                style: f => {
                    const active = MapManager.extractGeoName(f) === AppState.activeFeatureName;
                    return { color: active?'#DC2626':'#94a3b8', weight: active?2:1, fillColor: active?'#EF4444':'transparent', fillOpacity: active?0.2:0 };
                }
            }).addTo(group);
        }

        data.forEach(p => {
            if(p._validCoord) {
                L.circleMarker([p.LATITUDE, p.LONGITUDE], { radius: 3, color: 'transparent', fillColor: Utils.getTypeConfig(p._type).color, fillOpacity: 0.8 }).addTo(group);
            }
        });
        
        AppState.reportMap.invalidateSize();
        if (group.getLayers().length) AppState.reportMap.fitBounds(group.getBounds(), { padding: [20, 20] });
        else AppState.reportMap.setView(APP_CONFIG.SETTINGS.DEFAULT_MAP_CENTER, 7);
    },
    downloadCSV() {
        const data = AppState.visibleProjects;
        if (!data || !data.length) return alert("Tiada data dipaparkan.");
        const headers = ["SITE_NAME","DISTRICT","DUN","PARLIAMENT","LATITUDE","LONGITUDE","STATUS","PROJECT_TYPE"];
        data.forEach(p => p._extra_details.forEach(d => { if(!headers.includes(d.label)) headers.push(d.label); }));
        
        const csv = [headers.join(","), ...data.map(p => headers.map(h => {
            if(h==="PROJECT_TYPE") return p._type;
            if(h==="LATITUDE"||h==="LONGITUDE") return p[h];
            const extra = p._extra_details.find(d=>d.label===h);
            return `"${String(extra ? extra.value : (p[h]||"")).replace(/"/g, '""')}"`;
        }).join(","))].join("\n");
        
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], {type:"text/csv;charset=utf-8;"}));
        link.download = `GIS_Sabah_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    }
};

/**
 * 8. EXPORT & SHARE LOGIC (FIXED)
 */
async function captureReport(callback) {
    const originalNode = document.getElementById('report-content');
    if (!originalNode) return;

    UI.showLoading(true, "MENJANA IMEJ...");
    
    // 1. CLONE NODE to avoid scroll/overflow issues
    const clone = originalNode.cloneNode(true);
    
    // 2. STRETCH CLONE
    clone.style.width = "1400px"; // Fixed standard width
    clone.style.height = "auto";
    clone.style.maxHeight = "none";
    clone.style.overflow = "visible";
    clone.style.position = "absolute";
    clone.style.top = "-9999px";
    clone.style.left = "0";
    clone.style.zIndex = "9999";
    clone.style.background = "#f1f5f9"; // Ensure background exists
    
    // Remove buttons from clone
    const btns = clone.querySelector('.action-buttons');
    if(btns) btns.remove();
    const closeBtn = clone.querySelector('.modal-close-btn'); // Won't be there as it's outside content div, but safely check
    
    document.body.appendChild(clone);

    // 3. CAPTURE
    try {
        const canvas = await html2canvas(clone, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            logging: false,
            windowWidth: 1400
        });
        document.body.removeChild(clone);
        callback(canvas);
    } catch (err) {
        console.error(err);
        document.body.removeChild(clone);
        alert("Gagal menjana imej.");
    } finally {
        UI.showLoading(false);
    }
}

function shareReport() {
    captureReport(async (canvas) => {
        canvas.toBlob(async (blob) => {
            const file = new File([blob], "Laporan_GIS.png", { type: 'image/png' });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try { await navigator.share({ files: [file], title: 'Laporan GIS' }); } 
                catch (e) { saveAsImage(blob); }
            } else {
                saveAsImage(blob);
            }
        });
    });
}

function generateExport() {
    captureReport((canvas) => {
        const imgData = canvas.toDataURL('image/jpeg', 0.8);
        const pdf = new window.jspdf.jsPDF('l', 'mm', 'a3');
        const pdfW = pdf.internal.pageSize.getWidth();
        const pdfH = pdf.internal.pageSize.getHeight();
        const imgRatio = canvas.height / canvas.width;
        
        // Scale to fit width
        let printH = pdfW * imgRatio;
        if (printH > pdfH) {
             // If too tall, fit to height instead
             const scale = pdfH / printH;
             const printW = pdfW * scale;
             pdf.addImage(imgData, 'JPEG', (pdfW - printW)/2, 0, printW, pdfH);
        } else {
             pdf.addImage(imgData, 'JPEG', 0, 0, pdfW, printH);
        }
        pdf.save(`Laporan_GIS_${new Date().toISOString().slice(0,10)}.pdf`);
    });
}

function saveAsImage(blob) {
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "Laporan_GIS.png";
    link.click();
}

// Global Binds
window.toggleDashboard = () => document.getElementById('dashboard-panel').classList.toggle('closed');
window.closeReport = () => document.getElementById('report-overlay').classList.remove('open');
window.UI = UI; window.shareReport = shareReport; window.generateExport = generateExport; window.downloadCSV = UI.downloadCSV; window.openReport = UI.openReport.bind(UI);

window.onload = () => { UI.init(); MapManager.init(); DataManager.loadAllData(); };
</script>
</body>
</html>
