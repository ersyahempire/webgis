<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Web GIS Projek Sabah v5.8 - Official</title>
  
  <!-- FontAwesome & Google Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <!-- PDF Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ----- GLOBAL VARIABLES & RESET ----- */
:root {
  --primary: #4F46E5;        /* Indigo 600 */
  --primary-dark: #4338ca;   /* Indigo 700 */
  --primary-light: #818cf8;  /* Indigo 400 */
  --glass-bg: rgba(255, 255, 255, 0.90); 
  --glass-bg-hover: rgba(255, 255, 255, 0.98);    
  --glass-border: rgba(255, 255, 255, 0.8);        
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); 
  --glass-blur: 20px;                            
  --text-main: #111827;      /* Gray 900 */
  --text-sub: #6b7280;       /* Gray 500 */
  --radius: 20px;            
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  font-family: 'Plus Jakarta Sans', sans-serif;
  height: 100vh; width: 100vw;
  overflow: hidden;
  background: #eef2f5;
  color: var(--text-main);
}

/* ----- MAP CONTAINER ----- */
#map {
  position: absolute; top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 0;
  background: #ddd; 
}

/* TOOLTIP FIXES */
.leaflet-tooltip {
    pointer-events: none !important;
    background: rgba(255,255,255,0.8);
    border: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    font-weight: 700;
    font-size: 11px;
    color: var(--primary-dark);
}
.leaflet-interactive { cursor: pointer; }

/* ----- LOADING SCREEN ----- */
.loading-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.95); z-index: 9999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.5s;
}
.loading-overlay.hide { opacity: 0; pointer-events: none; }
.spinner {
    width: 50px; height: 50px; border: 5px solid #ddd;
    border-top: 5px solid var(--primary); border-radius: 50%;
    animation: spin 1s linear infinite; margin-bottom: 20px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* ----- SEARCH BAR ----- */
.search-container {
  position: absolute; top: 24px; left: 50%;
  transform: translateX(-50%); z-index: 1000;
  width: 90%; max-width: 480px; display: flex; gap: 10px;
}
.search-box {
  flex: 1;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  padding: 14px 24px; border-radius: 50px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex; align-items: center; transition: var(--transition);
}
.search-box:focus-within {
  transform: translateY(-2px) scale(1.01);
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 15px 40px rgba(79, 70, 229, 0.15);
  border-color: var(--primary-light);
}
.search-box i { color: var(--text-sub); margin-right: 12px; font-size: 16px; }
.search-box input {
  border: none; background: transparent; width: 100%;
  font-family: inherit; font-size: 15px; font-weight: 500; color: var(--text-main);
}

/* ----- FLOATING DASHBOARD (LEFT) ----- */
.panel-toggle {
  position: absolute; top: 24px; left: 24px; z-index: 1001;
  background: var(--primary); color: white;
  width: 50px; height: 50px; border-radius: 16px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
  border: none; font-size: 18px; transition: var(--transition);
}
.panel-toggle:hover { transform: translateY(-3px); background: var(--primary-dark); }

.dashboard-panel {
  position: absolute; top: 85px; left: 24px; bottom: 24px; width: 360px;
  z-index: 1000; background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  border-radius: var(--radius); border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex; flex-direction: column;
  transform: translateX(0); transition: var(--transition);
  opacity: 1; overflow: hidden;
}
.dashboard-panel.closed { transform: translateX(-120%); opacity: 0; pointer-events: none; }

.panel-header {
  padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.2);
  background: linear-gradient(to right, rgba(255,255,255,0.5), rgba(255,255,255,0.1));
}
.panel-header h2 { 
  margin: 0; font-size: 20px; font-weight: 800; 
  background: -webkit-linear-gradient(45deg, var(--primary-dark), var(--primary));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  display: flex; align-items: center; gap: 10px; 
}
.panel-content { padding: 20px 24px; overflow-y: auto; flex: 1; }

.main-stat {
  text-align: center; margin-bottom: 24px; padding: 20px; border-radius: 20px;
  background: linear-gradient(145deg, rgba(255,255,255,0.6), rgba(255,255,255,0.3));
  border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.03);
}
.main-stat-value { font-size: 48px; font-weight: 800; color: var(--text-main); line-height: 1; margin-bottom: 5px; }
.main-stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-sub); font-weight: 600; }
.area-badge {
  background: #e0e7ff; color: var(--primary); padding: 8px 16px; border-radius: 30px;
  font-size: 12px; font-weight: 700; display: inline-block; margin-top: 15px;
}

.grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
.mini-stat {
  background: rgba(255,255,255,0.5); padding: 16px; border-radius: 16px;
  text-align: center; border: 1px solid rgba(255,255,255,0.4);
  transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;
}
.mini-stat:hover { background: rgba(255,255,255,0.9); transform: translateY(-4px); }
.mini-stat.selected { background: #fff; border: 2px solid var(--primary); }
.mini-stat::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #ccc; opacity: 0.5; }
.mini-stat-val { font-size: 24px; font-weight: 700; color: var(--text-main); margin-bottom: 2px; }
.mini-stat-lbl { font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; }

/* Status List */
.status-section-title { font-size: 12px; font-weight: 800; text-transform: uppercase; color: var(--text-sub); margin: 0 0 16px 0; letter-spacing: 1px; }
.status-wrapper { margin-bottom: 12px; }
.status-item { 
  background: rgba(255,255,255,0.4); padding: 12px 16px; border-radius: 12px; 
  cursor: pointer; transition: var(--transition); border: 1px solid transparent; position: relative;
} 
.status-item:hover { background: rgba(255,255,255,0.8); }
.status-item.selected { background: #fff; border-color: var(--primary); border-radius: 12px 12px 0 0; }
.status-header { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin-bottom: 8px; font-weight: 600; } 
.status-name { font-weight: 700; color: var(--text-main); font-size: 13px; }
.progress-bg { width: 100%; height: 8px; background: rgba(0,0,0,0.06); border-radius: 10px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 10px; transition: width 1s; }
.status-details {
  background: rgba(255,255,255,0.6); padding: 16px; border-radius: 0 0 12px 12px;
  border: 1px solid rgba(255,255,255,0.5); border-top: none; display: none;
}
.status-details.show { display: block; }
.sub-stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px; }
.sub-stat-bar-bg { width: 100%; height: 4px; background: rgba(0,0,0,0.05); border-radius: 2px; margin-bottom: 10px; }
.sub-stat-bar-fill { height: 100%; border-radius: 2px; }

/* ----- CONTROLS (RIGHT) ----- */
.controls-container {
  position: absolute; top: 90px; right: 24px;
  display: flex; flex-direction: column; gap: 12px;
  z-index: 1000; align-items: flex-end; 
}
.control-card {
  background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  padding: 6px; border-radius: 14px; box-shadow: var(--glass-shadow); width: 52px; overflow: hidden;
  transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1), background 0.3s; border: 1px solid var(--glass-border); white-space: nowrap;
}
.control-card:hover, .control-card.expanded { width: 190px; background: var(--glass-bg-hover); }
.control-group-title {
  padding: 12px 14px 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--text-sub); letter-spacing: 0.5px; display: none;
}
.control-card.expanded .control-group-title { display: block; animation: fadeIn 0.3s; }

.toggle-btn {
  display: flex; align-items: center; width: 100%; padding: 10px; background: transparent; border: none; cursor: pointer;
  border-radius: 10px; color: var(--text-sub); transition: all 0.2s; text-align: left; margin-bottom: 2px;
}
.toggle-btn i, .toggle-btn span.icon-slot { width: 30px; text-align: center; font-size: 16px; flex-shrink: 0; }
.toggle-btn span.text-slot { opacity: 0; transition: opacity 0.2s; font-size: 13px; font-weight: 600; padding-left: 5px;}
.control-card:hover .toggle-btn span.text-slot, .control-card.expanded .toggle-btn span.text-slot { opacity: 1; }
.toggle-btn:hover { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
.toggle-btn.active { background: var(--primary); color: white; }
.toggle-btn.active i, .toggle-btn.active span.icon-slot { color: white !important; }

/* Legend Mini */
.legend-mini { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); }
.legend-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; font-weight: 500; color: var(--text-sub); }
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; box-shadow: 0 0 0 2px rgba(255,255,255,0.5); }

/* ----- REPORT MODAL ----- */
.report-overlay {
    position: fixed; inset: 0; z-index: 5000;
    background: rgba(17, 24, 39, 0.6); backdrop-filter: blur(6px);
    display: none; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s ease;
}
.report-overlay.open { display: flex; opacity: 1; }
.report-modal {
    width: 95%; max-width: 1400px; height: 90vh; border-radius: 20px;
    box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.5);
    display: flex; flex-direction: column; overflow: hidden;
    transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    background: linear-gradient(135deg, #7F7FD5 0%, #86A8E7 50%, #91EAE4 100%);
    color: #1f2937; border: 1px solid rgba(255,255,255,0.3); position: relative;
}
.report-overlay.open .report-modal { transform: scale(1); }
.report-container { padding: 30px; display: flex; flex-direction: column; gap: 25px; height: 100%; overflow-y: auto; }
.modal-close-btn {
    position: absolute; top: 15px; right: 20px; z-index: 5002;
    background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.4); width: 40px; height: 40px; border-radius: 50%; 
    cursor: pointer; color: #fff; display: flex; align-items: center; justify-content: center;
}
.modal-close-btn:hover { background: rgba(255, 255, 255, 0.8); color: #ef4444; }

/* Report Cards */
.card {
    background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px); border-radius: 16px; padding: 20px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.6);
}
.report-header-content { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.4); }
.header-title h1 { font-size: 1.1rem; font-weight: 800; text-transform: uppercase; margin: 0; color: rgba(255,255,255,0.8); letter-spacing: 1px; }
.header-title h2 { font-size: 2.2rem; font-weight: 800; margin: 5px 0 0 0; line-height: 1.1; color: #fff; }
.header-info { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; margin-right: 40px; }
.btn-download-pdf {
    background: rgba(255, 255, 255, 0.9); padding: 10px 20px; border-radius: 8px; font-size: 0.85rem; 
    cursor: pointer; border: none; color: #4f46e5; font-weight: 700; text-transform: uppercase;
    display: flex; align-items: center; gap: 8px;
}
.btn-download-pdf:hover { background: #fff; }
.current-time { font-size: 0.85rem; color: rgba(255,255,255,0.9); font-weight: 600; background: rgba(0,0,0,0.1); padding: 5px 12px; border-radius: 6px; }

/* Report Layout */
.top-row { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
.report-main-stat { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: rgba(255, 255, 255, 0.6); }
.report-main-stat h1 { font-size: 3.5rem; color: #3730a3; margin: 10px 0; }
.badge { background: rgba(79, 70, 229, 0.9); color: #fff; padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
.mini-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; }
.mini-card {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: rgba(255, 255, 255, 0.5); border-radius: 16px; padding: 15px;
    border: 1px solid rgba(255,255,255,0.5); border-top-width: 4px;
}
.mini-card h3 { font-size: 1.8rem; color: #1f2937; margin: 0 0 5px 0; }
.mini-card span { font-size: 0.75rem; font-weight: 700; color: #4b5563; text-transform: uppercase; }

.charts-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
.chart-card { height: 480px; padding: 20px; display: flex; flex-direction: column; background: rgba(255, 255, 255, 0.65); }
.chart-title { font-size: 0.9rem; font-weight: 700; margin-bottom: 15px; text-transform: uppercase; color: #111827; border-bottom: 1px solid rgba(0,0,0,0.05); }

.main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; min-height: 450px; }
.map-container { padding: 0; overflow: hidden; border-radius: 16px; }
#report-map { width: 100%; height: 100%; }
.status-container { background: rgba(255, 255, 255, 0.6); padding: 0; overflow: hidden; display: flex; flex-direction: column; }
.status-header-fixed { padding: 15px 20px; background: rgba(255,255,255,0.4); border-bottom: 1px solid rgba(255,255,255,0.5); font-weight: 800; color: #374151; }
.status-scroll-area { padding: 20px; overflow-y: auto; flex: 1; }
.status-group { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed rgba(0,0,0,0.1); }
.status-label-row { display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 6px; }
.progress-track { background: rgba(0,0,0,0.05); height: 8px; border-radius: 4px; width: 100%; overflow: hidden; margin-bottom: 10px; }

.bottom-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 10px; padding-bottom: 20px; }
.bottom-card { height: 480px; padding: 20px; background: rgba(255, 255, 255, 0.65); display: flex; flex-direction: column; overflow: hidden; }
.bottom-card-header { margin-bottom: 15px; flex-shrink: 0; }
.bottom-card-body { flex: 1; min-height: 0; width: 100%; }
.icon-box { width: 36px; height: 36px; border-radius: 8px; }

/* Responsive */
@media (max-width: 1200px) { .charts-row, .bottom-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { 
    .charts-row, .bottom-grid { grid-template-columns: 1fr; }
    .top-row, .main-content { grid-template-columns: 1fr; }
    .header-info { margin-right: 40px; }
}
</style>
</head>
<body>

  <!-- Map Background -->
  <div id="map"></div>

  <!-- Loading Screen -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div style="font-weight: 700; font-size: 14px; color: var(--primary); letter-spacing: 0.5px;">MEMUATKAN DATA GIS...</div>
    <div id="loading-msg" style="font-size: 11px; margin-top: 5px; color: #666;"></div>
  </div>

  <!-- Top Search Bar -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="search-input" placeholder="Cari tapak, daerah, atau parlimen...">
    </div>
  </div>

  <!-- Sidebar Toggle -->
  <button class="panel-toggle" id="sidebar-toggle" onclick="toggleDashboard()">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Floating Dashboard -->
  <div class="dashboard-panel" id="dashboard-panel">
    <div class="panel-header">
      <h2><i class="fas fa-layer-group"></i> Statistik Projek</h2>
    </div>
    
    <div class="panel-content">
      <div class="main-stat">
        <div class="main-stat-value" id="total-projects">0</div>
        <div class="main-stat-label">Jumlah Projek</div>
        <div id="selected-area" class="area-badge">SELURUH SABAH</div>
      </div>
      <div class="grid-stats" id="dynamic-grid-stats"></div>
      <div class="status-section-title">Status Kemajuan</div>
      <div id="status-list"></div>
      <div class="legend-mini" id="dynamic-legend"></div>
    </div>
  </div>

  <!-- Right Controls -->
  <div class="controls-container">
    <!-- CSV -->
    <div class="control-card">
        <button class="toggle-btn" title="Muat Turun CSV" onclick="downloadCSV()">
            <span class="icon-slot"><i class="fas fa-file-csv" style="color: #10B981;"></i></span> 
            <span class="text-slot">Muat Turun CSV</span>
        </button>
    </div>
    <!-- Report -->
    <div class="control-card">
        <button class="toggle-btn" title="Report Kad" onclick="openReport()">
            <span class="icon-slot"><i class="fas fa-file-invoice-dollar" style="color: #F59E0B;"></i></span> 
            <span class="text-slot">Report Kad</span>
        </button>
    </div>
    <!-- Layer Toggle -->
    <div class="control-card" id="layer-card">
      <div class="control-group-title">Sempadan</div>
      <button class="toggle-btn active" id="toggle-daerah" title="Daerah">
        <span class="icon-slot"><i class="fas fa-map-marked-alt"></i></span> <span class="text-slot">Daerah</span>
      </button>
      <button class="toggle-btn" id="toggle-dun" title="DUN">
        <span class="icon-slot"><i class="fas fa-landmark"></i></span> <span class="text-slot">DUN</span>
      </button>
      <button class="toggle-btn" id="toggle-parliament" title="Parlimen">
        <span class="icon-slot"><i class="fas fa-building"></i></span> <span class="text-slot">Parlimen</span>
      </button>
    </div>
    <!-- Category Filters -->
    <div class="control-card" id="filter-card">
      <div class="control-group-title">Penapis Data</div>
      <div id="dynamic-filter-btns"></div>
    </div>
  </div>

  <!-- REPORT MODAL -->
  <div class="report-overlay" id="report-overlay">
      <div class="report-modal" id="report-content">
          <button class="modal-close-btn" onclick="closeReport()"><i class="fas fa-times"></i></button>
          
          <div class="report-container">
              <!-- HEADER -->
              <header class="report-header-content">
                  <div class="header-title">
                      <h1>Laporan Dashboard Projek</h1>
                      <h2 id="report-layer-name">SELURUH SABAH</h2>
                  </div>
                  <div class="header-info">
                      <button class="btn-download-pdf" onclick="generatePDF()">Muat Turun PDF</button>
                      <div class="current-time" id="clock">Loading...</div>
                  </div>
              </header>

              <!-- TOP STATS -->
              <div class="top-row">
                  <div class="card report-main-stat">
                      <h1 id="report-total-count">0</h1>
                      <p>JUMLAH KESELURUHAN PROJEK</p>
                      <div class="badge" id="report-badge-area">SELURUH SABAH</div>
                  </div>
                  <div class="mini-stats-grid" id="report-mini-stats"></div>
              </div>

              <!-- CHARTS ROW -->
              <div class="charts-row">
                  <div class="card chart-card">
                      <div class="chart-title">Carta 01: Jumlah Site Mengikut Projek</div>
                      <div id="chart-01" style="flex:1; width:100%; min-height: 0; overflow:hidden;"></div>
                  </div>
                  <div class="card chart-card">
                      <div class="chart-title">Carta 02: Status Projek</div>
                      <div id="chart-02" style="flex:1; width:100%; min-height: 0; overflow:hidden;"></div>
                  </div>
                  <div class="card chart-card">
                      <div class="chart-title">Carta 03: Jumlah Projek vs Status</div>
                      <div id="chart-03" style="flex:1; width:100%; min-height: 0; overflow:hidden;"></div>
                  </div>
              </div>

              <!-- MAIN CONTENT (MAP & STATUS) -->
              <div class="main-content">
                  <div class="card map-container">
                      <div id="report-map"></div>
                  </div>
                  <div class="card status-container">
                      <div class="status-header-fixed">STATUS KEMAJUAN TERPERINCI</div>
                      <div class="status-scroll-area" id="dynamic-status-container"></div>
                  </div>
              </div>

              <!-- BOTTOM GRID -->
              <div class="bottom-grid" id="dynamic-bottom-grid"></div>

              <footer>
                  Sistem dibangunkan oleh MCMC Tawau &copy; 2024
              </footer>
          </div>
      </div>
  </div>
    
<!-- MAIN SCRIPT -->
<script>
/**
 * =============================================================================
 * 1. CONFIGURATION (WAJIB - USER BOLEH UBAH)
 * =============================================================================
 */
const APP_CONFIG = {
    PROJECT_TYPES: [
        { id: "db_bwa", sheetId: "1594VRWEs0PF56KXeSPudZTWkbGuS5UZmxXGrKqo4bUU", type: "BWA", label: "WiFi", color: "#51cf66", icon: "ðŸ“¶" },
        { id: "db_pim", sheetId: "1WyZiw72LOVytssXAuymJS_TIgckLCUqY56pB0QhawZU", type: "NADI", label: "NADI", color: "#4dabf7", icon: "ðŸ“¡" },
        { id: "db_pop", sheetId: "1JLqLtZPa4Kd6hEbRA2wgMgADX2h2-tdsXnG-YivSgU8", type: "POP", label: "POP", color: "#fcc419", icon: "ðŸŒ" },
        { id: "tower", sheetId: "1b0Aipp0MQvP8HWc-z28dugkGn5sWdNAx6ZE5-Mu13-0", type: "TOWER", label: "Menara", color: "#ff6b6b", icon: "ðŸ—¼", filter: { col: "PROJECT_TYPE", val: "USP" } }
    ],

    STATUS_COLORS: {
        "SIAP": { color: "#86efac", label: "SIAP" },
        "PEMBINAAN": { color: "#fde047", label: "PEMBINAAN" },
        "PERANCANGAN": { color: "#fca5a5", label: "PERANCANGAN" },
        "LAIN-LAIN": { color: "#cbd5e1", label: "LAIN-LAIN" }
    },

    SETTINGS: {
        MAX_EXTRA_INFO_COLUMNS: 15,
        REFRESH_INTERVAL_MS: 60000,
        DEFAULT_MAP_CENTER: [5.9804, 116.0735],
        DEFAULT_ZOOM: 8
    },
    
    GEOJSON_URLS: {
        district: "district.json",
        dun: "dun.json",
        parliament: "parliament.json"
    }
};

/**
 * =============================================================================
 * 2. UTILITIES / HELPER FUNCTIONS
 * =============================================================================
 */
const Utils = {
    escapeHtml: (str) => String(str || "").replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c])),
    normalize: (str) => String(str || "").trim().toUpperCase(),
    cleanFloat: (val) => {
        if (typeof val === 'number') return val;
        if (!val) return 0;
        const str = String(val).replace(/[^0-9.,-]/g, "").replace(',', '.').trim();
        const floatVal = parseFloat(str);
        return isNaN(floatVal) ? 0 : floatVal;
    },
    generateId: (rowObj, type) => {
        const name = Utils.normalize(rowObj.SITE_NAME || "UNKNOWN");
        const dist = Utils.normalize(rowObj.DISTRICT || "SABAH");
        return `${type}_${name.replace(/\s+/g, '_')}_${dist.replace(/\s+/g, '_')}`;
    },
    debounce: (fn, wait = 250) => {
        let t;
        return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); };
    },
    getRandomColor: () => {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) { color += letters[Math.floor(Math.random() * 16)]; }
        return color;
    },
    getStatusCategory: (rawStatus) => {
        const s = Utils.normalize(rawStatus);
        if (s.match(/SIAP|KOMITED|OPERASI|SELESAI|COMPLETE/)) return "SIAP";
        if (s.match(/BINA|IMPLEMENTASI|PROGRESS|PELAKSANAAN/)) return "PEMBINAAN";
        if (s.match(/RANCANG|BARU|PLAN/)) return "PERANCANGAN";
        return "LAIN-LAIN";
    },
    getTypeConfig: (typeKey) => APP_CONFIG.PROJECT_TYPES.find(t => t.type === typeKey) || { color: "#666", icon: "â“", label: typeKey },
    getStatusColor: (statusKey) => {
        const cat = Utils.getStatusCategory(statusKey);
        return APP_CONFIG.STATUS_COLORS[cat] ? APP_CONFIG.STATUS_COLORS[cat].color : APP_CONFIG.STATUS_COLORS["LAIN-LAIN"].color;
    }
};

/**
 * =============================================================================
 * 3. STATE MANAGEMENT
 * =============================================================================
 */
const AppState = {
    map: null,
    reportMap: null,
    markersLayerGroup: null,
    reportMarkerLayer: null,
    allProjects: [],
    currentFilteredList: [],
    markersBySite: new Map(),
    dataLayers: { district: null, dun: null, parliament: null },
    
    // Filter States
    activeBoundaryKey: null,
    activeFeatureName: null,
    searchTerm: "",
    activeStatusFilter: null,
    activeTypeToggles: new Set(), // Mula kosong (Semua marker off)
    
    // Charts
    charts: { c1: null, c2: null, c3: null, bottom: [] }
};

/**
 * =============================================================================
 * 4. DATA FETCHING & PROCESSING
 * =============================================================================
 */
const DataManager = {
    async loadAllData() {
        UI.showLoading(true, "MENGHUBUNGI GOOGLE SHEETS...");
        try {
            const promises = APP_CONFIG.PROJECT_TYPES.map(config => this.fetchSingleSheet(config));
            const results = await Promise.all(promises);
            AppState.allProjects = results.flat();
            
            if (AppState.allProjects.length === 0) alert("Tiada data ditemui.");
            
            MapManager.renderMarkersInBatches(AppState.allProjects, () => {
                FilterManager.applyFilters();
                UI.showLoading(false);
            });
        } catch (error) {
            console.error("Critical Data Load Error:", error);
            UI.showLoading(false);
            alert("Ralat memuatkan data.");
        }
    },
    async fetchSingleSheet(config) {
        const url = `https://docs.google.com/spreadsheets/d/${config.sheetId}/gviz/tq?tqx=out:json&tq=`;
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP Error ${res.status}`);
            const text = await res.text();
            const jsonStart = text.indexOf('{');
            const jsonEnd = text.lastIndexOf('}');
            if (jsonStart === -1 || jsonEnd === -1) return [];
            const json = JSON.parse(text.substring(jsonStart, jsonEnd + 1));
            return (json.table && json.table.rows) ? this.processSheetData(json.table, config) : [];
        } catch (e) {
            console.warn(`Gagal memuatkan sheet: ${config.label}`, e);
            return [];
        }
    },
    processSheetData(table, config) {
        const cols = table.cols.map(c => c ? Utils.normalize(c.label) : "");
        const rows = table.rows;
        const STD_HEADERS = {
            SITE_NAME: ["SITE_NAME", "SITE NAME", "SITE", "NAMA_TAPAK"],
            DISTRICT: ["DISTRICT", "DAERAH"],
            DUN: ["DUN"],
            PARLIAMENT: ["PARLIAMENT", "PARLIAMENT_NAME", "PARLIMEN"],
            LAT: ["LATITUDE", "LAT", "LATITUDE_DEC"],
            LNG: ["LONGITUDE", "LON", "LNG", "LONG"],
            STATUS: ["STATUS", "STATUS_1", "KEMAJUAN"]
        };
        return rows.map(r => {
            const rowData = {};
            const extraDetails = [];
            const getValue = (headerKeys) => {
                for (let key of headerKeys) {
                    const idx = cols.indexOf(key);
                    if (idx > -1 && r.c[idx] && r.c[idx].v !== null) return r.c[idx].v;
                }
                return "";
            };
            if (config.filter) {
                const filterColIdx = cols.indexOf(Utils.normalize(config.filter.col));
                if (filterColIdx > -1) {
                    const val = r.c[filterColIdx]?.v || "";
                    if (Utils.normalize(val) !== Utils.normalize(config.filter.val)) return null;
                }
            }
            rowData.SITE_NAME = String(getValue(STD_HEADERS.SITE_NAME) || "N/A").trim();
            rowData.DISTRICT = String(getValue(STD_HEADERS.DISTRICT)).trim();
            rowData.DUN = String(getValue(STD_HEADERS.DUN)).trim();
            rowData.PARLIAMENT = String(getValue(STD_HEADERS.PARLIAMENT)).trim();
            rowData.STATUS = String(getValue(STD_HEADERS.STATUS) || "TIADA STATUS").trim();
            rowData.LATITUDE = Utils.cleanFloat(getValue(STD_HEADERS.LAT));
            rowData.LONGITUDE = Utils.cleanFloat(getValue(STD_HEADERS.LNG));
            rowData._type = config.type;
            rowData._validCoord = (rowData.LATITUDE !== 0 && rowData.LONGITUDE !== 0);
            if (rowData.SITE_NAME === "N/A") return null;
            let count = 0;
            const usedKeys = Object.values(STD_HEADERS).flat();
            cols.forEach((colName, idx) => {
                if (count >= APP_CONFIG.SETTINGS.MAX_EXTRA_INFO_COLUMNS) return;
                if (!colName || usedKeys.includes(colName)) return;
                const val = r.c[idx]?.v;
                if (val !== null && val !== undefined && val !== "") {
                    extraDetails.push({ label: colName, value: String(val).trim() });
                    count++;
                }
            });
            rowData._extra_details = extraDetails;
            rowData._id = Utils.generateId(rowData, config.type);
            return rowData;
        }).filter(item => item !== null);
    }
};

/**
 * =============================================================================
 * 5. MAP RENDERING (LEAFLET)
 * =============================================================================
 */
const MapManager = {
    init() {
        AppState.map = L.map('map', { zoomControl: false }).setView(APP_CONFIG.SETTINGS.DEFAULT_MAP_CENTER, APP_CONFIG.SETTINGS.DEFAULT_ZOOM);
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap' });
        satellite.addTo(AppState.map);
        L.control.layers({ "Satelit (Esri)": satellite, "Peta (OSM)": osm }, null, { position: 'topright' }).addTo(AppState.map);
        L.control.zoom({ position: 'bottomright' }).addTo(AppState.map);
        AppState.markersLayerGroup = L.layerGroup().addTo(AppState.map);
        this.loadBoundaries();
    },
    async loadBoundaries() {
        const loadLayer = async (key, url) => {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("File Missing");
                const data = await res.json();
                const layer = L.geoJSON(data, {
                    style: { color: '#666', weight: 1, fillOpacity: 0.05, fillColor: '#ffffff' },
                    onEachFeature: (feature, layer) => {
                        const name = this.extractGeoName(feature);
                        layer.bindTooltip(name, { sticky: true, interactive: false, direction: 'center', className: 'leaflet-tooltip' });
                        layer.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            this.highlightBoundary(key, layer, name);
                        });
                        // HOVER EFFECT - RAWAK COLOR
                        layer.on('mouseover', (e) => {
                            if (AppState.activeFeatureName !== name) {
                                e.target.setStyle({ fillColor: Utils.getRandomColor(), fillOpacity: 0.5, weight: 2, color: '#333' });
                            }
                        });
                        layer.on('mouseout', (e) => {
                            if (AppState.activeFeatureName !== name) {
                                AppState.dataLayers[key].resetStyle(e.target);
                            }
                        });
                    }
                });
                AppState.dataLayers[key] = layer;
            } catch (e) {
                console.warn(`GeoJSON ${key} gagal dimuatkan.`);
                AppState.dataLayers[key] = L.layerGroup();
            }
        };
        await Promise.all([
            loadLayer('district', APP_CONFIG.GEOJSON_URLS.district),
            loadLayer('dun', APP_CONFIG.GEOJSON_URLS.dun),
            loadLayer('parliament', APP_CONFIG.GEOJSON_URLS.parliament)
        ]);
        
        // Setup Toggles
        document.getElementById('toggle-daerah').onclick = () => this.switchBoundary('district', 'toggle-daerah');
        document.getElementById('toggle-dun').onclick = () => this.switchBoundary('dun', 'toggle-dun');
        document.getElementById('toggle-parliament').onclick = () => this.switchBoundary('parliament', 'toggle-parliament');
        
        // DEFAULT LOAD: ACTIVE DISTRICT
        setTimeout(() => this.switchBoundary('district', 'toggle-daerah'), 500);
    },
    extractGeoName(feature) {
        const props = feature.properties || {};
        return Utils.normalize(props.NAME || props.name || props.DISTRICT || props.DAERAH || props.DUN || props.PARLIAMENT || "Sabah");
    },
    switchBoundary(key, btnId) {
        Object.values(AppState.dataLayers).forEach(l => { if(l && AppState.map.hasLayer(l)) AppState.map.removeLayer(l); });
        if (AppState.dataLayers[key] && AppState.dataLayers[key].getLayers().length > 0) {
            AppState.map.addLayer(AppState.dataLayers[key]);
            AppState.activeBoundaryKey = key;
        } else {
            AppState.activeBoundaryKey = null;
        }
        AppState.activeFeatureName = null;
        document.getElementById('selected-area').textContent = "SELURUH SABAH";
        document.querySelectorAll('#layer-card .toggle-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(btnId).classList.add('active');
        AppState.map.setView(APP_CONFIG.SETTINGS.DEFAULT_MAP_CENTER, APP_CONFIG.SETTINGS.DEFAULT_ZOOM);
        FilterManager.applyFilters();
    },
    highlightBoundary(key, layer, name) {
        AppState.dataLayers[key].eachLayer(l => {
            AppState.dataLayers[key].resetStyle(l);
            if(l.isTooltipOpen()) l.closeTooltip();
        });
        const color = Utils.getRandomColor();
        layer.setStyle({ weight: 3, color: 'var(--primary)', fillOpacity: 0.4, fillColor: color });
        AppState.activeFeatureName = name;
        document.getElementById('selected-area').textContent = name;
        AppState.map.fitBounds(layer.getBounds());
        FilterManager.applyFilters();
    },
    createMarker(project) {
        if (!project._validCoord) return null;
        const config = Utils.getTypeConfig(project._type);
        const statusColor = Utils.getStatusColor(project.STATUS);
        let extraHtml = project._extra_details.map(d => 
            `<div class="sub-stat-row"><span class="sub-stat-label">${Utils.escapeHtml(d.label)}</span><span class="sub-stat-val">${Utils.escapeHtml(d.value)}</span></div>`
        ).join('');
        if (extraHtml) extraHtml = `<div style="margin-top:10px; padding-top:10px; border-top:1px dashed #ccc; font-weight:700; font-size:11px;">MAKLUMAT TERPERINCI</div>` + extraHtml;
        const popupContent = `
            <div style="font-family:'Plus Jakarta Sans'; min-width:200px;">
                <div style="font-weight:800; font-size:14px; margin-bottom:5px; color:var(--primary);">${config.icon} ${Utils.escapeHtml(project.SITE_NAME)}</div>
                <div style="font-size:12px; color:#555;">
                    <div><b>Kategori:</b> ${config.label}</div>
                    <div><b>Daerah:</b> ${Utils.escapeHtml(project.DISTRICT)}</div>
                    <div><b>Status:</b> <span style="color:${statusColor}; font-weight:700;">${Utils.escapeHtml(project.STATUS)}</span></div>
                    ${extraHtml}
                </div>
            </div>`;
        const marker = L.circleMarker([project.LATITUDE, project.LONGITUDE], {
            radius: 6, fillColor: config.color, color: "#fff", weight: 2, opacity: 1, fillOpacity: 1
        }).bindPopup(popupContent);
        marker._meta = project;
        return marker;
    },
    renderMarkersInBatches(projects, onComplete) {
        const total = projects.length; 
        let i = 0;
        const batchSize = 500;
        const runChunk = () => {
            const end = Math.min(i + batchSize, total);
            for (; i < end; i++) {
                const p = projects[i];
                if (!AppState.markersBySite.has(p._id)) {
                    const m = this.createMarker(p);
                    if (m) AppState.markersBySite.set(p._id, m);
                }
            }
            if (i < total) setTimeout(runChunk, 20);
            else if (onComplete) onComplete();
        };
        runChunk();
    }
};

/**
 * =============================================================================
 * 6. DATA PROCESSING & FILTERING
 * =============================================================================
 */
const FilterManager = {
    applyFilters() {
        let list = AppState.allProjects;

        // 1. Boundary Filter
        if (AppState.activeBoundaryKey && AppState.activeFeatureName) {
            const boundaryName = AppState.activeFeatureName;
            list = list.filter(p => {
                if (AppState.activeBoundaryKey === 'district') return Utils.normalize(p.DISTRICT) === boundaryName;
                if (AppState.activeBoundaryKey === 'dun') return Utils.normalize(p.DUN) === boundaryName;
                if (AppState.activeBoundaryKey === 'parliament') return Utils.normalize(p.PARLIAMENT) === boundaryName;
                return false;
            });
        }

        // 2. Search Filter
        if (AppState.searchTerm) {
            const term = AppState.searchTerm.toLowerCase();
            list = list.filter(p => 
                p.SITE_NAME.toLowerCase().includes(term) ||
                p.DISTRICT.toLowerCase().includes(term) ||
                p.DUN.toLowerCase().includes(term)
            );
        }

        AppState.currentFilteredList = list;
        UI.updateDashboard(list);

        // 3. Map Marker Visibility (Based on Active Toggles)
        let mapList = list.filter(p => AppState.activeTypeToggles.has(p._type));
        
        if (AppState.activeStatusFilter) {
            mapList = mapList.filter(p => Utils.getStatusCategory(p.STATUS) === Utils.getStatusCategory(AppState.activeStatusFilter));
        }

        this.updateMapMarkers(mapList);
    },
    updateMapMarkers(displayList) {
        AppState.markersLayerGroup.clearLayers();
        const visibleIds = new Set(displayList.map(p => p._id));
        AppState.markersBySite.forEach((marker, id) => {
            if (visibleIds.has(id)) AppState.markersLayerGroup.addLayer(marker);
        });
    }
};

/**
 * =============================================================================
 * 7. UI RENDERING & CHARTS
 * =============================================================================
 */
const UI = {
    init() {
        this.generateDynamicControls();
        document.getElementById('search-input').addEventListener('input', Utils.debounce((e) => {
            AppState.searchTerm = e.target.value;
            FilterManager.applyFilters();
        }));
    },
    showLoading(show, msg) {
        const el = document.getElementById('loading');
        if(show) el.classList.remove('hide');
        else el.classList.add('hide');
        if(msg) document.getElementById('loading-msg').textContent = msg;
    },
    generateDynamicControls() {
        const grid = document.getElementById('dynamic-grid-stats');
        const legend = document.getElementById('dynamic-legend');
        const filters = document.getElementById('dynamic-filter-btns');
        
        APP_CONFIG.PROJECT_TYPES.forEach(t => {
            // Dashboard Mini Stat
            const stat = document.createElement('div');
            stat.className = 'mini-stat'; // Remove 'selected' initially
            stat.id = `stat-card-${t.type}`;
            stat.onclick = () => this.handleCategoryToggle(t.type);
            stat.setAttribute('style', `--stat-color: ${t.color}`);
            stat.innerHTML = `
                <style>#stat-card-${t.type}::before { background: ${t.color}; }</style>
                <div class="mini-stat-val" id="count-${t.type}" style="color:${t.color}">0</div>
                <div class="mini-stat-lbl">${t.label}</div>
            `;
            grid.appendChild(stat);

            // Legend
            legend.innerHTML += `<div class="legend-row"><span class="dot" style="background:${t.color}"></span> ${t.label}</div>`;

            // Filter Button (Right Side) - Start Disabled
            const btn = document.createElement('button');
            btn.className = "toggle-btn"; 
            btn.id = `toggle-${t.type}`;
            btn.innerHTML = `<span class="icon-slot">${t.icon}</span><span class="text-slot">${t.label}</span>`;
            btn.onclick = () => this.handleCategoryToggle(t.type);
            filters.appendChild(btn);
        });
    },
    handleCategoryToggle(type) {
        // Toggle Logic
        if (AppState.activeTypeToggles.has(type)) {
            AppState.activeTypeToggles.delete(type);
            document.getElementById(`stat-card-${type}`).classList.remove('selected');
            document.getElementById(`toggle-${type}`).classList.remove('active');
        } else {
            AppState.activeTypeToggles.add(type);
            document.getElementById(`stat-card-${type}`).classList.add('selected');
            document.getElementById(`toggle-${type}`).classList.add('active');
        }
        FilterManager.applyFilters();
    },
    updateDashboard(data) {
        document.getElementById('total-projects').textContent = data.length;
        APP_CONFIG.PROJECT_TYPES.forEach(t => {
            const count = data.filter(p => p._type === t.type).length;
            document.getElementById(`count-${t.type}`).textContent = count;
        });
        this.renderStatusList(data);
    },
    renderStatusList(data) {
        const container = document.getElementById('status-list');
        container.innerHTML = "";
        const stats = { "SIAP": 0, "PEMBINAAN": 0, "PERANCANGAN": 0, "LAIN-LAIN": 0 };
        const details = {};
        data.forEach(p => {
            const cat = Utils.getStatusCategory(p.STATUS);
            stats[cat]++;
            if(!details[cat]) details[cat] = {};
            if(!details[cat][p._type]) details[cat][p._type] = 0;
            details[cat][p._type]++;
        });
        Object.keys(APP_CONFIG.STATUS_COLORS).forEach(cat => {
            const count = stats[cat] || 0;
            if (count === 0 && cat === "LAIN-LAIN") return;
            const colorCfg = APP_CONFIG.STATUS_COLORS[cat];
            const percent = data.length > 0 ? Math.round((count / data.length) * 100) : 0;
            const isSelected = (AppState.activeStatusFilter === cat) ? "selected" : "";
            let subHtml = "";
            if (details[cat]) {
                Object.entries(details[cat]).forEach(([type, tCount]) => {
                    const tConfig = Utils.getTypeConfig(type);
                    const tPercent = Math.round((tCount / count) * 100);
                    subHtml += `
                        <div class="sub-stat-row">
                             <span style="color:${tConfig.color}; font-weight:700;">${tConfig.label}</span>
                             <span>${tCount}</span>
                        </div>
                        <div class="sub-stat-bar-bg"><div class="sub-stat-bar-fill" style="width:${tPercent}%; background:${tConfig.color}"></div></div>
                    `;
                });
            }
            const item = document.createElement('div');
            item.className = "status-wrapper";
            item.innerHTML = `
                <div class="status-item ${isSelected}" onclick="UI.toggleStatusFilter('${cat}')">
                    <div class="status-header">
                        <span class="status-name">${colorCfg.label}</span>
                        <span style="color:${colorCfg.color}; font-weight:800;">${count}</span>
                    </div>
                    <div class="progress-bg"><div class="progress-fill" style="width:${percent}%; background:${colorCfg.color}"></div></div>
                </div>
                <div class="status-details ${isSelected ? 'show' : ''}">${subHtml}</div>
            `;
            container.appendChild(item);
        });
    },
    toggleStatusFilter(status) {
        AppState.activeStatusFilter = (AppState.activeStatusFilter === status) ? null : status;
        FilterManager.applyFilters();
    },
    openReport() {
        const data = AppState.currentFilteredList.length > 0 ? AppState.currentFilteredList : AppState.allProjects;
        document.getElementById('report-overlay').classList.add('open');
        document.getElementById('report-layer-name').textContent = AppState.activeFeatureName || "SELURUH SABAH";
        document.getElementById('report-badge-area').textContent = AppState.activeFeatureName || "SELURUH SABAH";
        document.getElementById('report-total-count').textContent = data.length;
        this.updateClock();
        const miniContainer = document.getElementById('report-mini-stats');
        miniContainer.innerHTML = "";
        APP_CONFIG.PROJECT_TYPES.forEach(t => {
            const count = data.filter(p => p._type === t.type).length;
            miniContainer.innerHTML += `
                <div class="mini-card" style="border-top-color:${t.color}">
                    <h3 style="color:${t.color}">${count}</h3><span>${t.label}</span>
                </div>`;
        });
        ChartManager.renderCharts(data);
        const modalStatus = document.getElementById('dynamic-status-container');
        modalStatus.innerHTML = "";
        const statusCounts = {};
        data.forEach(p => { const s = p.STATUS; statusCounts[s] = (statusCounts[s] || 0) + 1; });
        Object.entries(statusCounts).sort((a,b) => b[1] - a[1]).forEach(([s, c]) => {
             const cat = Utils.getStatusCategory(s);
             const col = APP_CONFIG.STATUS_COLORS[cat].color;
             modalStatus.innerHTML += `
                <div class="status-group">
                    <div class="status-label-row"><span>${s}</span><span>${c}</span></div>
                    <div class="progress-track"><div class="progress-fill" style="width:${(c/data.length)*100}%; background:${col}"></div></div>
                </div>`;
        });
        setTimeout(() => {
            if(!AppState.reportMap) {
                AppState.reportMap = L.map('report-map', { zoomControl: false, attributionControl: false }).setView([5.9804, 116.0735], 7);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(AppState.reportMap);
                AppState.reportMarkerLayer = L.layerGroup().addTo(AppState.reportMap);
            }
            AppState.reportMap.invalidateSize();
            AppState.reportMarkerLayer.clearLayers();
            if (AppState.activeBoundaryKey && AppState.dataLayers[AppState.activeBoundaryKey]) {
                const boundary = L.geoJSON(AppState.dataLayers[AppState.activeBoundaryKey].toGeoJSON(), {
                     style: (f) => ({ color: (Utils.extractGeoName(f) === AppState.activeFeatureName) ? '#EF4444' : '#ccc', weight: 1 })
                }).addTo(AppState.reportMap);
                const activeLayer = boundary.getLayers().find(l => Utils.extractGeoName(l.feature) === AppState.activeFeatureName);
                if(activeLayer) AppState.reportMap.fitBounds(activeLayer.getBounds());
            }
            data.slice(0, 2000).forEach(p => {
                L.circleMarker([p.LATITUDE, p.LONGITUDE], { radius: 3, color: Utils.getTypeConfig(p._type).color, fillOpacity: 0.8 }).addTo(AppState.reportMarkerLayer);
            });
        }, 300);
    },
    updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true });
    },
    downloadCSV() {
        const data = AppState.currentFilteredList.length > 0 ? AppState.currentFilteredList : AppState.allProjects;
        if(data.length === 0) return alert("Tiada data.");
        const stdHeaders = ["SITE_NAME", "DISTRICT", "DUN", "PARLIAMENT", "LATITUDE", "LONGITUDE", "STATUS", "PROJECT_TYPE"];
        const extraKeys = new Set();
        data.forEach(p => p._extra_details.forEach(d => extraKeys.add(d.label)));
        const allHeaders = [...stdHeaders, ...Array.from(extraKeys)];
        const csvContent = [
            allHeaders.join(","),
            ...data.map(p => {
                return allHeaders.map(h => {
                    if (h === "PROJECT_TYPE") return p._type;
                    if (p[h] !== undefined) return `"${String(p[h]).replace(/"/g, '""')}"`;
                    const extra = p._extra_details.find(d => d.label === h);
                    return extra ? `"${String(extra.value).replace(/"/g, '""')}"` : "";
                }).join(",");
            })
        ].join("\n");
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Data_GIS_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    }
};

/**
 * =============================================================================
 * 8. CHART RENDERING (APEXCHARTS)
 * =============================================================================
 */
const ChartManager = {
    renderCharts(data) {
        const commonOpt = {
            chart: { type: 'bar', toolbar: { show: false }, animations: { enabled: false } },
            legend: { show: true, position: 'bottom' },
            dataLabels: { enabled: true }
        };
        const countsByType = {};
        APP_CONFIG.PROJECT_TYPES.forEach(t => countsByType[t.label] = data.filter(p => p._type === t.type).length);
        if(AppState.charts.c1) AppState.charts.c1.destroy();
        AppState.charts.c1 = new ApexCharts(document.querySelector("#chart-01"), {
            ...commonOpt, chart: { type: 'donut' },
            series: Object.values(countsByType),
            labels: Object.keys(countsByType),
            colors: APP_CONFIG.PROJECT_TYPES.map(t => t.color)
        });
        AppState.charts.c1.render();
        const countsByStatus = {};
        const cats = Object.keys(APP_CONFIG.STATUS_COLORS);
        cats.forEach(c => countsByStatus[c] = 0);
        data.forEach(p => {
            const c = Utils.getStatusCategory(p.STATUS);
            countsByStatus[c]++;
        });
        if(AppState.charts.c2) AppState.charts.c2.destroy();
        AppState.charts.c2 = new ApexCharts(document.querySelector("#chart-02"), {
            ...commonOpt, chart: { type: 'bar' },
            series: [{ name: 'Jumlah', data: Object.values(countsByStatus) }],
            xaxis: { categories: cats },
            colors: cats.map(c => APP_CONFIG.STATUS_COLORS[c].color),
            plotOptions: { bar: { distributed: true } }
        });
        AppState.charts.c2.render();
        const series = cats.map(status => {
            return {
                name: status,
                data: APP_CONFIG.PROJECT_TYPES.map(t => data.filter(p => p._type === t.type && Utils.getStatusCategory(p.STATUS) === status).length)
            };
        });
        if(AppState.charts.c3) AppState.charts.c3.destroy();
        AppState.charts.c3 = new ApexCharts(document.querySelector("#chart-03"), {
            ...commonOpt, chart: { type: 'bar', stacked: true },
            series: series,
            xaxis: { categories: APP_CONFIG.PROJECT_TYPES.map(t => t.label) },
            colors: cats.map(c => APP_CONFIG.STATUS_COLORS[c].color)
        });
        AppState.charts.c3.render();
        const bottomContainer = document.getElementById('dynamic-bottom-grid');
        bottomContainer.innerHTML = "";
        AppState.charts.bottom.forEach(c => c.destroy());
        AppState.charts.bottom = [];
        APP_CONFIG.PROJECT_TYPES.forEach((t, idx) => {
            const tData = data.filter(p => p._type === t.type);
            const tStats = [0, 0, 0];
            tData.forEach(p => {
                const s = Utils.getStatusCategory(p.STATUS);
                if(s === "SIAP") tStats[0]++;
                else if(s === "PEMBINAAN") tStats[1]++;
                else if(s === "PERANCANGAN") tStats[2]++;
            });
            const divId = `bottom-chart-${idx}`;
            bottomContainer.innerHTML += `
                <div class="card bottom-card">
                    <div class="bottom-card-header">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="icon-box" style="background:${t.color}; display:flex; align-items:center; justify-content:center; color:white;">${t.icon}</div>
                            <div><h4>${t.label}</h4><h3>${tData.length}</h3></div>
                        </div>
                    </div>
                    <div class="bottom-card-body" id="${divId}"></div>
                </div>`;
            setTimeout(() => {
                const c = new ApexCharts(document.querySelector(`#${divId}`), {
                    chart: { type: 'bar', height: '100%', toolbar: { show: false } },
                    series: [{ name: 'Jumlah', data: tStats }],
                    xaxis: { categories: ["Siap", "Bina", "Rancang"] },
                    colors: [APP_CONFIG.STATUS_COLORS.SIAP.color, APP_CONFIG.STATUS_COLORS.PEMBINAAN.color, APP_CONFIG.STATUS_COLORS.PERANCANGAN.color],
                    plotOptions: { bar: { distributed: true, borderRadius: 4 } },
                    legend: { show: false }
                });
                c.render();
                AppState.charts.bottom.push(c);
            }, 100);
        });
    }
};

/**
 * =============================================================================
 * 9. GLOBAL HANDLERS & INITIALIZATION
 * =============================================================================
 */
function toggleDashboard() {
    const panel = document.getElementById('dashboard-panel');
    const btn = document.getElementById('sidebar-toggle');
    panel.classList.toggle('closed');
    btn.innerHTML = panel.classList.contains('closed') ? '<i class="fas fa-chart-pie"></i>' : '<i class="fas fa-times"></i>';
}

function closeReport() {
    document.getElementById('report-overlay').classList.remove('open');
}

function generatePDF() {
    const element = document.querySelector('.report-container');
    const modal = document.querySelector('.report-modal');
    const origOverflow = modal.style.overflow;
    const origContOverflow = element.style.overflowY;
    modal.style.overflow = "visible";
    element.style.overflowY = "visible";
    document.querySelector('.modal-close-btn').style.display = 'none';
    document.querySelector('.btn-download-pdf').style.visibility = 'hidden';
    html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        const pdf = new window.jspdf.jsPDF('l', 'mm', 'a3');
        const pdfW = pdf.internal.pageSize.getWidth();
        const pdfH = (canvas.height * pdfW) / canvas.width;
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfW, pdfH);
        pdf.save(`Laporan_GIS_${APP_CONFIG.PROJECT_TYPES[0].type}_${new Date().toISOString().slice(0,10)}.pdf`);
    }).finally(() => {
        modal.style.overflow = origOverflow;
        element.style.overflowY = origContOverflow;
        document.querySelector('.modal-close-btn').style.display = 'flex';
        document.querySelector('.btn-download-pdf').style.visibility = 'visible';
    });
}

window.toggleDashboard = toggleDashboard;
window.closeReport = closeReport;
window.generatePDF = generatePDF;
window.downloadCSV = UI.downloadCSV;
window.openReport = UI.openReport.bind(UI);

window.onload = () => {
    UI.init();
    MapManager.init();
    DataManager.loadAllData();
    setInterval(() => DataManager.loadAllData(), APP_CONFIG.SETTINGS.REFRESH_INTERVAL_MS);
};
</script>
</body>
</html>
