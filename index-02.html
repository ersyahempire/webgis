<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Web GIS Projek Sabah v5.8 - Official</title>
  
  <!-- FontAwesome & Google Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <!-- PDF Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ----- GLOBAL VARIABLES & RESET ----- */
:root {
  --primary: #4F46E5;        /* Indigo 600 */
  --primary-dark: #4338ca;   /* Indigo 700 */
  --primary-light: #818cf8;  /* Indigo 400 */
  --glass-bg: rgba(255, 255, 255, 0.90); 
  --glass-bg-hover: rgba(255, 255, 255, 0.98);    
  --glass-border: rgba(255, 255, 255, 0.8);        
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); 
  --glass-blur: 20px;                             
  --text-main: #111827;      /* Gray 900 */
  --text-sub: #6b7280;       /* Gray 500 */
  --radius: 20px;            
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  font-family: 'Plus Jakarta Sans', sans-serif;
  height: 100vh; width: 100vw;
  overflow: hidden;
  background: #eef2f5;
  color: var(--text-main);
}

/* ----- MAP CONTAINER ----- */
#map {
  position: absolute; top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 0;
  background: #ddd; 
}

/* TOOLTIP FIXES */
.leaflet-tooltip {
    pointer-events: none !important;
    background: rgba(255,255,255,0.8);
    border: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    font-weight: 700;
    font-size: 11px;
    color: var(--primary-dark);
}
.leaflet-interactive { cursor: pointer; }

/* ----- LOADING SCREEN ----- */
.loading-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.95); z-index: 9999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.5s;
}
.loading-overlay.hide { opacity: 0; pointer-events: none; }
.spinner {
    width: 50px; height: 50px; border: 5px solid #ddd;
    border-top: 5px solid var(--primary); border-radius: 50%;
    animation: spin 1s linear infinite; margin-bottom: 20px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* ----- SEARCH BAR ----- */
.search-container {
  position: absolute; top: 24px; left: 50%;
  transform: translateX(-50%); z-index: 1000;
  width: 90%; max-width: 480px; display: flex; gap: 10px;
}
.search-box {
  flex: 1;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  padding: 14px 24px; border-radius: 50px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex; align-items: center; transition: var(--transition);
}
.search-box:focus-within {
  transform: translateY(-2px) scale(1.01);
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 15px 40px rgba(79, 70, 229, 0.15);
  border-color: var(--primary-light);
}
.search-box i { color: var(--text-sub); margin-right: 12px; font-size: 16px; }
.search-box input {
  border: none; background: transparent; width: 100%;
  font-family: inherit; font-size: 15px; font-weight: 500; color: var(--text-main);
}

/* ----- FLOATING DASHBOARD (LEFT) ----- */
.panel-toggle {
  position: absolute; top: 24px; left: 24px; z-index: 1001;
  background: var(--primary); color: white;
  width: 50px; height: 50px; border-radius: 16px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
  border: none; font-size: 18px; transition: var(--transition);
}
.panel-toggle:hover { transform: translateY(-3px); background: var(--primary-dark); }

.dashboard-panel {
  position: absolute; top: 85px; left: 24px; bottom: 24px; width: 360px;
  z-index: 1000; background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  border-radius: var(--radius); border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex; flex-direction: column;
  transform: translateX(0); transition: var(--transition);
  opacity: 1; overflow: hidden;
}
.dashboard-panel.closed { transform: translateX(-120%); opacity: 0; pointer-events: none; }

.panel-header {
  padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.2);
  background: linear-gradient(to right, rgba(255,255,255,0.5), rgba(255,255,255,0.1));
}
.panel-header h2 { 
  margin: 0; font-size: 20px; font-weight: 800; 
  background: -webkit-linear-gradient(45deg, var(--primary-dark), var(--primary));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  display: flex; align-items: center; gap: 10px; 
}
.panel-content { padding: 20px 24px; overflow-y: auto; flex: 1; }

.main-stat {
  text-align: center; margin-bottom: 24px; padding: 20px; border-radius: 20px;
  background: linear-gradient(145deg, rgba(255,255,255,0.6), rgba(255,255,255,0.3));
  border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.03);
}
.main-stat-value { font-size: 48px; font-weight: 800; color: var(--text-main); line-height: 1; margin-bottom: 5px; }
.main-stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-sub); font-weight: 600; }
.area-badge {
  background: #e0e7ff; color: var(--primary); padding: 8px 16px; border-radius: 30px;
  font-size: 12px; font-weight: 700; display: inline-block; margin-top: 15px;
}

.grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
.mini-stat {
  background: rgba(255,255,255,0.5); padding: 16px; border-radius: 16px;
  text-align: center; border: 1px solid rgba(255,255,255,0.4);
  transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;
}
.mini-stat:hover { background: rgba(255,255,255,0.9); transform: translateY(-4px); }
.mini-stat.selected { background: #fff; border: 2px solid var(--primary); }
.mini-stat::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #ccc; opacity: 0.5; }
.mini-stat-val { font-size: 24px; font-weight: 700; color: var(--text-main); margin-bottom: 2px; }
.mini-stat-lbl { font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; }

/* Status List - Shared Styles */
.status-section-title { font-size: 12px; font-weight: 800; text-transform: uppercase; color: var(--text-sub); margin: 0 0 16px 0; letter-spacing: 1px; }
.status-wrapper { margin-bottom: 12px; }
.status-item { 
  background: rgba(255,255,255,0.4); padding: 12px 16px; border-radius: 12px; 
  cursor: pointer; transition: var(--transition); border: 1px solid transparent; position: relative;
} 
.status-item:hover { background: rgba(255,255,255,0.8); }
.status-item.selected { background: #fff; border-color: var(--primary); border-radius: 12px 12px 0 0; }
.status-header { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin-bottom: 8px; font-weight: 600; } 
.status-name { font-weight: 700; color: var(--text-main); font-size: 13px; }
.progress-bg { width: 100%; height: 8px; background: rgba(0,0,0,0.06); border-radius: 10px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 10px; transition: width 1s; }
.status-details {
  background: rgba(255,255,255,0.6); padding: 16px; border-radius: 0 0 12px 12px;
  border: 1px solid rgba(255,255,255,0.5); border-top: none; display: none;
}
.status-details.show { display: block; }
.sub-stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px; }
.sub-stat-bar-bg { width: 100%; height: 4px; background: rgba(0,0,0,0.05); border-radius: 2px; margin-bottom: 10px; }
.sub-stat-bar-fill { height: 100%; border-radius: 2px; }

/* ----- CONTROLS (RIGHT) ----- */
.controls-container {
  position: absolute; top: 90px; right: 24px;
  display: flex; flex-direction: column; gap: 12px;
  z-index: 1000; align-items: flex-end; 
}
.control-card {
  background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  padding: 6px; border-radius: 14px; box-shadow: var(--glass-shadow); width: 52px; overflow: hidden;
  transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1), background 0.3s; border: 1px solid var(--glass-border); white-space: nowrap;
}
.control-card:hover, .control-card.expanded { width: 190px; background: var(--glass-bg-hover); }
.control-group-title {
  padding: 12px 14px 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--text-sub); letter-spacing: 0.5px; display: none;
}
.control-card.expanded .control-group-title { display: block; animation: fadeIn 0.3s; }

.toggle-btn {
  display: flex; align-items: center; width: 100%; padding: 10px; background: transparent; border: none; cursor: pointer;
  border-radius: 10px; color: var(--text-sub); transition: all 0.2s; text-align: left; margin-bottom: 2px;
}
.toggle-btn i, .toggle-btn span.icon-slot { width: 30px; text-align: center; font-size: 16px; flex-shrink: 0; }
.toggle-btn span.text-slot { opacity: 0; transition: opacity 0.2s; font-size: 13px; font-weight: 600; padding-left: 5px;}
.control-card:hover .toggle-btn span.text-slot, .control-card.expanded .toggle-btn span.text-slot { opacity: 1; }
.toggle-btn:hover { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
.toggle-btn.active { background: var(--primary); color: white; }
.toggle-btn.active i, .toggle-btn.active span.icon-slot { color: white !important; }

/* Legend Mini */
.legend-mini { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); }
.legend-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; font-weight: 500; color: var(--text-sub); }
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; box-shadow: 0 0 0 2px rgba(255,255,255,0.5); }

/* =============================================================================
   REPORT MODAL (STATIC INFOGRAPHIC - UPDATED FOR A3)
   ============================================================================= */
.report-overlay {
    position: fixed; inset: 0; z-index: 5000;
    background: rgba(17, 24, 39, 0.85); backdrop-filter: blur(8px);
    display: none; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s ease;
}
.report-overlay.open { display: flex; opacity: 1; }

.report-modal {
    /* Set Aspect Ratio for A3 Landscape (Approx 1.414 : 1) */
    width: 90vw; height: 90vh; 
    max-width: 1600px; aspect-ratio: 297/210; /* A3 Landscape Ratio */
    border-radius: 20px;
    box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.6);
    display: flex; flex-direction: column; overflow: hidden;
    transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    background: linear-gradient(135deg, #eef2f5 0%, #e0e7ff 100%);
    color: #1f2937; border: 8px solid #fff; position: relative;
}
.report-overlay.open .report-modal { transform: scale(1); }

/* Static Container - No Scrollbars Allowed */
.report-container { 
    padding: 30px; 
    display: flex; flex-direction: column; 
    height: 100%; width: 100%;
    overflow: hidden; /* Force Static */
    gap: 15px;
}

.modal-close-btn {
    position: absolute; top: 15px; right: 20px; z-index: 5002;
    background: #ef4444; border: none; width: 40px; height: 40px; border-radius: 50%; 
    cursor: pointer; color: #fff; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
}
.modal-close-btn:hover { background: #dc2626; transform: rotate(90deg); transition: 0.3s; }

/* Report Header */
.report-header-content { 
    display: flex; justify-content: space-between; align-items: center; 
    padding-bottom: 10px; border-bottom: 2px solid #3730a3; flex-shrink: 0;
}
.header-title h1 { font-size: 1.2rem; font-weight: 800; text-transform: uppercase; margin: 0; color: #6b7280; letter-spacing: 2px; }
.header-title h2 { font-size: 2.8rem; font-weight: 900; margin: 0; line-height: 1; color: #3730a3; }
.header-info { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
.btn-download-pdf {
    background: #4f46e5; padding: 10px 24px; border-radius: 8px; font-size: 0.9rem; 
    cursor: pointer; border: none; color: #fff; font-weight: 700; text-transform: uppercase;
    display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
}
.btn-download-pdf:hover { background: #4338ca; transform: translateY(-2px); }
.current-time { font-size: 0.9rem; color: #374151; font-weight: 700; background: #fff; padding: 6px 14px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

/* Top Section: KPIs & Charts */
.top-section { display: grid; grid-template-columns: 280px 1fr 1.5fr; gap: 15px; height: 28%; flex-shrink: 0; }

.kpi-card-main {
    background: #fff; border-radius: 16px; padding: 20px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e5e7eb;
}
.kpi-card-main h1 { font-size: 4.5rem; color: #3730a3; margin: 0; line-height: 1; font-weight: 900; }
.kpi-card-main p { font-size: 0.8rem; font-weight: 700; color: #6b7280; margin-top: 5px; text-transform: uppercase; }

.mini-stats-wrapper { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; }
.report-mini-card {
    background: #fff; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; 
    align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    border-top: 4px solid #ccc;
}
.report-mini-card h3 { font-size: 1.6rem; margin: 0; color: #111827; }
.report-mini-card span { font-size: 0.7rem; font-weight: 700; color: #6b7280; text-transform: uppercase; }

.chart-wrapper { background: #fff; border-radius: 16px; padding: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
.chart-header { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; color: #374151; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 5px; }

/* Main Content: Map & Status (Static Layout) */
.middle-section { 
    display: grid; grid-template-columns: 2fr 1fr; gap: 15px; 
    flex: 1; min-height: 0; /* Important for flex child */
}

.report-map-box { 
    background: #fff; border-radius: 16px; overflow: hidden; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 4px solid #fff;
    position: relative; height: 100%; width: 100%;
}
#report-map { width: 100%; height: 100%; background: #e5e7eb; }

.report-status-box { 
    background: #fff; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 100%;
}
.report-status-header { 
    padding: 12px; background: #f3f4f6; border-bottom: 1px solid #e5e7eb; 
    font-weight: 800; color: #3730a3; font-size: 0.9rem; text-transform: uppercase;
}
/* Static Status Grid - No Scroll */
.report-status-content { 
    padding: 10px; flex: 1; overflow: hidden; 
    display: grid; grid-template-columns: 1fr; gap: 8px; align-content: start;
}
.report-status-row {
    background: #f9fafb; padding: 8px 12px; border-radius: 8px; border-left: 4px solid #ccc;
    display: flex; flex-direction: column; justify-content: center;
}
.r-status-top { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
.r-status-bar { height: 6px; background: #e5e7eb; border-radius: 4px; overflow: hidden; width: 100%; }
.r-status-fill { height: 100%; }
.r-status-details { font-size: 0.65rem; color: #6b7280; margin-top: 4px; display: flex; gap: 8px; }

/* Bottom Section */
.bottom-section { height: 15%; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; flex-shrink: 0; }
.bottom-stat-card { background: #fff; border-radius: 12px; padding: 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }

footer { 
    text-align: center; font-size: 0.75rem; color: #6b7280; font-weight: 600; padding-top: 10px; 
    border-top: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;
}

</style>
</head>
<body>

  <!-- Map Background -->
  <div id="map"></div>

  <!-- Loading Screen -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div style="font-weight: 700; font-size: 14px; color: var(--primary); letter-spacing: 0.5px;">MEMUATKAN DATA GIS...</div>
    <div id="loading-msg" style="font-size: 11px; margin-top: 5px; color: #666;"></div>
  </div>

  <!-- Top Search Bar -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="search-input" placeholder="Cari tapak, daerah, atau parlimen...">
    </div>
  </div>

  <!-- Sidebar Toggle -->
  <button class="panel-toggle" id="sidebar-toggle" onclick="toggleDashboard()">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Floating Dashboard -->
  <div class="dashboard-panel" id="dashboard-panel">
    <div class="panel-header">
      <h2><i class="fas fa-layer-group"></i> Statistik Projek</h2>
    </div>
    
    <div class="panel-content">
      <!-- Main Count -->
      <div class="main-stat">
        <div class="main-stat-value" id="total-projects">0</div>
        <div class="main-stat-label">Jumlah Projek</div>
        <div id="selected-area" class="area-badge">SELURUH SABAH</div>
      </div>
      <!-- End Main Count -->

      <div class="grid-stats" id="dynamic-grid-stats"></div>
      <div class="status-section-title">Status Kemajuan</div>
      <div id="status-list"></div>
      <div class="legend-mini" id="dynamic-legend"></div>
    </div>
  </div>

  <!-- Right Controls -->
  <div class="controls-container">
    <!-- CSV -->
    <div class="control-card">
        <button class="toggle-btn" title="Muat Turun CSV" onclick="downloadCSV()">
            <span class="icon-slot"><i class="fas fa-file-csv" style="color: #10B981;"></i></span> 
            <span class="text-slot">Muat Turun CSV</span>
        </button>
    </div>
    <!-- Report -->
    <div class="control-card">
        <button class="toggle-btn" title="Infografik A3" onclick="openReport()">
            <span class="icon-slot"><i class="fas fa-file-invoice-dollar" style="color: #F59E0B;"></i></span> 
            <span class="text-slot">Infografik A3</span>
        </button>
    </div>
    <!-- Layer Toggle (Updated Title) -->
    <div class="control-card" id="layer-card">
      <div class="control-group-title">Penapis Sempadan</div>
      <button class="toggle-btn active" id="toggle-daerah" title="Daerah">
        <span class="icon-slot"><i class="fas fa-map-marked-alt"></i></span> <span class="text-slot">Daerah</span>
      </button>
      <button class="toggle-btn" id="toggle-dun" title="DUN">
        <span class="icon-slot"><i class="fas fa-landmark"></i></span> <span class="text-slot">DUN</span>
      </button>
      <button class="toggle-btn" id="toggle-parliament" title="Parlimen">
        <span class="icon-slot"><i class="fas fa-building"></i></span> <span class="text-slot">Parlimen</span>
      </button>
    </div>
    <!-- Category Filters (Updated Title) -->
    <div class="control-card" id="filter-card">
      <div class="control-group-title">Penapis Data</div>
      <div id="dynamic-filter-btns"></div>
    </div>
  </div>

  <!-- REPORT MODAL (INFOGRAPHIC A3 STATIC) -->
  <div class="report-overlay" id="report-overlay">
      <div class="report-modal" id="report-content">
          <button class="modal-close-btn" onclick="closeReport()"><i class="fas fa-times"></i></button>
          
          <div class="report-container">
              <!-- HEADER -->
              <header class="report-header-content">
                  <div class="header-title">
                      <h1>Laporan Prestasi Projek</h1>
                      <h2 id="report-layer-name">SELURUH SABAH</h2>
                  </div>
                  <div class="header-info">
                      <button class="btn-download-pdf" onclick="generatePDF()">
                        <i class="fas fa-file-pdf"></i> Muat Turun PDF (A3)
                      </button>
                      <div class="current-time" id="clock">Loading...</div>
                  </div>
              </header>

              <!-- SECTION 1: KPIs & CHARTS -->
              <div class="top-section">
                  <!-- Main Big Number -->
                  <div class="kpi-card-main">
                      <h1 id="report-total-count">0</h1>
                      <p>JUMLAH KESELURUHAN TAPAK PROJEK</p>
                      <div class="badge" style="background:#e0e7ff; color:#4f46e5; margin-top:10px; padding:5px 15px; border-radius:20px; font-weight:800; font-size:0.75rem;" id="report-badge-area">SABAH</div>
                  </div>

                  <!-- Mini Stats Grid -->
                  <div class="mini-stats-wrapper" id="report-mini-stats">
                    <!-- Injected via JS -->
                  </div>

                  <!-- Chart: Project Composition -->
                  <div class="chart-wrapper">
                      <div class="chart-header">Komposisi Projek</div>
                      <div id="chart-01" style="flex:1; width:100%; min-height:0;"></div>
                  </div>
              </div>

              <!-- SECTION 2: MAP & STATUS (STATIC LAYOUT) -->
              <div class="middle-section">
                  <!-- Map Container (Zoomed In) -->
                  <div class="report-map-box">
                      <div id="report-map"></div>
                      <!-- Map Legend Overlay -->
                      <div style="position:absolute; bottom:10px; right:10px; background:rgba(255,255,255,0.9); padding:8px; border-radius:8px; z-index:999; font-size:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                        <div style="font-weight:700; margin-bottom:4px;">PETUNJUK:</div>
                        <div id="report-map-legend"></div>
                      </div>
                  </div>

                  <!-- Status List (Static Grid) -->
                  <div class="report-status-box">
                      <div class="report-status-header">RINGKASAN STATUS KEMAJUAN</div>
                      <div class="report-status-content" id="report-status-grid">
                        <!-- Injected JS Grid Items -->
                      </div>
                  </div>
              </div>

              <!-- SECTION 3: BOTTOM CHARTS -->
              <div class="bottom-section" id="report-bottom-charts">
                  <!-- Injected Charts -->
              </div>

              <footer>
                  Sistem Maklumat Geografi (GIS) Projek Sabah | Dijana secara automatik pada <span id="footer-date"></span> | &copy; MCMC Tawau
              </footer>
          </div>
      </div>
  </div>
    
<!-- MAIN SCRIPT -->
<script>
/**
 * =============================================================================
 * 1. CONFIGURATION (WAJIB - USER BOLEH UBAH)
 * =============================================================================
 */
const APP_CONFIG = {
    PROJECT_TYPES: [
        { id: "db_bwa", sheetId: "1594VRWEs0PF56KXeSPudZTWkbGuS5UZmxXGrKqo4bUU", type: "BWA", label: "WiFi", color: "#51cf66", icon: "ðŸ“¶" },
        { id: "db_pim", sheetId: "1WyZiw72LOVytssXAuymJS_TIgckLCUqY56pB0QhawZU", type: "NADI", label: "NADI", color: "#4dabf7", icon: "ðŸ“¡" },
        { id: "db_pop", sheetId: "1JLqLtZPa4Kd6hEbRA2wgMgADX2h2-tdsXnG-YivSgU8", type: "POP", label: "POP", color: "#fcc419", icon: "ðŸŒ" },
        { id: "tower", sheetId: "1b0Aipp0MQvP8HWc-z28dugkGn5sWdNAx6ZE5-Mu13-0", type: "TOWER", label: "Menara", color: "#ff6b6b", icon: "ðŸ—¼", filter: { col: "PROJECT_TYPE", val: "USP" } }
    ],
    
    // Status keywords for coloring ONLY. Actual categories are dynamic.
    COLOR_PALETTE: {
        GREEN: "#86efac",  // Siap, Komited, etc.
        YELLOW: "#fde047", // Bina, Implementasi, etc.
        RED: "#fca5a5",    // Rancang, Baru, etc.
        GRAY: "#cbd5e1"    // Others
    },

    SETTINGS: {
        MAX_EXTRA_INFO_COLUMNS: 15,
        REFRESH_INTERVAL_MS: 900000, // 15 Minit
        DEFAULT_MAP_CENTER: [5.9804, 116.0735],
        DEFAULT_ZOOM: 8
    },
    
    GEOJSON_URLS: {
        district: "district.json",
        dun: "dun.json",
        parliament: "parliament.json"
    }
};

/**
 * =============================================================================
 * 2. UTILITIES / HELPER FUNCTIONS
 * =============================================================================
 */
const Utils = {
    escapeHtml: (str) => String(str || "").replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c])),
    normalize: (str) => String(str || "").trim().toUpperCase(),
    cleanFloat: (val) => {
        if (typeof val === 'number') return val;
        if (!val) return 0;
        const str = String(val).replace(/[^0-9.,-]/g, "").replace(',', '.').trim();
        const floatVal = parseFloat(str);
        return isNaN(floatVal) ? 0 : floatVal;
    },
    generateId: (rowObj, type) => {
        const name = Utils.normalize(rowObj.SITE_NAME || "UNKNOWN");
        const dist = Utils.normalize(rowObj.DISTRICT || "SABAH");
        return `${type}_${name.replace(/\s+/g, '_')}_${dist.replace(/\s+/g, '_')}`;
    },
    debounce: (fn, wait = 250) => {
        let t;
        return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); };
    },
    getRandomColor: () => {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) { color += letters[Math.floor(Math.random() * 16)]; }
        return color;
    },
    // Updated: Returns exact normalized status (No Aggregation)
    getStatusCategory: (rawStatus) => {
        return Utils.normalize(rawStatus) || "TIADA STATUS";
    },
    getTypeConfig: (typeKey) => APP_CONFIG.PROJECT_TYPES.find(t => t.type === typeKey) || { color: "#666", icon: "â“", label: typeKey },
    // Updated: Determines color based on keywords
    getStatusColor: (statusKey) => {
        const s = Utils.normalize(statusKey);
        if (s.match(/SIAP|KOMITED|OPERASI|SELESAI|COMPLETE/)) return APP_CONFIG.COLOR_PALETTE.GREEN;
        if (s.match(/BINA|IMPLEMENTASI|PROGRESS|PELAKSANAAN/)) return APP_CONFIG.COLOR_PALETTE.YELLOW;
        if (s.match(/RANCANG|BARU|PLAN/)) return APP_CONFIG.COLOR_PALETTE.RED;
        return APP_CONFIG.COLOR_PALETTE.GRAY;
    }
};

/**
 * =============================================================================
 * 3. STATE MANAGEMENT
 * =============================================================================
 */
const AppState = {
    map: null,
    reportMap: null,
    markersLayerGroup: null,
    reportMarkerLayer: null,
    allProjects: [],
    currentFilteredList: [],
    visibleProjects: [], // Tracks projects currently shown on map for CSV download
    markersBySite: new Map(),
    dataLayers: { district: null, dun: null, parliament: null },
    
    // Filter States
    activeBoundaryKey: null,
    activeFeatureName: null,
    searchTerm: "",
    activeStatusFilter: null,
    
    // Decoupled Filters
    activeCategory: null,      // Left Dashboard (Single Focus)
    activeTypeToggles: new Set(), // Right Controls (Multiple Select)
    
    // Charts
    charts: { c1: null, bottom: [] }
};

/**
 * =============================================================================
 * 4. DATA FETCHING & PROCESSING
 * =============================================================================
 */
const DataManager = {
    async loadAllData() {
        UI.showLoading(true, "MENGHUBUNGI GOOGLE SHEETS...");
        try {
            const promises = APP_CONFIG.PROJECT_TYPES.map(config => this.fetchSingleSheet(config));
            const results = await Promise.all(promises);
            AppState.allProjects = results.flat();
            
            if (AppState.allProjects.length === 0) alert("Tiada data ditemui.");
            
            MapManager.renderMarkersInBatches(AppState.allProjects, () => {
                FilterManager.applyFilters();
                UI.showLoading(false);
            });
        } catch (error) {
            console.error("Critical Data Load Error:", error);
            UI.showLoading(false);
            alert("Ralat memuatkan data.");
        }
    },
    async fetchSingleSheet(config) {
        const url = `https://docs.google.com/spreadsheets/d/${config.sheetId}/gviz/tq?tqx=out:json&tq=`;
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP Error ${res.status}`);
            const text = await res.text();
            const jsonStart = text.indexOf('{');
            const jsonEnd = text.lastIndexOf('}');
            if (jsonStart === -1 || jsonEnd === -1) return [];
            const json = JSON.parse(text.substring(jsonStart, jsonEnd + 1));
            return (json.table && json.table.rows) ? this.processSheetData(json.table, config) : [];
        } catch (e) {
            console.warn(`Gagal memuatkan sheet: ${config.label}`, e);
            return [];
        }
    },
    processSheetData(table, config) {
        const cols = table.cols.map(c => c ? Utils.normalize(c.label) : "");
        const rows = table.rows;
        const STD_HEADERS = {
            SITE_NAME: ["SITE_NAME", "SITE NAME", "SITE", "NAMA_TAPAK"],
            DISTRICT: ["DISTRICT", "DAERAH"],
            DUN: ["DUN"],
            PARLIAMENT: ["PARLIAMENT", "PARLIAMENT_NAME", "PARLIMEN"],
            LAT: ["LATITUDE", "LAT", "LATITUDE_DEC"],
            LNG: ["LONGITUDE", "LON", "LNG", "LONG"],
            STATUS: ["STATUS", "STATUS_1", "KEMAJUAN"]
        };
        return rows.map(r => {
            const rowData = {};
            const extraDetails = [];
            const getValue = (headerKeys) => {
                for (let key of headerKeys) {
                    const idx = cols.indexOf(key);
                    if (idx > -1 && r.c[idx] && r.c[idx].v !== null) return r.c[idx].v;
                }
                return "";
            };
            if (config.filter) {
                const filterColIdx = cols.indexOf(Utils.normalize(config.filter.col));
                if (filterColIdx > -1) {
                    const val = r.c[filterColIdx]?.v || "";
                    if (Utils.normalize(val) !== Utils.normalize(config.filter.val)) return null;
                }
            }
            rowData.SITE_NAME = String(getValue(STD_HEADERS.SITE_NAME) || "N/A").trim();
            rowData.DISTRICT = String(getValue(STD_HEADERS.DISTRICT)).trim();
            rowData.DUN = String(getValue(STD_HEADERS.DUN)).trim();
            rowData.PARLIAMENT = String(getValue(STD_HEADERS.PARLIAMENT)).trim();
            rowData.STATUS = String(getValue(STD_HEADERS.STATUS) || "TIADA STATUS").trim();
            rowData.LATITUDE = Utils.cleanFloat(getValue(STD_HEADERS.LAT));
            rowData.LONGITUDE = Utils.cleanFloat(getValue(STD_HEADERS.LNG));
            rowData._type = config.type;
            rowData._validCoord = (rowData.LATITUDE !== 0 && rowData.LONGITUDE !== 0);
            if (rowData.SITE_NAME === "N/A") return null;
            let count = 0;
            const usedKeys = Object.values(STD_HEADERS).flat();
            cols.forEach((colName, idx) => {
                if (count >= APP_CONFIG.SETTINGS.MAX_EXTRA_INFO_COLUMNS) return;
                if (!colName || usedKeys.includes(colName)) return;
                const val = r.c[idx]?.v;
                if (val !== null && val !== undefined && val !== "") {
                    extraDetails.push({ label: colName, value: String(val).trim() });
                    count++;
                }
            });
            rowData._extra_details = extraDetails;
            rowData._id = Utils.generateId(rowData, config.type);
            return rowData;
        }).filter(item => item !== null);
    }
};

/**
 * =============================================================================
 * 5. MAP RENDERING (LEAFLET)
 * =============================================================================
 */
const MapManager = {
    init() {
        AppState.map = L.map('map', { zoomControl: false }).setView(APP_CONFIG.SETTINGS.DEFAULT_MAP_CENTER, APP_CONFIG.SETTINGS.DEFAULT_ZOOM);
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap' });
        satellite.addTo(AppState.map);
        L.control.layers({ "Satelit (Esri)": satellite, "Peta (OSM)": osm }, null, { position: 'topright' }).addTo(AppState.map);
        L.control.zoom({ position: 'bottomright' }).addTo(AppState.map);
        AppState.markersLayerGroup = L.layerGroup().addTo(AppState.map);
        this.loadBoundaries();
    },
    async loadBoundaries() {
        const loadLayer = async (key, url) => {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("File Missing");
                const data = await res.json();
                const layer = L.geoJSON(data, {
                    style: { color: '#666', weight: 1, fillOpacity: 0.05, fillColor: '#ffffff' },
                    onEachFeature: (feature, layer) => {
                        const name = this.extractGeoName(feature);
                        layer.bindTooltip(name, { sticky: true, interactive: false, direction: 'center', className: 'leaflet-tooltip' });
                        layer.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            this.highlightBoundary(key, layer, name);
                        });
                        layer.on('mouseover', (e) => {
                            if (AppState.activeFeatureName !== name) {
                                e.target.setStyle({ fillColor: Utils.getRandomColor(), fillOpacity: 0.5, weight: 2, color: '#333' });
                            }
                        });
                        layer.on('mouseout', (e) => {
                            if (AppState.activeFeatureName !== name) {
                                AppState.dataLayers[key].resetStyle(e.target);
                            }
                        });
                    }
                });
                AppState.dataLayers[key] = layer;
            } catch (e) {
                console.warn(`GeoJSON ${key} gagal dimuatkan.`);
                AppState.dataLayers[key] = L.layerGroup();
            }
        };
        await Promise.all([
            loadLayer('district', APP_CONFIG.GEOJSON_URLS.district),
            loadLayer('dun', APP_CONFIG.GEOJSON_URLS.dun),
            loadLayer('parliament', APP_CONFIG.GEOJSON_URLS.parliament)
        ]);
        
        document.getElementById('toggle-daerah').onclick = () => this.switchBoundary('district', 'toggle-daerah');
        document.getElementById('toggle-dun').onclick = () => this.switchBoundary('dun', 'toggle-dun');
        document.getElementById('toggle-parliament').onclick = () => this.switchBoundary('parliament', 'toggle-parliament');
        
        setTimeout(() => this.switchBoundary('district', 'toggle-daerah'), 500);
    },
    extractGeoName(feature) {
        const props = feature.properties || {};
        return Utils.normalize(props.NAME || props.name || props.DISTRICT || props.DAERAH || props.DUN || props.PARLIAMENT || "Sabah");
    },
    switchBoundary(key, btnId) {
        Object.values(AppState.dataLayers).forEach(l => { if(l && AppState.map.hasLayer(l)) AppState.map.removeLayer(l); });
        if (AppState.dataLayers[key] && AppState.dataLayers[key].getLayers().length > 0) {
            AppState.map.addLayer(AppState.dataLayers[key]);
            AppState.activeBoundaryKey = key;
        } else {
            AppState.activeBoundaryKey = null;
        }
        AppState.activeFeatureName = null;
        document.getElementById('selected-area').textContent = "SELURUH SABAH";
        document.querySelectorAll('#layer-card .toggle-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(btnId).classList.add('active');
        AppState.map.setView(APP_CONFIG.SETTINGS.DEFAULT_MAP_CENTER, APP_CONFIG.SETTINGS.DEFAULT_ZOOM);
        FilterManager.applyFilters();
    },
    highlightBoundary(key, layer, name) {
        AppState.dataLayers[key].eachLayer(l => {
            AppState.dataLayers[key].resetStyle(l);
            if (!l.getTooltip()) {
                 const lName = this.extractGeoName(l.feature);
                 l.bindTooltip(lName, { sticky: true, interactive: false, direction: 'center', className: 'leaflet-tooltip' });
            }
            l.closeTooltip();
        });
        const color = Utils.getRandomColor();
        layer.setStyle({ weight: 3, color: 'var(--primary)', fillOpacity: 0.4, fillColor: color });
        layer.unbindTooltip(); 
        layer.closeTooltip();
        AppState.activeFeatureName = name;
        document.getElementById('selected-area').textContent = name;
        AppState.map.fitBounds(layer.getBounds());
        FilterManager.applyFilters();
    },
    createMarker(project) {
        if (!project._validCoord) return null;
        const config = Utils.getTypeConfig(project._type);
        const statusColor = Utils.getStatusColor(project.STATUS);
        let extraHtml = project._extra_details.map(d => 
            `<div class="sub-stat-row"><span class="sub-stat-label">${Utils.escapeHtml(d.label)}</span><span class="sub-stat-val">${Utils.escapeHtml(d.value)}</span></div>`
        ).join('');
        if (extraHtml) extraHtml = `<div style="margin-top:10px; padding-top:10px; border-top:1px dashed #ccc; font-weight:700; font-size:11px;">MAKLUMAT TERPERINCI</div>` + extraHtml;
        const popupContent = `
            <div style="font-family:'Plus Jakarta Sans'; min-width:200px;">
                <div style="font-weight:800; font-size:14px; margin-bottom:5px; color:var(--primary);">${config.icon} ${Utils.escapeHtml(project.SITE_NAME)}</div>
                <div style="font-size:12px; color:#555;">
                    <div><b>Kategori:</b> ${config.label}</div>
                    <div><b>Daerah:</b> ${Utils.escapeHtml(project.DISTRICT)}</div>
                    <div><b>Status:</b> <span style="color:${statusColor}; font-weight:700;">${Utils.escapeHtml(project.STATUS)}</span></div>
                    ${extraHtml}
                </div>
            </div>`;
        const marker = L.circleMarker([project.LATITUDE, project.LONGITUDE], {
            radius: 6, fillColor: config.color, color: "#fff", weight: 2, opacity: 1, fillOpacity: 1
        }).bindPopup(popupContent);
        marker._meta = project;
        return marker;
    },
    renderMarkersInBatches(projects, onComplete) {
        const total = projects.length; 
        let i = 0;
        const batchSize = 500;
        const runChunk = () => {
            const end = Math.min(i + batchSize, total);
            for (; i < end; i++) {
                const p = projects[i];
                if (!AppState.markersBySite.has(p._id)) {
                    const m = this.createMarker(p);
                    if (m) AppState.markersBySite.set(p._id, m);
                }
            }
            if (i < total) setTimeout(runChunk, 20);
            else if (onComplete) onComplete();
        };
        runChunk();
    }
};

/**
 * =============================================================================
 * 6. DATA PROCESSING & FILTERING
 * =============================================================================
 */
const FilterManager = {
    applyFilters() {
        let list = AppState.allProjects;

        if (AppState.activeBoundaryKey && AppState.activeFeatureName) {
            const boundaryName = AppState.activeFeatureName;
            list = list.filter(p => {
                if (AppState.activeBoundaryKey === 'district') return Utils.normalize(p.DISTRICT) === boundaryName;
                if (AppState.activeBoundaryKey === 'dun') return Utils.normalize(p.DUN) === boundaryName;
                if (AppState.activeBoundaryKey === 'parliament') return Utils.normalize(p.PARLIAMENT) === boundaryName;
                return false;
            });
        }

        if (AppState.searchTerm) {
            const term = AppState.searchTerm.toLowerCase();
            list = list.filter(p => 
                p.SITE_NAME.toLowerCase().includes(term) ||
                p.DISTRICT.toLowerCase().includes(term) ||
                p.DUN.toLowerCase().includes(term)
            );
        }

        AppState.currentFilteredList = list;
        UI.updateDashboard(list);

        let mapList = [];
        let typesToShow = new Set();

        if (AppState.activeCategory) {
            typesToShow.add(AppState.activeCategory);
        } else {
            typesToShow = AppState.activeTypeToggles;
        }

        if (typesToShow.size > 0) {
             mapList = list.filter(p => typesToShow.has(p._type));
        } else {
             mapList = []; 
        }

        if (AppState.activeStatusFilter) {
            // Updated: Exact match filtering for status
            mapList = mapList.filter(p => Utils.getStatusCategory(p.STATUS) === AppState.activeStatusFilter);
        }

        this.updateMapMarkers(mapList);
    },
    updateMapMarkers(displayList) {
        AppState.markersLayerGroup.clearLayers();
        // IMPORTANT: Simpan senarai projek yang dipaparkan untuk CSV
        AppState.visibleProjects = displayList;

        const visibleIds = new Set(displayList.map(p => p._id));
        AppState.markersBySite.forEach((marker, id) => {
            if (visibleIds.has(id)) AppState.markersLayerGroup.addLayer(marker);
        });
    }
};

/**
 * =============================================================================
 * 7. UI RENDERING & CHARTS
 * =============================================================================
 */
const UI = {
    init() {
        this.generateDynamicControls();
        document.getElementById('search-input').addEventListener('input', Utils.debounce((e) => {
            AppState.searchTerm = e.target.value;
            FilterManager.applyFilters();
        }));
    },
    showLoading(show, msg) {
        const el = document.getElementById('loading');
        if(show) el.classList.remove('hide');
        else el.classList.add('hide');
        if(msg) document.getElementById('loading-msg').textContent = msg;
    },
    generateDynamicControls() {
        const grid = document.getElementById('dynamic-grid-stats');
        const legend = document.getElementById('dynamic-legend');
        const filters = document.getElementById('dynamic-filter-btns');
        const mapLegend = document.getElementById('report-map-legend');
        
        APP_CONFIG.PROJECT_TYPES.forEach(t => {
            // Dashboard Mini Stats
            const stat = document.createElement('div');
            stat.className = 'mini-stat'; 
            stat.id = `stat-card-${t.type}`;
            stat.onclick = () => this.handleCategoryClick(t.type); 
            stat.setAttribute('style', `--stat-color: ${t.color}`);
            stat.innerHTML = `
                <style>#stat-card-${t.type}::before { background: ${t.color}; }</style>
                <div class="mini-stat-val" id="count-${t.type}" style="color:${t.color}">0</div>
                <div class="mini-stat-lbl">${t.label}</div>
            `;
            grid.appendChild(stat);

            legend.innerHTML += `<div class="legend-row"><span class="dot" style="background:${t.color}"></span> ${t.label}</div>`;
            mapLegend.innerHTML += `<div style="display:flex;align-items:center;margin-bottom:2px;"><span style="width:8px;height:8px;border-radius:50%;background:${t.color};margin-right:5px;"></span> ${t.label}</div>`;

            const btn = document.createElement('button');
            btn.className = "toggle-btn"; 
            btn.id = `toggle-${t.type}`;
            btn.innerHTML = `<span class="icon-slot">${t.icon}</span><span class="text-slot">${t.label}</span>`;
            btn.onclick = () => this.handleTypeToggle(t.type); 
            filters.appendChild(btn);
        });
    },
    handleCategoryClick(type) {
        if (AppState.activeCategory === type) {
            AppState.activeCategory = null; 
            document.querySelectorAll('.mini-stat').forEach(el => el.classList.remove('selected'));
        } else {
            AppState.activeCategory = type; 
            document.querySelectorAll('.mini-stat').forEach(el => el.classList.remove('selected'));
            document.getElementById(`stat-card-${type}`).classList.add('selected');
        }
        FilterManager.applyFilters(); 
    },
    handleTypeToggle(type) {
        if (AppState.activeCategory) {
            AppState.activeCategory = null;
            document.querySelectorAll('.mini-stat').forEach(el => el.classList.remove('selected'));
        }
        if (AppState.activeTypeToggles.has(type)) {
            AppState.activeTypeToggles.delete(type);
            document.getElementById(`toggle-${type}`).classList.remove('active');
        } else {
            AppState.activeTypeToggles.add(type);
            document.getElementById(`toggle-${type}`).classList.add('active');
        }
        FilterManager.applyFilters();
    },
    updateDashboard(data) {
        const totalEl = document.getElementById('total-projects');
        const currentVal = parseInt(totalEl.textContent) || 0;
        const newVal = data.length;
        this.animateValue("total-projects", currentVal, newVal, 1000); 

        APP_CONFIG.PROJECT_TYPES.forEach(t => {
            const count = data.filter(p => p._type === t.type).length;
            document.getElementById(`count-${t.type}`).textContent = count;
        });

        let statusData = data;
        if (AppState.activeCategory) {
            statusData = data.filter(p => p._type === AppState.activeCategory);
        }
        this.renderStatusList(statusData);
    },
    animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if(!obj) return;
        if(start === end) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.textContent = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.textContent = end;
            }
        };
        window.requestAnimationFrame(step);
    },
    renderStatusList(data) {
        const container = document.getElementById('status-list');
        container.innerHTML = "";
        
        const stats = {};
        data.forEach(p => {
            const cat = Utils.getStatusCategory(p.STATUS); 
            if(!stats[cat]) {
                stats[cat] = { 
                    count: 0, 
                    color: Utils.getStatusColor(cat), 
                    details: {} 
                };
            }
            stats[cat].count++;
            if(!stats[cat].details[p._type]) stats[cat].details[p._type] = 0;
            stats[cat].details[p._type]++;
        });
        
        const totalCount = data.length;
        
        const sortedCats = Object.keys(stats).sort((a,b) => stats[b].count - stats[a].count);

        sortedCats.forEach(cat => {
            const itemData = stats[cat];
            const percent = totalCount > 0 ? Math.round((itemData.count / totalCount) * 100) : 0;
            const isSelected = (AppState.activeStatusFilter === cat) ? "selected" : "";
            
            let subHtml = "";
            Object.entries(itemData.details).forEach(([type, tCount]) => {
                const tConfig = Utils.getTypeConfig(type);
                const tPercent = Math.round((tCount / itemData.count) * 100);
                subHtml += `
                    <div class="sub-stat-row">
                         <span style="color:${tConfig.color}; font-weight:700;">${tConfig.label}</span>
                         <span>${tCount}</span>
                    </div>
                    <div class="sub-stat-bar-bg"><div class="sub-stat-bar-fill" style="width:${tPercent}%; background:${tConfig.color}"></div></div>
                `;
            });

            const item = document.createElement('div');
            item.className = "status-wrapper";
            item.innerHTML = `
                <div class="status-item ${isSelected}" onclick="UI.toggleStatusFilter('${cat}')">
                    <div class="status-header">
                        <span class="status-name">${cat}</span>
                        <span style="color:${itemData.color}; font-weight:800;">${itemData.count} (${percent}%)</span>
                    </div>
                    <div class="progress-bg"><div class="progress-fill" style="width:${percent}%; background:${itemData.color}"></div></div>
                </div>
                <div class="status-details ${isSelected ? 'show' : ''}">${subHtml}</div>
            `;
            container.appendChild(item);
        });
    },
    toggleStatusFilter(status) {
        AppState.activeStatusFilter = (AppState.activeStatusFilter === status) ? null : status;
        FilterManager.applyFilters();
    },
    openReport() {
        const data = AppState.currentFilteredList.length > 0 ? AppState.currentFilteredList : AppState.allProjects;
        document.getElementById('report-overlay').classList.add('open');
        document.getElementById('report-layer-name').textContent = AppState.activeFeatureName || "SELURUH SABAH";
        document.getElementById('report-badge-area').textContent = AppState.activeFeatureName || "SELURUH SABAH";
        document.getElementById('report-total-count').textContent = data.length;
        document.getElementById('footer-date').textContent = new Date().toLocaleString('ms-MY');
        this.updateClock();
        
        // --- 1. Top Section Stats ---
        const miniContainer = document.getElementById('report-mini-stats');
        miniContainer.innerHTML = "";
        APP_CONFIG.PROJECT_TYPES.forEach(t => {
            const count = data.filter(p => p._type === t.type).length;
            miniContainer.innerHTML += `
                <div class="report-mini-card" style="border-top-color:${t.color}">
                    <h3 style="color:${t.color}">${count}</h3><span>${t.label}</span>
                </div>`;
        });
        
        ChartManager.renderCharts(data);
        
        // --- 2. Static Status Grid (No Scroll) ---
        const reportStatusGrid = document.getElementById('report-status-grid');
        reportStatusGrid.innerHTML = "";
        
        const counts = {};
        data.forEach(p => {
             const s = Utils.getStatusCategory(p.STATUS);
             counts[s] = (counts[s] || 0) + 1;
        });
        const sortedStatus = Object.keys(counts).sort((a,b) => counts[b] - counts[a]); // Max top 7 to fit

        sortedStatus.forEach(status => {
            const count = counts[status];
            const percent = ((count / data.length) * 100).toFixed(1);
            const color = Utils.getStatusColor(status);
            
            reportStatusGrid.innerHTML += `
                <div class="report-status-row" style="border-left-color:${color}">
                    <div class="r-status-top">
                        <span>${status}</span>
                        <span>${count}</span>
                    </div>
                    <div class="r-status-bar"><div class="r-status-fill" style="width:${percent}%; background:${color}"></div></div>
                    <div class="r-status-details">
                         <span>${percent}% daripada keseluruhan</span>
                    </div>
                </div>
            `;
        });

        // --- 3. Report Map (Zoomed) ---
        setTimeout(() => {
            if(AppState.reportMap) { AppState.reportMap.remove(); AppState.reportMap = null; }

            AppState.reportMap = L.map('report-map', { 
                zoomControl: false, 
                attributionControl: false,
                dragging: false, // Static map
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false
            });
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(AppState.reportMap);
            AppState.reportMarkerLayer = L.layerGroup().addTo(AppState.reportMap);
            
            AppState.reportMap.invalidateSize();
            
            let boundsToFit = null;

            // Add Boundary Layer
            if (AppState.activeBoundaryKey && AppState.dataLayers[AppState.activeBoundaryKey]) {
                const geoJsonData = AppState.dataLayers[AppState.activeBoundaryKey].toGeoJSON();
                const boundaryLayer = L.geoJSON(geoJsonData, {
                      style: (feature) => {
                          const name = Utils.extractGeoName(feature);
                          const isActive = name === AppState.activeFeatureName;
                          return { 
                              color: isActive ? '#DC2626' : '#94a3b8', 
                              weight: isActive ? 2 : 1,
                              fillColor: isActive ? '#EF4444' : 'transparent',
                              fillOpacity: isActive ? 0.2 : 0
                          };
                      }
                }).addTo(AppState.reportMap);
                
                if (AppState.activeFeatureName) {
                    boundaryLayer.eachLayer(l => {
                        if (Utils.extractGeoName(l.feature) === AppState.activeFeatureName) boundsToFit = l.getBounds();
                    });
                } else {
                    boundsToFit = boundaryLayer.getBounds();
                }
            } else {
                boundsToFit = L.latLngBounds([4.0, 114.0], [7.5, 119.5]);
            }

            // Add Markers (Lighter version for static map)
            data.slice(0, 3000).forEach(p => {
                const config = Utils.getTypeConfig(p._type);
                L.circleMarker([p.LATITUDE, p.LONGITUDE], { 
                    radius: 3, 
                    color: '#fff', 
                    weight: 0.5,
                    fillColor: config.color, 
                    fillOpacity: 1 
                }).addTo(AppState.reportMarkerLayer);
            });

            if(boundsToFit && boundsToFit.isValid()) {
                AppState.reportMap.fitBounds(boundsToFit, { padding: [20, 20] });
            } else {
                AppState.reportMap.setView(APP_CONFIG.SETTINGS.DEFAULT_MAP_CENTER, 7);
            }

        }, 300);
    },
    updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
    },
    downloadCSV() {
        // 1. Sumber Data: Hanya projek yang dipaparkan di peta (visibleProjects)
        const data = AppState.visibleProjects; 
        if (!data || data.length === 0) return alert("Tiada data pada peta untuk dimuat turun.");

        // 2. Kumpulkan semua header unik (Standard + Extra)
        const stdHeaders = ["SITE_NAME", "DISTRICT", "DUN", "PARLIAMENT", "LATITUDE", "LONGITUDE", "STATUS", "PROJECT_TYPE"];
        const extraKeys = new Set();
        data.forEach(p => p._extra_details.forEach(d => extraKeys.add(d.label)));
        const allHeaders = [...stdHeaders, ...Array.from(extraKeys)];

        // 3. Bina kandungan CSV
        const csvContent = [
            allHeaders.join(","),
            ...data.map(p => {
                return allHeaders.map(h => {
                    // Mapping standard columns
                    if (h === "PROJECT_TYPE") return p._type;
                    if (h === "LATITUDE" || h === "LONGITUDE") return p[h]; // Keep numbers
                    if (p[h] !== undefined) return `"${String(p[h]).replace(/"/g, '""')}"`;
                    
                    // Mapping extra columns
                    const extra = p._extra_details.find(d => d.label === h);
                    return extra ? `"${String(extra.value).replace(/"/g, '""')}"` : "";
                }).join(",");
            })
        ].join("\n");

        // 4. Bina Nama Fail Automatik
        // Format: data_gis_{layer}_{project}_{status}_{datetime}.csv
        
        // a. Layer Name
        let fLayer = AppState.activeFeatureName ? AppState.activeFeatureName.replace(/\s+/g, '_') : "Seluruh_Sabah";
        
        // b. Project Name
        let fProject = "Semua_Projek";
        if (AppState.activeCategory) {
            fProject = AppState.activeCategory;
        } else if (AppState.activeTypeToggles.size > 0) {
            fProject = (AppState.activeTypeToggles.size === 1) ? 
                Array.from(AppState.activeTypeToggles)[0] : "Gabungan";
        }
        
        // c. Status Name
        let fStatus = AppState.activeStatusFilter ? AppState.activeStatusFilter.replace(/\s+/g, '_') : "Semua_Status";
        
        // d. Date Time
        const now = new Date();
        const fDate = now.toISOString().slice(0,10).replace(/-/g, ''); // YYYYMMDD
        const fTime = now.toTimeString().slice(0,5).replace(/:/g, ''); // HHMM
        
        const fileName = `data_gis_${fLayer}_${fProject}_${fStatus}_${fDate}_${fTime}.csv`;

        // 5. Muat Turun
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
    }
};

/**
 * =============================================================================
 * 8. CHART RENDERING (APEXCHARTS)
 * =============================================================================
 */
const ChartManager = {
    renderCharts(data) {
        const commonOpt = {
            chart: { type: 'bar', toolbar: { show: false }, animations: { enabled: false } },
            legend: { show: true, position: 'right' },
            dataLabels: { enabled: true, style: { fontSize: '10px' } }
        };
        
        // Chart 1: Project Types (Donut)
        const countsByType = {};
        APP_CONFIG.PROJECT_TYPES.forEach(t => countsByType[t.label] = data.filter(p => p._type === t.type).length);
        if(AppState.charts.c1) AppState.charts.c1.destroy();
        AppState.charts.c1 = new ApexCharts(document.querySelector("#chart-01"), {
            ...commonOpt, 
            chart: { type: 'pie', height: '100%' }, // Use available height
            series: Object.values(countsByType),
            labels: Object.keys(countsByType),
            colors: APP_CONFIG.PROJECT_TYPES.map(t => t.color),
            legend: { position: 'bottom', fontSize: '10px' }
        });
        AppState.charts.c1.render();
        
        // Bottom Charts
        const bottomContainer = document.getElementById('report-bottom-charts');
        bottomContainer.innerHTML = "";
        AppState.charts.bottom.forEach(c => c.destroy());
        AppState.charts.bottom = [];
        
        // Display top 3 Categories only if filtered data exists, else display empty msg handled by UI
        APP_CONFIG.PROJECT_TYPES.forEach((t, idx) => {
            if(idx > 2) return; // Limit to 3 for bottom grid A3 layout
            const tData = data.filter(p => p._type === t.type);
            const tStatusCounts = {};
            tData.forEach(p => {
                const s = Utils.getStatusCategory(p.STATUS);
                tStatusCounts[s] = (tStatusCounts[s] || 0) + 1;
            });
            const tCats = Object.keys(tStatusCounts).sort((a,b) => tStatusCounts[b] - tStatusCounts[a]).slice(0, 4);

            const divId = `bottom-chart-${idx}`;
            bottomContainer.innerHTML += `
                <div class="bottom-stat-card">
                    <div style="width:30%;">
                        <div style="font-weight:800; font-size:0.8rem; color:#374151;">${t.label}</div>
                        <div style="font-size:1.5rem; font-weight:900; color:${t.color};">${tData.length}</div>
                    </div>
                    <div id="${divId}" style="width:70%; height:80px;"></div>
                </div>`;
            setTimeout(() => {
                const c = new ApexCharts(document.querySelector(`#${divId}`), {
                    chart: { type: 'bar', height: 80, toolbar: { show: false }, sparkline: { enabled: true } },
                    series: [{ name: 'Jumlah', data: tCats.map(k => tStatusCounts[k]) }],
                    xaxis: { categories: tCats },
                    colors: tCats.map(k => Utils.getStatusColor(k)),
                    plotOptions: { bar: { distributed: true, borderRadius: 2, columnWidth: '60%' } },
                    tooltip: { fixed: { enabled: false }, x: { show: true } }
                });
                c.render();
                AppState.charts.bottom.push(c);
            }, 100);
        });
    }
};

/**
 * =============================================================================
 * 9. GLOBAL HANDLERS & INITIALIZATION
 * =============================================================================
 */
function toggleDashboard() {
    const panel = document.getElementById('dashboard-panel');
    const btn = document.getElementById('sidebar-toggle');
    panel.classList.toggle('closed');
    btn.innerHTML = panel.classList.contains('closed') ? '<i class="fas fa-chart-pie"></i>' : '<i class="fas fa-times"></i>';
}

function closeReport() {
    document.getElementById('report-overlay').classList.remove('open');
}

function generatePDF() {
    const element = document.querySelector('.report-container');
    const modal = document.querySelector('.report-modal');
    
    // Hide UI controls before print
    document.querySelector('.modal-close-btn').style.display = 'none';
    document.querySelector('.btn-download-pdf').style.visibility = 'hidden';
    
    // Force specific A3 width for capture (High Res)
    // A3 @ 96 DPI approx 1587px width. Using slightly less to be safe.
    const originalWidth = modal.style.width;
    const originalHeight = modal.style.height;
    const originalTransform = modal.style.transform;
    
    // Lock dimensions for screenshot
    modal.style.width = "1587px";
    modal.style.height = "1123px";
    modal.style.transform = "none";
    modal.style.maxWidth = "none";
    modal.style.maxHeight = "none";
    modal.style.borderRadius = "0";

    // Re-trigger map size invalidation to fill new space
    if(AppState.reportMap) AppState.reportMap.invalidateSize();

    setTimeout(() => {
        html2canvas(element, { 
            scale: 2, // 2x scale for crisp text
            useCORS: true,
            backgroundColor: "#f3f4f6",
            width: 1587,
            height: 1123,
            windowWidth: 1587,
            windowHeight: 1123
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            // A3 Landscape: 420mm x 297mm
            const pdf = new window.jspdf.jsPDF('l', 'mm', 'a3'); 
            pdf.addImage(imgData, 'JPEG', 0, 0, 420, 297);
            pdf.save(`Laporan_GIS_${APP_CONFIG.PROJECT_TYPES[0].type}_${new Date().toISOString().slice(0,10)}.pdf`);
        }).finally(() => {
            // Revert Styles
            modal.style.width = "";
            modal.style.height = "";
            modal.style.transform = "";
            modal.style.maxWidth = "";
            modal.style.maxHeight = "";
            modal.style.borderRadius = "";
            
            document.querySelector('.modal-close-btn').style.display = 'flex';
            document.querySelector('.btn-download-pdf').style.visibility = 'visible';
            
            if(AppState.reportMap) AppState.reportMap.invalidateSize();
        });
    }, 500); // Wait for repaint
}

window.toggleDashboard = toggleDashboard;
window.closeReport = closeReport;
window.generatePDF = generatePDF;
window.downloadCSV = UI.downloadCSV;
window.openReport = UI.openReport.bind(UI);

window.onload = () => {
    UI.init();
    MapManager.init();
    DataManager.loadAllData();
    setInterval(() => DataManager.loadAllData(), APP_CONFIG.SETTINGS.REFRESH_INTERVAL_MS);
};
</script>
</body>
</html>
